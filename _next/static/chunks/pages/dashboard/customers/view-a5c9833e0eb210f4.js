(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8971],{2548:function(e,n,t){"use strict";var r=t(64836);n.Z=void 0;var i=r(t(64938)),o=t(85893);n.Z=(0,i.default)((0,o.jsx)("path",{d:"M11 7h2v2h-2zm0 4h2v6h-2zm1-9C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8"}),"InfoOutlined")},81261:function(e,n,t){"use strict";var r=t(64836);n.Z=void 0;var i=r(t(64938)),o=t(85893);n.Z=(0,i.default)((0,o.jsx)("path",{d:"M2 20h20v-4H2zm2-3h2v2H4zM2 4v4h20V4zm4 3H4V5h2zm-4 7h20v-4H2zm2-3h2v2H4z"}),"Storage")},6054:function(e,n,t){"use strict";var r=t(67294),i=function(e){var n=(0,r.useRef)();return(0,r.useEffect)(function(){n.current=e}),n.current};n.Z=i},11082:function(e,n){"use strict";var t=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"GBP";return new Intl.NumberFormat(["en-GB"],{currency:n,currencyDisplay:"symbol",style:"currency"}).format(e)};n.Z=t},24262:function(e,n,t){"use strict";function r(e){var n=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds(),e.getMilliseconds()));return n.setUTCFullYear(e.getFullYear()),e.getTime()-n.getTime()}t.d(n,{Z:function(){return r}})},83946:function(e,n,t){"use strict";function r(e){if(null===e||!0===e||!1===e)return NaN;var n=Number(e);return isNaN(n)?n:n<0?Math.ceil(n):Math.floor(n)}t.d(n,{Z:function(){return r}})},11640:function(e,n,t){"use strict";t.d(n,{Z:function(){return a}});var r=t(83946),i=t(19013),o=t(13882);function a(e,n){(0,o.Z)(2,arguments);var t=(0,i.Z)(e),a=(0,r.Z)(n);if(isNaN(a))return new Date(NaN);if(!a)return t;var s=t.getDate(),c=new Date(t.getTime());return(c.setMonth(t.getMonth()+a+1,0),s>=c.getDate())?c:(t.setFullYear(c.getFullYear(),c.getMonth(),s),t)}},83894:function(e,n,t){"use strict";t.d(n,{Z:function(){return o}});var r=t(19013),i=t(13882);function o(e){(0,i.Z)(1,arguments);var n=(0,r.Z)(e);return n.setHours(23,59,59,999),n}},43703:function(e,n,t){"use strict";t.d(n,{Z:function(){return o}});var r=t(19013),i=t(13882);function o(e){(0,i.Z)(1,arguments);var n=(0,r.Z)(e);return n.setDate(1),n.setHours(0,0,0,0),n}},38148:function(e,n,t){"use strict";t.d(n,{Z:function(){return o}});var r=t(19013),i=t(13882);function o(e){(0,i.Z)(1,arguments);var n=(0,r.Z)(e),t=new Date(0);return t.setFullYear(n.getFullYear(),0,1),t.setHours(0,0,0,0),t}},71534:function(e,n,t){"use strict";t.d(n,{N:function(){return a}});var r=t(58594),i=t(85893),o=[{id:"assignedToMe",label:"Assigned to me",value:"assignedToMe"}],a=function(e){var n=e.data,t=e.errors,a=e.name,s=e.onChange,c=e.register;return(0,i.jsx)(r.Z,{errors:t,data:n||o,legend:"",name:a,onChange:s,register:c})};a.defaultProps={name:"assignedToMe"}},34197:function(e,n,t){"use strict";t.d(n,{E:function(){return r}});var r=function(e,n){if(Array.isArray(n)){var t,r=null;return n.forEach(function(n){var t,i=null==e?void 0:null===(t=e.timings)||void 0===t?void 0:t.find(function(e){return e.status===n});r=(null==i?void 0:i.createdAt)||r}),r}var i=null==e?void 0:null===(t=e.timings)||void 0===t?void 0:t.find(function(e){return e.status===n});return(null==i?void 0:i.createdAt)||null}},86385:function(e,n,t){"use strict";t.d(n,{V:function(){return X}});var r,i=t(16835),o=t(59499),a=t(67294),s=t(30381),c=t.n(s),d=t(11163),u=t.n(d),l=t(57460),m=t.n(l),p=t(6812),f=t(73359),v=t(71383),h=(0,t(75063).Ps)(r||(r=(0,v.Z)(['\n  query GetLocations(\n    $accountId: Int\n    $limit: Int\n    $offset: Int\n    $q: String\n    $orderBy: Location_order_by!\n  ) {\n    properties: Location(\n      limit: $limit\n      offset: $offset\n      order_by: [$orderBy]\n      where: {\n        Account_Locations: {\n          accountId: { _eq: $accountId }\n          Account: { type: { _eq: "customer" } }\n        }\n        _or: [\n          { name: { _ilike: $q } }\n          { Addresses: { Address: { city: { _ilike: $q } }, entity: { _eq: "Location" } } }\n          { Addresses: { Address: { postCode: { _ilike: $q } }, entity: { _eq: "Location" } } }\n        ]\n      }\n    ) {\n      id\n      access\n      contactUserId\n      createdAt\n      name\n      status\n      addresses: Addresses(where: { entity: { _eq: "Location" }, registered: { _eq: true } }) {\n        id\n        status\n        address: Address {\n          id\n          name\n          addressLine1\n          postCode\n        }\n      }\n      customer: Account_Locations {\n        id\n        account: Account {\n          id\n          name\n        }\n      }\n      compliances: Compliances(\n        where: { entity: { _eq: "Location" } }\n        order_by: { expiryAt: asc }\n      ) {\n        id\n        expiryAt\n        compliance: Compliance {\n          id\n          name\n        }\n      }\n      bookings: Jobs(\n        where: { Invoices: { invoiceType: { _in: ["customerVat", "ProformaInvoiceCustomer"] } } }\n      ) {\n        id\n        Invoices {\n          AccountEntry {\n            balance\n          }\n        }\n      }\n      invoices: Invoice(where: { invoiceType: { _eq: "customerPPM" } }) {\n        AccountEntry {\n          balance\n        }\n      }\n      user: User {\n        id\n        fullName\n      }\n    }\n    meta: Location_aggregate(\n      where: {\n        Account_Locations: {\n          accountId: { _eq: $accountId }\n          Account: { type: { _eq: "customer" } }\n        }\n        _or: [\n          { name: { _ilike: $q } }\n          { Addresses: { Address: { city: { _ilike: $q } }, entity: { _eq: "Location" } } }\n          { Addresses: { Address: { postCode: { _ilike: $q } }, entity: { _eq: "Location" } } }\n        ]\n      }\n    ) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n']))),g=t(9164),b=t(61730),y=t(5616),x=t(93946),j=t(26447),I=t(11057),w=t(98456),O=t(90629),Z=t(15861),_=t(2548),C=t(81261),A=t(19958),P=t(32836),S=t(42283),k=t(50135),L=t(90948),D=t(11994),N=t(6911),q=t(3896),M=t(76301),T=t(85893);function $(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),t.push.apply(t,r)}return t}function E(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?$(Object(t),!0).forEach(function(n){(0,o.Z)(e,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):$(Object(t)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})}return e}var F=function(e){var n=e.initialFilters,t=e.filters,r=e.setFilters,o=e.open,s=e.onClose,c=(0,d.useRouter)().query,u=(0,b.Z)("(max-width: 400px)"),l=(0,a.useMemo)(function(){return(null==c?void 0:c.tab)==="locations"},[c]),m=(0,q.X)("form_data_".concat(n.filterType).concat(l?"_".concat(n.accountId):""),n),p=(0,i.Z)(m,2),v=p[0],h=p[1],g=(0,a.useState)(),y=g[0],x=g[1],w=(0,S.cI)({defaultValues:v}),Z=w.control,_=w.handleSubmit,C=w.register,A=w.reset,P=w.errors,L=(0,f.t)(M.SW,{variables:{where:{name:{_ilike:""!==y?"%".concat(y,"%"):null}}}}),D=(0,i.Z)(L,2),$=D[0],F=D[1],R=F.loading,W=F.data,V=(W=void 0===W?{items:[]}:W).items,U=function(){r(n),A(),s(),h(E(E({},n),{},{filterType:n.filterType}))},B=function(e){var i,o=E(E(E({},t),e),{},{accountId:l?n.accountId:null===(i=e.customer)||void 0===i?void 0:i.value,q:e.q});r(E(E({},o),{},{q:e.q?"%".concat(e.q,"%"):null})),h(E(E({},o),{},{customer:l?null:e.customer,filterType:n.filterType})),A(),s()};return(0,T.jsx)(H,{open:o,onClose:s,children:(0,T.jsx)(O.Z,{sx:{minWidth:u?"300px":"400px",padding:"20px 40px"},children:(0,T.jsxs)("form",{onSubmit:_(B),children:[(0,T.jsxs)(j.Z,{spacing:l?8:4,children:[(0,T.jsx)(k.Z,{fullWidth:!0,variant:"standard",color:"secondary",label:"Search...",name:"q",inputRef:C}),!l&&(0,T.jsx)(S.Qr,{name:"customer",control:Z,render:function(e){var n,t=e.value,r=e.onChange;return(0,T.jsx)(N.q,{limitTags:6,color:"secondary",value:t,onChange:function(e,n){return r(n)},label:"Select customer",loading:R,onOpen:function(){return $()},options:V,setSearch:x,textFieldProps:{label:"Select customer",variant:"standard",color:"secondary",error:P.customer,helperText:null===(n=P.customer)||void 0===n?void 0:n.message}})}})]}),(0,T.jsxs)(j.Z,{width:"100%",direction:"row",justifyContent:"flex-end",spacing:2,sx:{margin:"20px 0"},children:[(0,T.jsx)(I.Z,{variant:"contained",color:"danger",onClick:function(){return U()},children:"Cancel"}),(0,T.jsx)(I.Z,{variant:"contained",color:"secondary",type:"submit",children:"Search"})]})]})})})},H=(0,L.ZP)(D.Z)(function(){return{display:"flex",justifyContent:"center",alignItems:"center",width:"100%",height:"100%"}}),R=t(45110),W=t(42846),V=t(48829),U=t(94568),B=t(35137),z=t(58095);function Y(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),t.push.apply(t,r)}return t}function J(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?Y(Object(t),!0).forEach(function(n){(0,o.Z)(e,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):Y(Object(t)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})}return e}var G=function(e){return c()(e).format("YYYY-MM-DD")},Q=function(e,n){var t;return(null==e?void 0:e.reduce(function(e,n){var t;return e+(null==n?void 0:null===(t=n.Invoices)||void 0===t?void 0:t.reduce(function(e,n){var t;return e+(null==n?void 0:null===(t=n.AccountEntry)||void 0===t?void 0:t.balance)||0},0))||0},0))+(null==n?void 0:n.reduce(function(e,n){var t;return e+(null==n?void 0:null===(t=n.AccountEntry)||void 0===t?void 0:t.balance)||0},0))},X=function(e){var n,t=e.accountId,r=e.accountName,o=e.initialFilters,s=e.columnVisibilityModel,c=e.tableContainerHeight,d=(0,a.useState)(!1),l=d[0],v=d[1],S=(0,a.useState)(!1),k=S[0],L=S[1],D=(0,a.useState)(J({},o)),N=D[0],q=D[1],M=(0,W.x)({filters:N}),$=M.initialData,E=M.ref,H=(0,z.a)(),Y=(0,b.Z)("(max-width: 400px)"),X=(0,U.s)(),K=(0,p.a)(h,{variables:$}),ee=K.data,en=(ee=void 0===ee?{properties:[],meta:{aggregate:{totalCount:0}}}:ee).properties,et=ee.meta,er=K.loading,ei=K.refetch,eo=(0,f.t)(h,{fetchPolicy:"no-cache",variables:{accountId:$.accountId,q:$.q,orderBy:$.orderBy},onCompleted:function(e){try{var n=m().unparse(eu(e.properties)),t="data:application/octet-stream,"+encodeURIComponent(n);(0,V.S)(t,"locations.csv")}finally{L(!1)}}}),ea=(0,i.Z)(eo,1)[0],es=function(e){e.stopPropagation(),L(!0),ea()},ec=function(e,n){e.stopPropagation(),H.show({content:(0,T.jsx)(A.V,{accountId:t,accountName:r,data:null==n?void 0:n.data,entity:"Location",refetch:ei}),title:null!=n&&n.data?"Edit location":"Create location"})},ed=function(e){var n=e.row;u().push("".concat("/dashboard/properties/","view?id=").concat(n.data.id,"&tab=details"))},eu=function(e){return e.map(function(e){var n,t,r=null==e?void 0:null===(n=e.addresses[0])||void 0===n?void 0:n.address;return{name:e.name||"Not Specified",customer:e.customer[0].account.name,address:r?"".concat(r.addressLine1," - ").concat(r.postCode):"",bookings:null===(t=e.bookings)||void 0===t?void 0:t.length,totalSpent:(0,R.T)(Q(e.bookings,e.invoices)),createdAt:G(e.createdAt)}})},el=function(){return en.map(function(e){var n,t,r,i;return{id:e.id,data:e,name:e.name||"Not Specified",address:null!==(n=e.addresses[0])&&void 0!==n&&n.address?"\n            ".concat(null===(t=e.addresses[0])||void 0===t?void 0:t.address.addressLine1," -\n            ").concat(null===(r=e.addresses[0])||void 0===r?void 0:r.address.postCode):"Please Add",customer:e.customer[0].account.name,customerId:e.customer[0].account.id,workOrders:null===(i=e.bookings)||void 0===i?void 0:i.length,totalSpent:(0,R.T)(Q(e.bookings,e.invoices)),compliancesList:e.compliances,createdAt:G(e.createdAt),status:e.status,actions:""}})},em=(0,a.useMemo)(function(){var e={};return!el().length&&null!=$&&$.q?{title:"No results",subtitleFirstLine:"The filters you have applied have returned no results",subtitleSecondLine:"Please amend and try again if necessary."}:{title:"No locations",subtitleFirstLine:"You currently have no locations set up in the system",subtitleSecondLine:"Click\xa0create location\xa0to get started building.",buttonText:"Create location",onAction:ec}},[JSON.stringify(el())]),ep=J({},s);return(0,T.jsxs)(T.Fragment,{children:[l&&(0,T.jsx)(F,{initialFilters:o,open:l,filters:N,setFilters:q,onClose:function(){return v(!1)}}),(0,T.jsxs)(j.Z,{width:"100%",spacing:2,sx:{height:"100%"},children:[(0,T.jsxs)(j.Z,{width:"100%",direction:"row",justifyContent:"space-between",children:[(0,T.jsx)(I.Z,{variant:"contained",startIcon:(0,T.jsx)(C.Z,{}),onClick:function(){return v(!0)},children:"Filters"}),(0,T.jsxs)(j.Z,{direction:"row",spacing:2,children:[(0,T.jsx)(I.Z,{variant:"contained",color:"secondary",onClick:ec,children:"Create Location"}),!X&&(0,T.jsx)(I.Z,{startIcon:!k&&(0,T.jsx)("img",{src:"/static/icons/csv.svg"}),disabled:k,variant:"contained",color:"success",onClick:es,children:k?(0,T.jsx)(w.Z,{size:20,color:"secondary"}):"Export"})]})]}),(0,T.jsxs)(O.Z,{sx:{padding:"16px 0px",height:c},children:[(0,T.jsx)(Z.Z,{ml:2,variant:"h5",sx:{fontWeight:600,marginBottom:"15px"},children:"Locations"}),null!==(n=el())&&void 0!==n&&n.length?(0,T.jsx)(P.i,{ref:E,loading:er,columns:[{headerName:"Name",field:"name",minWidth:370,flex:1},{headerName:"Address",field:"address",minWidth:300,flex:1,sortable:!1},{headerName:"Customer",field:"customer",sortable:!1,flex:1,minWidth:Y?100:"auto",renderCell:function(e){var n=e.row,t=n.customer,r=n.customerId;return(0,T.jsx)(g.r,{color:"secondary",href:"/dashboard/customers/view?id=".concat(r),children:t})}},{headerName:"Work Orders",field:"workOrders",sortable:!1,minWidth:Y?100:"auto",renderCell:function(e){var n=e.row.workOrders;return(0,T.jsx)(y.Z,{sx:{marginLeft:"3em"},children:n})},flex:1},{headerName:"Total Spent",field:"totalSpent",sortable:!1,minWidth:Y?140:"auto",renderCell:function(e){var n=e.row.totalSpent;return(0,T.jsx)(y.Z,{sx:{marginLeft:"1.5em"},children:n})},flex:1},{field:"createdAt",headerName:"Created At",minWidth:Y?200:"auto",flex:1,sortable:!0},{field:"actions",headerName:"Actions",sortable:!1,minWidth:Y?80:"auto",renderCell:function(e){var n=e.row;return(0,T.jsx)(x.Z,{sx:{marginLeft:"1em"},onClick:function(){return ed({row:n})},children:(0,T.jsx)(_.Z,{})})},flex:1}],rows:el(),columnVisibilityModel:ep,meta:et,refetch:ei,autoHeight:!1,containerHeight:"calc(100% - 52px)",onRowClick:ed}):!er&&(0,T.jsx)(B.C,J({imageSrc:"/static/icons/no_locations_found.svg"},em))]})]})]})};X.defaultProps={columnVisibilityModel:{},tableContainerHeight:"calc(100% - 52px)"}},95102:function(e,n,t){"use strict";t.d(n,{$A:function(){return v},$E:function(){return h},A1:function(){return f},Un:function(){return p},yf:function(){return b},zg:function(){return g}});var r,i,o,a,s,c,d,u,l=t(71383),m=t(75063);(0,m.Ps)(r||(r=(0,l.Z)(["\n  query GetProperty($id: Int!) {\n    location: Location_by_pk(id: $id) {\n      id\n      contactUserId\n      name\n      access\n      contactUser: User {\n        id\n        nameFirst\n        nameLast\n      }\n      propertyOwner: Account_Locations {\n        account: Account {\n          id\n          name\n          type\n        }\n      }\n    }\n  }\n"])));var p=(0,m.Ps)(i||(i=(0,l.Z)(['\n  query GetMapProperties {\n    properties: Location {\n      id\n      access\n      createdAt\n      name\n      contactUserId\n      addresses: Addresses(where: { entity: { _eq: "Location" } }) {\n        id\n        registered\n        operating\n        trading\n        invoice\n        status\n        createdAt\n        address: Address {\n          id\n          name\n          addressLine1\n          addressLine2\n          addressLine3\n          city\n          county\n          geo\n          postCode\n          country: Country {\n            id\n            name\n          }\n        }\n      }\n      bookings: Jobs {\n        id\n        title\n        createdAt\n        customerId\n        amount\n        locationId\n        managerId\n        quoteNumber\n        reference\n        status\n        serviceId\n        meta\n        customer: Customer {\n          id\n          name\n        }\n        location: Location {\n          id\n          name\n          addresses: Addresses(where: { entity: { _eq: "Location" } }) {\n            id\n            registered\n            operating\n            trading\n            invoice\n            status\n            createdAt\n            address: Address {\n              id\n              name\n              addressLine1\n              addressLine2\n              addressLine3\n              city\n              county\n              geo\n              postCode\n              country: Country {\n                id\n                name\n              }\n            }\n          }\n        }\n        manager: Manager {\n          id\n          nameFirst\n          nameLast\n        }\n        sla: SLA {\n          id\n          name\n          notes\n        }\n        supplier: Supplier {\n          id\n          companyNumber\n          createdAt\n          name\n          status\n          type\n          updatedAt\n          website\n          clientType\n          managerId\n          vatId\n          meta\n          media: Media {\n            id\n            medium: Medium {\n              id\n              category\n              filename\n              meta\n              type\n            }\n          }\n          manager: Manager {\n            id\n            fullName\n          }\n        }\n        supplierOffers: SupplierOffers {\n          status\n          rate\n          supplier: Supplier {\n            id\n            companyNumber\n            createdAt\n            name\n            status\n            type\n            updatedAt\n            website\n            clientType\n            managerId\n            vatId\n            meta\n            media: Media {\n              id\n              medium: Medium {\n                id\n                category\n                filename\n                meta\n                type\n              }\n            }\n            manager: Manager {\n              id\n              fullName\n            }\n          }\n        }\n        timings: JobTimings {\n          id\n          status\n          createdAt\n        }\n      }\n    }\n  }\n']))),f=(0,m.Ps)(o||(o=(0,l.Z)(["\n  mutation AddLocation($objects: [Location_insert_input!]!) {\n    insert_Location(objects: $objects) {\n      returning {\n        id\n        name\n      }\n    }\n  }\n"]))),v=(0,m.Ps)(a||(a=(0,l.Z)(["\n  mutation UpdateAccountLocation(\n    $location: Location_set_input\n    $locationId: Int!\n    $accountId: Int!\n    $newAccountId: Int!\n    $hasChanged: Boolean!\n  ) {\n    update_Account_Location(\n      where: { Account: { id: { _eq: $accountId } }, id: { _eq: $locationId } }\n      _set: { accountId: $newAccountId }\n    ) @include(if: $hasChanged) {\n      returning {\n        id\n      }\n    }\n    update_Location_by_pk(pk_columns: { id: $locationId }, _set: $location) {\n      id\n    }\n  }\n"]))),h=(0,m.Ps)(s||(s=(0,l.Z)(["\n  mutation UpdateAccount($id: Int!, $changes: Account_set_input) {\n    update_Account_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n  }\n"]))),g=(0,m.Ps)(c||(c=(0,l.Z)(["\n  mutation UpdateLocation($id: Int!, $changes: Location_set_input) {\n    update_Location_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n  }\n"])));(0,m.Ps)(d||(d=(0,l.Z)(["\n  query GetAccountName($id: Int!) {\n    account: Account_by_pk(id: $id) {\n      id\n      name\n      type\n    }\n  }\n"])));var b=(0,m.Ps)(u||(u=(0,l.Z)(["\n  query GetPropertiesJob($id: Int!) {\n    property: Location_by_pk(id: $id) {\n      id\n      jobs: Jobs {\n        id\n        timings: JobTimings {\n          id\n          status\n          createdAt\n        }\n      }\n    }\n  }\n"])))},51910:function(e,n,t){"use strict";t.r(n),t.d(n,{default:function(){return nd}});var r,i,o=t(38033),a=t(9270),s=t(62140),c=t(67294),d=t(11163),u=t.n(d),l=t(6812),m=t(77375),p=t(41085),f=t(12964),v=t(59499),h=t(71383),g=t(75063),b=(0,g.Ps)(r||(r=(0,h.Z)(['\n  query GetPropertiesCompliance(\n    $accountId: Int\n    $limit: Int\n    $offset: Int\n    $q: String\n    $orderBy: Location_order_by!\n    $now: date\n    $nextMonth: date\n  ) {\n    properties: Location(\n      limit: $limit\n      offset: $offset\n      order_by: [$orderBy]\n      where: {\n        Account_Locations: {\n          accountId: { _eq: $accountId }\n          Account: { type: { _eq: "customer" } }\n        }\n        _or: [\n          { name: { _ilike: $q } }\n          { Addresses: { Address: { city: { _ilike: $q } }, entity: { _eq: "Location" } } }\n          { Addresses: { Address: { postCode: { _ilike: $q } }, entity: { _eq: "Location" } } }\n        ]\n      }\n    ) {\n      id\n      access\n      contactUserId\n      createdAt\n      name\n\n      jobs: Jobs(where: { Compliances: { id: { _is_null: false }, entity: { _eq: "Job" } } }) {\n        id\n        number\n        amount\n        timingStart\n        scheduledAt\n      }\n      upComing: Compliances_aggregate(\n        where: {\n          entity: { _eq: "Location" }\n          _and: [{ expiryAt: { _gt: $now } }, { expiryAt: { _lt: $nextMonth } }]\n        }\n      ) {\n        aggregate {\n          count\n        }\n      }\n      overdue: Compliances_aggregate(\n        where: { expiryAt: { _lt: $now }, entity: { _eq: "Location" } }\n      ) {\n        aggregate {\n          count\n        }\n      }\n\n      compliances: Compliances(\n        where: { entity: { _eq: "Location" } }\n        order_by: { expiryAt: asc }\n      ) {\n        id\n        expiryAt\n        compliance: Compliance {\n          id\n          name\n        }\n      }\n    }\n    meta: Location_aggregate(\n      where: {\n        Account_Locations: {\n          accountId: { _eq: $accountId }\n          Account: { type: { _eq: "customer" } }\n        }\n        _or: [\n          { name: { _ilike: $q } }\n          { Addresses: { Address: { city: { _ilike: $q } }, entity: { _eq: "Location" } } }\n          { Addresses: { Address: { postCode: { _ilike: $q } }, entity: { _eq: "Location" } } }\n        ]\n      }\n    ) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n']))),y=t(11640),x=t(10367),j=t(11082),I=t(26186),w=t(58965),O=t(67872),Z=t(65524),_=t(51466),C=t(11587),A=t(76727),P=t(88424),S=t(85893),k=function(e){var n=(0,P.O)();return parseInt(e.filter(function(e){return(0,P.O)(e.expiryAt)>=n}).length/e.length*100)},L=function(e){var n=e.row.compliancesList;if(!n||0===n.length)return null;var t=k(n);return(0,S.jsxs)(q,{children:[(0,S.jsx)(N,{content:"".concat(n.length," : ").concat(t.toString(),"%"),context:T(t),size:"sm"}),D(n)]})},D=function(e){var n=e.find(function(e){var n=(0,A.r)(e.expiryAt);return e});return n&&(0,S.jsxs)(M,{children:[(0,S.jsx)(_.Z,{content:(0,I.Z)(n.expiryAt),context:$(n.expiryAt),size:"sm"}),(0,S.jsx)(_.Z,{content:n.compliance.name,size:"sm"})]})},N=(0,x.ZP)(C.Z).withConfig({displayName:"helper__StyledBadge",componentId:"sc-1pr776d-0"})(["margin:0;"]),q=x.ZP.div.withConfig({displayName:"helper__Wrapper",componentId:"sc-1pr776d-1"})(["align-items:center;display:flex;"]),M=x.ZP.div.withConfig({displayName:"helper__Next",componentId:"sc-1pr776d-2"})(["flex-direction:column;margin-left:1rem;"]),T=function(e){return e>79?"success":e>49?"info":"danger"},$=function(e){var n=(0,A.r)(e);return n>14?"success":n>=0?"info":"danger"},E=t(42846),F=t(73303),H=t.n(F),R=t(72936),W=t(55863);function V(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),t.push.apply(t,r)}return t}var U="/dashboard/properties/",B=new Date,z=(0,y.Z)(B,1),Y=(0,y.Z)(B,-12),J=function(e){var n=e.accountId,t=(e.accountName,e.filters);e.showAddButton;var r=(0,R.x)().hasRole,i=(0,W.q)().hasUserModule,o=r("customer_user"),a=i("finances"),s=(0,E.x)({filters:t}),c=s.initialData,d=s.ref,m=(0,l.a)(b,{variables:function(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?V(Object(t),!0).forEach(function(n){(0,v.Z)(e,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):V(Object(t)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})}return e}({accountId:n,now:B,nextMonth:z},c)}),p=m.data,f=(p=void 0===p?{properties:[],meta:{aggregate:{totalCount:0}}}:p).properties,h=p.meta,g=m.loading,y=m.refetch,x=function(e){return H()(null==e?void 0:e.filter(function(e){return new Date(e.timingStart)>Y&&new Date(e.timingStart)<B}),function(e){return Number(e.amount)})},_=function(e){return null==e?void 0:e.find(function(e){return new Date(null==e?void 0:e.timingStart)>B})},C=function(e){u().push("".concat(U,"view?id=").concat(e.data.id,"&tab=compliance"))},A=function(e){var n=e.e,t=e.id,r=e.item;n.stopPropagation(),u().push("".concat(U,"view?id=").concat(t,"&tab=compliance&").concat(r,"=1"))},P=function(e,n){return(0,S.jsx)(G,{onClick:function(t){return A({e:t,id:e.data.id,item:n})},children:e[n]})};return(0,S.jsxs)(w.Z,{fitParentHeight:!0,open:!0,title:"Locations Compliance",children:[(0,S.jsx)(Z.p,{customerId:n,hideFinance:!a&o}),(0,S.jsx)(O.t,{columns:[{hidden:!0},{hidden:!0},{text:"Name"},{text:"Overdue",formatter:function(e){return P(e.row,"overdue")}},{text:"Upcoming",formatter:function(e){return P(e.row,"upcoming")}},{text:"Unconfirmed"},{text:"Next Visit"},{text:"Work orders"},{hidden:o&&!a,text:"Total Spent",formatter:function(e){var n=e.row;return(0,j.Z)(x(n.data.jobs))}},{formatter:L,text:"Compliance"},{text:"Created"}],loading:g,meta:h,ref:d,refetch:y,rowClick:C,rows:f.map(function(e){var n,t,r,i,o,a;return{data:e,locationId:e.id,location:e.name||"Not Specified",overdue:null===(n=e.overdue)||void 0===n?void 0:n.aggregate.count,upcoming:null===(t=e.upComing)||void 0===t?void 0:t.aggregate.count,unconfirmed:e.jobs.filter(function(e){return!e.scheduledAt}).length,nextVisit:null!==(r=_(null===(i=e.data)||void 0===i?void 0:i.jobs))&&void 0!==r&&r.timingStart?(0,I.Z)(null===(o=_(e.data.jobs))||void 0===o?void 0:o.timingStart):"-",jobs:null===(a=e.jobs)||void 0===a?void 0:a.length,totalSpent:(0,j.Z)(x),compliancesList:e.compliances,createdAt:(0,I.Z)(e.createdAt)}})})]})},G=x.ZP.a.withConfig({displayName:"table__StyledLink",componentId:"sc-gee8ln-0"})(["display:block;cursor:pointer;color:",";&:hover{background:rgb(221,221,221);}"],function(e){return e.theme.COLOUR.secondary});J.defaultProps={hiddenColumns:[],isCompliance:!1,showAddButton:!1,showMediaButton:!1,showOverallRating:!1};var Q=t(16540),X=t(16387),K=t(53344),ee=(0,g.Ps)(i||(i=(0,h.Z)(["\n  query GetComplianceRating($accountId: Int!) {\n    properties: Account_Location_aggregate(where: { accountId: { _eq: $accountId } }) {\n      nodes {\n        location: Location {\n          compliances: Compliances_aggregate {\n            aggregate {\n              count\n            }\n          }\n          compliance: Compliances {\n            id\n            expiryAt\n          }\n        }\n      }\n    }\n  }\n"]))),en=t(6788);function et(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),t.push.apply(t,r)}return t}var er=function(e){var n=e.customerId,t=(0,l.a)(ee,{variables:{accountId:n}}).data,r=(t=void 0===t?{properties:[]}:t).properties,i=function(){u().push("/dashboard/customers/view?id=".concat(n,"&tab=compliance"))};return(0,S.jsx)(w.Z,{open:!0,title:"Compliance Score",children:(0,S.jsx)(ei,{onClick:i,children:(0,S.jsx)(_.Z,function(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?et(Object(t),!0).forEach(function(n){(0,v.Z)(e,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):et(Object(t)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})}return e}({},(0,en.Bo)(r)))})})},ei=x.ZP.a.withConfig({displayName:"rating__Link",componentId:"sc-1w2kx3z-0"})(["cursor:pointer;text-decoration:none;"]),eo=t(41890),ea=t(30381),es=t.n(ea),ec=t(19056),ed=t(9205),eu=function(e){var n,t,r,i,o,a,s,c,d,l,m,p,f=e.customer,v=e.offCanvas,h=e.refetch,g=(0,ed.WE)(f,"registered"),b=(0,ed.WE)(f,"trading"),y=(0,ed.WE)(f,"invoice"),x=function(e){e&&h()};return[{id:1,label:"Create account",date:f.createdAt},{id:2,label:"Complete profile",info:"",date:(null==g?void 0:g.createdAt)||null,actions:[{id:1,active:!0,content:"Registered address",context:"secondary",handleClick:function(){var e;v.show({content:(0,S.jsx)(ec.H,{addressId:(null==g?void 0:null===(e=g.address)||void 0===e?void 0:e.id)||null,entity:"Account",entityId:f.id,id:(null==g?void 0:g.id)||null,onSubmit:x,type:"registered"}),submit:!1,title:"Manage addresses"})},type:"button"},{id:2,active:!0,content:"Trading address",context:"secondary",handleClick:function(){var e;v.show({content:(0,S.jsx)(ec.H,{addressId:(null==b?void 0:null===(e=b.address)||void 0===e?void 0:e.id)||null,entity:"Account",entityId:f.id,id:(null==b?void 0:b.id)||null,onSubmit:x,type:"trading"}),submit:!1,title:"Manage addresses"})},type:"button"},{id:3,active:!0,content:"Invoice address",context:"secondary",handleClick:function(){var e;v.show({content:(0,S.jsx)(ec.H,{addressId:(null==y?void 0:null===(e=y.address)||void 0===e?void 0:e.id)||null,entity:"Account",entityId:f.id,id:(null==y?void 0:y.id)||null,onSubmit:x,type:"invoice"}),submit:!1,title:"Manage addresses",width:"50%"})},type:"button"}]},{id:3,label:"Add location",info:"",date:null!==(n=f.propertiesMeta)&&void 0!==n&&null!==(t=n.aggregate)&&void 0!==t&&t.count?f.createdAt:null,content:[{id:1,active:(null===(r=f.propertiesMeta)||void 0===r?void 0:null===(i=r.aggregate)||void 0===i?void 0:i.count)>0,data:"".concat(null===(o=f.propertiesMeta)||void 0===o?void 0:null===(a=o.aggregate)||void 0===a?void 0:a.count," properties added")}],actions:[{id:1,active:!0,content:"Submit location",context:"secondary",handleClick:function(){u().push("".concat("/dashboard/customers/","view?id=").concat(f.id,"&tab=locations"))},type:"button"}]},{id:6,label:"Start issuing work orders",info:"submit work orders",date:null!==(s=f.jobsMeta)&&void 0!==s&&null!==(c=s.aggregate)&&void 0!==c&&c.count?f.createdAt:null,content:[{id:1,active:(null===(d=f.jobsMeta)||void 0===d?void 0:null===(l=d.aggregate)||void 0===l?void 0:l.count)>0,data:"".concat(null===(m=f.jobsMeta)||void 0===m?void 0:null===(p=m.aggregate)||void 0===p?void 0:p.count," jobs created")}]}]},el=function(e,n,t){var r=eu({customer:e,offCanvas:n,refetch:t});return r.forEach(function(e){e.date&&(e.date=es()(e.date).format("D MMM YYYY HH:mm"))}),r},em=t(58095),ep=function(e){var n,t=e.customer,r=e.refetch,i=(0,em.a)();return(0,S.jsx)(w.Z,{open:!0,title:"Profile",children:(0,S.jsx)(eo.Z,{items:el(t,i,r),summary:(n=t,[{label:"Account manager: ",value:n.manager?"".concat(n.manager.nameFirst," ").concat(n.manager.nameLast," "):"Unassigned"},{label:"Users: ",value:n.usersMeta?n.usersMeta.aggregate.count:0},{label:"Status: ",value:n.status||""}])},"stepper-".concat(t.id))})},ef=t(99229),ev=t(55206),eh=t(46165),eg=t(62929),eb=function(e){var n,t=e.customer,r=e.hasRole,i=e.refetch,o=(0,ed.WE)(t,"registered"),c=(0,ed.WE)(t,"trading"),d=[{key:"Company Number",value:t.companyNumber},{key:"VAT",value:t.vatId}];return t.clientType&&d.push({key:"Customer Type",value:t.clientType.name}),null!==(n=t.meta)&&void 0!==n&&n.xeroContactId&&d.push({key:"Xero Contact ID",value:t.meta.xeroContactId}),(0,S.jsx)(S.Fragment,{children:(0,S.jsxs)(a.Z,{children:[(0,S.jsxs)(s.Z,{md:4,children:[(0,S.jsx)(eh.g,{avatar:(0,K.Q)(t.media),editable:r("admin"),entity:t,entityName:"Account",icons:r("admin")?(0,eg.Y)(t):[]}),t.contactUsers&&(0,S.jsx)(w.Z,{title:"Contact",children:t.contactUsers.map(function(e){var n;return(0,S.jsxs)("div",{children:[(0,S.jsx)(Q.Z,{rows:[{key:"Name",value:"".concat(e.user.nameFirst," ").concat(e.user.nameLast)},{key:"Phone",value:e.user.phone},{key:"Email",value:e.user.email}]}),(0,S.jsx)("br",{})]},e.userId)})}),(0,S.jsx)(w.Z,{title:"Company",children:(0,S.jsx)(Q.Z,{rows:d})}),o&&(0,S.jsx)(X.f,{address:o.address,entity:"Account",entityId:t.id,id:o.id,refetch:i,title:"Registered Address",type:"registered"}),c&&(0,S.jsx)(X.f,{address:c.address,entity:"Account",entityId:t.id,id:c.id,refetch:i,title:"Trading Address",type:"trading"}),r("admin")&&(0,S.jsx)(ev.E,{entity:"Account",entityId:t.id,open:!0,title:"Notes"})]}),(0,S.jsx)(s.Z,{md:4,children:(0,S.jsx)(ep,{refetch:i,customer:t})}),(0,S.jsxs)(s.Z,{md:4,children:[(0,S.jsx)(ef.G,{details:!0,entity:"Account",entityId:t.id}),(0,S.jsx)(er,{customerId:t.id})]})]})})},ey=t(92568),ex=t(16835),ej=t(73359),eI=t(57460),ew=t.n(eI),eO=t(77439),eZ=t(40826),e_=t(62466),eC=t(68956),eA=t(48829),eP=t(71847),eS=t(23466),ek=t(69532),eL=t(825),eD=t(94568);function eN(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),t.push.apply(t,r)}return t}function eq(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?eN(Object(t),!0).forEach(function(n){(0,v.Z)(e,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):eN(Object(t)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})}return e}var eM=function(e){var n,t,r,i=e.filters,o=e.workorderVisibility,a=(0,R.x)(),s=a.hasRole,c=a.user,d=(0,W.q)(),p=d.admin,f=d.hasUserModule,v=null===(n=p.jobSetting)||void 0===n?void 0:n.jobNumberPrefix,h=null===(t=p.jobSetting)||void 0===t?void 0:t.jobNumberSuffix,g=s("customer_user"),b=f("finances"),y=(0,E.x)({filters:i}),x=y.initialData,Z=y.ref,C=(0,l.a)(m.G5,{variables:eq(eq({},x),{},{number:x.id?String(x.id):null,startDate:x.startDate,endDate:x.endDate,adminId:c.adminId})}),A=C.data,P=(A=void 0===A?{jobs:[],meta:{aggregate:{totalCount:0}}}:A).jobs,k=A.meta,L=C.loading,D=C.refetch,N=function(){var e=(0,R.x)().user,n=x.customerId,t=x.endDate,r=x.locationId,i=x.orderBy,a=x.startDate,s=x.status,c=x.supplierId,d=(0,ej.t)(m.G5,{variables:{adminId:e.adminId,customerId:n,endDate:t,locationId:r,orderBy:i,startDate:a,status:s,supplierId:c},onCompleted:function(n){var t,r,i=(0,eS.c)(n.jobs,e.accountType,{numberPrefix:v,numberSuffix:h}),o=(null===(t=n.jobs[0])||void 0===t?void 0:null===(r=t.customer)||void 0===r?void 0:r.name)||"Customer",a=ew().unparse(i),s="data:application/octet-stream,"+encodeURIComponent(a);(0,eA.S)(s,"".concat(o,"-BookingData.csv"))}}),u=(0,ex.Z)(d,1)[0];return(0,S.jsxs)(S.Fragment,{children:[!(0,eD.s)()&&(0,S.jsx)(eO.Z,{context:"light",onClick:function(e){e.stopPropagation(),u()},title:"Export to CSV",size:"md",children:(0,S.jsx)(eZ.Z,{context:"secondary",icon:"file-csv",size:"lg"})}),o&&(0,S.jsx)(eO.Z,{content:"Create Work Order",context:"secondary",size:"sm",onClick:T})]})},q=function(e){u().push("".concat("/dashboard/issues/","manage?id=").concat(e.number))},M=[{hidden:!0},{hidden:!0},{hidden:!0},{text:"ID",formatter:function(e){var n=e.row;return(0,S.jsx)(eL.D,{id:n.id,invoiceNumber:n.invoiceNumber,number:n.number,numberPrefix:v,numberSuffix:h,openCanvas:!0,type:n.type})}},{text:"Reference"},{text:"Description"},{sortable:!0,sortName:'{"Job": { "Service": {"name": "ORDER"} }}',text:"Service"},{sortable:!0,sortName:'{"Job": { "SLA": {"name": "ORDER"} }}',text:"Priority"},{formatter:(0,e_.Z)("/dashboard/properties/view","propertyId","location"),sortable:!0,sortName:'{"Job":{"Location": {"name": "ORDER"}}}',text:"Location"},{hidden:g&&!b,text:"Total \xa3",formatter:function(e){var n,t,r=e.row;return n=r.customerVatTotal,t=r.customerExpensesTotal,(0,S.jsxs)(S.Fragment,{children:[(0,S.jsxs)(_.Z,{size:"xs",children:["Job total ",(0,j.Z)(n)]}),(0,S.jsxs)(_.Z,{size:"xs",children:["Expense customer ",(0,j.Z)(t)]})]})}},{hidden:!0},{hidden:!s("admin"),text:"Supplier \xa3",formatter:function(e){var n,t,r=e.row;return n=r.supplierVatTotal,t=r.supplierExpensesTotal,(0,S.jsxs)(S.Fragment,{children:[(0,S.jsxs)(_.Z,{size:"xs",children:["Amount ",(0,j.Z)(n)]}),(0,S.jsxs)(_.Z,{size:"xs",children:["Expense amount ",(0,j.Z)(t)]})]})}},{hidden:!0},{hidden:!s("admin"),text:"Revenue",formatter:function(e){var n=e.row;return(0,j.Z)(n.revenue)}},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{text:"Scheduled"},{sortable:!0,sortName:"createdAt",text:"Created"},{sortable:!0,sortName:"status",formatter:function(e){var n=e.row;return(0,ek.B)({value:n.status})},text:"Status"},{hidden:!s("admin"),formatter:eC.Z,formatterData:[{context:"secondary",icon:["fas","edit"],onClick:function(e,n){return q(n)},tooltip:"Edit"},{context:"secondary",icon:["fas","receipt"],onClick:function(e,n){return u().push("/dashboard/issues/view?id=".concat(n.number))},tooltip:"info"}],text:"Actions"}],T=function(e){e.stopPropagation();var n=(0,eP.Uu)(i);u().push("/dashboard/issues/manage".concat(n))};return(0,S.jsx)(w.Z,{fitParentHeight:!0,open:!0,title:"Work Orders",toolbar:(0,S.jsx)(N,{}),children:(0,S.jsx)(O.t,{columns:M,loading:L,meta:k,ref:Z,refetch:D,rows:null==P?void 0:P.map(function(e){var n,t,r,i,o,a,s,c,d,u=e.scheduledAt?(0,I.Z)(e.scheduledAt,!0):e.timingStart?(0,I.Z)(e.timingStart,!0):"-",l=e.customerRebateAmount>0?e.customerVatTotal-e.customerRebateAmount-e.supplierTotal:e.customerTotal-e.supplierTotal;return{id:e.id,type:e.type,number:e.number,invoiceNumber:null===(n=e.invoices)||void 0===n?void 0:null===(t=n[0])||void 0===t?void 0:t.invoiceNumber,ref:e.reference||"-",description:e.description||"-",service:(null===(r=e.service)||void 0===r?void 0:r.name)||"-",priority:(null===(i=e.sla)||void 0===i?void 0:i.name)||"-",location:(null===(o=e.location)||void 0===o?void 0:o.name)||"-",customerVatTotal:e.customerVatTotal||0,customerExpensesTotal:e.customerExpensesTotal||0,supplierVatTotal:e.supplierVatTotal||0,supplierExpensesTotal:e.supplierExpensesTotal||0,revenue:l||0,propertyId:null===(a=e.location)||void 0===a?void 0:a.id,managerId:null===(s=e.manager)||void 0===s?void 0:s.id,customerId:null===(c=e.customer)||void 0===c?void 0:c.id,supplierId:(null===(d=e.supplier)||void 0===d?void 0:d.id)||"",scheduleDate:u,date:(0,I.Z)(e.createdAt),status:e.status,actions:""}})})})};eM.defaultProps={filters:{assetId:null,managerId:null}};var eT=t(27812),e$=t(52019),eE=t(49501),eF=t(84043),eH=t(83894),eR=t(71534),eW=t(52220),eV=t(71772),eU=t(19015);function eB(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),t.push.apply(t,r)}return t}function ez(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?eB(Object(t),!0).forEach(function(n){(0,v.Z)(e,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):eB(Object(t)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})}return e}var eY=function(e){var n=e.initialValues,t=e.control,r=e.errors,i=e.register,o=e.setFilters,d=e.watch,u=e.setValue,l=e.show,m=e.reset,p=(0,c.useContext)(e$.Z).hasRole,f={control:t,errors:r,register:i},v=d("customerId"),h=d("locationId"),g=d("supplierId"),b=d("userId"),y=function(e){var n=e.map(function(e){return e.value});o(function(e){return ez(ez({},e),{},{status:n.length>0?n:null})}),o(function(e){return ez(ez({},e),{},{isChangedStatusSelect:!0})}),u("status",e),e.length||o(function(e){return ez(ez({},e),{},{isChangedStatusSelect:!1})})};return(0,c.useEffect)(function(){n.customerId||o(function(e){return ez(ez({},e),{},{customerId:"number"==typeof v?v:(null==v?void 0:v.value)||null})})},[v]),(0,c.useEffect)(function(){o(function(e){return ez(ez({},e),{},{locationId:"number"==typeof h?h:(null==h?void 0:h.value)||null})})},[h]),(0,c.useEffect)(function(){o(function(e){return ez(ez({},e),{},{supplierId:"number"==typeof g?g:(null==g?void 0:g.value)||null})})},[g]),(0,c.useEffect)(function(){o(function(e){return ez(ez({},e),{},{userId:"number"==typeof b?b:(null==b?void 0:b.value)||null})})},[b]),(0,c.useEffect)(function(){return function(){o(n),m(n)}},[l]),(0,S.jsxs)(a.Z,{children:[(0,S.jsx)(s.Z,{md:6,children:(0,S.jsx)(eE.Z,{label:null,children:(0,S.jsx)(eF.Z,ez(ez({},f),{},{placeholder:"Select status",name:"status",isMulti:!0,onChange:y,options:(0,eP.lR)(l)}))})}),p(["supplier"].concat((0,eT.Z)(eU.n)))&&(0,S.jsx)(s.Z,{md:6,children:(0,S.jsx)(eV.P,ez(ez({},f),{},{errors:ez({},r),label:"",userId:n.userId,name:"userId",placeholder:"Select user",type:"user"}))}),!n.customerId&&p("admin")&&(0,S.jsx)(s.Z,{md:6,children:(0,S.jsx)(eV.P,ez(ez({},f),{},{errors:ez({},r),label:"",name:"customerId",placeholder:"Select customer",type:"customer"}))}),p("admin")&&(0,S.jsx)(s.Z,{md:6,children:(0,S.jsx)(eV.P,ez(ez({},f),{},{errors:ez({},r),label:"",accountId:n.customerId,name:"locationId",placeholder:"Select location",type:"property"}))}),p("admin")&&(0,S.jsx)(s.Z,{md:6,children:(0,S.jsx)(eV.P,ez(ez({},f),{},{errors:ez({},r),label:"",name:"supplierId",placeholder:"Select supplier",type:"supplier"}))}),(0,S.jsx)(s.Z,{md:12,children:(0,S.jsxs)(a.Z,{children:[(0,S.jsx)(s.Z,{md:6,children:(0,S.jsx)(eW.M,ez(ez({},f),{},{name:"startDate",onChange:function(e){o(function(n){return ez(ez({},n),{},{startDate:e||null})}),u("startDate",e)},placeholder:"Start date"}))}),(0,S.jsx)(s.Z,{md:6,children:(0,S.jsx)(eW.M,ez(ez({},f),{},{name:"endDate",onChange:function(e){var n=e?(0,eH.Z)(e):e;o(function(e){return ez(ez({},e),{},{endDate:n})}),u("endDate",n)},placeholder:"End date"}))})]})}),!n.noAssignToMeFilter&&p([].concat((0,eT.Z)(eU.SA),(0,eT.Z)(eU.n),(0,eT.Z)(eU.nx)))&&(0,S.jsx)(s.Z,{md:12,children:(0,S.jsx)(eR.N,ez(ez({},f),{},{name:"managerId",onChange:function(e){return o(function(n){return ez(ez({},n),{},{managerId:e.target.checked})})}}))})]})},eJ=t(78295),eG=t(86385),eQ=t(37559),eX=t(44594),eK=t(45155),e0=t(92927),e1=t(26447),e2=t(15861),e8=t(87918),e3=t(90629),e4=t(11057),e6=t(32836),e5=t(29026),e9=t(32715),e7=t(26143),ne=t(44253),nn=t(578),nt=t(15843);function nr(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),t.push.apply(t,r)}return t}function ni(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?nr(Object(t),!0).forEach(function(n){(0,v.Z)(e,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):nr(Object(t)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})}return e}var no=function(e){var n=e.editable,t=e.initialFilters,r=e.parentEntity,i=e.entity,o=e.entityId,a=e.tableHeight,s=e.paperHeight,d=(0,e9.d)(),u=(0,ex.Z)(d,2),m=u[0],p=u[1],f=(0,c.useState)({}),v=f[0],h=f[1],g=(0,c.useState)(!1),b=g[0],y=g[1],x=(0,E.x)({filters:v}),j=x.ref,I=x.initialData,w=(0,l.a)(e5.MD,{variables:ni(ni({},I),{},{entity:r,childEntityId:o,childEntity:i,includeLocations:"Customer"===i})}),O=w.data,Z=(O=void 0===O?{schedules:[],meta:{aggregate:{totalCount:0}}}:O).schedules,_=O.meta,C=w.loading,A=w.refetch,P=(0,c.useCallback)(function(e){n&&p({content:function(n){var t=n.onClose;return(0,S.jsx)(ne.t,{isEdit:e.isChild,scheduleId:e.id,entity:i,entityId:o,close:t})}})},[i,o,n,p]),k=(0,c.useCallback)(function(e){return[{icon:"edit",onClick:function(n){n.stopPropagation(),P(e)},tooltip:"Edit Schedule"}]},[P]),L=(0,c.useMemo)(function(){return[{sortable:!1,flex:1,minWidth:180,field:"serviceLine",headerName:"Service line"},{sortable:!1,flex:1,minWidth:180,field:"schedule",headerName:"Schedule"},{sortable:!1,flex:1,minWidth:180,field:"rate",headerName:"\xa3/H",renderCell:function(e){var n=e.row;return(0,S.jsxs)(e1.Z,{children:[(0,S.jsxs)(e2.Z,{children:["First hour: \xa3 ",n.rate.firstHour]}),(0,S.jsxs)(e2.Z,{children:["Subsequent hours: \xa3 ",n.rate.subsequentHours]})]})}},{sortable:!1,flex:1,minWidth:180,field:"rateOOH",headerName:"\xa3/H OOH",renderCell:function(e){var n=e.row;return(0,S.jsxs)(e1.Z,{children:[(0,S.jsxs)(e2.Z,{children:["First hour: \xa3 ",n.rateOOH.firstHour]}),(0,S.jsxs)(e2.Z,{children:["Subsequent hours: \xa3 ",n.rateOOH.subsequentHours]})]})}},{sortable:!1,flex:1,minWidth:180,field:"ratePremium",headerName:"\xa3/H Premium",renderCell:function(e){var n=e.row;return(0,S.jsxs)(e1.Z,{children:[(0,S.jsxs)(e2.Z,{children:["First hour: \xa3 ",n.ratePremium.firstHour]}),(0,S.jsxs)(e2.Z,{children:["Subsequent hours: \xa3 ",n.ratePremium.subsequentHours]})]})}},{sortable:!1,flex:1,minWidth:150,field:"locations",headerName:"Locations"},{sortable:!1,flex:1,minWidth:150,field:"coverageArea",headerName:"Coverage area"},{sortable:!1,flex:1,field:"minimumDuration",headerName:"Min duration"},{sortable:!1,flex:1,field:"minimumIncrement",headerName:"Min increment"},{sortable:!1,flex:1,minWidth:100,field:"status",headerName:"Status",renderCell:function(e){var n=e.row;return(0,S.jsx)(e8.Z,{label:"active"===n.status?"Active":"Inactive",color:"active"===n.status?"success":"danger",size:"small"})}},{sortable:!1,width:100,field:"actions",headerName:"Actions",renderCell:function(e){var n=e.row;return(0,S.jsx)(e7.C,{row:n,actionsData:k})}}]},[k]),D=(0,c.useMemo)(function(){return Z.map(function(e){var n,t,r=null===(n=e.childSchedules)||void 0===n?void 0:n[0];return r?{id:r.id,serviceLine:e.service.name,schedule:r.name,rate:r.normal,rateOOH:r.ooh,ratePremium:r.premium,locations:(null===(t=r.locations)||void 0===t?void 0:t.map(function(e){return e.location.name}).join(", "))||"-",coverageArea:e.postcodeAreas.map(function(e){return e.postcode.area}).join(", "),minimumDuration:r.minimumDuration,minimumIncrement:r.minimumIncrement,status:r.status,serviceId:r.serviceId,isChild:!0}:{id:e.id,serviceLine:e.service.name,schedule:e.name,rate:e.normal,rateOOH:e.ooh,ratePremium:e.premium,locations:"-",coverageArea:e.postcodeAreas.map(function(e){return e.postcode.area}).join(", "),minimumDuration:e.minimumDuration,minimumIncrement:e.minimumIncrement,status:e.status,serviceId:e.serviceId}})},[Z]);return(0,S.jsxs)(S.Fragment,{children:[m,(0,S.jsx)(nn.X,{open:b,close:function(){return y(!1)},initialFilters:t,setFilters:h}),(0,S.jsx)(e1.Z,{width:"100%",spacing:2,children:(0,S.jsxs)(e3.Z,{sx:{paddingTop:"16px",paddingBottom:"16px",height:s},children:[(0,S.jsxs)(e1.Z,{direction:"row",justifyContent:"space-between",pl:2,pr:2,children:[(0,S.jsx)(e2.Z,{variant:"h5",sx:{fontWeight:600},children:"Services"}),(0,S.jsx)(e4.Z,{startIcon:(0,S.jsx)(nt.Z,{}),variant:"contained",onClick:function(){return y(!0)},children:"Filters"})]}),(0,S.jsx)(e6.i,{autoHeight:!1,loading:C,ref:j,columns:L,rows:D,meta:_,refetch:A,containerHeight:a,columnVisibilityModel:{locations:"Customer"===i,actions:n},onRowClick:function(e){return P(e.row)}})]})})]})};no.defaultProps={editable:!1,tableHeight:"calc(100% - 42px)",paperHeight:"calc(100% - 32px)"};var na=function(){var e,n=(0,R.x)(),t=n.hasRole,r=n.user,i=(0,W.q)(),o=i.hasUserModule,a=i.admin,s=(0,d.useRouter)().query,u=(0,c.useMemo)(function(){return s.tab||"details"},[s.tab]),v=(null==a?void 0:null===(e=a.modules)||void 0===e?void 0:e.sageIntegration)||!1,h="customer"===r.accountType?r.accountId:s.id,g=t("admin"),b=t("customer_user"),y=o("finances"),x=o("quotes"),j=(0,l.a)(m.UB,{fetchPolicy:"no-cache",variables:{id:h}}),I=j.loading,w=j.data,O=(w=void 0===w?{customer:{}}:w).customer,Z=j.error,_=j.refetch;if(Z)return"Error! ".concat(Z);var C={accountId:O.id,q:null,filterType:"customer_locations_tab"},A=[(0,S.jsx)("div",{active:"details"===u||!u,label:"Details",children:(0,S.jsx)(eb,{customer:O,hasRole:t,refetch:_})}),(0,S.jsx)("div",{hide:b&&!y,active:"finance"===u,label:"Finance",children:(0,S.jsx)(ey.b,{type:"customer",accountId:O.id,accountName:O.name,accountRefetch:_,meta:O.meta,hasSageIntegration:v})}),(0,S.jsx)("div",{active:"users"===u,label:"Users",children:(0,S.jsx)(eK.q,{accountType:"customer",filters:{accountId:O.id}})}),(0,S.jsx)("div",{active:"locations"===u,label:"Locations",children:(0,S.jsx)(eG.V,{accountId:O.id,accountName:O.name,columnVisibilityModel:{customer:!1,totalSpent:!b||y},initialFilters:C,tableContainerHeight:"calc(80vh - 22px)"})}),(0,S.jsxs)("div",{active:"compliance"===u,label:"Compliance",children:[(0,S.jsx)(J,{accountId:O.id,filters:{accountId:O.id},hiddenColumns:["Address","Customer"],initialFilters:{accountId:O.id,filterType:"customer_compliance_tab"},showMediaButton:!0,showOverallRating:!0,sortOrder:{item:"expiryAt",order:"desc"}}),(0,S.jsx)(f.J,{FiltersComp:eY,initialFilters:{customerId:O.id,startDate:null,endDate:null,status:null,locationId:null,supplierId:null,noAssignToMeFilter:!0,id:null,filterType:"customer_bookings_quotes_tab"},TableComp:eM,workorderVisibility:!0})]}),(0,S.jsx)("div",{active:"work-orders"===u,label:"Work Orders",children:(0,S.jsx)(eJ.A,{filtersVisibilityModel:{customer:!1,user:t("customer"),location:t(["admin","customer"]),accountManager:!1,manager:!1,customerManager:!1},entityRelationToFetch:{customerId:O.id},initialFilters:{startDate:null,endDate:null,status:null,customerId:O.id,locationId:null,supplierId:null,noAssignToMeFilter:!0,id:null,filterType:"locations_work_orders_tab"},columnVisibilityModel:{customerNet:Boolean(!b||y),amountOutstanding:Boolean(!b||y)}})}),(0,S.jsx)("div",{active:"slas"===u,label:"SLAs",children:(0,S.jsxs)(p.Z,{handleChange:!1,children:[(0,S.jsx)("div",{active:!0,label:"Work Order SLAs",children:(0,S.jsx)(e0.H,{title:"Work Order SLAs",subtype:"reactive",isEntity:!0,entity:"Account",entityId:O.id})}),(0,S.jsx)("div",{label:"Quote SLAs",children:(0,S.jsx)(e0.H,{title:"Quote SLAs",subtype:"quote",isEntity:!0,entity:"Account",entityId:O.id})})]})}),(0,S.jsx)("div",{hide:b&&!y,active:"services"===u,label:"Services",children:(0,S.jsx)(no,{editable:g,initialFilters:{filterType:"customer"},parentEntity:"System-Customer",entity:"Customer",entityId:O.id,paperHeight:"calc(100vh - 90px)"})}),(0,S.jsx)("div",{hide:b&&!x,active:"quotes"===u,label:"Quotes",children:(0,S.jsx)(f.J,{FiltersComp:eQ.r,initialFilters:{customerId:O.id,supplierId:null,status:null,id:null,filterType:"customer_quote_tab"},TableComp:eX.v})})];return!I&&(0,S.jsx)(p.Z,{children:A.filter(function(e){return!e.props.hide})},u)},ns=function(){return(0,S.jsx)(a.Z,{children:(0,S.jsx)(s.Z,{md:12,children:(0,S.jsx)(na,{})})})},nc=function(){return(0,S.jsx)(ns,{})};nc.getLayout=function(e){return(0,S.jsx)(o.Z,{children:e})};var nd=nc},55328:function(e,n,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/dashboard/customers/view",function(){return t(51910)}])}},function(e){e.O(0,[3662,367,2283,212,8890,619,1100,1336,4135,5020,6043,1564,4244,5370,3911,3776,6540,2329,778,4046,1023,4253,3148,2797,9241,653,8062,1207,7328,4061,597,2904,9528,7147,7725,8033,9229,26,4195,9201,339,7277,6247,2927,7576,7718,3180,9774,2888,179],function(){return e(e.s=55328)}),_N_E=e.O()}]);