(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9312],{84083:function(e,t,n){"use strict";n.d(t,{z:function(){return ea}});var r,i,o,a,s,c=n(59499),u=n(50029),l=n(16835),d=n(64687),p=n.n(d),m=n(67294),f=n(66252),v=n(6812),h=n(50319),b=n(71383),x=n(75063),j=(0,x.Ps)(r||(r=(0,b.Z)(["\n  mutation InsertExpense($objects: [Expense_insert_input!]!) {\n    insert_Expense(objects: $objects) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),g=(0,x.Ps)(i||(i=(0,b.Z)(["\n  mutation UpdateExpense($id: Int!, $changes: Expense_set_input) {\n    update_Expense_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n  }\n"]))),y=(0,x.Ps)(o||(o=(0,b.Z)(["\n  mutation UpdateExpense($parentId: Int!, $changes: Expense_set_input) {\n    parentExspense: update_Expense(where: { id: { _eq: $parentId } }, _set: $changes) {\n      returning {\n        id\n      }\n    }\n    childExpenses: update_Expense(where: { parentId: { _eq: $parentId } }, _set: $changes) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),Z=(0,x.Ps)(a||(a=(0,b.Z)(['\n  query GetExpenses($entity: String, $entityId: Int, $jobId: Int) {\n    expenses: Expense(\n      where: { jobId: { _eq: $jobId }, entity: { _eq: $entity }, entityId: { _eq: $entityId } }\n    ) {\n      id\n      categoryId\n      description\n      amount\n      unit\n      markup\n      vat\n      paid\n      jobId\n      total\n      entity\n      entityId\n      occurredAt\n      recurring\n      category: Category {\n        name\n      }\n      media: Media(where: { entity: { _eq: "Expense" } }) {\n        id\n      }\n    }\n  }\n']))),w=(0,x.Ps)(s||(s=(0,b.Z)(["\n  mutation DeleteExpense($id: Int!) {\n    delete_Expense_by_pk(id: $id) {\n      id\n    }\n  }\n"]))),O=n(52019),I=n(11082),S=n(68956),P=n(16551),C=n(77439),D=n(33006),R=n(9270),k=n(62140),E=n(86036),A=n(16540),q=n(58965),T=n(34197),_=n(99229),$=n(42283),H=n(79665),N=n(76600),M=n(90951),F=n(28497),J=n(49501),L=n(55563),U=n(32979),V=n(6710),Q=n(71772),z=n(74231),Y=(0,z.Ry)().shape({amount:(0,z.Rx)().required(),unit:(0,z.Rx)().required(),categoryId:(0,z.Ry)().required(),description:(0,z.Z_)().required(),markup:(0,z.Rx)().transform(function(e){return isNaN(e)?null:e}).nullable(),paid:(0,z.Z_)().oneOf(["admin","supplier"]).required(),vatMarkup:(0,z.Rx)().transform(function(e){return isNaN(e)?null:e}).nullable()}),B=n(85893);function G(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function W(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?G(Object(n),!0).forEach(function(t){(0,c.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):G(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var K=function(e){e.categories,e.currency;var t=e.defaultValues,n=e.submit,r=e.serviceRateExpenses,i=e.showRecurring;null!=t&&t.vat&&(null==t?void 0:t.vat)!=="20"&&(t.vatMarkup=t.vat,t.vat="custom");var o=(0,$.cI)({defaultValues:W({vat:"20"},t),resolver:(0,H.S)(Y)}),a=o.control,s=o.errors,c=o.handleSubmit,u=o.register,l=(0,o.watch)("vat"),d={control:a,errors:s,register:u};return(0,B.jsxs)(N.Z,{id:"offCanvasForm",handleSubmit:c(n),children:[(0,B.jsx)(M.Z,W(W({},d),{},{name:"paid",data:[{id:"admin",label:"Admin",value:"admin"},{id:"supplier",label:"Supplier",value:"supplier"}],legend:"Paid by"})),(0,B.jsx)(F.Z,W(W({},d),{},{name:"amount",label:"Unit Cost",vat:"Ex VAT"})),(0,B.jsx)(J.Z,{label:"Units",children:(0,B.jsx)(L.Z,W(W({},d),{},{name:"unit"}))}),(0,B.jsx)(M.Z,W(W({},d),{},{name:"vat",data:[{id:"default",label:"Default (20%)",value:20},{id:"custom",label:"Custom",value:"custom"}],legend:"VAT"})),"custom"===l&&(0,B.jsx)(U.Z,W(W({},d),{},{label:"Custom VAT",name:"vatMarkup"})),r?(0,B.jsx)(L.Z,W(W({},d),{},{name:"markup",type:"hidden"})):(0,B.jsx)(U.Z,W(W({},d),{},{label:"Markup ".concat(r?"(Service Rate Expenses and Materials : ".concat(r,"%)"):""),name:"markup"})),(0,B.jsx)(Q.P,W(W({},d),{},{errors:W({},s),label:"Category",name:"categoryId",type:"expenseCategory"})),(0,B.jsx)(J.Z,{label:"Description",children:(0,B.jsx)(V.Z,W(W({},d),{},{name:"description",rows:2}))}),i&&(0,B.jsx)(M.Z,W(W({},d),{},{name:"recurring",data:[{id:"recurring",label:"Recurring",value:"recurring"},{id:"nextInvoice",label:"Only for next invoice",value:"nextInvoice"}]})),t.id&&(0,B.jsx)(L.Z,W(W({},d),{},{name:"id",type:"hidden"}))]})};K.defaultProps={currency:"GBP",serviceRateExpenses:0,showRecurring:!1};var X=n(41391),ee=n(33908),et=n(11552),en=n(73845),er=n(58095);function ei(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function eo(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ei(Object(n),!0).forEach(function(t){(0,c.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ei(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var ea=function(e){var t,n,r,i,o,a,s=e.currency,c=e.enableUpdate,d=e.entity,b=e.entityId,x=e.job,$=e.jobs,H=e.refetchParent,N=e.tab,M=e.withDetails,F=e.showRecurring,J=(0,f.x)(),L=(0,m.useContext)(O.Z).hasRole,U=(0,er.a)(),V=(0,T.E)(x,"invoiceSent"),Q=(0,T.E)(x,"closed"),z=L("customer")&&!V,Y=!x||!Q&&(L(["admin"])&&!(0,T.E)(x,["validated","unvalidated"])||L(["admin","supplier"])&&!(0,T.E)(x,"reportSent")||c),G=(0,ee.B)("serviceRateExpenses",null==x?void 0:x.financeLogs,null==x?void 0:null===(t=x.customer)||void 0===t?void 0:null===(n=t.meta)||void 0===n?void 0:null===(r=n.finance)||void 0===r?void 0:r.serviceRateExpenses)||0,W=N||(!L("admin")&&L("supplier")?"supplier":"admin"),ei=(0,v.a)(Z,{variables:{entity:d,entityId:b,jobId:null==x?void 0:x.id},skip:z}),ea=ei.data,es=(ea=void 0===ea?{expenses:[]}:ea).expenses,ec=ei.loading,eu=ei.refetch,el=(0,X.E)(es,0,W),ed=el.preparedExpenses,ep=el.totalExpenses,em=el.totalExpensesExVAT,ef=(0,h.D)(w,{onCompleted:function(){x&&(0,et.F)(J,x.id),"JobSchedule"===d&&b&&(0,en.j)({client:J,scheduleId:b}),"Location"===d&&b&&(0,en.j)({client:J,locationId:b}),H?H():eu()}}),ev=(0,l.Z)(ef,1)[0],eh=(0,h.D)(j,{onCompleted:function(){x&&(0,et.F)(J,x.id),"JobSchedule"===d&&b&&(0,en.j)({client:J,scheduleId:b}),"Location"===d&&b&&(0,en.j)({client:J,locationId:b}),U.close(),H?H():eu()}}),eb=(0,l.Z)(eh,1)[0],ex=(0,h.D)(g,{onCompleted:function(){x&&(0,et.F)(J,x.id),"JobSchedule"===d&&b&&(0,en.j)({client:J,scheduleId:b}),"Location"===d&&b&&(0,en.j)({client:J,locationId:b}),U.close(),H?H():eu()}}),ej=(0,l.Z)(ex,1)[0],eg=(0,h.D)(y,{onCompleted:function(){x&&(0,et.F)(J,x.id),"JobSchedule"===d&&b&&(0,en.j)({client:J,scheduleId:b}),"Location"===d&&b&&(0,en.j)({client:J,locationId:b}),U.close(),H?H():eu()}}),ey=(0,l.Z)(eg,1)[0],eZ=(i=(0,u.Z)(p().mark(function e(t){var n,r;return p().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.id){e.next=7;break}return delete(n=eo({},t)).id,e.next=5,ey({variables:{parentId:t.id,changes:n}});case 5:e.next=10;break;case 7:return r=eo(eo({},t),{},{entity:d,entityId:b,Expenses:{data:$.map(function(e){return eo(eo({},t),{},{jobId:e.id})})}}),e.next=10,eb({variables:{objects:r}});case 10:case"end":return e.stop()}},e)})),function(e){return i.apply(this,arguments)}),ew=(o=(0,u.Z)(p().mark(function e(t){var n,r;return p().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if("custom"===t.vat&&(t.vat=t.vatMarkup),r=(n=t.unit*t.amount)*(t.markup/100)+n,t.total=r*(t.vat/100)+r,delete t.vatMarkup,t.categoryId=t.categoryId.value,"JobSchedule"!==d){e.next=11;break}return e.next=9,eZ(t);case 9:case 14:e.next=18;break;case 11:if(!t.id){e.next=16;break}return e.next=14,ej({variables:{id:t.id,changes:t}});case 16:return e.next=18,eb({variables:{objects:eo(eo({},t),{},{jobId:null==x?void 0:x.id})}});case 18:case"end":return e.stop()}},e)})),function(e){return o.apply(this,arguments)}),eO=function(e){var t=e.item?eo({},null==e?void 0:e.item):{markup:G};null!=t&&t.vat&&(t.vat=String(t.vat)),U.show({content:(0,B.jsx)(K,{currency:s,defaultValues:t,entityId:b,submit:ew,serviceRateExpenses:G,showRecurring:F}),title:"Expenses"})},eI=function(e,t){e.preventDefault(),e.stopPropagation(),ev({variables:{id:t.item.id}})},eS=function(e){U.show({content:(0,B.jsx)(_.G,{entity:"Expenses",entityId:e.item.id}),submit:!1,title:"Media"})},eP=[{text:"Description"},{formatter:function(e){var t=e.row;return(0,I.Z)(t.total,s)},text:"Total"},{text:"Paid By"},{formatter:S.Z,formatterData:[{context:"secondary",icon:["fas","edit"],onClick:function(e,t){return eO(t)},tooltip:"Edit"},{context:"info",icon:["fas","file-upload"],numberOverlay:"mediaCount",onClick:function(e,t){return eS(t)},tooltip:"Media"},{context:"danger",icon:["fas","trash"],onClick:function(e,t){return eI(e,t)},tooltip:"Delete"}],hidden:!Y,text:"Actions"},{hidden:!0},{hidden:!0}],eC=function(){return(0,B.jsx)(P.Z,{children:(0,B.jsx)(C.Z,{context:"secondary",content:"Add",onClick:eO,size:"sm"})})},eD=function(){return(0,B.jsxs)(B.Fragment,{children:[!M&&(0,B.jsx)(D.Z,{content:"Expenses",tag:"h3"}),(0,B.jsxs)(R.Z,{children:[(0,B.jsx)(k.Z,{md:6,children:(0,B.jsx)(E.Z,{content:"Total",text:(0,I.Z)(em,s)})}),(0,B.jsx)(k.Z,{md:6,children:(0,B.jsx)(E.Z,{content:"VAT Total",text:(0,I.Z)(ep,s)})})]}),(0,B.jsx)(A.Z,{columns:eP,loading:ec,rows:null==ed?void 0:ed.map(function(e){var t,n;return{description:e.description,total:e.total,paid:e.paid.charAt(0).toUpperCase()+e.paid.slice(1),actions:"",item:eo(eo(eo({},e),{occurredAt:new Date(e.occurredAt)}),{categoryId:{label:null===(t=e.category)||void 0===t?void 0:t.name,value:e.categoryId}}),mediaCount:null===(n=e.media)||void 0===n?void 0:n.length}})}),Y&&!M&&(0,B.jsx)(P.Z,{align:"flex-end",children:(0,B.jsx)(C.Z,{context:"secondary",content:"Add",onClick:eO,size:"sm"})})]})};return M?(0,B.jsx)(q.Z,{toolbar:Y&&(0,B.jsx)(eC,{}),open:!0,title:"Expenses",children:eD()}):eD()};ea.defaultProps={currency:"GBP",enableUpdate:!1,withDetails:!0,showRecurring:!1}},41391:function(e,t,n){"use strict";n.d(t,{E:function(){return a}});var r=n(59499);function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach(function(t){(0,r.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var a=function(e,t,n){var r=0,i=0,a=null==e?void 0:e.filter(function(e){return"supplier"===n&&"supplier"===e.paid||"supplier"!==n});return{preparedExpenses:null==a?void 0:a.map(function(e){var a=e.amount;"supplier"!==n&&(a+=e.markup/100*a,a/=1-t/100);var s=a*(e.unit||1),c=s+s*(e.vat/100);return i+=s,r+=c,o(o({},e),{},{id:e.id,name:e.description,unitCost:a,price:s,total:c,unit:e.unit||1,vatAmount:s*(e.vat/100),vatRate:e.vat/100,markup:e.markup})}),totalExpenses:r,totalExpensesExVAT:i}}},33908:function(e,t,n){"use strict";n.d(t,{B:function(){return i}});var r=n(27812),i=function(e,t,n){if(!t)return null;var i,o=null===(i=(0,r.Z)(t).sort(function(e,t){return e.createdAt-t.createdAt}).find(function(t){return t.type===e}))||void 0===i?void 0:i.value;return o||0===o?o:n||0}},33673:function(e,t,n){"use strict";n.d(t,{I:function(){return i}});var r=n(77349),i=function(e){var t,n,i,o,a,s,c,u,l,d=e.job,p=e.type,m=e.invoiceDate,f=parseInt(null===(t=d.admin)||void 0===t?void 0:null===(n=t.meta)||void 0===n?void 0:null===(i=n.finance)||void 0===i?void 0:i.invoiceDueDate)||30;return"customer"===p&&(f=parseInt(null===(o=d.customer)||void 0===o?void 0:null===(a=o.meta)||void 0===a?void 0:null===(s=a.finance)||void 0===s?void 0:s.invoiceDueDate)||parseInt(null===(c=d.admin)||void 0===c?void 0:null===(u=c.meta)||void 0===u?void 0:null===(l=u.finance)||void 0===l?void 0:l.invoiceDueDate)||30),(0,r.Z)(new Date(m),f)}},10693:function(e,t,n){"use strict";n.d(t,{e:function(){return v}});var r,i=n(50029),o=n(64687),a=n.n(o),s=n(26186),c=n(9205),u=n(34197),l=n(50558),d=n(33366),p=n(60036),m=n(94568),f=n(48764).Buffer,v=(r=(0,i.Z)(a().mark(function e(t){var n,r,i,o,v,h,b,x,j,g,y,Z,w,O,I,S,P,C,D,R,k,E,A,q,T,_,$,H,N,M;return a().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return k=t.adminId,E=t.job,q=void 0===(A=t.openReport)||A,T=function(){return E.media.filter(function(e){var t;return"image"===e.item.type&&!(null!==(t=e.item.meta)&&void 0!==t&&t.adminOnly)}).map(function(e){var t,n;if(null!==(t=e.item)&&void 0!==t&&null!==(n=t.meta)&&void 0!==n&&n.thumbnails){var r=e.item.meta.thumbnails.find(function(e){return"small"===e.name});if(r)return{filename:r.relativePath}}return{filename:e.item.filename}})},_=(0,c.WE)(E.location,"registered"),$=d.hD.find(function(e){var t;return e.value===(null===(t=E.report)||void 0===t?void 0:t.completion)}),H={job:{assets:E.assets,address:null==_?void 0:_.address,sublocation:E.sublocation,contractor:null===(n=E.supplier)||void 0===n?void 0:n.name,completedAt:"incorrect"===E.timingStatus?E.correctEnd:(0,s.Z)((0,u.E)(E,"completed")),customer:null===(r=E.customer)||void 0===r?void 0:r.name,description:f.from(E.description).toString("base64"),expenses:null===(i=E.expenses)||void 0===i?void 0:i.map(function(e){return e.description}),further:(null==$?void 0:$.text)||null,id:E.id,notes:null!==(o=E.report)&&void 0!==o&&o.notes?f.from(null==E?void 0:null===(v=E.report)||void 0===v?void 0:v.notes).toString("base64"):"",number:E.number,raisedBy:(0,l.j$)(E,"pending"),reference:E.reference,service:null===(h=E.service)||void 0===h?void 0:h.name,dateStart:"incorrect"===E.timingStatus?E.correctStart:(0,u.E)(E,"inProgress"),dateEnd:"incorrect"===E.timingStatus?E.correctEnd:(0,u.E)(E,"completed"),priority:null===(b=E.sla)||void 0===b?void 0:b.name,passFailStatus:null===(x=E.report)||void 0===x?void 0:x.passFailStatus,customerSignature:null!==(j=E.report)&&void 0!==j&&null!==(g=j.meta)&&void 0!==g&&g.customerSignatureName?{name:null===(y=E.report)||void 0===y?void 0:y.meta.customerSignatureName,data:null===(Z=E.report)||void 0===Z?void 0:Z.meta.customerSignatureTime}:null,supplierSignature:null!==(w=E.report)&&void 0!==w&&null!==(O=w.meta)&&void 0!==O&&O.supplierSignatureName?{name:null===(I=E.report)||void 0===I?void 0:I.meta.supplierSignatureName,data:null===(S=E.report)||void 0===S?void 0:S.meta.supplierSignatureTime}:null,recommendations:null!==(P=E.report)&&void 0!==P&&P.recommendations?f.from(null===(C=E.report)||void 0===C?void 0:C.recommendations).toString("base64"):""},jobReportId:null!==(D=null===(R=E.report)||void 0===R?void 0:R.id)&&void 0!==D?D:null,adminId:k,media:T()},!(0,m.a)()&&q&&(N=window.open("/download","_blank")),e.next=8,window.fetch("".concat("https://aws.cleverly.works","/pdf/job-report/create"),{method:"POST",headers:{"Content-Type":"application/json; charset=utf-8"},body:JSON.stringify(H)}).then(function(e){return e.json()}).then(function(e){if(q){var t,n,r,i,o;null===(t=N)||void 0===t||null===(n=t.location)||void 0===n||n.assign("".concat("https://cleverly-media.s3.eu-west-2.amazonaws.com","/").concat(e.key)),null!==(r=window)&&void 0!==r&&null!==(i=r.Capacitor)&&void 0!==i&&null!==(o=i.Plugins)&&void 0!==o&&o.Browser&&window.Capacitor.Plugins.Browser.open({url:"".concat("https://cleverly-media.s3.eu-west-2.amazonaws.com","/").concat(e.key)})}return{blob:e,link:"".concat("https://cleverly-media.s3.eu-west-2.amazonaws.com","/").concat(e.key)}}).catch(function(e){(0,p.Tb)({message:e,section:"fetch"})});case 8:return M=e.sent,e.abrupt("return",M);case 10:case"end":return e.stop()}},e)})),function(e){return r.apply(this,arguments)})},51555:function(e,t,n){"use strict";n.d(t,{L:function(){return x},g:function(){return b}});var r,i,o,a,s=n(71383),c=n(50029),u=n(64687),l=n.n(u),d=n(9205),p=n(94568),m=n(60036),f=n(75063),v=n(48764).Buffer,h=(i=(0,c.Z)(l().mark(function e(t,n){var r,i,o,a,s,c,u,p,m,f,h;return l().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(c=[],u=[],p=null,p=n?t.quotations.find(function(e){return e.id===n}):t.quotations.find(function(e){return"supplierQuoteSent"===e.status})){e.next=6;break}return e.abrupt("return",null);case 6:return p.lineItems.forEach(function(e){var t={name:e.description,price:e.total,vatRate:.2,qty:e.qty,unit:e.qtyUnit,rate:e.unitRate};"Materials"===e.type?u.push(t):"Labour"===e.type&&c.push(t)}),m=(0,d.WE)(null==t?void 0:t.location,"registered"),f=(null===(r=p.meta)||void 0===r?void 0:r.terms)||(null==t?void 0:null===(i=t.admin)||void 0===i?void 0:null===(o=i.meta)||void 0===o?void 0:null===(a=o.quote)||void 0===a?void 0:a.terms)||"",h={id:p.id,job:{currency:"\xa3",customerName:null===(s=t.customer)||void 0===s?void 0:s.name,startDate:p.startDate,description:v.from(t.description).toString("base64"),duration:p.totalDuration?1===p.totalDuration?"".concat(p.totalDuration," ").concat(p.totalDurationUnit):"".concat(p.totalDuration," ").concat(p.totalDurationUnit,"s"):"-",number:t.number,reference:(null==t?void 0:t.reference)||"",labour:c,materials:u,methodStatement:p.methodStatement,propertyAddress:null==m?void 0:m.address,sublocation:t.sublocation,terms:v.from(f).toString("base64")}},e.abrupt("return",h);case 11:case"end":return e.stop()}},e)})),function(e,t){return i.apply(this,arguments)}),b=(o=(0,c.Z)(l().mark(function e(t){var n,r,i,o,a,s,c,u,d,f,v=arguments;return l().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=v.length>1&&void 0!==v[1]?v[1]:null,r=v.length>2?v[2]:void 0,e.prev=2,(0,p.a)()||(c=window.open("/download","_blank")),e.next=6,x(t,n,r);case 6:if(u=e.sent){e.next=9;break}throw Error("Failed to download quote");case 9:null!==(i=c)&&void 0!==i&&i.location&&(null===(d=c)||void 0===d||null===(f=d.location)||void 0===f||f.assign(u)),null!==(o=window)&&void 0!==o&&null!==(a=o.Capacitor)&&void 0!==a&&null!==(s=a.Plugins)&&void 0!==s&&s.Browser&&window.Capacitor.Plugins.Browser.open({url:u}),e.next=16;break;case 13:e.prev=13,e.t0=e.catch(2),(0,m.Tb)({message:e.t0,section:"fetch"});case 16:case"end":return e.stop()}},e,null,[[2,13]])})),function(e){return o.apply(this,arguments)}),x=(a=(0,c.Z)(l().mark(function e(t){var n,r,i,o,a,s,c,u,d=arguments;return l().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=d.length>1&&void 0!==d[1]?d[1]:null,r=d.length>2?d[2]:void 0,e.next=4,h(t,n);case 4:if(!(i=e.sent)){e.next=15;break}return e.next=8,r.mutate({mutation:j,variables:{data:i}});case 8:if(c=(s=(a=void 0===(a=e.sent.data)?{pdfQuoteCreate:{}}:a).pdfQuoteCreate).success,u=s.key,c){e.next=14;break}throw Error("Failed to create PDF");case 14:return e.abrupt("return","".concat("https://cleverly-media.s3.eu-west-2.amazonaws.com","/").concat(u));case 15:return e.abrupt("return",null);case 16:case"end":return e.stop()}},e)})),function(e){return a.apply(this,arguments)}),j=(0,f.Ps)(r||(r=(0,s.Z)(["\n  mutation PDFQuoteCreate($data: jsonb!) {\n    pdfQuoteCreate(data: $data) {\n      success\n      key\n    }\n  }\n"])))},7581:function(e,t,n){"use strict";n.d(t,{D7:function(){return g},KQ:function(){return j},R7:function(){return x},j$:function(){return Z},kx:function(){return w},l1:function(){return b},lk:function(){return y},ys:function(){return h}});var r,i,o,a,s,c,u,l,d,p,m,f=n(71383),v=n(75063),h=(0,v.Ps)(r||(r=(0,f.Z)(['\n  query GetSuppliers(\n    $limit: Int\n    $offset: Int\n    $orderBy: Account_order_by!\n    $where: Account_bool_exp\n  ) {\n    suppliers: Account(limit: $limit, offset: $offset, where: $where, order_by: [$orderBy]) {\n      id\n      createdAt\n      name\n      status\n      companyNumber\n      vatId\n      website\n      jobs: SupplierJobs_aggregate {\n        aggregate {\n          count\n          max {\n            scheduledAt\n          }\n          sum {\n            amount\n          }\n        }\n      }\n      jobList: SupplierJobs(order_by: { createdAt: desc }) {\n        id\n      }\n      services: Services(where: { entity: { _eq: "Account" } }) {\n        id\n        service: Service {\n          id\n          name\n        }\n      }\n      addresses: Addresses(where: { entity: { _eq: "Account" } }) {\n        id\n        registered\n        operating\n        trading\n        invoice\n        status\n        createdAt\n        address: Address {\n          id\n          name\n          addressLine1\n          addressLine2\n          addressLine3\n          city\n          county\n          geo\n          postCode\n          country: Country {\n            id\n            name\n          }\n        }\n      }\n      locations: Account_Locations {\n        id\n      }\n      manager: Manager {\n        id\n        nameFirst\n        nameLast\n      }\n      contactUsers: Account_Users(where: { isContact: { _eq: true } }) {\n        id\n        role\n        position\n        isContact\n        lastSignInAt\n        userId\n        user: User {\n          id\n          name: nameFirst\n          nameFirst\n          nameLast\n          phone\n          status\n          email\n          createdAt\n          fullName\n          accounts: Account_Users {\n            id\n            role\n            position\n            isContact\n            status\n            account: Account {\n              id\n              name\n              type\n            }\n          }\n        }\n      }\n    }\n    meta: Account_aggregate(where: $where) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n']))),b=(0,v.Ps)(i||(i=(0,f.Z)(['\n  query GetSupplier($id: Int!) {\n    supplier: Account_by_pk(id: $id) {\n      id\n      companyNumber\n      createdAt\n      name\n      status\n      type\n      updatedAt\n      website\n      clientType\n      managerId\n      vatId\n      meta\n      statusLogs: StatusLog(where: { entity: { _eq: "Account" } }) {\n        id\n        status\n        createdAt\n      }\n      media: Media {\n        id\n        medium: Medium {\n          id\n          category\n          filename\n          meta\n          type\n        }\n      }\n      manager: Manager {\n        id\n        fullName\n      }\n      addresses: Addresses(where: { entity: { _eq: "Account" } }) {\n        id\n        registered\n        operating\n        trading\n        invoice\n        status\n        createdAt\n        address: Address {\n          id\n          name\n          addressLine1\n          addressLine2\n          addressLine3\n          city\n          county\n          geo\n          postCode\n          country: Country {\n            id\n            name\n          }\n        }\n      }\n\n      details: SupplierDetail {\n        cisRegistered\n        quotingEmail\n        typeOfOrganisation\n        utrNumber\n        accountId\n      }\n\n      contactUsers: Account_Users(where: { isContact: { _eq: true } }) {\n        role\n        position\n        isContact\n        lastSignInAt\n        userId\n        user: User {\n          id\n          name: nameFirst\n          nameFirst\n          nameLast\n          phone\n          status\n          email\n          createdAt\n          fullName\n        }\n      }\n      usersMeta: Account_Users_aggregate {\n        aggregate {\n          count\n        }\n      }\n\n      compliances: Compliances(where: { entity: { _eq: "Account" } }, order_by: { expiryAt: asc }) {\n        id\n        createdAt\n        entity\n        entityId\n        expiryAt\n        regNum\n        insuranceAmount\n        meta\n      }\n      coverage: PostcodeAreas(where: { entity: { _eq: "Account" }, status: { _eq: "active" } }) {\n        id\n        status\n        createdAt\n        area: PostcodeArea {\n          id\n          name\n          area\n        }\n      }\n      services: Services {\n        serviceId\n        createdAt\n      }\n      references: References {\n        id\n        createdAt\n      }\n    }\n  }\n']))),x=(0,v.Ps)(o||(o=(0,f.Z)(["\n  query GetSupplierManage($id: Int!) {\n    supplier: Account_by_pk(id: $id) {\n      id\n      name\n      website\n      companyNumber\n      vatId\n      status\n      meta\n      managerSelected: Manager {\n        id\n        label: fullName\n        value: id\n      }\n      supplierDetails: SupplierDetail {\n        id\n        cisRegistered\n        quotingEmail\n        typeOfOrganisation\n        utrNumber\n      }\n    }\n  }\n"]))),j=(0,v.Ps)(a||(a=(0,f.Z)(["\n  mutation AddSupplier($objects: [Account_insert_input!]!) {\n    insert_Account(objects: $objects) {\n      returning {\n        id\n      }\n    }\n  }\n"])));(0,v.Ps)(s||(s=(0,f.Z)(["\n  mutation AddSupplierDetail($objects: [SupplierDetail_insert_input!]!) {\n    insert_SupplierDetail(objects: $objects) {\n      returning {\n        id\n        accountId\n      }\n    }\n  }\n"]))),(0,v.Ps)(c||(c=(0,f.Z)(["\n  mutation AddSupplierOffer($objects: [SupplierOffer_insert_input!]!) {\n    insert_SupplierOffer(objects: $objects) {\n      returning {\n        id\n      }\n    }\n  }\n"])));var g=(0,v.Ps)(u||(u=(0,f.Z)(["\n  mutation UpdateSupplier(\n    $supplierId: Int!\n    $supplier: Account_set_input\n    $supplierDetails: SupplierDetail_set_input\n  ) {\n    update_SupplierDetail(where: { accountId: { _eq: $supplierId } }, _set: $supplierDetails) {\n      returning {\n        id\n      }\n    }\n\n    update_Account_by_pk(pk_columns: { id: $supplierId }, _set: $supplier) {\n      id\n    }\n  }\n"]))),y=(0,v.Ps)(l||(l=(0,f.Z)(['\n  query GetPostCodeAreas(\n    $limit: Int\n    $offset: Int\n    $q: String\n    $supplierId: Int\n    $status: String = "active"\n  ) {\n    coverage: PostcodeArea_Entity(\n      where: {\n        entity: { _eq: "Account" }\n        entityId: { _eq: $supplierId }\n        status: { _eq: $status }\n        PostcodeArea: { name: { _ilike: $q } }\n      }\n      order_by: { PostcodeArea: { name: asc } }\n      limit: $limit\n      offset: $offset\n    ) {\n      id\n      status\n      createdAt\n      area: PostcodeArea {\n        id\n        name\n        area\n      }\n    }\n    meta: PostcodeArea_Entity_aggregate(\n      where: {\n        entity: { _eq: "Account" }\n        entityId: { _eq: $supplierId }\n        status: { _eq: $status }\n        PostcodeArea: { name: { _ilike: $q } }\n      }\n    ) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n']))),Z=(0,v.Ps)(d||(d=(0,f.Z)(["\n  query GetPostCodeAreaForSelect($countryId: Int, $q: String) {\n    items: PostcodeArea(\n      where: { name: { _ilike: $q }, countryId: { _eq: $countryId } }\n      order_by: { name: asc }\n    ) {\n      area\n      label: name\n      value: id\n    }\n  }\n"]))),w=(0,v.Ps)(p||(p=(0,f.Z)(['\n  query GetServicesForSelect($q: String, $limit: Int, $offset: Int) {\n    items: Service(\n      where: { name: { _ilike: $q }, status: { _eq: "active" } }\n      limit: $limit\n      offset: $offset\n      order_by: { name: asc }\n    ) {\n      label: name\n      value: id\n    }\n  }\n'])));(0,v.Ps)(m||(m=(0,f.Z)(['\n  query GetFinancialJob(\n    $adminId: Int\n    $customerId: Int\n    $endDate: timestamptz\n    $startDate: timestamptz\n    $limit: Int\n    $status: [String]\n    $managerId: Int\n    $locationId: Int\n    $offset: Int\n    $supplierId: Int\n    $q: String\n    $orderBy: Job_order_by!\n  ) {\n    jobs: Job(\n      limit: $limit\n      offset: $offset\n      where: {\n        type: { _in: ["reactive", "ppm"] }\n        _and: [\n          {\n            _or: [\n              { reference: { _ilike: $q } }\n              { title: { _ilike: $q } }\n              { number: { _ilike: $q } }\n              { number: { _ilike: $q } }\n              { Invoices: { invoiceNumber: { _ilike: $q } } }\n            ]\n          }\n          {\n            _or: [\n              { _and: [{ timingStart: { _gte: $startDate } }, { timingStart: { _lte: $endDate } }] }\n              { _and: [{ scheduledAt: { _gte: $startDate } }, { scheduledAt: { _lte: $endDate } }] }\n            ]\n          }\n        ]\n        status: { _in: $status }\n        customerId: { _eq: $customerId }\n        supplierId: { _eq: $supplierId }\n        managerId: { _eq: $managerId }\n        adminId: { _eq: $adminId }\n        locationId: { _eq: $locationId }\n      }\n      order_by: [$orderBy]\n    ) {\n      id\n      type\n      number\n      status\n      description\n      reference\n      timingStart\n      scheduledAt\n      createdAt\n\n      customerTotal: customerFinances(path: "amountInfo.total")\n      supplierTotal: supplierFinances(path: "amountInfo.total")\n      customerVatTotal: customerFinances(path: "amountInfo.vatTotal")\n      supplierVatTotal: supplierFinances(path: "amountInfo.vatTotal")\n      customerExpensesTotal: customerFinances(path: "expensesInfo.expensesTotal")\n      supplierExpensesTotal: supplierFinances(path: "expensesInfo.expensesTotal")\n      customerRebateAmount: customerFinances(path: "rebate.amount")\n\n      slaId\n      invoices: Invoices(order_by: { createdAt: desc }) {\n        invoiceNumber\n      }\n      customer: Customer {\n        id\n        name\n      }\n      supplier: Supplier {\n        id\n        name\n      }\n      location: Location {\n        id\n        name\n      }\n      sublocation: Sublocation {\n        id\n        name\n      }\n      sla: SLA {\n        name\n      }\n      manager: Manager {\n        fullName\n        nameLast\n        nameFirst\n        id\n      }\n      service: Service {\n        id\n        name\n      }\n    }\n    meta: Job_aggregate(\n      where: {\n        type: { _in: ["reactive", "ppm"] }\n        _and: [\n          {\n            _or: [\n              { reference: { _ilike: $q } }\n              { title: { _ilike: $q } }\n              { number: { _ilike: $q } }\n              { number: { _ilike: $q } }\n              { Invoices: { invoiceNumber: { _ilike: $q } } }\n            ]\n          }\n          {\n            _or: [\n              { _and: [{ timingStart: { _gte: $startDate } }, { timingStart: { _lte: $endDate } }] }\n              { _and: [{ scheduledAt: { _gte: $startDate } }, { scheduledAt: { _lte: $endDate } }] }\n            ]\n          }\n        ]\n        status: { _in: $status }\n        customerId: { _eq: $customerId }\n        supplierId: { _eq: $supplierId }\n        managerId: { _eq: $managerId }\n        adminId: { _eq: $adminId }\n        locationId: { _eq: $locationId }\n      }\n    ) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n'])))},10667:function(e,t,n){"use strict";n.d(t,{T:function(){return s}});var r=n(58965),i=n(86036),o=n(5547),a=n(85893),s=function(e){var t,n,s,c=e.open,u=e.supplier,l="";return o.E.forEach(function(e){var t;e.value===(null===(t=u.details)||void 0===t?void 0:t.typeOfOrganisation)&&(l=e.text)}),(0,a.jsxs)(r.Z,{open:c,title:"Company",children:[(0,a.jsx)(i.Z,{content:"Organization Type",text:l}),(0,a.jsx)(i.Z,{content:"Company Number",text:u.companyNumber}),(0,a.jsx)(i.Z,{content:"VAT Number",text:u.vatId}),(0,a.jsx)(i.Z,{content:"UTR Number",text:null===(t=u.details)||void 0===t?void 0:t.utrNumber}),(0,a.jsx)(i.Z,{content:"CIS registration number",text:null===(n=u.details)||void 0===n?void 0:n.cisRegistered}),(0,a.jsx)(i.Z,{content:"Website",text:u.website}),(null===(s=u.meta)||void 0===s?void 0:s.xeroContactId)&&(0,a.jsx)(i.Z,{content:"Xero Contact ID",text:u.meta.xeroContactId})]})};s.defaultProps={open:!0}},73816:function(e,t,n){"use strict";n.d(t,{D:function(){return s}});var r=n(58965),i=n(86036),o=n(55377),a=n(85893),s=function(e){var t=e.supplier;return(0,a.jsx)(r.Z,{open:!0,title:"Contact",children:t.contactUsers.map(function(e){var n;return(0,a.jsxs)("div",{children:[(0,a.jsx)(i.Z,{content:"Name",text:"".concat(e.user.fullName)}),(0,a.jsx)(i.Z,{content:"Phone",text:e.user.phone}),(0,a.jsx)(i.Z,{content:"Email",text:e.user.email}),(0,a.jsx)(i.Z,{content:"Quoting Email",text:(null===(n=t.details)||void 0===n?void 0:n.quotingEmail)||"-"}),(0,a.jsx)(o.Z,{})]},e.user.id)})})}},17386:function(e,t,n){"use strict";n.d(t,{O:function(){return l}});var r=n(59499),i=n(90948),o=n(40044),a=n(85893);function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach(function(t){(0,r.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var u=(0,i.ZP)(function(e){return(0,a.jsx)(o.Z,c({disableRipple:!0},e))})(function(e){var t=e.theme;return{textTransform:"none",color:t.palette.text.primary,"&.Mui-selected":{fontWeight:600,color:t.palette.secondary.contrastText,backgroundColor:t.palette.secondary.main},"&.Mui-focusVisible":{backgroundColor:"rgba(100, 95, 228, 0.32)"}}}),l=function(e){return(0,a.jsx)(u,c({},e))};l.defaultProps={}},49397:function(e,t,n){"use strict";n.d(t,{x:function(){return d}});var r=n(59499),i=n(4730),o=n(90948),a=n(5616),s=n(85893),c=["children","value","index","boxProps","boxSx"];function u(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?u(Object(n),!0).forEach(function(t){(0,r.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):u(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var d=function(e){var t=e.children,n=e.value,r=e.index,o=e.boxProps,u=e.boxSx,d=(0,i.Z)(e,c);return(0,s.jsx)(p,l(l({role:"tabpanel",hidden:n!==r,id:"simple-tabpanel-".concat(r),"aria-labelledby":"simple-tab-".concat(r)},d),{},{children:n===r&&(0,s.jsx)(a.Z,l(l({},o),{},{sx:l({padding:"25px 0"},u),children:t}))}))};d.defaultProps={boxProps:{},boxSx:{}};var p=(0,o.ZP)(a.Z)(function(){return{"& .MuiTabs-root":{}}})},30363:function(e,t,n){"use strict";n.d(t,{m:function(){return f}});var r=n(4730),i=n(59499),o=n(90948),a=n(3892),s=n(11163),c=n.n(s),u=n(85893),l=["onChange","changeQuery"];function d(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function p(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?d(Object(n),!0).forEach(function(t){(0,i.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):d(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var m=(0,o.ZP)(function(e){return(0,u.jsx)(a.Z,p({},e))})(function(e){var t=e.theme,n=e.size;return p(p({},"small"===n&&{height:"32px",minHeight:"32px"}),{},{"& .MuiTabs-scroller":p({overflow:"scroll !important"},"small"===n&&{height:"60px",minHeight:"60px"}),"& .MuiTabs-indicator":{display:"none"},"& .MuiTabs-flexContainer > .MuiTab-root":p(p({},"small"===n&&{height:"32px",minHeight:"32px"}),{},{border:1,borderStyle:"solid",borderColor:t.palette.divider,"&:first-child":p({borderTopLeftRadius:"10px",borderBottomLeftRadius:"10px"},"small"===n&&{borderTopLeftRadius:"5px",borderBottomLeftRadius:"5px"}),"&:last-child":p({borderTopRightRadius:"10px",borderBottomRightRadius:"10px"},"small"===n&&{borderTopRightRadius:"5px",borderBottomRightRadius:"5px"})})})}),f=function(e){var t=e.onChange,n=e.changeQuery,i=(0,r.Z)(e,l),o=(0,s.useRouter)(),a=function(e,r){t(e,r),n&&d(r)},d=function(e){var t=o.query;delete t.tab,t.tab=e,c().push({pathname:o.pathname,query:t,shallow:!0})};return(0,u.jsx)(m,p({onChange:a},i))};f.defaultProps={size:"small"}},32836:function(e,t,n){"use strict";n.d(t,{i:function(){return I}});var r=n(59499),i=n(67294),o=n(11163),a=n(83148),s=n(26447),c=n(15861),u=n(90948),l=n(5616),d=n(41796),p=n(87361),m=n(42096),f=n(87043),v=n(61730),h=n(58886),b=n(70872),x=n(85893);function j(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function g(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?j(Object(n),!0).forEach(function(t){(0,r.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):j(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var y=function(e){var t=e.currentPage,n=e.totalCount,r=e.pageSize,i=e.onPageChange,o=(0,v.Z)("(max-width:400px)"),a=(0,v.Z)("(max-width:500px)");return(0,x.jsx)(Z,{mb:2,page:t,count:Math.ceil(n/r),onChange:function(e,t){return i(t)},variant:"outlined",shape:"rounded",size:o?"small":"medium",hidePrevButton:1===t,hideNextButton:t===Math.ceil(n/r),siblingCount:a?0:1,renderItem:function(e){return(0,x.jsx)(h.Z,g({slots:{previous:function(){return"Previous"},next:function(){return"Next"}}},e))}})};y.defaultProps={currentPage:1,totalCount:0,pageSize:50,onPageChange:function(){}};var Z=(0,u.ZP)(b.Z)(function(e){var t,n=e.hidePrevButton,i=e.hideNextButton,o=e.theme;return t={},(0,r.Z)(t,"&.MuiPagination-root",{alignSelf:"center",marginTop:"16px"}),(0,r.Z)(t,"& .MuiPaginationItem-root",{fontWeight:600,margin:0,borderRadius:0}),(0,r.Z)(t,"& .MuiPagination-ul > li:last-child .MuiPaginationItem-previousNext:last-child",{margin:0,borderRadius:"0 5px 5px 0"}),(0,r.Z)(t,"& .MuiPagination-ul > li:first-child .MuiPaginationItem-previousNext:last-child",{margin:0,borderRadius:"5px 0 0 5px"}),(0,r.Z)(t,"& button.Mui-selected",g(g({color:o.palette.white.main,backgroundColor:o.palette.secondary.main},i?{borderRadius:"0 5px 5px 0"}:{}),n?{borderRadius:"5px 0 0 5px"}:{})),t});function w(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function O(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?w(Object(n),!0).forEach(function(t){(0,r.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):w(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var I=(0,i.forwardRef)(function(e,t){var n=e.columns,r=e.history,a=e.initialSort,u=e.meta,l=e.refetch,d=e.paginationSize,v=e.containerHeight,h=e.noResultsMessage,b=e.autoHeight,j=(0,o.useRouter)(),g=j.query,Z=void 0===g?{}:g,w=(0,i.useState)(parseInt(null==Z?void 0:Z.page,10)||1),I=w[0],C=w[1],D=(0,i.useState)(d||f.C1.paginationSize),R=D[0],k=D[1];a||(a={item:"createdAt",order:"desc"});var E=(0,i.useState)({item:a.item,order:a.order}),A=E[0],q=E[1],T=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=j.query,n=void 0===t?{}:t;if(e>1?n.page=e:delete n.page,!(Object.keys(n).length>0))return{};var r=Object.keys(n).map(function(t){return"page"===t?"".concat(t,"=").concat(e):"".concat(t,"=").concat(n[t])}).join("&");return"?".concat(r)},_=function(){q({item:a.item,order:a.order}),C(1);var e=T();j.push(e),k(d||f.C1.paginationSize)};(0,i.useImperativeHandle)(t,function(){return{currentPage:I,pageSize:R,sort:A,resetPagination:function(){_()}}});var $=function(e){var t=T(e);r&&j.push(t),C(e),!r&&l&&l()},H=function(e){e&&e.field&&e.sort?(q({item:n.find(function(t){return t.field===e.field}).sortName||e.field||e.item||a.item,order:e.sort||e.order||a.order}),l&&l()):(q({item:a.item,order:a.order}),l&&l())};return(0,x.jsxs)(S,{containerHeight:v,children:[(0,x.jsx)(P,O({hideFooter:!0,disableColumnMenu:!0,disableSelectionOnClick:!0,autoHeight:b,sortingMode:"server",onSortModelChange:function(e){return H(e[0])},columns:n,pageSize:R,slots:{columnSortedAscendingIcon:function(){return(0,x.jsx)(p.Z,{})},columnSortedDescendingIcon:function(){return(0,x.jsx)(m.Z,{})},columnUnsortedIcon:function(){return(0,x.jsxs)(s.Z,{alignItems:"center",sx:{width:"33px"},children:[(0,x.jsx)(p.Z,{sx:{marginBottom:"-15px"}}),(0,x.jsx)(m.Z,{})]})},noResultsOverlay:function(){return(0,x.jsx)(s.Z,{height:"100%",alignItems:"center",justifyContent:"center",spacing:1,p:1,children:(0,x.jsx)(c.Z,{children:h})})},noRowsOverlay:function(){return(0,x.jsx)(s.Z,{height:"100%",alignItems:"center",justifyContent:"center",spacing:1,p:1,children:(0,x.jsx)(c.Z,{children:h})})}}},e)),u&&Math.ceil(u.aggregate.totalCount/R)>1&&(0,x.jsx)(y,{currentPage:I,totalCount:u.aggregate.totalCount,pageSize:R,onPageChange:$})]})});I.defaultProps={columns:[],history:!1,loading:!1,rows:[],noResultsMessage:"There are no results.",autoHeight:!0};var S=(0,u.ZP)(l.Z)(function(e){return{height:e.containerHeight,display:"flex",flexDirection:"column"}}),P=(0,u.ZP)(a.s)(function(e){var t,n=e.theme,i=e.hideHeader,o=(e.rows,e.loading,e.rowHeight),a=e.isPdf;return t={"--DataGrid-overlayHeight":"40px"},(0,r.Z)(t,"&.MuiDataGrid-root",O({color:n.palette.black.main,border:"none"},a&&{"@media print":{display:"block"}})),(0,r.Z)(t,"& .MuiDataGrid-main",O({},a&&{"@media print":{overflow:"visible !important"}})),(0,r.Z)(t,"& .MuiDataGrid-columnHeaders",O(O({},i&&{display:"none"}),{},{"& .MuiDataGrid-iconButtonContainer":{visibility:"visible","& .MuiButtonBase-root.MuiIconButton-root":{backgroundColor:"inherit",color:n.palette.black.main,"&:hover":{backgroundColor:"rgba(0, 0, 0, 0.1)"}}}})),(0,r.Z)(t,"& .MuiDataGrid-virtualScroller",O(O({},i&&{marginTop:"0 !important"}),a&&{"@media print":{overflow:"visible !important"}})),(0,r.Z)(t,"& .MuiDataGrid-iconSeparator",{opacity:0}),(0,r.Z)(t,"& .MuiDataGrid-columnHeaderTitle",{fontWeight:700}),(0,r.Z)(t,"& .MuiButtonBase-root.MuiDataGrid-columnHeaderTitle",{fontWeight:700}),(0,r.Z)(t,"& .MuiDataGrid-virtualScrollerContent",O({},a&&{height:"initial !important",minHeight:"initial !important"})),(0,r.Z)(t,"& .MuiDataGrid-virtualScrollerRenderZone",O({},a&&{position:"relative"})),(0,r.Z)(t,"& .MuiDataGrid-overlayWrapper",(0,r.Z)({},"& .MuiCircularProgress-root",{color:n.palette.secondary.main})),(0,r.Z)(t,"& .MuiDataGrid-row",O({},a&&{minHeight:"".concat(o,"cm !important"),maxHeight:"".concat(o,"cm !important")})),(0,r.Z)(t,"& .MuiDataGrid-row > .MuiDataGrid-cell",O({},a&&{minHeight:"".concat(o,"cm !important"),maxHeight:"".concat(o,"cm !important")})),(0,r.Z)(t,"& .MuiDataGrid-row.even",{backgroundColor:n.palette.muiLightGray.main,"&:hover, &.Mui-hovered":{backgroundColor:(0,d.Fq)(n.palette.muiLightGray.main,.3),"@media (hover: none)":{backgroundColor:"transparent"}},"&.Mui-selected":{backgroundColor:(0,d.Fq)(n.palette.muiLightGray.main,.3+n.palette.action.selectedOpacity),"&:hover, &.Mui-hovered":{backgroundColor:(0,d.Fq)(n.palette.muiLightGray.main,.3+n.palette.action.selectedOpacity+n.palette.action.hoverOpacity),"@media (hover: none)":{backgroundColor:(0,d.Fq)(n.palette.muiLightGray.main,.3+n.palette.action.selectedOpacity)}}}}),t})},2112:function(e,t,n){"use strict";n.d(t,{b:function(){return r}});var r=function(e){return String(e).toLowerCase().replace("gb","").length>=9}},5547:function(e,t,n){"use strict";n.d(t,{E:function(){return r}});var r=[{text:"Select Type Of Organisation",value:""},{text:"Sole trader",value:"soleTrader"},{text:"Limited company",value:"limitedCompany"},{text:"Partnership",value:"partnership"},{text:"LLP",value:"llp"},{text:"PLC",value:"plc"}]},21788:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return uM}});var r,i,o,a,s,c,u,l,d,p,m,f,v,h,b,x,j,g,y,Z,w,O,I,S,P,C,D,R,k,E,A,q,T,_,$,H,N,M,F,J,L,U,V,Q,z,Y,B,G,W=n(59499),K=n(67294),X=n(11163),ee=n.n(X),et=n(73987),en=n(27812),er=n(6812),ei=n(75436),eo=n(38512),ea=n(71383),es=n(75063),ec=n(59636),eu=n(15641),el=n(4431),ed=n(69496),ep=(0,es.Ps)(r||(r=(0,ea.Z)(['\n  query GetJob($adminId: Int!, $number: String!) {\n    job: Job(where: { adminId: { _eq: $adminId }, number: { _eq: $number } }) {\n      ...JobFields\n      ...JobQuoteFields\n      ...JobSupplierFields\n      reportPassFail\n      reportPassFailTitle\n      requireReportRecommendations\n      estimatedDuration\n      estimatedDurationUnit\n      anyTimeOption\n      hourStart\n      hourEnd\n      meta\n      supplierVatTotal: supplierFinances(path: "amountInfo.vatTotal")\n      assets: Assets {\n        id\n        status\n        asset: Asset {\n          id\n          name\n        }\n      }\n      ppmInvoices: AccountEntries {\n        Invoices {\n          id\n          invoiceNumber\n          invoiceType\n          meta\n          createdAt\n          accountEntry: AccountEntry {\n            id\n          }\n        }\n      }\n      invoices: Invoices(order_by: { createdAt: desc }) {\n        id\n        invoiceNumber\n        invoiceType\n        createdAt\n        amounts\n        reconciledAmount: AccountEntry {\n          reconciliations: InvoiceReconciliations_aggregate {\n            aggregate {\n              sum {\n                amount\n              }\n            }\n          }\n        }\n      }\n      jobScheduleId\n      shortJobDesc: Taxonomy(where: { Taxonomy: { type: { _eq: "jobTags" } } }) {\n        id\n        taxonomyId\n        comments\n        taxonomy: Taxonomy {\n          name\n        }\n      }\n      supplierId\n      customerId\n      customerUserId\n      locationId\n      parentJob: ParentJob {\n        createdAt\n        id\n        number\n        reference\n        status\n        title\n        type\n      }\n      childJobs: Jobs {\n        createdAt\n        id\n        number\n        reference\n        status\n        title\n        type\n      }\n      admin: Admin {\n        id\n        name\n        meta\n        bankAccounts: BankAccounts {\n          id\n          bank\n          stripeId\n          accountNumber\n          routingNumber\n          bic\n          iban\n          status\n          default\n          createdAt\n        }\n        addresses: Addresses {\n          id\n          registered\n          operating\n          trading\n          invoice\n          status\n          createdAt\n          address: Address {\n            id\n            name\n            addressLine1\n            addressLine2\n            addressLine3\n            city\n            county\n            geo\n            postCode\n            country: Country {\n              id\n              name\n            }\n          }\n        }\n      }\n      customer: Customer {\n        id\n        name\n      }\n\n      compliances: Compliances(where: { entity: { _eq: "Job" } }) {\n        id\n        compliance: Compliance {\n          id\n          name\n        }\n      }\n\n      expenses: Expenses {\n        id\n        amount\n        description\n        markup\n        total\n        unit\n        vat\n        paid\n      }\n      location: Location {\n        id\n        name\n        addresses: Addresses(where: { entity: { _eq: "Location" } }) {\n          ...AddressEntityFields\n          address: Address {\n            ...AddressFields\n            country: Country {\n              id\n              name\n            }\n          }\n        }\n        slas: SLAs(where: { entity: { _eq: "Location" } }) {\n          id\n          entity\n          entityId\n          onSite\n          onSiteUnit\n          jobReport\n          jobReportUnit\n          completion\n          completionUnit\n          notes\n          inUse\n          normalRate\n          oohRate\n          premiumRate\n          minimumInterval\n          minimumLength\n          slaId\n          sla: SLA {\n            id\n            name\n            notes\n            normalRate\n            oohRate\n            premiumRate\n            onSite\n            onSiteUnit\n            jobReport\n            jobReportUnit\n            completion\n            completionUnit\n            minimumInterval\n            minimumLength\n          }\n        }\n        services: Services(where: { entity: { _eq: "Location" } }) {\n          id\n          dayRate\n          dayRateOOH\n          dayRatePremium\n          hourRate\n          hourRateOOH\n          hourRatePremium\n          minimumInterval\n          minimumLength\n          callOutHourRate\n          callOutHourRateOOH\n          callOutHourRatePremium\n          notes\n          delivery\n          createdAt\n          updatedAt\n          entity\n          entityId\n          serviceId\n          service: Service {\n            id\n            name\n            countryId\n            currencyId\n            customerDayRate\n            customerDayRateOOH\n            customerDayRatePremium\n            customerHourRate\n            customerHourRateOOH\n            customerHourRatePremium\n            supplierDayRate\n            supplierDayRateOOH\n            supplierDayRatePremium\n            supplierHourRate\n            supplierHourRateOOH\n            supplierHourRatePremium\n            minimumInterval\n            minimumLength\n          }\n        }\n      }\n      sublocation: Sublocation {\n        id\n        name\n      }\n      report: JobReport {\n        id\n        completion\n        notes\n        timing\n        passFailStatus\n        recommendations\n        comments\n        createdAt\n        updatedAt\n        meta\n      }\n      service: Service {\n        id\n        name\n        countryId\n        currencyId\n        customerDayRate\n        customerDayRateOOH\n        customerDayRatePremium\n        customerHourRate\n        customerHourRateOOH\n        customerHourRatePremium\n        supplierDayRate\n        supplierDayRateOOH\n        supplierDayRatePremium\n        supplierHourRate\n        supplierHourRateOOH\n        supplierHourRatePremium\n        minimumInterval\n        minimumLength\n        status\n        createdAt\n      }\n      sla: SLA {\n        id\n        name\n        notes\n        normalRate\n        oohRate\n        premiumRate\n        onSite\n        onSiteUnit\n        jobReport\n        jobReportUnit\n        completion\n        completionUnit\n        minimumInterval\n        minimumLength\n      }\n      media: Media {\n        id\n        item: Medium {\n          id\n          category\n          filename\n          meta\n          name\n          type\n        }\n      }\n      supplier: Supplier {\n        ...AccountFields\n        contactUsers: Account_Users(where: { isContact: { _eq: true } }) {\n          role\n          position\n          isContact\n          lastSignInAt\n          userId\n          user: User {\n            ...UserFields\n          }\n        }\n        services: Services(where: { entity: { _eq: "Account" } }) {\n          id\n          dayRate\n          dayRateOOH\n          dayRatePremium\n          hourRate\n          hourRateOOH\n          hourRatePremium\n          minimumInterval\n          minimumLength\n          callOutHourRate\n          callOutHourRateOOH\n          callOutHourRatePremium\n          notes\n          delivery\n          createdAt\n          updatedAt\n          entity\n          entityId\n          serviceId\n          service: Service {\n            id\n            name\n            countryId\n            currencyId\n            customerDayRate\n            customerDayRateOOH\n            customerDayRatePremium\n            customerHourRate\n            customerHourRateOOH\n            customerHourRatePremium\n            supplierDayRate\n            supplierDayRateOOH\n            supplierDayRatePremium\n            supplierHourRate\n            supplierHourRateOOH\n            supplierHourRatePremium\n            minimumInterval\n            minimumLength\n          }\n        }\n      }\n      financeLogs: JobFinanceLogs(order_by: { createdAt: desc }) {\n        id\n        type\n        value\n        difference\n        createdAt\n      }\n      supplierOffers: SupplierOffers {\n        id\n        status\n        rate\n        dayRate\n        meta\n        notes\n        statusLog\n        account: Supplier {\n          id\n          type\n          name\n        }\n      }\n      manager: Manager {\n        ...UserFields\n      }\n      tenantUser: TenantUser {\n        ...UserFields\n      }\n      quotations: SupplierQuotes {\n        id\n        quoteNumber\n        accountId\n        methodStatement\n        notes\n        quoteNumber\n        startDate\n        status\n        totalDuration\n        totalDurationUnit\n        createdAt\n        updatedAt\n        siteVisitAt\n        type\n        lineItems: SupplierQuoteLineItems {\n          id\n          description\n          item\n          qty\n          qtyUnit\n          quoteId\n          total\n          type\n          unitRate\n          supplierTotal\n        }\n        supplier: Supplier {\n          id\n          type\n          name\n          accountUsers: Account_Users {\n            user: User {\n              id\n              fullName\n              nameFirst\n              nameLast\n              phone\n              email\n              devices: UserDevices(where: { status: { _eq: "active" } }) {\n                id\n                playerId\n              }\n            }\n          }\n        }\n      }\n      timings: JobTimings(order_by: { id: desc }) {\n        id\n        status\n        notes\n        meta\n        quoteId\n        createdAt\n        user: User {\n          id\n          fullName\n        }\n      }\n    }\n  }\n  ',"\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n"])),eu.z,el.WW,el.MR,ec.aL,ec.pf,ec.H_,ed.Px),em=(0,es.Ps)(i||(i=(0,ea.Z)(['\n  query GetJob($adminId: Int!, $number: String!) {\n    job: Job(where: { adminId: { _eq: $adminId }, number: { _eq: $number } }) {\n      ...JobFields\n      ...JobQuoteFields\n      ...JobSupplierFields\n      reportPassFail\n      reportPassFailTitle\n      requireReportRecommendations\n      estimatedDuration\n      estimatedDurationUnit\n      anyTimeOption\n      hourStart\n      hourEnd\n      onSiteTimingEnd\n      meta\n      permitsLinks\n      relatedLinks\n      supplierVatTotal: supplierFinances(path: "amountInfo.vatTotal")\n      assets: Assets {\n        id\n        status\n        asset: Asset {\n          id\n          name\n        }\n      }\n      ppmInvoices: AccountEntries {\n        Invoices {\n          id\n          invoiceNumber\n          invoiceType\n          meta\n          createdAt\n          accountEntry: AccountEntry {\n            id\n          }\n        }\n      }\n      invoices: Invoices(order_by: { createdAt: desc }) {\n        id\n        invoiceNumber\n        invoiceType\n        createdAt\n        amounts\n        reconciledAmount: AccountEntry {\n          reconciliations: InvoiceReconciliations_aggregate {\n            aggregate {\n              sum {\n                amount\n              }\n            }\n          }\n        }\n      }\n      jobScheduleId\n      shortJobDesc: Taxonomy(where: { Taxonomy: { type: { _eq: "jobTags" } } }) {\n        id\n        taxonomyId\n        comments\n        taxonomy: Taxonomy {\n          name\n        }\n      }\n      supplierId\n      customerId\n      customerUserId\n      locationId\n      parentJob: ParentJob {\n        createdAt\n        id\n        number\n        reference\n        status\n        title\n        type\n      }\n      childJobs: Jobs {\n        createdAt\n        id\n        number\n        reference\n        status\n        title\n        type\n      }\n      admin: Admin {\n        id\n        name\n        meta\n        bankAccounts: BankAccounts {\n          id\n          bank\n          stripeId\n          accountNumber\n          routingNumber\n          bic\n          iban\n          status\n          default\n          createdAt\n        }\n        addresses: Addresses {\n          id\n          registered\n          operating\n          trading\n          invoice\n          status\n          createdAt\n          address: Address {\n            id\n            name\n            addressLine1\n            addressLine2\n            addressLine3\n            city\n            county\n            geo\n            postCode\n            country: Country {\n              id\n              name\n            }\n          }\n        }\n      }\n      customer: Customer {\n        id\n        name\n      }\n\n      compliances: Compliances(where: { entity: { _eq: "Job" } }) {\n        id\n        compliance: Compliance {\n          id\n          name\n        }\n      }\n\n      expenses: Expenses {\n        id\n        amount\n        description\n        markup\n        total\n        unit\n        vat\n        paid\n      }\n      location: Location {\n        id\n        name\n        permitsRequired\n        addresses: Addresses(where: { entity: { _eq: "Location" } }) {\n          ...AddressEntityFields\n          address: Address {\n            ...AddressFields\n            country: Country {\n              id\n              name\n            }\n          }\n        }\n        slas: SLAs(where: { entity: { _eq: "Location" } }) {\n          id\n          entity\n          entityId\n          onSite\n          onSiteUnit\n          jobReport\n          jobReportUnit\n          completion\n          completionUnit\n          notes\n          inUse\n          normalRate\n          oohRate\n          premiumRate\n          minimumInterval\n          minimumLength\n          slaId\n          sla: SLA {\n            id\n            name\n            notes\n            normalRate\n            oohRate\n            premiumRate\n            onSite\n            onSiteUnit\n            jobReport\n            jobReportUnit\n            completion\n            completionUnit\n            minimumInterval\n            minimumLength\n          }\n        }\n        services: Services(where: { entity: { _eq: "Location" } }) {\n          id\n          dayRate\n          dayRateOOH\n          dayRatePremium\n          hourRate\n          hourRateOOH\n          hourRatePremium\n          minimumInterval\n          minimumLength\n          callOutHourRate\n          callOutHourRateOOH\n          callOutHourRatePremium\n          notes\n          delivery\n          createdAt\n          updatedAt\n          entity\n          entityId\n          serviceId\n          service: Service {\n            id\n            name\n            countryId\n            currencyId\n            customerDayRate\n            customerDayRateOOH\n            customerDayRatePremium\n            customerHourRate\n            customerHourRateOOH\n            customerHourRatePremium\n            supplierDayRate\n            supplierDayRateOOH\n            supplierDayRatePremium\n            supplierHourRate\n            supplierHourRateOOH\n            supplierHourRatePremium\n            minimumInterval\n            minimumLength\n          }\n        }\n      }\n      sublocation: Sublocation {\n        id\n        name\n      }\n      report: JobReport {\n        id\n        completion\n        notes\n        timing\n        passFailStatus\n        recommendations\n        comments\n        createdAt\n        updatedAt\n        meta\n      }\n      service: Service {\n        id\n        name\n        countryId\n        currencyId\n        customerDayRate\n        customerDayRateOOH\n        customerDayRatePremium\n        customerHourRate\n        customerHourRateOOH\n        customerHourRatePremium\n        supplierDayRate\n        supplierDayRateOOH\n        supplierDayRatePremium\n        supplierHourRate\n        supplierHourRateOOH\n        supplierHourRatePremium\n        minimumInterval\n        minimumLength\n        status\n        createdAt\n      }\n      sla: SLA {\n        id\n        name\n        notes\n        normalRate\n        oohRate\n        premiumRate\n        onSite\n        onSiteUnit\n        jobReport\n        jobReportUnit\n        completion\n        completionUnit\n        minimumInterval\n        minimumLength\n      }\n      media: Media {\n        id\n        item: Medium {\n          id\n          category\n          filename\n          meta\n          name\n          type\n        }\n      }\n      supplier: Supplier {\n        ...AccountFields\n        contactUsers: Account_Users(where: { isContact: { _eq: true } }) {\n          role\n          position\n          isContact\n          lastSignInAt\n          userId\n          user: User {\n            ...UserFields\n          }\n        }\n        services: Services(where: { entity: { _eq: "Account" } }) {\n          id\n          dayRate\n          dayRateOOH\n          dayRatePremium\n          hourRate\n          hourRateOOH\n          hourRatePremium\n          minimumInterval\n          minimumLength\n          callOutHourRate\n          callOutHourRateOOH\n          callOutHourRatePremium\n          notes\n          delivery\n          createdAt\n          updatedAt\n          entity\n          entityId\n          serviceId\n          service: Service {\n            id\n            name\n            countryId\n            currencyId\n            customerDayRate\n            customerDayRateOOH\n            customerDayRatePremium\n            customerHourRate\n            customerHourRateOOH\n            customerHourRatePremium\n            supplierDayRate\n            supplierDayRateOOH\n            supplierDayRatePremium\n            supplierHourRate\n            supplierHourRateOOH\n            supplierHourRatePremium\n            minimumInterval\n            minimumLength\n          }\n        }\n      }\n      financeLogs: JobFinanceLogs(order_by: { createdAt: desc }) {\n        id\n        type\n        value\n        difference\n        createdAt\n      }\n      supplierOffers: SupplierOffers {\n        id\n        status\n        rate\n        dayRate\n        meta\n        notes\n        statusLog\n        account: Supplier {\n          id\n          type\n          name\n        }\n      }\n      manager: Manager {\n        ...UserFields\n      }\n      tenantUser: TenantUser {\n        ...UserFields\n      }\n      quotations: SupplierQuotes {\n        id\n        quoteNumber\n        accountId\n        methodStatement\n        notes\n        quoteNumber\n        startDate\n        status\n        totalDuration\n        totalDurationUnit\n        createdAt\n        updatedAt\n        siteVisitAt\n        type\n        lineItems: SupplierQuoteLineItems {\n          id\n          description\n          item\n          qty\n          qtyUnit\n          quoteId\n          total\n          type\n          unitRate\n          supplierTotal\n        }\n        supplier: Supplier {\n          id\n          type\n          name\n          accountUsers: Account_Users {\n            user: User {\n              id\n              fullName\n              nameFirst\n              nameLast\n              phone\n              email\n              devices: UserDevices(where: { status: { _eq: "active" } }) {\n                id\n                playerId\n              }\n            }\n          }\n        }\n      }\n      timings: JobTimings(order_by: { id: desc }) {\n        id\n        status\n        notes\n        meta\n        quoteId\n        createdAt\n        user: User {\n          id\n          fullName\n        }\n      }\n    }\n  }\n  ',"\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n"])),eu.z,el.WW,el.MR,ec.aL,ec.pf,ec.H_,ed.Px),ef=(0,es.Ps)(o||(o=(0,ea.Z)(['\n  query GetJob($adminId: Int!, $number: String!) {\n    job: Job(where: { adminId: { _eq: $adminId }, number: { _eq: $number } }) {\n      ...JobFields\n      ...JobQuoteFields\n      ...JobSupplierFields\n      customerId\n      locationId\n      estimatedDuration\n      estimatedDurationUnit\n      meta\n      permitsLinks\n      relatedLinks\n      assets: Assets {\n        id\n        status\n        asset: Asset {\n          id\n          name\n        }\n      }\n      ppmInvoices: AccountEntries {\n        Invoices {\n          id\n          invoiceNumber\n          invoiceType\n          meta\n          createdAt\n          accountEntry: AccountEntry {\n            id\n          }\n        }\n      }\n      invoices: Invoices(order_by: { createdAt: desc }) {\n        id\n        invoiceNumber\n        invoiceType\n        createdAt\n        amounts\n        reconciledAmount: AccountEntry {\n          reconciliations: InvoiceReconciliations_aggregate {\n            aggregate {\n              sum {\n                amount\n              }\n            }\n          }\n        }\n      }\n      financeLogs: JobFinanceLogs(order_by: { createdAt: desc }) {\n        id\n        type\n        value\n        difference\n        createdAt\n      }\n      admin: Admin {\n        id\n        name\n        meta\n      }\n      customer: Customer {\n        id\n        name\n      }\n      compliances: Compliances(where: { entity: { _eq: "Job" } }) {\n        id\n        compliance: Compliance {\n          id\n          name\n        }\n      }\n      expenses: Expenses {\n        id\n        paid\n        description\n        amount\n        markup\n        vat\n      }\n      location: Location {\n        id\n        name\n        permitsRequired\n        addresses: Addresses(where: { entity: { _eq: "Location" } }) {\n          ...AddressEntityFields\n          address: Address {\n            ...AddressFields\n            country: Country {\n              id\n              name\n            }\n          }\n        }\n        slas: SLAs(where: { entity: { _eq: "Location" } }) {\n          id\n          entity\n          entityId\n          onSite\n          onSiteUnit\n          jobReport\n          jobReportUnit\n          completion\n          completionUnit\n          notes\n          inUse\n          normalRate\n          oohRate\n          premiumRate\n          minimumInterval\n          minimumLength\n          slaId\n          sla: SLA {\n            id\n            name\n            notes\n            normalRate\n            oohRate\n            premiumRate\n            onSite\n            onSiteUnit\n            jobReport\n            jobReportUnit\n            completion\n            completionUnit\n            minimumInterval\n            minimumLength\n          }\n        }\n        services: Services(where: { entity: { _eq: "Location" } }) {\n          id\n          dayRate\n          dayRateOOH\n          dayRatePremium\n          hourRate\n          hourRateOOH\n          hourRatePremium\n          minimumInterval\n          minimumLength\n          callOutHourRate\n          callOutHourRateOOH\n          callOutHourRatePremium\n          notes\n          delivery\n          createdAt\n          updatedAt\n          entity\n          entityId\n          serviceId\n          service: Service {\n            id\n            name\n            countryId\n            currencyId\n            customerDayRate\n            customerDayRateOOH\n            customerDayRatePremium\n            customerHourRate\n            customerHourRateOOH\n            customerHourRatePremium\n            supplierDayRate\n            supplierDayRateOOH\n            supplierDayRatePremium\n            supplierHourRate\n            supplierHourRateOOH\n            supplierHourRatePremium\n            minimumInterval\n            minimumLength\n          }\n        }\n      }\n      sublocation: Sublocation {\n        id\n        name\n      }\n      report: JobReport {\n        id\n        completion\n        notes\n        timing\n        passFailStatus\n        recommendations\n        comments\n        createdAt\n        updatedAt\n        meta\n      }\n      service: Service {\n        id\n        name\n        countryId\n        currencyId\n        customerDayRate\n        customerDayRateOOH\n        customerDayRatePremium\n        customerHourRate\n        customerHourRateOOH\n        customerHourRatePremium\n        supplierDayRate\n        supplierDayRateOOH\n        supplierDayRatePremium\n        supplierHourRate\n        supplierHourRateOOH\n        supplierHourRatePremium\n        minimumInterval\n        minimumLength\n        status\n        createdAt\n      }\n      sla: SLA {\n        id\n        name\n        notes\n        normalRate\n        oohRate\n        premiumRate\n        onSite\n        onSiteUnit\n        jobReport\n        jobReportUnit\n        completion\n        completionUnit\n        minimumInterval\n        minimumLength\n      }\n      media: Media {\n        id\n        item: Medium {\n          id\n          category\n          filename\n          meta\n          name\n          type\n        }\n      }\n      supplier: Supplier {\n        ...AccountFields\n        contactUsers: Account_Users(where: { isContact: { _eq: true } }) {\n          role\n          position\n          isContact\n          lastSignInAt\n          userId\n          user: User {\n            ...UserFields\n          }\n        }\n        services: Services(where: { entity: { _eq: "Account" } }) {\n          id\n          dayRate\n          dayRateOOH\n          dayRatePremium\n          hourRate\n          hourRateOOH\n          hourRatePremium\n          minimumInterval\n          minimumLength\n          callOutHourRate\n          callOutHourRateOOH\n          callOutHourRatePremium\n          notes\n          delivery\n          createdAt\n          updatedAt\n          entity\n          entityId\n          serviceId\n          service: Service {\n            id\n            name\n            countryId\n            currencyId\n            customerDayRate\n            customerDayRateOOH\n            customerDayRatePremium\n            customerHourRate\n            customerHourRateOOH\n            customerHourRatePremium\n            supplierDayRate\n            supplierDayRateOOH\n            supplierDayRatePremium\n            supplierHourRate\n            supplierHourRateOOH\n            supplierHourRatePremium\n            minimumInterval\n            minimumLength\n          }\n        }\n      }\n      supplierOffers: SupplierOffers {\n        id\n        status\n        rate\n        dayRate\n        meta\n        notes\n        account: Supplier {\n          id\n          type\n          name\n        }\n      }\n      manager: Manager {\n        ...UserFields\n      }\n      tenantUser: TenantUser {\n        ...UserFields\n      }\n      quotations: SupplierQuotes(\n        where: { status: { _neq: "cancelled" } }\n        order_by: { quoteNumber: asc }\n      ) {\n        id\n        quoteNumber\n        accountId\n        methodStatement\n        notes\n        quoteNumber\n        recommended\n        startDate\n        status\n        totalDuration\n        totalDurationUnit\n        createdAt\n        updatedAt\n        siteVisitAt\n        type\n        lineItems: SupplierQuoteLineItems {\n          id\n          description\n          item\n          qty\n          qtyUnit\n          quoteId\n          total\n          type\n          unitRate\n          supplierTotal\n        }\n        supplier: Supplier {\n          id\n          type\n          name\n        }\n      }\n      timings: JobTimings(order_by: { id: desc }) {\n        id\n        status\n        notes\n        meta\n        quoteId\n        createdAt\n        user: User {\n          id\n          fullName\n        }\n      }\n      shortJobDesc: Taxonomy(where: { Taxonomy: { type: { _eq: "jobTags" } } }) {\n        id\n        taxonomyId\n        comments\n        taxonomy: Taxonomy {\n          name\n        }\n      }\n      answers: Taxonomy(\n        where: { Taxonomy: { type: { _eq: "jobQuestion" } } }\n        order_by: { taxonomyId: asc }\n      ) {\n        id\n        taxonomyId\n        comments\n        taxonomy: Taxonomy {\n          name\n        }\n      }\n      costCategoryTaxonomy: CostCategory {\n        id\n        name\n      }\n      parentJob: ParentJob {\n        createdAt\n        id\n        number\n        reference\n        status\n        title\n      }\n      childJobs: Jobs {\n        createdAt\n        id\n        number\n        reference\n        status\n        title\n      }\n    }\n  }\n  ',"\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n"])),eu.z,el.WW,el.MR,ec.aL,ec.pf,ec.H_,ed.Px),ev=(0,es.Ps)(a||(a=(0,ea.Z)(["\n  mutation UpdateJob(\n    $id: Int!\n    $changes: Job_set_input\n    $deleteTiming: JobTiming_bool_exp!\n    $insertTiming: [JobTiming_insert_input!]!\n  ) {\n    update_Job_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n    delete_JobTiming(where: $deleteTiming) {\n      returning {\n        id\n      }\n    }\n    insert_JobTiming(objects: $insertTiming) {\n      returning {\n        id\n      }\n    }\n    delete_JobFinanceLog(where: { system: { _eq: true }, jobId: { _eq: $id } }) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),eh=n(50029),eb=n(16835),ex=n(64687),ej=n.n(ex),eg=n(66252),ey=n(50319),eZ=n(5616),ew=n(86532),eO=n(38895),eI=n(15861),eS=n(22797),eP=n(86886),eC=n(11057),eD=n(26447),eR=n(78289),ek=n(70983),eE=n(67983),eA=n(19370),eq=n(44472),eT=n(90948),e_=n(14621),e$=n(57249),eH=n(10556),eN=n(70490),eM=n(66647),eF=n(1698),eJ=n(85893),eL=function(e){var t=e.steps,n=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return e.filter(function(e){return!!e.active})},r=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return e.filter(function(e){var t=e.active,n=e.data;return!!t&&!!n})};return(0,eJ.jsx)(eZ.Z,{children:(0,eJ.jsx)(eA.Z,{orientation:"vertical",connector:(0,eJ.jsx)(eU,{}),children:t.filter(function(e){var t=e.active;return void 0===t||t}).map(function(e,t){var i=e.id,o=e.label,a=e.info,s=e.date,c=e.content,u=e.actions,l=!!s,d=r(c),p=n(u),m=l?(0,eJ.jsx)(ek.Z,{color:"primary"}):(0,eJ.jsx)(eE.Z,{color:"primary"});return(0,eJ.jsxs)(eq.Z,{completed:l,expanded:!0,children:[(0,eJ.jsxs)(eQ,{icon:m,children:[(0,eJ.jsx)(eI.Z,{sx:{fontSize:"13px",fontWeight:600},children:o}),(0,eJ.jsx)(eI.Z,{sx:{fontSize:"10px",fontWeight:400,ml:3,opacity:.6},children:s})]}),(0,eJ.jsxs)(eV,{children:[(0,eJ.jsx)(eZ.Z,{children:l||(null==d?void 0:d.length)>0?d.map(function(e){return"function"==typeof e.data?e.data():(0,eJ.jsx)(eI.Z,{sx:{fontSize:"10px"},children:e.data})}):(0,eJ.jsx)(eI.Z,{sx:{fontSize:"10px",fontStyle:"italic"},children:a})}),(null==p?void 0:p.length)>0&&(0,eJ.jsx)(eD.Z,{mt:.5,spacing:.5,children:p.map(function(e){return"button"!==e.type?null:(0,eJ.jsx)(eZ.Z,{children:(0,eJ.jsx)(eC.Z,{color:e.context,variant:"contained",size:"small",onClick:e.handleClick,children:e.content})})})})]})]},"".concat(o,"-").concat(i))})})})},eU=(0,eT.ZP)(e_.Z)(function(e){var t,n=e.theme;return t={},(0,W.Z)(t,"&.".concat(e$.Z.active),(0,W.Z)({},"& .".concat(e$.Z.line),{borderColor:n.palette.primary.main})),(0,W.Z)(t,"&.".concat(e$.Z.completed),(0,W.Z)({},"& .".concat(e$.Z.line),{borderColor:n.palette.primary.main})),(0,W.Z)(t,"& .".concat(e$.Z.line),{borderColor:n.palette.primary.main,borderLeftWidth:4,borderRadius:1,marginLeft:"-2px"}),t}),eV=(0,eT.ZP)(eH.Z)(function(e){var t=e.theme;return(0,W.Z)({},"&.".concat(eN.Z.root),{borderColor:t.palette.primary.main,borderLeftWidth:4,marginLeft:"10px"})}),eQ=(0,eT.ZP)(eM.Z)(function(e){var t;return e.theme,t={},(0,W.Z)(t,"&.".concat(eF.Z.root),{padding:0}),(0,W.Z)(t,"& .".concat(eF.Z.labelContainer),{color:"inherit"}),(0,W.Z)(t,"& .".concat(eF.Z.label),{display:"flex",alignItems:"center",color:"inherit"}),t}),ez=n(51797),eY=n(91613),eB=n(25213),eG=n(31181),eW=n(27434),eK=n(34197),eX=n(30381),e0=n.n(eX),e1=n(11082),e2=n(26186),e3=n(51555),e6=n(42283),e5=n(79665),e4=n(76600),e7=n(92264),e8=n(71772),e9=n(74231),te=(0,e9.Ry)().shape({serviceSelected:(0,e9.Ry)().required()});function tt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function tn(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?tt(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):tt(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var tr,ti=function(e){var t,n=e.job,r=e.refetch,i=e.toggleShow,o=(0,K.useContext)(et.Z).user,a=(0,e6.cI)({defaultValues:{serviceSelected:n.serviceId},resolver:(0,e5.S)(te)}),s=a.errors,c=a.handleSubmit,u=a.register,l=a.control,d=(0,ey.D)(ec.xY,{onCompleted:function(){r&&r(),i()}}),p=(0,eb.Z)(d,1)[0],m=(t=(0,eh.Z)(ej().mark(function e(t){var r;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r={status:"raised",quoted:!1,type:"reactive",serviceId:t.serviceSelected.value},e.next=3,p({variables:{id:n.id,changes:r,timing:{notes:t.comments,status:"raised",jobId:n.id,userId:o.id}}}).then(function(){return i()});case 3:case"end":return e.stop()}},e)})),function(e){return t.apply(this,arguments)});return(0,eJ.jsxs)(e4.Z,{handleSubmit:c(m),children:[(0,eJ.jsx)(e8.P,tn(tn({},{control:l,errors:s,register:u}),{},{errors:tn({},s),name:"serviceSelected",label:"Service",type:"service"})),(0,eJ.jsx)(e7.H,{content:"Submit",type:"submit"})]})},to=(tr=(0,eh.Z)(ej().mark(function e(t,n,r){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,eJ.jsx)(ti,{job:t,toggleShow:n.show,refetch:r}),submit:!1,title:"Make reactive"});case 1:case"end":return e.stop()}},e)})),function(e,t,n){return tr.apply(this,arguments)}),ta=n(51040),ts=n(15214),tc=n(58594),tu=n(90951),tl=n(49501),td=n(55563),tp=n(77439),tm=n(51466),tf=function(){var e,t=(e=(0,eh.Z)(ej().mark(function e(){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}},e)})),function(){return e.apply(this,arguments)});return(0,eJ.jsxs)(eJ.Fragment,{children:[(0,eJ.jsx)(tm.Z,{children:"No completed quotes"}),(0,eJ.jsx)(tp.Z,{content:"Resend notification to selected supplier(s)",size:"sm",onClick:t})]})},tv=n(52696),th=function(e,t,n){var r,i=null==t?void 0:null===(r=t.slice())||void 0===r?void 0:r.sort(function(e,t){return t.id-e.id});return null==i?void 0:i.find(function(t){return t.status==="".concat(e,"QuoteThresholdApproval")&&n===t.quoteId})},tb=function(e,t,n){var r,i=null==t?void 0:null===(r=t.slice())||void 0===r?void 0:r.sort(function(e,t){return t.id-e.id});return null==i?void 0:i.find(function(t){return t.status==="".concat(e,"QuoteThresholdApproved")&&n===t.quoteId})},tx=function(e,t,n){var r,i=null==t?void 0:null===(r=t.slice())||void 0===r?void 0:r.sort(function(e,t){return t.id-e.id});return null==i?void 0:i.find(function(t){return t.status==="".concat(e,"QuoteThresholdRejected")&&n===t.quoteId})},tj=function(e,t){var n,r=null==t?void 0:null===(n=t.slice())||void 0===n?void 0:n.sort(function(e,t){return t.id-e.id});return null==r?void 0:r.find(function(t){return t.status==="".concat(e,"ThresholdApproval")})},tg=function(e,t){var n,r=null==t?void 0:null===(n=t.slice())||void 0===n?void 0:n.sort(function(e,t){return t.id-e.id});if(Array.isArray(e)){var i=null;return e.forEach(function(e){i=(null==r?void 0:r.find(function(t){return t.status==="".concat(e,"ThresholdApproved")}))||i}),i}return null==r?void 0:r.find(function(t){return t.status==="".concat(e,"ThresholdApproved")})},ty=function(e,t){var n,r=null==t?void 0:null===(n=t.slice())||void 0===n?void 0:n.sort(function(e,t){return t.id-e.id});return null==r?void 0:r.find(function(t){return t.status==="".concat(e,"ThresholdRejected")})},tZ=n(50558);function tw(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function tO(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?tw(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):tw(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var tI,tS=function(e){var t,n=e.job,r=e.user,i=e.quotations,o=e.refetch,a=e.toggleShow,s=(0,eg.x)(),c=(0,K.useContext)(eR.Z),u=null==r?void 0:r.quoteThreshold,l=i.filter(function(e){return["supplierQuoteComplete","supplierQuoteSent","thresholdApproved","waitingThresholdApproval"].includes(e.status)}),d=(0,e6.cI)({defaultValues:{selectedQuotes:n.selectedQuotes||[]}}),p=d.errors,m=d.handleSubmit,f=d.register,v=d.watch,h=(0,K.useState)(0),b=h[0],x=h[1],j=(0,K.useState)([]),g=j[0],y=j[1],Z=v(),w=Z.selectedQuotes,O=Z.sendQuote,I=w&&w.length>0;(0,K.useEffect)(function(){var e=l.filter(function(e){var t=1.2*e.lineItems.reduce(function(e,t){return e+t.total},0);return!(!w.includes("".concat(e.id))||(0,tZ.il)(u,t)||tb("adminCustomer",null==n?void 0:n.timings,e.id))&&(t>b&&x(t),!0)});y(e)},[w]);var S,P,C=(0,ey.D)(ta.Dg),D=(0,eb.Z)(C,1)[0],R=(0,ey.D)(ec.xY,{onCompleted:function(){o&&o(),a()}}),k=(0,eb.Z)(R,1)[0],E=(0,ey.D)(ec.yT),A=(0,eb.Z)(E,1)[0],q=l.map(function(e){return{id:e.id,label:e.quoteNumber,value:e.id}}),T=(P=(0,eh.Z)(ej().mark(function e(t){var i,o,a;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i=tO({},n.meta)||{},"string"==typeof t.selectedQuotes&&(t.selectedQuotes=[t.selectedQuotes]),o=[],e.next=5,Promise.all(t.selectedQuotes.map(function(){var e=(0,eh.Z)(ej().mark(function e(t){var r,i;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=q.find(function(e){return Number(t)===e.id}),e.next=3,(0,e3.L)(n,Number(t),s);case 3:return i=e.sent,o.push({label:r.label,url:i}),e.abrupt("return",D({variables:{id:t,changes:{status:"supplierQuoteSent"},supplierOffer:[]}}));case 6:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}()));case 5:a="quoteSent","sendQuote"===O&&t.sendQuote&&t.quotingEmail&&A({variables:{timing:{status:"quotePDFSent",jobId:n.id,userId:r.id,meta:{toEmail:t.quotingEmail,selectedQuotations:o}}}}),k({variables:{id:n.id,changes:{status:a,meta:i},timing:{status:a,jobId:n.id,userId:r.id},_append:{statusData:(0,W.Z)({},a,e0()().toISOString())}}});case 8:case"end":return e.stop()}},e)})),function(e){return P.apply(this,arguments)});if(0===l.length)return(0,eJ.jsx)(tf,{});var _={errors:p,register:f};return(0,eJ.jsxs)(e4.Z,{handleSubmit:m(T),children:[g.length>0&&(0,eJ.jsx)(ts.Z,{content:"Based on your user settings, this quote requires approval before it can be sent.\n          Please request approval by clicking the button below.",context:"warning"}),(0,eJ.jsx)(tc.Z,tO(tO({},_),{},{data:q,legend:"Select quotations",name:"selectedQuotes"})),(0,eJ.jsx)(tu.Z,tO(tO({},_),{},{data:[{id:"sendQuote",label:"Send quote via email",value:"sendQuote"},{id:"markAsQuoteSent",label:"Mark quote as sent",value:"markAsQuoteSent"}],name:"sendQuote",stacked:!0})),"sendQuote"===O&&(0,eJ.jsx)(tl.Z,{label:"Send to email address",children:(0,eJ.jsx)(td.Z,tO(tO({},_),{},{defaultValue:null===(t=n.supplier)||void 0===t?void 0:t.details[0].quotingEmail,name:"quotingEmail"}))}),g.length>0?(0,eJ.jsx)(tp.Z,{content:"Request approval",size:"md",disabled:!I,onClick:function(){return(0,tv.I_)({type:"quote",role:"adminCustomer",quotations:g,jobId:n.id,accountId:r.accountId,amount:b,offCanvas:c})}}):(0,eJ.jsx)("div",{style:{marginTop:"10px"},children:(0,eJ.jsx)(tp.Z,{content:"Send Quotation(s)",size:"md",type:"submit",disabled:!I})})]})},tP=function(e,t,n,r){n.show({content:(0,eJ.jsx)(tS,{job:e,user:t,quotations:e.quotations,refetch:r,toggleShow:n.close}),submit:!1,title:"Send Quote"})},tC=n(6710),tD=n(11552),tR=function(e){var t,n,r=e.job,i=e.refetch,o=e.status,a=e.toggleShow,s=e.onClose,c=e.shouldCalculateFinance,u=(0,eg.x)(),l=(0,K.useContext)(et.Z).user,d=(0,e6.cI)({defaultValues:{comments:""}}),p=d.errors,m=d.handleSubmit,f=d.register,v=(0,ey.D)(ec.xY,{onCompleted:(t=(0,eh.Z)(ej().mark(function e(){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!c){e.next=5;break}return e.next=3,(0,tD.F)(u,r.id);case 3:i&&i(),a();case 5:case"end":return e.stop()}},e)})),function(){return t.apply(this,arguments)}),refetchQueries:["GetJob"]}),h=(0,eb.Z)(v,1)[0],b=(n=(0,eh.Z)(ej().mark(function e(t){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:h({variables:{id:r.id,changes:{status:o},timing:{notes:t.comments,status:o,jobId:r.id,userId:l.id}}}).then(function(){s()}).catch(function(e){});case 1:case"end":return e.stop()}},e)})),function(e){return n.apply(this,arguments)});return(0,eJ.jsxs)(e4.Z,{handleSubmit:m(b),children:[(0,eJ.jsx)(tl.Z,{label:"Comments",children:(0,eJ.jsx)(tC.Z,{errors:p,name:"comments",register:f,rows:3})}),(0,eJ.jsx)(e7.H,{content:"Submit",type:"submit"})]})},tk=(tI=(0,eh.Z)(ej().mark(function e(t,n,r,i,o){var a;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:a=(null!=o?o:{shouldCalculateFinance:!0}).shouldCalculateFinance,r.show({content:(0,eJ.jsx)(tR,{job:t,status:n,toggleShow:r.show,refetch:i,onClose:r.close,shouldCalculateFinance:a}),submit:!1,title:"Job status change"});case 2:case"end":return e.stop()}},e)})),function(e,t,n,r,i){return tI.apply(this,arguments)}),tE=n(95103),tA=n(52220);function tq(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function tT(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?tq(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):tq(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var t_=[1,2,3].map(function(e){return{text:e,value:e,disabled:!1}}),t$=function(e){var t,n=e.job,r=e.toggleShow,i=e.updateJob,o=e.addJobTiming,a=e.user,s=(0,e6.cI)(),c=s.control,u=s.errors,l=s.handleSubmit,d=s.register,p=(t=(0,eh.Z)(ej().mark(function e(t){var s;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t.status="quoteNew",t.type="quote",t.quoteDue=e0()(t.quoteDue).format(),t.quoted=!0,s={notes:"Compliance to Quote",status:"quoteNew",jobId:n.id,userId:a.id},e.next=7,o({variables:{objects:[s]}});case 7:return e.next=9,i({variables:{id:n.id,changes:t}}).then(function(){r()});case 9:case"end":return e.stop()}},e)})),function(e){return t.apply(this,arguments)}),m={control:c,errors:u,register:d};return(0,eJ.jsxs)(e4.Z,{handleSubmit:l(p),children:[(0,eJ.jsx)(tl.Z,{label:"Number of Quotes",children:(0,eJ.jsx)(tE.Z,tT(tT({},m),{},{name:"quoteNumber",options:[{text:"Select Type",value:"",disabled:!1}].concat((0,en.Z)(t_))}))}),(0,eJ.jsx)(tl.Z,{label:"Quote due date"}),(0,eJ.jsx)(tA.M,tT(tT({},m),{},{name:"quoteDue"})),(0,eJ.jsx)(e7.H,{content:"Create quote",size:"md",type:"submit"})]})},tH=n(9270),tN=n(62140),tM=n(58965),tF=n(84083),tJ=function(e){return(0,e9.Ry)().shape((0,W.Z)({},e,(0,e9.Rx)().required()))},tL=n(39179),tU=n(26936),tV=function(e){var t=e.defaultValue,n=e.label,r=e.name,i=e.onSubmit,o=e.rightLabel,a=e.clearLogs,s=(0,e6.cI)({resolver:(0,e5.S)(tJ(r))}),c=s.errors,u=s.handleSubmit,l=s.control,d=s.reset,p=s.setValue;(0,K.useEffect)(function(){isNaN(t)||p(r,t)},[t,r,p]);var m=function(e){i(r,e[r]),d()};return(0,eJ.jsx)("form",{onSubmit:u(m),children:(0,eJ.jsxs)(eP.ZP,{container:!0,children:[(0,eJ.jsx)(eP.ZP,{item:!0,xs:4,children:n&&(0,eJ.jsxs)(eI.Z,{children:[n,":"]})}),(0,eJ.jsx)(eP.ZP,{item:!0,xs:8,children:(0,eJ.jsxs)(eD.Z,{direction:"row",spacing:1,children:[(0,eJ.jsx)(e6.Qr,{name:r,control:l,render:function(e){var t,n=e.value,i=e.onChange;return(0,eJ.jsx)(tL.I,{leftLabel:(0,eJ.jsx)(tU.Z,{sx:{height:"18px"}}),rightLabel:o,sx:{width:"80px"},type:"number",InputProps:{inputProps:{min:0,step:".01"}},value:n,onChange:i,error:c[r],helperText:null===(t=c[r])||void 0===t?void 0:t.message})}}),(0,eJ.jsx)(eC.Z,{size:"small",variant:"contained",color:"danger",onClick:function(){a(r,d)},children:"Clear"}),(0,eJ.jsx)(eC.Z,{size:"small",variant:"contained",type:"submit",children:"Save"})]})})]})})};tV.defaultProps={rightLabel:"Ex Vat"};var tQ=n(10367),tz=n(32979),tY=n(43916),tB=n(19639),tG=function(e){var t=e.defaultValue,n=e.label,r=e.name,i=e.onSubmit,o=(0,e6.cI)({resolver:(0,e5.S)(tJ(r))}),a=o.errors,s=o.handleSubmit,c=o.register,u=o.reset,l=o.setValue;(0,K.useEffect)(function(){t&&l(r,t)},[t]);var d=function(e){i(r,e[r]),u()};return(0,eJ.jsx)(e4.Z,{handleSubmit:s(d),children:(0,eJ.jsx)(tH.Z,{align:"center",children:(0,eJ.jsx)(tN.Z,{md:12,children:(0,eJ.jsx)(tl.Z,{label:n,children:(0,eJ.jsxs)(tW,{children:[(0,eJ.jsx)(tz.Z,{errors:a,name:r,register:c}),(0,eJ.jsx)(tK,{children:(0,eJ.jsx)(tY.Z,{children:(0,eJ.jsx)(tB.Z,{addonType:"append",children:(0,eJ.jsx)(tp.Z,{content:"Save",context:"secondary",type:"submit",size:"sm"})})})})]})})})})})},tW=tQ.ZP.div.withConfig({displayName:"percentInput__StyledWrapper",componentId:"sc-14c0oiw-0"})(["display:flex;"]),tK=tQ.ZP.div.withConfig({displayName:"percentInput__StyledInputGroup",componentId:"sc-14c0oiw-1"})(["display:flex;align-items:center;margin-bottom:9px;"]),tX=n(32836),t0=function(e){var t=e.loading,n=e.logs;return(0,eJ.jsxs)(eD.Z,{children:[(0,eJ.jsx)(eI.Z,{variant:"h6",children:"Change Log"}),(0,eJ.jsx)(tX.i,{columns:[{flex:1,field:"type",headerName:"Type",sortable:!1},{flex:1,field:"value",headerName:"Value",sortable:!1},{flex:1,field:"user",headerName:"User",sortable:!1},{flex:1,field:"date",headerName:"Date",sortable:!1}],loading:t,rows:n.map(function(e){var t;return{id:e.id,type:e.type,value:e.value?"".concat(e.value," (").concat(e.difference>0?"+".concat(e.difference):e.difference||"-",")"):"clear",user:(null===(t=e.meta)||void 0===t?void 0:t.username)||"-",date:e0()(e.createdAt).format("YYYY-MM-DD")}})})]})},t1=n(33908),t2=n(72936),t3=n(30363),t6=n(17386),t5=n(49397),t4=function(e){var t,n,r,i,o,a,s,c,u,l=e.job,d=e.refetchJob,p=e.activeTab,m=(0,t2.x)().user,f=(0,eg.x)(),v=(0,K.useState)(0),h=v[0],b=v[1],x=(!!(null!==(t=l.customer)&&void 0!==t&&null!==(n=t.meta)&&void 0!==n&&null!==(r=n.finance)&&void 0!==r&&r.serviceRateLabour)||!!(null!==(i=l.customer)&&void 0!==i&&null!==(o=i.meta)&&void 0!==o&&null!==(a=o.finance)&&void 0!==a&&a.serviceRateExpenses))&&"supplier"!==p,j=(0,er.a)(eo.bZ,{variables:{jobId:l.id}}),g=j.loading,y=j.data,Z=(y=void 0===y?{logs:[]}:y).logs,w=j.refetch,O=(0,ey.D)(eo.Tw,{onCompleted:(s=(0,eh.Z)(ej().mark(function e(){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!l){e.next=3;break}return e.next=3,(0,tD.F)(f,l.id);case 3:w(),d();case 5:case"end":return e.stop()}},e)})),function(){return s.apply(this,arguments)})}),I=(0,eb.Z)(O,1)[0],S=(c=(0,eh.Z)(ej().mark(function e(t,n){var r,i;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r="timing"!==t?n-(0,t1.B)(t,Z)||0:null,i={type:t,value:n,jobId:l.id,difference:r,meta:{username:"".concat(m.nameFirst," ").concat(m.nameLast),userId:m.id}},e.next=4,I({variables:{objects:[i]}});case 4:case"end":return e.stop()}},e)})),function(e,t){return c.apply(this,arguments)}),P=(u=(0,eh.Z)(ej().mark(function e(t,n){var r,i;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=null,i={type:t,value:null,jobId:l.id,difference:r,meta:{username:"".concat(m.nameFirst," ").concat(m.nameLast),userId:m.id}},e.next=4,I({variables:{objects:[i]}}).then(function(){return n()});case 4:case"end":return e.stop()}},e)})),function(e,t){return u.apply(this,arguments)}),C=function(e,t){b(t)};return(0,eJ.jsxs)(eD.Z,{children:[(0,eJ.jsxs)(eZ.Z,{sx:{width:"100%",height:"100%"},children:[(0,eJ.jsx)(eZ.Z,{children:(0,eJ.jsxs)(t3.m,{value:h,onChange:C,children:[(0,eJ.jsx)(t6.O,{label:"Customer"}),(0,eJ.jsx)(t6.O,{label:"Supplier"})]})}),(0,eJ.jsx)(t5.x,{value:h,index:0,children:(0,eJ.jsxs)(eD.Z,{spacing:2,children:[x&&(0,eJ.jsxs)(eJ.Fragment,{children:[(0,eJ.jsx)(tG,{defaultValue:(0,t1.B)("serviceRateLabour",Z),label:"Service Rate Labour ",name:"serviceRateLabour",onSubmit:S,clearLogs:P}),(0,eJ.jsx)(tG,{defaultValue:(0,t1.B)("serviceRateExpenses",Z),label:"Service Rate Expenses and Materials",name:"serviceRateExpenses",onSubmit:S,clearLogs:P})]}),(0,eJ.jsx)(tV,{defaultValue:(0,t1.B)("discount",Z),label:"Customer discount",name:"discount",onSubmit:S,clearLogs:P,vat:"Ex VAT"}),!x&&"fixed"===l.pricing&&(0,eJ.jsx)(tV,{defaultValue:(0,t1.B)("amount",Z),label:"Amount",name:"amount",onSubmit:S,clearLogs:P,vat:"Ex Vat"}),"time-materials"===l.pricing&&!x&&(0,eJ.jsxs)(eJ.Fragment,{children:[(0,eJ.jsx)(eI.Z,{variant:"h6",children:"Normal"}),(0,eJ.jsx)(tV,{defaultValue:(0,t1.B)("firstHourRateCustomerNormal",Z),label:"First hour rate",name:"firstHourRateCustomerNormal",onSubmit:S,clearLogs:P,vat:"Ex Vat"}),(0,eJ.jsx)(tV,{defaultValue:(0,t1.B)("subsequentHoursRateCustomerNormal",Z),label:"Subsequent hours rate",name:"subsequentHoursRateCustomerNormal",onSubmit:S,clearLogs:P,vat:"Ex Vat"}),(0,eJ.jsx)(eI.Z,{variant:"h6",children:"OOH"}),(0,eJ.jsx)(tV,{defaultValue:(0,t1.B)("firstHourRateCustomerOOH",Z),label:"First hour rate",name:"firstHourRateCustomerOOH",onSubmit:S,clearLogs:P,vat:"Ex Vat"}),(0,eJ.jsx)(tV,{defaultValue:(0,t1.B)("subsequentHoursRateCustomerOOH",Z),label:"Subsequent hours rate",name:"subsequentHoursRateCustomerOOH",onSubmit:S,clearLogs:P,vat:"Ex Vat"}),(0,eJ.jsx)(eI.Z,{variant:"h6",children:"Premium"}),(0,eJ.jsx)(tV,{defaultValue:(0,t1.B)("firstHourRateCustomerPremium",Z),label:"First hour rate",name:"firstHourRateCustomerPremium",onSubmit:S,clearLogs:P,vat:"Ex Vat"}),(0,eJ.jsx)(tV,{defaultValue:(0,t1.B)("subsequentHoursRateCustomerPremium",Z),label:"Subsequent hours rate",name:"subsequentHoursRateCustomerPremium",onSubmit:S,clearLogs:P,vat:"Ex Vat"})]})]})}),(0,eJ.jsx)(t5.x,{value:h,index:1,children:(0,eJ.jsxs)(eD.Z,{spacing:2,children:[(0,eJ.jsx)(tV,{defaultValue:(0,t1.B)("supplierDeduction",Z),label:"Supplier deduction",name:"supplierDeduction",onSubmit:S,clearLogs:P,vat:"Ex VAT"}),"fixed"===l.pricing&&(0,eJ.jsxs)(eJ.Fragment,{children:[(0,eJ.jsx)(tV,{defaultValue:(0,t1.B)("supplierLabourAmount",Z),label:"Supplier labour amount",name:"supplierLabourAmount",onSubmit:S,clearLogs:P,vat:"Ex Vat"}),(0,eJ.jsx)(tV,{defaultValue:(0,t1.B)("supplierMaterialsAmount",Z),label:"Supplier materials amount",name:"supplierMaterialsAmount",onSubmit:S,clearLogs:P,vat:"Ex Vat"})]}),"time-materials"===l.pricing&&(0,eJ.jsxs)(eJ.Fragment,{children:[(0,eJ.jsx)(eI.Z,{variant:"h6",children:"Normal"}),(0,eJ.jsx)(tV,{defaultValue:(0,t1.B)("firstHourRateSupplierNormal",Z),label:"First hour rate",name:"firstHourRateSupplierNormal",onSubmit:S,clearLogs:P,vat:"Ex Vat"}),(0,eJ.jsx)(tV,{defaultValue:(0,t1.B)("subsequentHoursRateSupplierNormal",Z),label:"Subsequent hours rate",name:"subsequentHoursRateSupplierNormal",onSubmit:S,clearLogs:P,vat:"Ex Vat"}),(0,eJ.jsx)(eI.Z,{variant:"h6",children:"OOH"}),(0,eJ.jsx)(tV,{defaultValue:(0,t1.B)("firstHourRateSupplierOOH",Z),label:"First hour rate",name:"firstHourRateSupplierOOH",onSubmit:S,clearLogs:P,vat:"Ex Vat"}),(0,eJ.jsx)(tV,{defaultValue:(0,t1.B)("subsequentHoursRateSupplierOOH",Z),label:"Subsequent hours rate",name:"subsequentHoursRateSupplierOOH",onSubmit:S,clearLogs:P,vat:"Ex Vat"}),(0,eJ.jsx)(eI.Z,{variant:"h6",children:"Premium"}),(0,eJ.jsx)(tV,{defaultValue:(0,t1.B)("firstHourRateSupplierPremium",Z),label:"First hour rate",name:"firstHourRateSupplierPremium",onSubmit:S,clearLogs:P,vat:"Ex Vat"}),(0,eJ.jsx)(tV,{defaultValue:(0,t1.B)("subsequentHoursRateSupplierPremium",Z),label:"Subsequent hours rate",name:"subsequentHoursRateSupplierPremium",onSubmit:S,clearLogs:P,vat:"Ex Vat"})]})]})})]}),(0,eJ.jsx)(t0,{loading:g,logs:Z})]})},t7=n(86036),t8=n(40527),t9=n(9105),ne=n(50135),nt=n(50480),nn=n(69368),nr=n(6054),ni=n(19957),no=n(27940);function na(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function ns(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?na(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):na(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var nc=function(e){var t,n,r,i,o,a,s,c,u,l,d=e.description,p=e.handleWorkDescriptionSubmit,m=e.job,f=e.currentQuestions,v=(0,K.useState)(f),h=v[0],b=v[1],x={};m.shortJobDesc&&m.shortJobDesc.length>0&&(x={value:m.shortJobDesc[0].taxonomyId,label:m.shortJobDesc[0].taxonomy.name});var j=(0,e6.cI)({defaultValues:{description:d,taxonomyId_ShortDesc:x,name:"".concat(null===(t=m.meta)||void 0===t?void 0:null===(n=t.reporter)||void 0===n?void 0:n.nameFirst," ").concat(null===(r=m.meta)||void 0===r?void 0:null===(i=r.reporter)||void 0===i?void 0:i.nameLast),email:null===(o=m.meta)||void 0===o?void 0:null===(a=o.reporter)||void 0===a?void 0:a.email,phone:null===(s=m.meta)||void 0===s?void 0:null===(c=s.reporter)||void 0===c?void 0:c.phone,shouldSendNotifications:null===(u=m.meta)||void 0===u?void 0:null===(l=u.reporter)||void 0===l?void 0:l.shouldSendNotifications}}),g=j.control,y=j.errors,Z=j.handleSubmit,w=j.register,O=j.setValue,I=(0,j.watch)("taxonomyId_ShortDesc",f),S=(0,nr.Z)(I);(0,K.useEffect)(function(){I!==S&&S&&b(I.childs)},[I]);var P={control:g,errors:y,register:w},C=function(e){p(e)},D=function(e){O("questions",JSON.stringify(e)),Z(C)()};return(0,eJ.jsxs)(eJ.Fragment,{children:[(0,eJ.jsxs)(e4.Z,{handleSubmit:Z(C),children:[(0,eJ.jsx)(no.l,ns(ns({},P),{},{label:"Short Job Description",name:"taxonomyId_ShortDesc",type:"jobTags"})),(0,eJ.jsx)(tl.Z,{label:"Work description",children:(0,eJ.jsx)(tC.Z,ns(ns({},P),{},{name:"description",rows:3}))}),(0,eJ.jsxs)(eD.Z,{rowGap:2,children:[(0,eJ.jsx)(eI.Z,{typography:"h6",children:"Originator"}),(0,eJ.jsx)(ne.Z,{name:"name",placeholder:"Name",inputRef:w}),(0,eJ.jsx)(ne.Z,{name:"phone",placeholder:"Phone",inputRef:w}),(0,eJ.jsx)(ne.Z,{name:"email",placeholder:"Email",inputRef:w}),(0,eJ.jsx)(e6.Qr,{control:g,name:"shouldSendNotifications",render:function(e){var t=e.value,n=e.onChange;return(0,eJ.jsx)(nt.Z,{label:"Should originator receive notifications",control:(0,eJ.jsx)(nn.Z,{checked:t,color:"secondary",onChange:function(e){var t;return n(null===(t=e.target)||void 0===t?void 0:t.checked)}})})}})]}),(0,eJ.jsx)(td.Z,ns(ns({},P),{},{name:"questions",type:"hidden"}))]}),(0,eJ.jsx)(ni.D,{entity:"Job",entityId:m.id,onSuccess:D,questions:h})]})},nu=function(e){var t,n,r,i=e.isQuotes,o=e.edit,a=e.job,s=e.refetch,c=(0,K.useContext)(eR.Z),u=a.shortJobDesc&&a.shortJobDesc.length?a.shortJobDesc[0].taxonomy.name:"",l=null===(t=a.answers)||void 0===t?void 0:t.map(function(e){var t;return{id:e.id,taxonomyId:e.taxonomyId,comments:e.comments,name:null===(t=e.taxonomy)||void 0===t?void 0:t.name}}),d=(0,ey.D)(eo.FA),p=(0,eb.Z)(d,1)[0],m=(r=(0,eh.Z)(ej().mark(function e(t){var n;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=(0,t8.eD)(t,a.id),delete t.questions,delete t.taxonomyId_ShortDesc,e.next=5,p({variables:{jobId:a.id,changes:t,questions:n,hasQuestions:n.length>0}});case 5:c.close(),s();case 7:case"end":return e.stop()}},e)})),function(e){return r.apply(this,arguments)}),f=function(){c.show({content:(0,eJ.jsx)(nc,{description:a.description||"",handleWorkDescriptionSubmit:m,job:a,currentQuestions:l}),title:"Work Description"})},v=function(){return(0,eJ.jsx)(tp.Z,{context:"secondary",onClick:f,size:"sm",children:"Edit"})};return(0,eJ.jsxs)(tM.Z,(n={fitParentHeight:!0,open:!0,title:"Sensors"},(0,W.Z)(n,"title","Issue Reported - Client"),(0,W.Z)(n,"toolbar",o&&(0,eJ.jsx)(v,{})),(0,W.Z)(n,"children",[!i&&(0,eJ.jsx)(t7.Z,{content:"Short Job Description",text:u}),(0,eJ.jsx)(t7.Z,{content:i?"Description":"Job Description",text:a.description}),(0,eJ.jsx)(t9.y,{answers:l})]),n))};nu.defaultProps={edit:!1};var nl=function(e){var t=e.job,n=e.refetch;return(0,eJ.jsxs)(eJ.Fragment,{children:[(0,eJ.jsxs)(tH.Z,{children:[(0,eJ.jsx)(tN.Z,{md:6,children:(0,eJ.jsx)(tF.z,{enableUpdate:!0,job:t,open:!0,refetchParent:n},"expenses-".concat(t.id))}),(0,eJ.jsx)(tN.Z,{md:6,children:(0,eJ.jsx)(nu,{edit:!0,job:t,refetch:n},"workDescription-".concat(t.id))})]}),(0,eJ.jsx)(tM.Z,{title:"Amounts",open:!0,children:(0,eJ.jsx)(t4,{job:t,refetchJob:n})})]})},nd=(0,es.Ps)(s||(s=(0,ea.Z)(['\n  mutation UpdateJobTiming(\n    $id: Int!\n    $changes: Job_set_input\n    $timing: [JobTiming_insert_input!]!\n  ) {\n    update_Job_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n    delete_JobTiming(\n      where: { status: { _in: ["accepted", "lateArrival", "timingChanged"] }, jobId: { _eq: $id } }\n    ) {\n      affected_rows\n    }\n    insert_JobTiming(objects: $timing) {\n      returning {\n        id\n        status\n        createdAt\n      }\n    }\n    update_SupplierOffer(where: { jobId: { _eq: $id } }, _set: { status: "offered" }) {\n      returning {\n        id\n      }\n    }\n  }\n']))),np=n(52019),nm=n(59819),nf=(0,e9.Ry)().shape({timing:(0,e9.Z_)().required().oneOf(["at","between"]),timingStart:(0,e9.hT)().required(),timingEnd:(0,e9.hT)().when("timing",{is:"between",then:(0,e9.hT)().required()}),timingNormalHours:(0,e9.Z_)()});function nv(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function nh(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?nv(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):nv(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var nb=function(e){var t,n,r=e.job,i=e.refetch,o=e.toggleShow,a=(0,X.useRouter)().query,s=(0,eg.x)(),c=(0,K.useContext)(et.Z).user,u=(0,K.useContext)(np.Z).hasRole,l=(0,e6.cI)({defaultValues:{timing:r.timing,timingEnd:r.timingEnd?new Date(r.timingEnd):null,allowTimingNormalHours:!r.timingNormalHours,timingStart:r.timingStart?new Date(r.timingStart):null},resolver:(0,e5.S)(nf)}),d=l.control,p=l.errors,m=l.handleSubmit,f=l.register,v=l.setValue,h=l.watch,b=h("timing",r.timing),x=(0,ey.D)(nd,{onCompleted:(t=(0,eh.Z)(ej().mark(function e(){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!r){e.next=3;break}return e.next=3,(0,tD.F)(s,r.id);case 3:i&&i(),o();case 5:case"end":return e.stop()}},e)})),function(){return t.apply(this,arguments)})}),j=(0,eb.Z)(x,1)[0],g=(n=(0,eh.Z)(ej().mark(function e(t){var n,i;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:i=t,["timingEnd","timingStart"].forEach(function(e){i[e]&&(i[e]=e0()(i[e]).utc().format())}),"allowTimingNormalHours"===i.allowTimingNormalHours?i.timingNormalHours=!1:i.timingNormalHours=!0,delete i.allowTimingNormalHours,i.timing&&"at"===i.timing&&(i.timingEnd=null),i.scheduledAt=null,i.status="offered",null!==(n=r.meta)&&void 0!==n&&n.arrivalAnytime&&(i.meta=nh(nh({},r.meta),{},{arrivalAnytime:!1})),delete i.timeSpan,j({variables:{id:r.id,changes:nh({},i),timing:{status:"timingChanged",meta:{timingEnd:e0()(r.timingEnd).utc().format(),timingStart:e0()(r.timingStart).utc().format()},jobId:r.id,userId:c.id}}});case 11:case"end":return e.stop()}},e)})),function(e){return n.apply(this,arguments)});return(0,eJ.jsx)(e4.Z,{id:"offCanvasForm",handleSubmit:m(g),children:(0,eJ.jsx)(nm.X,nh(nh({},{control:d,errors:p,register:f}),{},{hasRole:u,timingWatch:b,setValue:v,watch:h,query:a}))})},nx=(0,es.Ps)(c||(c=(0,ea.Z)(['\n  mutation UpdateJobPricing(\n    $id: Int!\n    $changes: Job_set_input\n    $timing: [JobTiming_insert_input!]!\n    $offerId: Int!\n    $offerChanges: SupplierOffer_set_input\n    $hasOfferAccept: Boolean!\n  ) {\n    update_Job_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n    update_SupplierOffer_by_pk(pk_columns: { id: $offerId }, _set: $offerChanges)\n      @include(if: $hasOfferAccept) {\n      id\n    }\n    delete_JobTiming(\n      where: { status: { _in: ["accepted", "lateArrival", "pricingChanged"] }, jobId: { _eq: $id } }\n    ) {\n      affected_rows\n    }\n    insert_JobTiming(objects: $timing) {\n      returning {\n        id\n        status\n        createdAt\n      }\n    }\n  }\n']))),nj=n(13868),ng=n(42985),ny=function(e){var t={};return["amount","customerSpendThreshold","paymentMethod","pricing","supplierLabourAmount","supplierMaterialsAmount"].forEach(function(n){var r=e[n];"number"==typeof r&&(r=r.toString()),t[n]=r}),e.service&&(t.serviceSelected={value:e.service.id,label:e.service.name}),e.costCategoryTaxonomy&&(t.costCategorySelected={value:e.costCategoryTaxonomy.id,label:e.costCategoryTaxonomy.name}),t},nZ=function(e){return["amount","customerSpendThreshold","supplierLabourAmount","supplierMaterialsAmount"].forEach(function(t){e[t]?e[t]=parseInt(e[t]):e[t]=null}),["costCategory","service"].forEach(function(t){e[t+"Selected"]&&e[t+"Selected"].value&&(e[t+"Id"]=e[t+"Selected"].value),delete e[t+"Selected"]}),e},nw=(0,e9.Ry)().shape({costCategorySelected:(0,e9.Ry)().required(),serviceSelected:(0,e9.Ry)().required(),pricing:(0,e9.Z_)().oneOf(["time-materials","fixed"]),customerSpendThreshold:(0,e9.Z_)(),amount:(0,e9.Z_)(),supplierLabourAmount:(0,e9.Z_)(),supplierMaterialsAmount:(0,e9.Z_)(),paymentMethod:(0,e9.Z_)().oneOf(["card","invoice","N/A"])});function nO(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function nI(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?nO(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):nO(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var nS=function(e){var t,n,r,i,o=e.job,a=e.refetch,s=e.toggleShow,c=(0,K.useContext)(et.Z).user,u=(0,eg.x)(),l=(0,e6.cI)({defaultValues:ny(o),resolver:(0,e5.S)(nw)}),d=l.control,p=l.errors,m=l.handleSubmit,f=l.register,v=l.watch,h=v("pricing",o.pricing),b=v("serviceSelected",{value:null===(t=o.service)||void 0===t?void 0:t.id,label:null===(n=o.service)||void 0===n?void 0:n.name}),x=(0,ey.D)(nx,{onCompleted:(r=(0,eh.Z)(ej().mark(function e(){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!o){e.next=3;break}return e.next=3,(0,tD.F)(u,o.id);case 3:a&&a(),s();case 5:case"end":return e.stop()}},e)})),function(){return r.apply(this,arguments)})}),j=(0,eb.Z)(x,1)[0],g=(i=(0,eh.Z)(ej().mark(function e(t){var n,r,i,a,s;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:(n=nZ(t)).status="offered",i=(null==(r=o.supplierOffers.find(function(e){return"accepted"===e.status}))?void 0:r.statusLog)||[],a=(null==r?void 0:r.id)||0,s=[].concat((0,en.Z)(i),[{createdAt:new Date,status:"offered",userId:c.id}]),j({variables:{id:o.id,changes:nI({},n),timing:{status:"pricingChanged",jobId:o.id,userId:c.id},offerId:a,hasOfferAccept:!!a,offerChanges:{status:"offered",statusLog:s}}});case 7:case"end":return e.stop()}},e)})),function(e){return i.apply(this,arguments)}),y={control:d,errors:p,register:f};return(0,eJ.jsxs)(e4.Z,{id:"offCanvasForm",handleSubmit:m(g),children:[(0,eJ.jsx)(ng.t,nI({},y)),(0,eJ.jsx)(nj.n,nI(nI({},y),{},{pricingWatch:h,serviceSelectedWatch:b}))]})},nP=(0,es.Ps)(u||(u=(0,ea.Z)(["\n  mutation AssignSupplier($object: AssignSupplierInput!) {\n    assignSupplier(assignSupplierInput: $object) {\n      data\n      success\n    }\n  }\n"]))),nC=(0,es.Ps)(l||(l=(0,ea.Z)(["\n  query GetSuppliersForAssign($jobId: Int!) {\n    data: getSuppliersForAssign(jobId: $jobId) {\n      job\n      customerRates\n      suppliers\n      hasArea\n      hasActiveOffer\n    }\n  }\n"]))),nD=n(72852),nR=n(45110),nk=function(e){var t=e.suppliers,n=e.customerRates,r=e.selected,i=e.setSelected,o=e.setError,a=(0,K.useMemo)(function(){return t.map(function(e){var t,r,i,o,a,s;return{id:e.id,name:e.name,normal:{firstHour:e.normal.firstHour,subsequentHours:e.normal.subsequentHours},ooh:{firstHour:e.ooh.firstHour,subsequentHours:e.ooh.subsequentHours},premium:{firstHour:e.premium.firstHour,subsequentHours:e.premium.subsequentHours},above:(null==n?void 0:null===(t=n.normal)||void 0===t?void 0:t.firstHour)<e.normal.firstHour||(null==n?void 0:null===(r=n.normal)||void 0===r?void 0:r.subsequentHours)<e.normal.subsequentHours||(null==n?void 0:null===(i=n.ooh)||void 0===i?void 0:i.firstHour)<e.ooh.firstHour||(null==n?void 0:null===(o=n.ooh)||void 0===o?void 0:o.subsequentHours)<e.ooh.subsequentHours||(null==n?void 0:null===(a=n.premium)||void 0===a?void 0:a.firstHour)<e.premium.firstHour||(null==n?void 0:null===(s=n.premium)||void 0===s?void 0:s.subsequentHours)<e.premium.subsequentHours}})},[t,n]),s=(0,K.useCallback)(function(e,t){t?(i((0,en.Z)(a.map(function(e){return e.id}))),a.some(function(e){return e.above})&&o({message:"Supplier rates are above customer rates.",severity:"error",color:"error"})):i([])},[a,o,i]),c=(0,K.useCallback)(function(e,t,n){t?(i([].concat((0,en.Z)(r),[n.id])),n.above&&o({message:"Supplier rates are above customer rates.",severity:"error",color:"error"})):i(r.filter(function(e){return e!==n.id}))},[r,o,i]),u=(0,K.useMemo)(function(){return[{flex:1,field:"name",headerName:"Supplier",sortable:!1},{flex:1,field:"normal",headerName:"Normal",sortable:!1,renderCell:function(e){var t=e.row;return(0,eJ.jsxs)(eD.Z,{children:[(0,eJ.jsxs)(eI.Z,{children:["First hour: ",(0,nR.T)(t.normal.firstHour)]}),(0,eJ.jsxs)(eI.Z,{children:["Subsequent hours: ",(0,nR.T)(t.normal.subsequentHours)]})]})}},{flex:1,field:"ooh",headerName:"OOH",sortable:!1,renderCell:function(e){var t=e.row;return(0,eJ.jsxs)(eD.Z,{children:[(0,eJ.jsxs)(eI.Z,{children:["First hour: ",(0,nR.T)(t.ooh.firstHour)]}),(0,eJ.jsxs)(eI.Z,{children:["Subsequent hours: ",(0,nR.T)(t.ooh.subsequentHours)]})]})}},{flex:1,field:"premium",headerName:"Premium",sortable:!1,renderCell:function(e){var t=e.row;return(0,eJ.jsxs)(eD.Z,{children:[(0,eJ.jsxs)(eI.Z,{children:["First hour: ",(0,nR.T)(t.premium.firstHour)]}),(0,eJ.jsxs)(eI.Z,{children:["Subsequent hours: ",(0,nR.T)(t.premium.subsequentHours)]})]})}},{minWidth:60,field:"switch",headerName:"",sortable:!1,renderHeader:function(){return(0,eJ.jsx)(nD.Z,{color:"secondary",onChange:function(e,t){return s(e,t)}})},renderCell:function(e){var t=e.row;return(0,eJ.jsx)(nD.Z,{color:"secondary",checked:r.includes(t.id),onChange:function(e,n){return c(e,n,t)}})}}]},[s,c,r]);return(0,eJ.jsx)(tX.i,{autoHeight:!1,hideFooter:!1,columns:u,rows:a,pagination:!0,sortingMode:"client",paginationSize:10,initialState:{pagination:{paginationModel:{pageSize:10}}}})};nk.defaultProps={customerRates:{},setError:function(){},setSelected:function(){},suppliers:[]};var nE,nA=n(84808),nq=n(98456),nT=n(46901),n_=n(3084),n$=function(e){var t,n,r,i,o,a,s,c,u=e.jobId,l=e.repost,d=e.refetch,p=e.toggleShow,m=e.isSingleSupplier,f=(0,eg.x)(),v=(0,n_.D)(),h=(0,K.useState)([]),b=h[0],x=h[1],j=(0,K.useState)(null),g=j[0],y=j[1],Z=(0,e6.cI)().handleSubmit,w=(0,er.a)(nC,{variables:{jobId:u},onError:function(e){v.show({content:"Error: ".concat(e.message),severity:"error"})}}),O=w.data,I=(O=void 0===O?{data:{job:{},customerRates:null,suppliers:[],hasArea:!0,hasActiveOffer:!1}}:O).data,S=I.job,P=I.suppliers,C=I.customerRates,D=I.hasArea,R=I.hasActiveOffer,k=w.loading,E=(0,ey.D)(nP,{onCompleted:(s=(0,eh.Z)(ej().mark(function e(t){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,tD.F)(f,u);case 2:v.show({content:"Supplier was assigned.",severity:"success"}),d(),p();case 5:case"end":return e.stop()}},e)})),function(e){return s.apply(this,arguments)}),onError:function(e){v.show({content:"Error: ".concat(e.message),severity:"error"})}}),A=(0,eb.Z)(E,2),q=A[0],T=A[1].loading,_=(c=(0,eh.Z)(ej().mark(function e(){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(b.length){e.next=2;break}return e.abrupt("return",v.show({content:"Error: Select at least one supplier.",severity:"error"}));case 2:if(!(m&&R||m&&b.length>1)){e.next=4;break}return e.abrupt("return",v.show({content:"Jobs can only be reallocated to one supplier.",severity:"warning",color:"info"}));case 4:if(!("quote"===S.type&&b.length>S.quoteNumber)){e.next=6;break}return e.abrupt("return",v.show({content:"Jobs can be assigned to a maximum of ".concat(S.quoteNumber," suppliers."),severity:"warning",color:"info"}));case 6:q({variables:{object:{jobId:u,repost:l,supplierIds:b}}});case 7:case"end":return e.stop()}},e)})),function(){return c.apply(this,arguments)});return(0,eJ.jsxs)("form",{id:"offCanvasForm",onSubmit:Z(_),children:[(k||T)&&(0,eJ.jsx)(nA.Z,{sx:{zIndex:1e5},open:!0,children:(0,eJ.jsx)(nq.Z,{color:"secondary"})}),(0,eJ.jsxs)(eD.Z,{children:[(0,eJ.jsx)(eI.Z,{children:"Suppliers have been pruned based on the location of the customer and assigned services."}),(0,eJ.jsxs)(eI.Z,{children:["Service: ",(0,eJ.jsx)("strong",{children:S.serviceName})]}),"quote"!==S.type&&C&&(0,eJ.jsxs)(eI.Z,{children:["Customer rates:"," ",(0,eJ.jsxs)("strong",{children:[(0,nR.T)(null==C?void 0:null===(t=C.normal)||void 0===t?void 0:t.firstHour),"/",(0,nR.T)(null==C?void 0:null===(n=C.normal)||void 0===n?void 0:n.subsequentHours),"(Normal),","  "]}),(0,eJ.jsxs)("strong",{children:[(0,nR.T)(null==C?void 0:null===(r=C.ooh)||void 0===r?void 0:r.firstHour),"/",(0,nR.T)(null==C?void 0:null===(i=C.ooh)||void 0===i?void 0:i.subsequentHours),"(OOH),","  "]}),(0,eJ.jsxs)("strong",{children:[(0,nR.T)(null==C?void 0:null===(o=C.premium)||void 0===o?void 0:o.firstHour),"/",(0,nR.T)(null==C?void 0:null===(a=C.premium)||void 0===a?void 0:a.subsequentHours),"(Premium)"]})]}),"quote"===S.type&&S.quoteNumber&&(0,eJ.jsxs)(eI.Z,{children:[(0,eJ.jsx)("strong",{children:S.quoteNumber})," supplier(s) needed for quote."]}),(0,eJ.jsxs)(eD.Z,{spacing:1,mt:1,mb:1,children:[!D&&(0,eJ.jsx)(nT.Z,{variant:"filled",severity:"error",children:"This location does not have an address associated."}),l&&(0,eJ.jsx)(nT.Z,{variant:"filled",severity:"info",children:"Note: Reposting the job will cancel previous offers."}),g&&(0,eJ.jsx)(nT.Z,{variant:"filled",severity:g.severity,color:g.color,children:g.message})]}),(0,eJ.jsx)(nk,{suppliers:P,customerRates:C,selected:b,setSelected:x,setError:y})]})]})};n$.defaultProps={repost:!1,isSingleSupplier:!1,refetch:function(){},toggleShow:function(){}};var nH,nN,nM,nF,nJ,nL=(nE=(0,eh.Z)(ej().mark(function e(t){var n,r,i,o;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n=t.jobId,r=t.offCanvas,i=t.refetch,o=t.isSingleSupplier,r.show({content:(0,eJ.jsx)(n$,{jobId:n,refetch:i,toggleShow:r.show,isSingleSupplier:o}),anchor:"left",title:"Assign Supplier",xs3:"100vw",sm:"100vw",sm2:"100vw",sm3:"65vw",md2:"65vw",lg:"65vw",lg2:"65vw"});case 2:case"end":return e.stop()}},e)})),function(e){return nE.apply(this,arguments)}),nU=(nH=(0,eh.Z)(ej().mark(function e(t,n,r,i,o){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,eJ.jsx)(t$,{addJobTiming:i,job:t,toggleShow:n.show,updateJob:r,user:o}),placement:"left",title:"Create Quote",width:"50%"});case 1:case"end":return e.stop()}},e)})),function(e,t,n,r,i){return nH.apply(this,arguments)}),nV=(nN=(0,eh.Z)(ej().mark(function e(t,n,r){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,eJ.jsx)(nS,{job:t,toggleShow:n.show,refetch:r}),title:"Change job pricing/service",width:"40%"});case 1:case"end":return e.stop()}},e)})),function(e,t,n){return nN.apply(this,arguments)}),nQ=(nM=(0,eh.Z)(ej().mark(function e(t,n,r){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,eJ.jsx)(nb,{job:t,toggleShow:n.show,refetch:r}),title:"Change job timing",width:"40%"});case 1:case"end":return e.stop()}},e)})),function(e,t,n){return nM.apply(this,arguments)}),nz=(nF=(0,eh.Z)(ej().mark(function e(t,n,r){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,eJ.jsx)(nl,{job:t,refetch:r}),submit:!1,title:"Change job finance",xs3:"100vw",sm:"100vw",sm2:"100vw",sm3:"65vw",md2:"50vw",lg:"50vw",lg2:"50vw"});case 1:case"end":return e.stop()}},e)})),function(e,t,n){return nF.apply(this,arguments)}),nY=(nJ=(0,eh.Z)(ej().mark(function e(t){var n,r,i,o;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n=t.jobId,t.repost,r=t.offCanvas,i=t.refetch,o=t.isSingleSupplier,r.show({content:(0,eJ.jsx)(n$,{jobId:n,repost:!0,refetch:i,toggleShow:r.show,isSingleSupplier:o}),anchor:"left",title:"Repost Job",xs3:"100vw",sm:"100vw",sm2:"100vw",sm3:"65vw",md2:"65vw",lg:"65vw",lg2:"65vw"});case 2:case"end":return e.stop()}},e)})),function(e){return nJ.apply(this,arguments)}),nB=n(74975);function nG(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function nW(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?nG(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):nG(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var nK,nX=function(e){var t,n=e.job,r=e.quotation,i=e.refetch,o=e.toggleShow,a=(0,e6.cI)({defaultValues:{siteVisitAt:r.siteVisitAt?new Date(r.siteVisitAt):null}}),s=a.control,c=a.errors,u=a.handleSubmit,l=a.register,d=n.siteVisitEnd,p=n.siteVisitStart,m=n.siteVisitWeekends,f=(0,ey.D)(ta.HI,{onCompleted:function(e){i&&i(),o()}}),v=(0,eb.Z)(f,1)[0],h=(t=(0,eh.Z)(ej().mark(function e(t){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t.startDate&&(t.startDate=(0,nB.Z)(new Date(t.startDate))),e.next=3,v({variables:{id:r.id,changes:t,recommend:!1}});case 3:case"end":return e.stop()}},e)})),function(e){return t.apply(this,arguments)}),b=function(e){var t=new Date(e);return t.getHours()>=8&&17>t.getHours()&&t.getTime()<=new Date(d).getTime()&&t.getTime()>=new Date(p).getTime()},x=function(e){var t=e.getDay();return 0!==t&&6!==t};return(0,eJ.jsxs)(e4.Z,{handleSubmit:u(h),children:[(0,eJ.jsx)(tl.Z,{label:"Site visit time"}),(0,eJ.jsx)(tA.M,nW(nW({},{control:s,errors:c,register:l}),{},{register:l,dateFormat:"d MMM yyyy HH:mm",minDate:p?new Date(p):new Date,maxDate:d&&new Date(d),filterTime:b,filterDate:!m&&x,name:"siteVisitAt",showTimeSelect:!0,todayButton:!1})),(0,eJ.jsx)(e7.H,{content:"Submit",type:"submit"})]})},n0=function(e,t,n,r){n.show({content:(0,eJ.jsx)(nX,{job:e,quotation:t,refetch:r,toggleShow:n.close}),submit:!1,title:"Site visit time",width:"40%"})},n1=(0,es.Ps)(d||(d=(0,ea.Z)(["\n  mutation CreateRemedialQuote($jobId: Int!, $slaId: Int!, $description: String) {\n    createRemedialQuote(jobId: $jobId, slaId: $slaId, description: $description) {\n      data\n      success\n    }\n  }\n"]))),n2=e9.Ry({slaId:e9.Rx().integer().required()}),n3=function(e){var t,n,r=e.jobId,i=e.customerId,o=e.locationId,a=e.toggleShow,s=(0,e6.cI)({defaultValues:{},resolver:(0,e5.S)(n2)}),c=s.watch,u=s.handleSubmit,l=s.errors,d=s.register,p=c("slaId"),m=(0,er.a)(eo.Ab,{skip:!i||!o,variables:{customerId:i,locationId:o}}).data,f=(0,t8.GU)("quote",m),v=null==f?void 0:null===(t=f.find(function(e){return e.id===Number(p)}))||void 0===t?void 0:t.notes,h=(0,ey.D)(n1,{onCompleted:function(){return a()},refetchQueries:["GetJob"]}),b=(0,eb.Z)(h,2),x=b[0],j=b[1].loading,g=(n=(0,eh.Z)(ej().mark(function e(t){var n,i;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.description,i=t.slaId,e.next=3,x({variables:{jobId:r,slaId:i,description:n}});case 3:case"end":return e.stop()}},e)})),function(e){return n.apply(this,arguments)});return j?(0,eJ.jsx)(eD.Z,{width:"100%",alignItems:"center",children:(0,eJ.jsx)(nq.Z,{color:"secondary"})}):(0,eJ.jsxs)(e4.Z,{id:"offCanvasForm",handleSubmit:u(g),children:[(0,eJ.jsx)(tu.Z,{register:d,errors:l,data:f,legend:"Priority",name:"slaId"}),p&&(0,eJ.jsx)(ts.Z,{content:v||"-",context:"light"}),(0,eJ.jsx)(tl.Z,{label:"Description",children:(0,eJ.jsx)(tC.Z,{errors:l,name:"description",register:d,rows:3})}),(0,eJ.jsx)(e7.H,{content:"Create remedial quote",type:"submit"})]})};n3.defaultProps={toggleShow:function(){}};var n6,n5=(nK=(0,eh.Z)(ej().mark(function e(t){var n,r,i,o;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n=t.jobId,r=t.customerId,i=t.locationId,(o=t.offCanvas).show({content:(0,eJ.jsx)(n3,{jobId:n,customerId:r,locationId:i,toggleShow:o.close}),title:"Remedial quote",submit:!1});case 2:case"end":return e.stop()}},e)})),function(e){return nK.apply(this,arguments)}),n4=(n6=(0,eh.Z)(ej().mark(function e(t){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:ee().push("/dashboard/issues/view?id=".concat(t));case 1:case"end":return e.stop()}},e)})),function(e){return n6.apply(this,arguments)}),n7=function(e){var t,n,r,i=e.user,o=(e.deleteJobTiming,e.job),a=e.offCanvas,s=e.offCanvasNew,c=e.refetch,u=e.updateJob,l=e.client,d=o.siteVisitStart,p=(null===(t=o.parentJob)||void 0===t?void 0:t.type)==="reactive";return"closed"===o.status?[{id:1,label:"New Quote",date:(0,eK.E)(o,"quoteOffered")||(0,eK.E)(o,"closed")},{id:2,label:"Quote Closed",date:(0,eK.E)(o,"closed"),actions:[{id:1,active:(0,eK.E)(o,"closed"),content:"Repost job",context:"danger",handleClick:function(){return tk(o,u,"quoteNew")},type:"button"}]}]:[{id:1,label:"New Quote",date:(0,eK.E)(o,"quoteNew"),content:[{id:1,active:!0,data:"Created By ".concat((null==o?void 0:null===(n=o.timings[0])||void 0===n?void 0:null===(r=n.user)||void 0===r?void 0:r.fullName)||"")}],actions:[{id:1,active:(0,eK.E)(o,"quoteNew")&&!(0,eK.E)(o,"inProgress")&&!(0,eK.E)(o,"quoteOffered"),content:"Make reactive",context:"secondary",handleClick:function(){return to(o,a,c)},type:"button"},{id:2,active:p,content:"Related works",context:"info",handleClick:function(){var e;return n4(null===(e=o.parentJob)||void 0===e?void 0:e.number)},type:"button"}]},{id:2,label:"Sent to Supplier(s)",info:o.quotations.length<o.quoteNumber?"".concat(o.quoteNumber," supplier(s) needed for this quote\n            (").concat(o.quotations.length,"/").concat(o.quoteNumber," selected)"):"no assigned suppliers",date:o.quotations.length>0&&(0,eK.E)(o,"quoteOffered"),actions:[{id:1,active:o.quotations.length<o.quoteNumber&&("quoteNew"===o.status||(0,eK.E)(o,"quoteNew"))&&!(0,eK.E)(o,"inProgress"),content:"Assign suppliers",context:"info",data:{"data-cy":"supplierAssign"},handleClick:function(){return nL({jobId:o.id,offCanvas:s,refetch:c})},type:"button"},{id:2,active:o.quotations.length>=o.quoteNumber&&(0,eK.E)(o,"quoteOffered")&&!(0,eK.E)(o,"quoteAccepted"),content:"Repost job",context:"danger",handleClick:function(){return nY({jobId:o.id,offCanvas:s,refetch:c})},type:"button"}]},{id:3,label:"Received from Supplier(s)",info:"waiting for supplier to submit",date:(0,eK.E)(o,"quoteReceived"),content:o.quotations.map(function(e,t){return{id:t,active:!(0,eK.E)(o,"supplierQuoteComplete")&&e.siteVisitAt&&"supplierQuoteComplete"!==e.status&&"supplierQuoteRefused"!==e.status,data:function(){return(0,eJ.jsxs)(eJ.Fragment,{children:["Site visit at ".concat(e.quoteNumber),":",(0,eJ.jsxs)("b",{children:[" ",(0,e2.Z)(e.siteVisitAt,!0)]})]})}}}),actions:o.quotations.map(function(e,t){return{id:t,active:!(0,eK.E)(o,"supplierQuoteComplete")&&d&&"supplierQuoteComplete"!==e.status&&"supplierQuoteRefused"!==e.status,content:e.siteVisitAt?"Edit site visit time ".concat(e.quoteNumber):"Select site visit time ".concat(e.quoteNumber),context:"secondary",handleClick:function(){return n0(o,e,a,c)},type:"button"}})},{id:4,label:"Sent to Customer",info:"not sent",date:(0,eK.E)(o,"quoteSent"),actions:[{id:1,active:!!o.quotations.find(function(e){return"supplierQuoteSent"===e.status})&&(0,eK.E)(o,"quoteSent"),content:"Download quote",context:"secondary",handleClick:function(){return(0,e3.g)(o,null,l)},type:"button"},{id:2,active:(0,eK.E)(o,"quoteReceived")&&!(0,eK.E)(o,"quoteSent"),content:"Send quote",context:"secondary",handleClick:function(){return tP(o,i,a,c)},type:"button"}]},{id:5,label:"Accepted / Rejected",info:"waiting for customer to accept",date:(0,eK.E)(o,"quoteAccepted")||"quoteRejected"===o.status&&(0,eK.E)(o,"quoteRejected")},{id:6,label:"Closed",date:(0,eK.E)(o,"quoteClosed")}]},n8=function(e){var t=e.job;return e.offCanvas,e.refetch,[{id:1,label:"Quote raised",info:"quote is with contractor for pricing",date:(0,eK.E)(t,"quoteNew")||(0,eK.E)(t,"quoteOffered")},{id:2,label:"In review",info:"currently being reviewed",date:(0,eK.E)(t,"quoteReceived")},{id:3,label:"Awaiting acceptance",info:"awaiting your acceptance",date:(0,eK.E)(t,"quoteSent")},{id:4,label:"Accept / Reject",date:(0,eK.E)(t,"quoteAccepted")||"quoteRejected"===t.status&&(0,eK.E)(t,"quoteRejected")},{id:5,label:"Closed",date:(0,eK.E)(t,"quoteClosed")}]},n9=function(e){var t,n=e.job,r=e.offCanvas,i=e.refetch,o=e.user,a=(null===(t=n.parentJob)||void 0===t?void 0:t.type)==="reactive",s=n.quotations.length>0?n.quotations.find(function(e){return e.accountId===o.accountId}):{},c=s&&("supplierQuoteDraft"===s.status||"supplierQuoteComplete"===s.status)?s.updatedAt:null,u=s&&"supplierQuoteComplete"===s.status?s.updatedAt:null,l=n.siteVisitStart;return[{id:1,label:"Quotation offered",date:(0,eK.E)(n,"quoteOffered"),actions:[{id:2,active:a,content:"Related works",context:"info",handleClick:function(){var e;return n4(null===(e=n.parentJob)||void 0===e?void 0:e.number)},type:"button"}]},{id:2,label:"Quotation",info:"need to complete the quotation",date:c,content:n.quotations.map(function(e,t){return{id:t,active:!(0,eK.E)(n,"supplierQuoteComplete")&&e.siteVisitAt&&"supplierQuoteComplete"!==e.status&&"supplierQuoteRefused"!==e.status,data:function(){return(0,eJ.jsxs)(eJ.Fragment,{children:["Site visit at ".concat(e.quoteNumber),":",(0,eJ.jsxs)("b",{children:[" ",(0,e2.Z)(e.siteVisitAt,!0)]})]})}}}),actions:n.quotations.map(function(e,t){return{id:t,active:!(0,eK.E)(n,"supplierQuoteComplete")&&l&&"supplierQuoteComplete"!==e.status&&"supplierQuoteRefused"!==e.status,content:e.siteVisitAt?"Edit site visit time ".concat(e.quoteNumber):"Select site visit time ".concat(e.quoteNumber),context:"secondary",handleClick:function(){return n0(n,e,r,i)},type:"button"}})},{id:3,label:"Completed",date:u}]},re=function(e,t,n,r,i,o,a,s,c,u){var l;return n("admin")?l=n7({user:c,deleteJobTiming:t,job:r,offCanvas:i,offCanvasNew:o,refetch:a,updateJob:s,client:u}):n("supplier")?l=n9({job:r,offCanvas:i,refetch:a,user:c}):n("customer")&&(l=n8({job:r,offCanvas:i,refetch:a})),l.forEach(function(e){e.date&&(e.date=e0()(e.date).format("D MMM YYYY HH:mm"))}),l},rt=function(e){var t=[];return t.push({label:"Scheduled start:",value:e.timingStart?e0()(e.timingStart).format("D MMM YYYY HH:mm"):""}),e.timingEnd&&t.push({label:"Scheduled end:",value:e.timingEnd?e0()(e.timingEnd).format("D MMM YYYY HH:mm"):""}),"chargable"===e.quoteCharge&&t.push({label:"Quote charge:",value:(0,e1.Z)(e.quoteChargeAmount)}),t},rn=n(73303),rr=n.n(rn),ri=n(45697),ro=n.n(ri);function ra(e){var t,n=e.autoStart,r=e.startTime,i=e.endTime,o=e.interval,a=void 0===o?1e3:o,s=(0,K.useState)((t=(i?e0()(i):e0()()).diff()-e0()(r).diff())>-1?t:0),c=s[0],u=s[1],l=(0,K.useState)(n),d=l[0],p=l[1];(0,K.useEffect)(function(){var e=null;return d?e=setInterval(function(){u(e0()().diff()-e0()(r).diff())},a):clearInterval(e),function(){clearInterval(e)}},[d]);var m,f=function(){p(!0)},v=function(){p(!1)};return{time:{seconds:(m=e0().duration(c)).seconds().toString().padStart(2,"0"),minutes:m.minutes().toString().padStart(2,"0"),hours:parseInt(m.asHours(),10),exactHours:m.asHours().toFixed(2)},start:f,stop:v}}ra.propTypes={autoStart:ri.bool,startTime:ri.string.isRequired,endTime:ri.string,interval:ri.number};var rs,rc,ru,rl=function(e){for(var t=null,n=(0,en.Z)(null==e?void 0:e.timings).sort(function(e,t){return e.id-t.id}),r=n.length-1;r>=0;r--){var i,o=n[r].status;if("inProgress"===o||"resumed"===o||"continued"===o){t=(null===(i=n[r])||void 0===i?void 0:i.createdAt)||t;break}}return t},rd=function(e){for(var t=null,n=(0,en.Z)(null==e?void 0:e.timings).sort(function(e,t){return e.id-t.id}),r=n.length-1;r>=0;r--){var i,o=n[r].status;if("paused"===o||"onHold"===o||"completed"===o){t=(null===(i=n[r])||void 0===i?void 0:i.createdAt)||t;break}}return t},rp=n(11699),rm=function(e){var t=e.slice().sort(function(e,t){return Number(e.id)-Number(t.id)}).filter(function(e){return"inProgress"===e.status||"paused"===e.status||"resumed"===e.status||"continued"===e.status||"completed"===e.status||"onHold"===e.status}),n=[],r=t.findIndex(function(e){return"inProgress"===e.status}),i=t.findIndex(function(e){return"completed"===e.status});if(-1===r&&-1===i)return n;-1===i&&(i=t.length-1);for(var o=r;o<=i;o+=2)if(("inProgress"===t[o].status||"resumed"===t[o].status||"continued"===t[o].status)&&o+1<t.length){var a=(0,rp.Z)(new Date(t[o+1].createdAt),new Date(t[o].createdAt));n.push({startDate:t[o].createdAt,endDate:t[o+1].createdAt,duration:Math.round(a)})}return n},rf=function(e){for(var t="",n=e.slice().sort(function(e,t){return Number(e.id)-Number(t.id)}),r=n.length-1;r>=0;r--){var i=n[r].status;if("onHold"===i||"resumed"===i||"paused"===i||"continued"===i){t=n[r].status;break}}return t},rv=n(13352),rh=n(21023),rb=function(e){var t,n=e.job,r=(0,eg.x)(),i=(0,K.useContext)(et.Z).user,o="fixed"===n.pricing,a="incorrect"===n.timingStatus,s=n.supplier,c=rf(n.timings),u=(0,eK.E)(n,"accepted"),l=(0,eK.E)(n,"inProgress")&&!(0,eK.E)(n,"completed"),d="onHold"===c,p="paused"===c,m=!(n.media.filter(function(e){var t;return!(null!==(t=e.item.meta)&&void 0!==t&&t.adminOnly)}).length>0),f=(0,eK.E)(n,"closed"),v=rm(n.timings),h=rr()(v,"duration"),b=ra({autoStart:!1,startTime:rl(n),endTime:rd(n)}),x=b.time,j=x.seconds,g=x.minutes,y=x.hours,Z=b.start,w=b.stop,O=(0,ey.D)(rv.xY,{refetchQueries:["GetJob"],onCompleted:(t=(0,eh.Z)(ej().mark(function e(){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!n){e.next=3;break}return e.next=3,(0,tD.F)(r,n.id);case 3:case"end":return e.stop()}},e)})),function(){return t.apply(this,arguments)})}),I=(0,eb.Z)(O,1)[0];(0,K.useEffect)(function(){!l||p||d?w():Z()},[l,n,d,p,Z,w]);var S=function(e){return function(t){t.stopPropagation(),I({variables:{id:n.id,changes:{status:e},timing:{status:e,jobId:n.id,userId:i.id}}})}},P=function(e){e.stopPropagation(),I({variables:{id:n.id,changes:{status:"inProgress"},timing:{status:"inProgress",jobId:n.id,userId:i.id},_append:{statusData:{inProgress:e0()().toISOString()}}}})},C=function(e){e.stopPropagation(),I({variables:{id:n.id,changes:{status:"completed"},timing:{status:"completed",jobId:n.id,userId:i.id},_append:{statusData:{inProgress:e0()().toISOString()}}}})},D=v.map(function(e,t){return{id:t,startDate:e.startDate,endDate:e.endDate,duration:e.duration}});return(0,eJ.jsxs)(ew.Z,{disableGutters:!0,children:[(0,eJ.jsx)(eO.Z,{expandIcon:(0,eJ.jsx)(eW.Z,{}),"aria-controls":"timer-content",id:"timer-header",children:(0,eJ.jsxs)(eP.ZP,{container:!0,children:[(0,eJ.jsx)(eP.ZP,{item:!0,xs:12,children:(0,eJ.jsx)(eI.Z,{variant:"h6",children:"Timer"})}),(0,eJ.jsx)(eP.ZP,{item:!0,xs:12,display:"flex",justifyContent:"center",sx:{marginTop:"-18px"},children:(0,eJ.jsxs)(eI.Z,{sx:{fontSize:"24px",fontWeight:600},children:[y,":",g,":",j]})}),(0,eJ.jsxs)(eP.ZP,{item:!0,xs:12,display:"flex",justifyContent:"center",children:[l&&m&&(0,eJ.jsx)(nT.Z,{variant:"filled",severity:"info",sx:{mb:1},children:"You must add at least one photo in order to end the timer."}),a&&(0,eJ.jsx)(nT.Z,{variant:"filled",severity:"error",sx:{mb:1},children:"Timer has been marked as incorrect by supplier"})]}),(0,eJ.jsx)(eP.ZP,{item:!0,xs:12,children:!f&&s&&(0,eJ.jsxs)(eD.Z,{direction:"row",display:"flex",justifyContent:"center",spacing:2,children:[!d&&!!u&&!(0,eK.E)(n,"inProgress")&&(0,eJ.jsx)(eC.Z,{mt:2,color:"success",variant:"contained",onClick:P,children:"Start"}),!!(0,eK.E)(n,"inProgress")&&!(0,eK.E)(n,"completed")&&!p&&!d&&(0,eJ.jsx)(eC.Z,{mt:2,color:"danger",variant:"contained",onClick:S("paused"),children:"Pause"}),!(0,eK.E)(n,"completed")&&p&&!d&&(0,eJ.jsx)(eC.Z,{mt:2,variant:"contained",onClick:S("continued"),children:"Continue"}),!!(0,eK.E)(n,"inProgress")&&!(0,eK.E)(n,"completed")&&!d&&!p&&!m&&(0,eJ.jsx)(eC.Z,{mt:2,variant:"contained",color:"danger",onClick:C,children:"End"})]})})]})}),(0,eJ.jsx)(eS.Z,{children:!o&&(0,eJ.jsxs)(eZ.Z,{children:[(0,eJ.jsx)(tX.i,{rows:D,columns:[{field:"startDate",headerName:"Date",flex:1,sortable:!1,valueGetter:function(e){var t=e.row;return e0()(t.startDate).format("YYYY-MM-DD")}},{field:"duration",headerName:"Minutes",flex:1,sortable:!1,renderCell:function(e){var t=e.row;return e.value,(0,eJ.jsx)(rh.Z,{title:(0,eJ.jsxs)(eJ.Fragment,{children:["From: ".concat(e0()(t.startDate).format("YYYY-MM-DD HH:mm")),(0,eJ.jsx)("br",{}),"To: ".concat(e0()(t.endDate).format("YYYY-MM-DD HH:mm")," ")]}),children:(0,eJ.jsx)("span",{children:Math.round(t.duration/60)})})}}]}),(0,eJ.jsxs)(eD.Z,{direction:"row",pl:"10px",children:[(0,eJ.jsx)(eI.Z,{children:"Total:"}),(0,eJ.jsx)(eI.Z,{ml:.5,color:"secondary",children:Math.round(h/60)})]})]})})]})},rx=n(92034),rj=n(99229),rg=(rs=(0,eh.Z)(ej().mark(function e(t,n){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,eJ.jsx)(rj.G,{entity:"JobTiming",entityId:t}),title:"Dispute media"});case 1:case"end":return e.stop()}},e)})),function(e,t){return rs.apply(this,arguments)}),ry=n(85011),rZ=function(e){var t,n=e.job,r=e.refetch,i=e.status,o=e.toggleShow,a=(0,K.useContext)(eR.Z),s=(0,K.useContext)(et.Z).user,c=(0,e6.cI)({defaultValues:{comments:""}}),u=c.errors,l=c.handleSubmit,d=c.register,p=(0,ey.D)(eo.r2,{onCompleted:function(e){var t=e.insert_JobTiming.returning[0].id;t&&"inDispute"===i?f(t):(r&&r(),o())}}),m=(0,eb.Z)(p,1)[0],f=function(e){a.show({content:(0,eJ.jsx)(ry.z,{accept:"image/*",category:null,entity:"JobTiming",entityId:e,expiryShow:!1,onSuccess:function(){return v(e)},showSubmitButton:!0}),title:"Upload Photo",submit:!1})},v=function(e){r&&r(),o(),a.close()},h=(t=(0,eh.Z)(ej().mark(function e(t){var r;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:r={notes:t.comments,status:i,jobId:n.id,userId:s.id},m({variables:{objects:[r]}});case 2:case"end":return e.stop()}},e)})),function(e){return t.apply(this,arguments)});return(0,eJ.jsx)(e4.Z,{id:"offCanvasForm",handleSubmit:l(h),children:(0,eJ.jsx)(tl.Z,{label:"Comments",children:(0,eJ.jsx)(tC.Z,{errors:u,name:"comments",register:d,rows:3})})})},rw=(rc=(0,eh.Z)(ej().mark(function e(t,n,r){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,eJ.jsx)(rZ,{job:t,status:"inDispute",toggleShow:n.show,refetch:r}),title:"Dispute"});case 1:case"end":return e.stop()}},e)})),function(e,t,n){return rc.apply(this,arguments)}),rO=(ru=(0,eh.Z)(ej().mark(function e(t,n,r){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,eJ.jsx)(rZ,{job:t,status:"disputeResolved",toggleShow:n.show,refetch:r}),title:"Resolve Dispute"});case 1:case"end":return e.stop()}},e)})),function(e,t,n){return ru.apply(this,arguments)}),rI=n(10693);function rS(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function rP(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?rS(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):rS(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var rC,rD=function(e){var t,n=e.job,r=e.toggleShow,i=(0,e6.cI)({defaultValues:{isRecall:!1}}),o=i.errors,a=i.handleSubmit,s=i.register,c=(t=(0,eh.Z)(ej().mark(function e(t){var i;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:"true"===t.isRecall?(0,rI.e)({adminId:n.adminId,job:n,openReport:!1}).then(function(e){ee().push("/dashboard/issues/manage?recall=true&parentId=".concat(n.id,"&report=").concat(encodeURIComponent(e.blob.key)))}):ee().push("/dashboard/issues/manage?recall=false&parentId=".concat(n.id)),r();case 3:case"end":return e.stop()}},e)})),function(e){return t.apply(this,arguments)});return(0,eJ.jsx)(e4.Z,{id:"offCanvasForm",handleSubmit:a(c),children:(0,eJ.jsx)(tl.Z,{label:"",children:(0,eJ.jsx)(tc.Z,rP(rP({},{errors:o,register:s}),{},{name:"isRecall",data:[{label:"Is this a recall?",key:"recall",value:!0}]}))})})},rR=(rC=(0,eh.Z)(ej().mark(function e(t,n){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,eJ.jsx)(rD,{job:t,toggleShow:n.close}),title:"Follow On"});case 1:case"end":return e.stop()}},e)})),function(e,t){return rC.apply(this,arguments)}),rk=n(41749),rE=n(93673),rA=n(825),rq=n(55863),rT=n(86559);function r_(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function r$(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r_(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r_(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var rH=function(e){var t,n=e.job,r=e.refetch,i=e.toggleShow,o=(0,K.useContext)(et.Z).user,a=(0,e6.cI)({defaultValues:{comments:"",jobHoldReason:null}}),s=a.control,c=a.errors,u=a.handleSubmit,l=a.register,d=(0,ey.D)(ec.xY,{onCompleted:function(){r&&r(),i()}}),p=(0,eb.Z)(d,1)[0],m=(t=(0,eh.Z)(ej().mark(function e(t){var r,i,a;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:i="onHold",a={},null!==(r=t.jobHoldReason)&&void 0!==r&&r.value&&(a.jobHoldReason={},a.jobHoldReason.value=t.jobHoldReason.value,a.jobHoldReason.label=t.jobHoldReason.label),p({variables:{id:n.id,changes:{status:i},timing:{jobId:n.id,meta:a,notes:t.comments,status:i,userId:o.id}}});case 4:case"end":return e.stop()}},e)})),function(e){return t.apply(this,arguments)}),f={errors:c,register:l,control:s};return(0,eJ.jsxs)(e4.Z,{handleSubmit:u(m),children:[(0,eJ.jsx)(no.l,r$(r$({},f),{},{label:"Reason",name:"jobHoldReason",type:"jobHoldReason"})),(0,eJ.jsx)(tl.Z,{label:"Comments",children:(0,eJ.jsx)(tC.Z,r$(r$({},f),{},{name:"comments",rows:3}))}),(0,eJ.jsx)(e7.H,{content:"Submit",type:"submit"})]})},rN=(0,es.Ps)(p||(p=(0,ea.Z)(['\n  mutation UpdateSupplierOffer(\n    $jobId: Int!\n    $jobChanges: Job_set_input\n    $timing: [JobTiming_insert_input!]!\n  ) {\n    delete_JobTiming(where: { jobId: { _eq: $jobId }, status: { _in: ["accepted", "offered"] } }) {\n      returning {\n        jobId\n      }\n    }\n    insert_JobTiming(objects: $timing) {\n      returning {\n        id\n        status\n        createdAt\n      }\n    }\n\n    update_SupplierOffer(where: { jobId: { _eq: $jobId } }, _set: { status: "cancelled" }) {\n      returning {\n        id\n      }\n    }\n\n    update_Job_by_pk(pk_columns: { id: $jobId }, _set: $jobChanges) {\n      id\n    }\n  }\n']))),rM=(0,es.Ps)(m||(m=(0,ea.Z)(["\n  mutation AcceptJob($object: AcceptJobOfferInput!) {\n    acceptJobOffer(acceptOfferInput: $object) {\n      data\n      success\n    }\n  }\n"]))),rF=(0,es.Ps)(f||(f=(0,ea.Z)(['\n  mutation UpdateSupplierOffer(\n    $noAnotherOffers: Boolean!\n    $assignedReject: Boolean!\n    $changes: SupplierOffer_set_input\n    $id: Int!\n    $jobId: Int!\n    $jobChanges: Job_set_input\n    $timing: [JobTiming_insert_input!]!\n  ) {\n    insert_JobTiming(objects: $timing) @include(if: $assignedReject) {\n      returning {\n        id\n        status\n        createdAt\n      }\n    }\n    delete_JobTiming(where: { jobId: { _eq: $jobId }, status: { _in: "offered" } })\n      @include(if: $noAnotherOffers) {\n      returning {\n        id\n        status\n        createdAt\n      }\n    }\n    update_Job_by_pk(pk_columns: { id: $jobId }, _set: $jobChanges) @include(if: $assignedReject) {\n      id\n    }\n    update_SupplierOffer_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n  }\n']))),rJ=n(55377),rL=n(55843),rU=(0,e9.Ry)().shape({arrivalTime:(0,e9.hT)().required(),acceptedContractor:(0,e9.Ry)().required(),time:(0,e9.Xg)()}),rV=(0,e9.Ry)().shape({rejectedNotes:(0,e9.Z_)().required()}),rQ=n(27952);function rz(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function rY(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?rz(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):rz(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var rB=function(e){var t,n,r,i=e.accountId,o=e.job,a=e.offCanvas,s=e.refetch,c=e.edit,u=(0,K.useState)(),l=u[0],d=u[1],p=(0,t2.x)(),m=p.hasRole,f=p.user,v=(0,eg.x)(),h=m("admin"),b=m("supplier"),x=i||"supplier"===f.accountType&&f.accountId,j=(null==o?void 0:null===(t=o.quotations.find(function(e){return"quotationAccepted"===e.status}))||void 0===t?void 0:t.startDate)||new Date,g=o.quoted?j:o.timingStart,y=(0,K.useState)(null),Z=y[0],w=y[1],O=(0,K.useState)(null),I=O[0],S=O[1],P=(0,K.useState)(null),C=P[0],D=P[1],R=(0,K.useState)(null),k=R[0],E=R[1],A=(0,K.useState)(!1),q=A[0],T=A[1],_=(0,K.useState)(!1),$=_[0],H=_[1],N=(0,K.useState)(!1),M=N[0],F=N[1];(0,K.useEffect)(function(){function e(e,r,i,o){var a=t(e,i),s=t(r,o);n(e,r,a,s)}function t(e,t){return e.set({hour:t.hour()||0,minute:t.minute()||0,second:t.second()||0,millisecond:t.millisecond()||0}).toISOString()}function n(e,t,n,r){w(e?new Date(e):null),S(t?new Date(t):null),D(n?new Date(n):null),E(r?new Date(r):null)}if("ppm"===o.type&&o.timingStart&&o.timingEnd&&b){if(e0()().isAfter(e0()(o.timingStart))){var r=e0()(o.timingStart),i=e0()(o.timingEnd),a=e0()(o.hourStart||e0()().startOf("day"),"HH:mm:ssZ"),s=e0()(o.hourEnd||e0()().endOf("day"),"HH:mm:ssZ");e(r,i,a,s)}else if(e0()().isAfter(e0()(o.timingStart).subtract(7,"day"))){var c=e0()().diff(e0()(o.timingStart).subtract(7,"day"),"ms"),u=e0()(o.timingStart),l=e0()(o.timingStart).set({millisecond:c||0}),d=e0()(o.hourStart||e0()().startOf("day"),"HH:mm:ssZ"),p=e0()(o.hourEnd||e0()().endOf("day"),"HH:mm:ssZ");e(u,l,d,p)}else e0()().isBefore(e0()(o.timingStart).subtract(7,"day"))&&(n(),T(!0));H(!0)}else if("ppm"===o.type&&o.timingStart&&o.timingEnd&&!b){var m=e0()(o.timingStart),f=e0()(o.timingEnd),v=e0()(o.hourStart||e0()().startOf("day"),"HH:mm:ssZ"),x=e0()(o.hourEnd||e0()().endOf("day"),"HH:mm:ssZ");e(m,f,v,x),H(!1)}else"reactive"===o.type&&o.quoted?n(o.timingStart,e0()(o.timingStart).add(60,"day")):"reactive"===o.type&&(h||b)&&n(o.timingStart,null)},[o.timingStart,o.timingEnd,o.type,o.quoted,o.hourStart,o.hourEnd,b,h]);var J,L=o.supplierOffers.filter(function(e){return"cancelled"!==e.status}),U=null;L.forEach(function(e){e.account.id===x&&(U=e)});var V,Q=(0,ey.D)(rM,{onCompleted:(J=(0,eh.Z)(ej().mark(function e(t){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!o){e.next=3;break}return e.next=3,(0,tD.F)(v,o.id);case 3:s&&s(),a.close();case 5:case"end":return e.stop()}},e)})),function(e){return J.apply(this,arguments)}),onError:function(e){d(e.message)}}),z=(0,eb.Z)(Q,1)[0],Y=(V=(0,eh.Z)(ej().mark(function e(t){var n;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:z({variables:{object:{arrivalAnytime:!1,jobId:o.id,scheduledAt:t.arrivalTime?(0,rQ.v)(t.arrivalTime):null,supplierId:x,supplierUserId:null===(n=t.acceptedContractor)||void 0===n?void 0:n.value,supplierOfferId:U.id,offerStatusLog:JSON.stringify(U.statusLog),userId:f.id,edit:c}}});case 1:case"end":return e.stop()}},e)})),function(e){return V.apply(this,arguments)}),B=(0,e6.cI)({defaultValues:{arrivalTime:Z,acceptedContractor:null!=o&&null!==(n=o.supplier)&&void 0!==n&&null!==(r=n.contactUsers)&&void 0!==r&&r.length?{value:o.supplier.contactUsers[0].user.id,label:o.supplier.contactUsers[0].user.fullName}:null},resolver:(0,e5.S)(rU)}),G=B.control,W=B.errors,X=B.handleSubmit,ee=B.register,et=B.setValue,en=(0,B.watch)("arrivalTime");(0,K.useEffect)(function(){et("arrivalTime",Z)},[Z,et]),(0,K.useEffect)(function(){en&&o.onSiteTimingEnd&&e0()(en).isAfter(e0()(o.onSiteTimingEnd))?F(!0):F(!1)},[en,o.onSiteTimingEnd]);var er={control:G,errors:W,register:ee};return(0,eJ.jsxs)(e4.Z,{handleSubmit:X(Y),children:[$&&(0,eJ.jsx)(nT.Z,{variant:"filled",severity:"warning",color:"info",sx:{"& .MuiAlert-icon":{alignItems:"center"},mb:2},children:"Please be aware that you can only choose a date and time for attendance no more than 7 days prior, or any time within the calendar month of the job."}),M&&(0,eJ.jsx)(nT.Z,{variant:"filled",severity:"warning",color:"info",sx:{"& .MuiAlert-icon":{alignItems:"center"},mb:2},children:"Warning: The selected time is beyond the relevant SLA."}),(0,eJ.jsxs)("div",{children:[(0,eJ.jsx)("strong",{children:"Scheduled:"})," ",(0,eJ.jsx)("span",{children:(0,nB.Z)(new Date(g),"d MMM yyyy HH:mm")}),o.timingEnd&&(0,eJ.jsxs)("span",{children:[" - ",(0,nB.Z)(new Date(o.timingEnd),"d MMM yyyy HH:mm")]})]}),(0,eJ.jsx)(rJ.Z,{}),(0,eJ.jsx)(tl.Z,{label:"Arrival time"}),(0,eJ.jsx)(tA.M,rY(rY({},er),{},{dateFormat:"d MMM yyyy HH:mm",readOnly:q,disabled:q,maxDate:I,minDate:Z,maxTime:k,minTime:C,name:"arrivalTime",showTimeSelect:!0,timeIntervals:15,todayButton:!1})),(0,eJ.jsx)(rL.Z,{}),(0,eJ.jsx)(e8.P,rY(rY({},er),{},{accountId:x,errors:rY({},W),label:"Operative",name:"acceptedContractor",type:"user"})),(0,eJ.jsx)(e7.H,{content:"Confirm",type:"submit"}),l&&(0,eJ.jsx)(ts.Z,{content:l,context:"danger"})]})};rB.defaultProps={edit:!1};var rG=(0,e9.Ry)().shape({cancellingReason:(0,e9.Z_)().required()});function rW(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function rK(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?rW(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):rW(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var rX,r0,r1,r2,r3=function(e){var t,n,r=e.job,i=e.refetch,o=e.offCanvas,a=(0,K.useContext)(et.Z).user,s=(0,e6.cI)({defaultValues:{notes:""},resolver:(0,e5.S)(rG)}),c=s.errors,u=s.handleSubmit,l=s.register,d=(0,s.watch)("canNotMakeDate"),p={errors:c,register:l},m=(0,ey.D)(rN,{onCompleted:function(e){o.close(),"supplier"===a.accountType?ee().push("/dashboard"):i&&i()}}),f=(0,eb.Z)(m,1)[0],v=(n=(0,eh.Z)(ej().mark(function e(t){var n,i,o;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:o=null,o={scheduledAt:null,status:"raised",supplierId:null,supplierUserId:null},(i=[]).push({status:"supplierCancel",jobId:r.id,userId:a.id,notes:t.cancellingReason,meta:{supplierId:null===(n=r.supplier)||void 0===n?void 0:n.id}}),f({variables:{jobChanges:o,jobId:r.id,timing:i}});case 5:case"end":return e.stop()}},e)})),function(e){return n.apply(this,arguments)});return(0,eJ.jsxs)(eJ.Fragment,{children:[(0,eJ.jsx)(tu.Z,rK(rK({},p),{},{data:[{id:"yes",label:"Yes",value:!0},{id:"no",label:"No",value:!1}],legend:"Are you cancelling because you cannot make the scheduled date and time?",name:"canNotMakeDate",stacked:!0})),"true"===d&&(0,eJ.jsx)(rB,{accountId:null===(t=r.supplier)||void 0===t?void 0:t.id,edit:!0,job:r,offCanvas:o,refetch:i}),"false"===d&&(0,eJ.jsxs)(e4.Z,{handleSubmit:u(v),children:[(0,eJ.jsx)(tl.Z,{label:"Please provide a reason for cancelling this job",children:(0,eJ.jsx)(tC.Z,rK(rK({},p),{},{name:"cancellingReason",rows:3}))}),(0,eJ.jsx)(e7.H,{content:"Confirm",type:"submit"})]})]})},r6=n(39474),r5=n(4021),r4=(rX=(0,eh.Z)(ej().mark(function e(t){var n,r,i,o,a;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n=t.type,r=t.job,i=t.offCanvas,o=t.refetch,e.t0=n,e.next="customer"===e.t0?4:"supplier"===e.t0?6:8;break;case 4:return a=r.customerId,e.abrupt("break",9);case 6:return a=r.supplierId,e.abrupt("break",9);case 8:return e.abrupt("return");case 9:i.show({content:(0,eJ.jsx)(r5.q,{type:n,accountId:a,adminId:r.adminId,jobId:r.id,jobNumber:r.number,refetch:o,toggleShow:i.show,invoicesForJobOnly:!0}),title:"Payment",width:"50%"});case 10:case"end":return e.stop()}},e)})),function(e){return rX.apply(this,arguments)}),r7=function(e){var t,n=e.job,r=e.refetch,i=e.status,o=e.toggleShow,a=(0,K.useContext)(et.Z).user,s=(0,e6.cI)({defaultValues:{comments:""}}),c=s.errors,u=s.handleSubmit,l=s.register,d=(0,ey.D)(eo.r2,{onCompleted:function(){r&&r(),o()}}),p=(0,eb.Z)(d,1)[0],m=(t=(0,eh.Z)(ej().mark(function e(t){var r;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:r={notes:t.comments,status:i,jobId:n.id,userId:a.id},p({variables:{objects:[r]}});case 2:case"end":return e.stop()}},e)})),function(e){return t.apply(this,arguments)});return(0,eJ.jsx)(e4.Z,{id:"offCanvasForm",handleSubmit:u(m),children:(0,eJ.jsx)(tl.Z,{label:"Comments",children:(0,eJ.jsx)(tC.Z,{errors:c,name:"comments",register:l,rows:3})})})},r8=function(e,t){var n=e.addJobTiming,r=e.entityId,i=e.job,o=e.onlyShow,a=void 0!==o&&o,s=e.userId,c={status:"complianceReportSent",jobId:i.id,userId:s};t.show({content:(0,eJ.jsx)(rj.G,{entity:"Compliance_Entity",entityId:r,showActionButtons:!a,showItemActions:!a,onMediaAdd:function(){n({variables:{objects:[c]}}),t.close()}}),submit:!1,title:a?"Compliance report":"Upload report"})},r9=(r0=(0,eh.Z)(ej().mark(function e(t,n,r){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,eJ.jsx)(r7,{job:t,refetch:r,status:"complianceApproved",toggleShow:n.show}),title:"Approve report"});case 1:case"end":return e.stop()}},e)})),function(e,t,n){return r0.apply(this,arguments)}),ie=(r1=(0,eh.Z)(ej().mark(function e(t,n,r){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,eJ.jsx)(r7,{job:t,refetch:r,status:"complianceRejected",toggleShow:n.show}),title:"Reject report"});case 1:case"end":return e.stop()}},e)})),function(e,t,n){return r1.apply(this,arguments)}),it=function(e){var t=e.deleteJobTiming,n=e.job,r=e.userId;t({variables:{id:n.id,status:"complianceRequestedDocumentation",userId:r}})},ir=(r2=(0,eh.Z)(ej().mark(function e(t,n,r){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,eJ.jsx)(r7,{job:t,refetch:r,status:"complianceRequestedDocumentation",toggleShow:n.show}),title:"Request Documentation"});case 1:case"end":return e.stop()}},e)})),function(e,t,n){return r2.apply(this,arguments)}),ii=n(19056),io=n(9205),ia=(0,es.Ps)(v||(v=(0,ea.Z)(["\n  mutation ValidateJob($jobId: Int!, $invoiceIds: [Int], $notes: String) {\n    validateJob(jobId: $jobId, invoiceIds: $invoiceIds, notes: $notes) {\n      success\n      data\n    }\n  }\n"]))),is=(0,es.Ps)(h||(h=(0,ea.Z)(['\n  query GetInvoicesByJobId($jobId: Int!, $invoiceTypes: [String!]!) {\n    invoices: Invoice(\n      where: {\n        invoiceType: { _in: $invoiceTypes }\n        entityId: { _eq: $jobId }\n        entity: { _eq: "Job" }\n      }\n    ) {\n      id\n      invoiceNumber\n      invoiceType\n    }\n  }\n']))),ic=(0,es.Ps)(b||(b=(0,ea.Z)(['\n  mutation UpdateJob($id: Int!, $timing: [JobTiming_insert_input!]!) {\n    delete_JobTiming(where: { jobId: { _eq: $id }, status: { _eq: "validated" } }) {\n      returning {\n        jobId\n      }\n    }\n    insert_JobTiming(objects: $timing) {\n      returning {\n        id\n        status\n        createdAt\n      }\n    }\n  }\n']))),iu=n(40755),il=n(6911),id=n(58681);function ip(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return im(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return im(e,t)}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw o}}}}function im(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}var iv=function(e){e.addJobTiming;var t=e.deleteJobTiming,n=e.job,r=e.refetch,i=e.status,o=e.toggleShow,a=(0,X.useRouter)().query,s=(0,t2.x)().user,c=(0,n_.D)(),u=(0,iu.RM)(null==s?void 0:s.id),l=(0,eK.E)(n,"unvalidated"),d=(0,iu.BR)({adminId:s.id,xeroClientId:null==a?void 0:a.clientId,onSaveXeroTokenCallback:function(){return r&&r()}},[s]),p=d.tokenStatus,m=d.onCallAuthorize,f=d.onUpdateInvoiceInXero,v=(0,e6.cI)({defaultValues:{notes:"",invoice:[]}}),h=v.errors,b=v.control,x=v.handleSubmit;(0,K.useEffect)(function(){n.invoices.some(function(e){var t;return null===(t=e.accountEntry.meta)||void 0===t?void 0:t.xeroInvoiceId})&&!a.clientId&&u&&"unauthenticated"===p&&m(window.location.href)},[u,p]);var j,g,y=(0,er.a)(is,{variables:{jobId:n.id,invoiceTypes:["customerVat","ProformaInvoiceCustomer"]}}).data,Z=(y=void 0===y?{invoices:[]}:y).invoices,w=(0,ey.D)(ia,{refetchQueries:function(){return["getInvoices"]},onError:function(e){c.show({content:"Error: ".concat(e.message),severity:"error"})},onCompleted:(j=(0,eh.Z)(ej().mark(function e(){var t,i,a,s;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:c.show({content:"Job was successfully validated.",severity:"success"}),t=ip(n.invoices),e.prev=2,t.s();case 4:if((i=t.n()).done){e.next=11;break}if(s=i.value,!(u&&"authorized"===p&&null!==(a=s.accountEntry.meta)&&void 0!==a&&a.xeroInvoiceId)){e.next=9;break}return e.next=9,f({accountEntryId:s.accountEntry.id,invoiceType:s.invoiceType});case 9:e.next=4;break;case 11:e.next=16;break;case 13:e.prev=13,e.t0=e.catch(2),t.e(e.t0);case 16:return e.prev=16,t.f(),e.finish(16);case 19:r&&r(),o();case 21:case"end":return e.stop()}},e,null,[[2,13,16,19]])})),function(){return j.apply(this,arguments)})}),O=(0,eb.Z)(w,2),I=O[0],S=O[1].loading,P=(0,ey.D)(ic,{refetchQueries:function(){return["getInvoices"]},onError:function(e){c.show({content:"Error: ".concat(e.message),severity:"error"})},onCompleted:function(){c.show({content:"Job was successfully un-validated.",severity:"success"}),r&&r(),o()}}),C=(0,eb.Z)(P,2),D=C[0],R=C[1].loading,k=(g=(0,eh.Z)(ej().mark(function e(r){var o,a,c,u;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:"validated"===i?I({variables:{jobId:n.id,invoiceIds:(null===(o=r.invoice)||void 0===o?void 0:o.map(function(e){return e.value}))||[],notes:r.notes}}):"unvalidated"===i&&(t({variables:{id:n.id,status:"waitingForThresholdApproval",userId:s.id}}),t({variables:{id:n.id,status:"thresholdRejected",userId:s.id}}),t({variables:{id:n.id,status:"thresholdApproved",userId:s.id}}),D({variables:{id:n.id,timing:{notes:r.notes,status:i,jobId:n.id,userId:s.id}}}));case 1:case"end":return e.stop()}},e)})),function(e){return g.apply(this,arguments)});if(S||R)return(0,eJ.jsx)(eD.Z,{alignItems:"center",children:(0,eJ.jsx)(nq.Z,{color:"secondary"})});var E=Z.map(function(e){return{value:e.id,label:"".concat(e.invoiceNumber," ").concat(id.Tq[e.invoiceType])}}),A="validated"===i?"Leave comments below, if appropriate, to provide context for other users.":"Please leave comments below to provide relevant context for other users.";return(0,eJ.jsx)("form",{id:"offCanvasForm",onSubmit:x(k),children:(0,eJ.jsxs)(eD.Z,{spacing:2,children:["validated"===i&&(0,eJ.jsx)(nT.Z,{severity:"warning",color:"info",children:l?"Please choose the invoices from the below\n    for which you would like to update the information.":"Once validated, you will not be able to amend financial information within the job.\n    Invoices already generated cannot be changed."}),"unvalidated"===i&&(0,eJ.jsx)(nT.Z,{children:"This enables you to update financial information within the job. However, please note that any previously generated invoices will remain unchanged."}),"validated"===i&&l&&(0,eJ.jsx)(e6.Qr,{name:"invoice",control:b,render:function(e){var t=e.value,n=e.onChange;return(0,eJ.jsx)(il.q,{multiple:!0,value:t,onChange:function(e,t){n(t)},options:E,textFieldProps:{fullWidth:!0,color:"secondary",variant:"filled",label:"Select invoices",error:h.invoice,helperText:h.invoice&&h.invoice.message}})}}),(0,eJ.jsx)(e6.Qr,{name:"notes",control:b,render:function(e){var t=e.value,n=e.onChange;return(0,eJ.jsx)(ne.Z,{multiline:!0,fullWidth:!0,rows:4,color:"secondary",variant:"filled",label:"Notes",value:t,onChange:n,error:h.notes,helperText:A})}})]})})},ih=(0,es.Ps)(x||(x=(0,ea.Z)(["\n  mutation InsertJobTiming($timing: [JobTiming_insert_input!]!) {\n    insert_JobTiming(objects: $timing) {\n      returning {\n        id\n        status\n        createdAt\n      }\n    }\n  }\n"])));(0,es.Ps)(j||(j=(0,ea.Z)(["\n  query GetInvoicePointer($id: Int!) {\n    account: Account_by_pk(id: $id) {\n      id\n      name\n      type\n      meta\n    }\n  }\n"])));var ib=(0,es.Ps)(g||(g=(0,ea.Z)(["\n  mutation createCustomerInvoice(\n    $jobId: Int!\n    $customerEmail: String\n    $sendEmail: String\n    $dueDate: timestamptz!\n  ) {\n    createCustomerInvoice(\n      jobId: $jobId\n      customerEmail: $customerEmail\n      sendEmail: $sendEmail\n      dueDate: $dueDate\n    ) {\n      data\n    }\n  }\n"]))),ix=(0,es.Ps)(y||(y=(0,ea.Z)(["\n  mutation createSupplierInvoice(\n    $jobId: Int!\n    $supplierEmail: String\n    $sendEmail: String\n    $dueDate: timestamptz!\n  ) {\n    createSupplierInvoice(\n      jobId: $jobId\n      supplierEmail: $supplierEmail\n      sendEmail: $sendEmail\n      dueDate: $dueDate\n    ) {\n      data\n    }\n  }\n"]))),ij=n(73359),ig=n(16551),iy=n(33234),iZ=n(33816),iw=n(46718);function iO(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function iI(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?iO(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):iO(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var iS=function(e){var t,n,r,i,o,a,s=e.defaultOptions,c=e.job,u=e.showSubmit,l=e.watch,d=(0,eg.x)(),p=l("sendEmail"),m=l("revisions"),f=(0,ij.t)(iZ.By,{onCompleted:function(e){var t,n=e.invoices,r=null==n?void 0:n[0];id.YK.includes(null==r?void 0:r.invoiceType)?(0,iw.$)(null==r?void 0:null===(t=r.accountEntry)||void 0===t?void 0:t.meta):(0,iy._Z)({client:d,jobId:c.id,type:"customerVat",preview:u})}}),v=(0,eb.Z)(f,1)[0],h=(a=(0,eh.Z)(ej().mark(function e(){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:"reactive"===c.type?v({variables:{jobId:c.id,invoiceType:"customerVat"}}):v({variables:{jobId:c.id,invoiceType:"customerPpmInvoice"}});case 1:case"end":return e.stop()}},e)})),function(){return a.apply(this,arguments)});return(0,eJ.jsxs)(eJ.Fragment,{children:[(0,eJ.jsx)(tH.Z,{children:(0,eJ.jsx)(iP,{md:10,children:(0,eJ.jsx)(tm.Z,{children:u?"Preview PDF":"Download PDF"})})}),(0,eJ.jsx)(rL.Z,{}),(0,eJ.jsx)(ig.Z,{align:"flex-start",children:(0,eJ.jsx)(tp.Z,{content:"reactive"===c.type?"Customer VAT":"Customer PPM",context:m&&"-1"!==m?"warning":"secondary",onClick:h,size:"sm"})}),u&&(0,eJ.jsxs)(eJ.Fragment,{children:[(0,eJ.jsx)(rL.Z,{}),(0,eJ.jsx)(t7.Z,{content:"Customer",text:null===(t=c.customer)||void 0===t?void 0:t.name}),(0,eJ.jsx)(t7.Z,{content:"Customer Contact",text:null===(n=c.customerUser)||void 0===n?void 0:n.fullName}),(0,eJ.jsx)(t7.Z,{content:"Phone",text:null===(r=c.customerUser)||void 0===r?void 0:r.phone}),(0,eJ.jsx)(t7.Z,{content:"Email",text:null===(i=c.customerUser)||void 0===i?void 0:i.email}),(0,eJ.jsx)(rL.Z,{}),(0,eJ.jsx)(tl.Z,{label:"Due date",children:(0,eJ.jsx)(tA.M,iI(iI({},s),{},{name:"dueDate",placeholder:"Due date"}))}),(0,eJ.jsx)(rL.Z,{}),(0,eJ.jsx)(rL.Z,{}),(0,eJ.jsx)(tu.Z,iI(iI({},s),{},{data:[{id:"sendEmail",label:"Send invoice via email",value:"sendEmail"},{id:"markAsInvoiceSent",label:"Mark invoice as sent",value:"markAsInvoiceSent"}],name:"sendEmail"})),"sendEmail"===p&&(0,eJ.jsx)(tl.Z,{label:"Send to email address",children:(0,eJ.jsx)(td.Z,iI(iI({},s),{},{defaultValue:null===(o=c.customerUser)||void 0===o?void 0:o.email,name:"customerEmail"}))})]})]})},iP=(0,tQ.ZP)(tN.Z).withConfig({displayName:"customer__StyledColumn",componentId:"sc-1fgc93a-0"})(["align-self:center;"]);function iC(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function iD(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?iC(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):iC(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var iR=function(e){var t,n,r,i,o=e.defaultOptions,a=e.job,s=e.showSubmit,c=e.watch,u=(0,eg.x)(),l=(null==a?void 0:null===(t=a.supplier)||void 0===t?void 0:null===(n=t.contactUsers[0])||void 0===n?void 0:n.user)||null,d=c("sendEmail"),p=c("revisions"),m=(0,ij.t)(iZ.By,{onCompleted:function(e){var t,n=e.invoices,r=null==n?void 0:n[0];id.YK.includes(null==r?void 0:r.invoiceType)?(0,iw.$)(null==r?void 0:null===(t=r.accountEntry)||void 0===t?void 0:t.meta):(0,iy._Z)({client:u,jobId:a.id,type:"supplier",preview:s})}}),f=(0,eb.Z)(m,1)[0],v=(i=(0,eh.Z)(ej().mark(function e(){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:"reactive"===a.type?f({variables:{jobId:a.id,invoiceType:"supplier"}}):f({variables:{jobId:a.id,invoiceType:"supplierPpmInvoice"}});case 1:case"end":return e.stop()}},e)})),function(){return i.apply(this,arguments)});return(0,eJ.jsxs)(eJ.Fragment,{children:[(0,eJ.jsx)(tH.Z,{children:(0,eJ.jsx)(ik,{md:10,children:(0,eJ.jsx)(tm.Z,{children:s?"Preview PDF":"Download PDF"})})}),(0,eJ.jsx)(rL.Z,{}),(0,eJ.jsx)(tp.Z,{content:"Supplier",context:p&&"-1"!==p?"warning":"secondary",onClick:v,size:"md"}),s&&(0,eJ.jsxs)(eJ.Fragment,{children:[(0,eJ.jsx)(rL.Z,{}),(0,eJ.jsx)(t7.Z,{content:"Supplier",text:null===(r=a.supplier)||void 0===r?void 0:r.name}),l&&(0,eJ.jsxs)(eJ.Fragment,{children:[(0,eJ.jsx)(t7.Z,{content:"Supplier Contact",text:l.fullName}),(0,eJ.jsx)(t7.Z,{content:"Phone",text:l.phone}),(0,eJ.jsx)(t7.Z,{content:"Email",text:l.email})]}),(0,eJ.jsx)(rL.Z,{}),(0,eJ.jsx)(tl.Z,{label:"Due date",children:(0,eJ.jsx)(tA.M,iD(iD({},o),{},{name:"dueDate",placeholder:"Due date"}))}),(0,eJ.jsx)(rL.Z,{}),(0,eJ.jsx)(tu.Z,iD(iD({},o),{},{data:[{id:"sendEmail",label:"Send invoice via email",value:"sendEmail"},{id:"markAsInvoiceSent",label:"Mark invoice as sent",value:"markAsInvoiceSent"}],name:"sendEmail"})),"sendEmail"===d&&(0,eJ.jsx)(tl.Z,{label:"Send to email address",children:(0,eJ.jsx)(td.Z,iD(iD({},o),{},{defaultValue:l.email,name:"supplierEmail"}))})]})]})},ik=(0,tQ.ZP)(tN.Z).withConfig({displayName:"supplier__StyledColumn",componentId:"sc-v4o4fk-0"})(["align-self:center;"]),iE=(0,e9.Ry)().shape({sendEmail:(0,e9.Z_)().required(),dueDate:(0,e9.Z_)().required()}),iA=n(33673),iq=function(e){var t,n,r,i=e.job,o=e.refetch,a=e.showSubmit,s=e.toggleShow,c=e.type,u=(0,K.useContext)(et.Z).user,l=(0,eg.x)(),d=(0,n_.D)(),p=(0,e6.cI)({resolver:(0,e5.S)(iE),defaultValues:{dueDate:(0,iA.I)({job:i,type:c,invoiceDate:new Date})}}),m=p.errors,f=p.handleSubmit,v=p.register,h=p.control,b=p.watch,x=b("sendEmail"),j=b("customerEmail"),g=b("supplierEmail"),y=(0,ey.D)(ih,{onError:function(e){d.show({content:"Error: ".concat(e.message),severity:"error"})},onCompleted:function(){o&&o(),s()}}),Z=(0,eb.Z)(y,1)[0],w=(0,ey.D)(ib,{refetchQueries:function(){return["getInvoices"]},onError:function(e){d.show({content:"Error: ".concat(e.message),severity:"error"})},onCompleted:(t=(0,eh.Z)(ej().mark(function e(){var t;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if("sendEmail"!==x){e.next=8;break}return e.next=3,(0,iy._Z)({client:l,jobId:i.id,type:"customerVat",getUrl:!0});case 3:return t=e.sent,e.next=6,Z({variables:{timing:{status:"invoicePDFSent",jobId:i.id,userId:u.id,meta:{toEmail:j,fileUrl:t}}}});case 6:e.next=10;break;case 8:o&&o(),s();case 10:case"end":return e.stop()}},e)})),function(){return t.apply(this,arguments)})}),O=(0,eb.Z)(w,2),I=O[0],S=O[1].loading,P=(0,ey.D)(ix,{refetchQueries:function(){return["getInvoices"]},onError:function(e){d.show({content:"Error: ".concat(e.message),severity:"error"})},onCompleted:(n=(0,eh.Z)(ej().mark(function e(){var t;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if("sendEmail"!==x){e.next=8;break}return e.next=3,(0,iy._Z)({client:l,jobId:i.id,type:"supplier",getUrl:!0});case 3:return t=e.sent,e.next=6,Z({variables:{timing:{status:"invoicePDFSentSupplier",jobId:i.id,userId:u.id,meta:{toEmail:g,fileUrl:t}}}});case 6:e.next=10;break;case 8:o&&o(),s();case 10:case"end":return e.stop()}},e)})),function(){return n.apply(this,arguments)})}),C=(0,eb.Z)(P,2),D=C[0],R=C[1].loading,k=(r=(0,eh.Z)(ej().mark(function e(t){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if("customer"!==c){e.next=5;break}return e.next=3,I({variables:{jobId:i.id,customerEmail:t.customerEmail,sendEmail:t.sendEmail,dueDate:new Date(t.dueDate)}});case 3:e.next=8;break;case 5:if("supplier"!==c){e.next=8;break}return e.next=8,D({variables:{jobId:i.id,supplierEmail:t.supplierEmail,sendEmail:t.sendEmail,dueDate:new Date(t.dueDate)}});case 8:case"end":return e.stop()}},e)})),function(e){return r.apply(this,arguments)}),E={errors:m,register:v,control:h};return S||R?(0,eJ.jsx)(eD.Z,{alignItems:"center",children:(0,eJ.jsx)(nq.Z,{color:"secondary"})}):(0,eJ.jsxs)(e4.Z,{id:"offCanvasForm",handleSubmit:f(k),children:["customer"===c?(0,eJ.jsx)(iS,{defaultOptions:E,job:i,showSubmit:a,watch:b}):(0,eJ.jsx)(iR,{defaultOptions:E,job:i,showSubmit:a,watch:b}),a&&(0,eJ.jsx)(e7.H,{content:"Submit",type:"submit"})]})};iq.defaultProps={refetch:function(){},toggleShow:function(){}};var iT=function(e,t,n,r,i){r.show({content:(0,eJ.jsx)(iv,{job:e,addJobTiming:t,deleteJobTiming:n,refetch:i,status:"validated",toggleShow:r.close}),title:"Validate job"})},i_=function(e,t,n,r,i){r.show({content:(0,eJ.jsx)(iv,{addJobTiming:t,deleteJobTiming:n,job:e,refetch:i,status:"unvalidated",toggleShow:r.show}),title:"Unvalidate job"})},i$=function(e,t,n,r,i,o){n.show({content:(0,eJ.jsx)(iq,{job:t,refetch:r,showSubmit:i,toggleShow:n.close,type:e}),submit:!1,title:i?"Send ".concat(e," invoice"):"Download ".concat(e," invoice")})},iH=function(e,t,n){var r=(0,io.Hv)(e,"customer"),i=function(e){e&&n()};t.show({content:(0,eJ.jsx)(ii.H,{entity:"Location",entityId:e.location.id,id:r.id,onSubmit:i,addressId:r.address.id,type:"invoice"}),submit:!1,title:"Manage addresses"})};function iN(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function iM(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?iN(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):iN(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var iF,iJ=function(e){var t,n=e.job,r=e.refetch,i=e.toggleShow,o=(0,K.useContext)(et.Z).user,a=(0,e6.cI)({defaultValues:{comments:""}}),s=a.errors,c=a.handleSubmit,u=a.register,l=(0,ey.D)(eo.Tw,{onCompleted:function(){r&&r()}}),d=(0,eb.Z)(l,1)[0],p=(0,ey.D)(ec.xY,{onCompleted:function(){r&&r(),i()}}),m=(0,eb.Z)(p,1)[0],f=(t=(0,eh.Z)(ej().mark(function e(t){var r,i,a,s,c,u,l,p,f,v,h,b,x,j,g,y,Z,w,O,I,S,P,C,D;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i=iM({type:"discount"},r={value:0,jobId:n.id,difference:0,system:!0,meta:{username:"".concat(o.nameFirst," ").concat(o.nameLast),userId:o.id,notes:t.comments}}),a=iM({type:"customerDeposit"},r),s=iM({type:"supplierDeposit"},r),c=iM({type:"supplierDeduction"},r),u=iM({type:"amount"},r),l=iM({type:"supplierMaterialsAmount"},r),p=iM({type:"supplierLabourAmount"},r),f=iM({type:"additions"},r),v=iM({type:"deductions"},r),h=iM({type:"firstHourRateCustomerNormal"},r),b=iM({type:"subsequentHoursRateCustomerNormal"},r),x=iM({type:"firstHourRateCustomerOOH"},r),j=iM({type:"subsequentHoursRateCustomerOOH"},r),g=iM({type:"firstHourRateCustomerPremium"},r),y=iM({type:"subsequentHoursRateCustomerPremium"},r),Z=iM({type:"firstHourRateSupplierNormal"},r),w=iM({type:"subsequentHoursRateSupplierNormal"},r),O=iM({type:"firstHourRateSupplierOOH"},r),I=iM({type:"subsequentHoursRateSupplierOOH"},r),S=iM({type:"firstHourRateSupplierPremium"},r),P=iM({type:"subsequentHoursRateSupplierPremium"},r),C=[i,s,c,a],D="fixed"===n.pricing?[u,l,p]:[f,v,h,b,x,j,g,y,Z,w,O,I,S,P],e.next=26,d({variables:{objects:[].concat(C,D)}}).then(function(e){m({variables:{id:n.id,changes:{status:"closed"},timing:{notes:t.comments,status:"closed",jobId:n.id,userId:o.id}}})});case 26:case"end":return e.stop()}},e)})),function(e){return t.apply(this,arguments)});return(0,eJ.jsxs)(e4.Z,{handleSubmit:c(f),children:[(0,eJ.jsx)(tl.Z,{label:"Comments",children:(0,eJ.jsx)(tC.Z,{errors:s,name:"comments",register:u,rows:3})}),(0,eJ.jsx)(e7.H,{content:"Submit",type:"submit"})]})},iL=(iF=(0,eh.Z)(ej().mark(function e(t,n,r){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,eJ.jsx)(iJ,{job:t,toggleShow:n.show,refetch:r}),submit:!1,title:"Close and zero value job"});case 1:case"end":return e.stop()}},e)})),function(e,t,n){return iF.apply(this,arguments)});function iU(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function iV(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?iU(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):iU(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var iQ,iz=function(e){var t,n,r,i=e.accountId,o=e.job,a=e.offCanvas,s=e.refetch,c=e.cancelMod,u=(0,K.useContext)(et.Z).user,l=(0,eg.x)(),d=i||"supplier"===u.accountType&&u.accountId,p=!!(null!==(t=o.supplier)&&void 0!==t&&t.id)||!!(0,eK.E)(o,"quoteNew"),m=o.supplierOffers.filter(function(e){return"cancelled"!==e.status}),f=null;m.forEach(function(e){e.account.id===d&&(f=e)});var v,h=(0,ey.D)(rF,{onCompleted:(r=(0,eh.Z)(ej().mark(function e(t){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!o){e.next=3;break}return e.next=3,(0,tD.F)(l,o.id);case 3:a.close(),"supplier"===u.accountType?ee().push("/dashboard"):s&&s();case 5:case"end":return e.stop()}},e)})),function(e){return r.apply(this,arguments)})}),b=(0,eb.Z)(h,1)[0],x=(v=(0,eh.Z)(ej().mark(function e(t){var n,r,i,a,s,l,d;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:r=[],i=null,a=null,s=!0,l="rejected",(null==m?void 0:m.length)>1&&(s=!1),d={createdAt:(0,rQ.v)(),notes:t.rejectedNotes,status:"cancelled",userId:u.id},null!==(n=f)&&void 0!==n&&n.statusLog?(i=(0,en.Z)(f.statusLog)).push(d):i=[d],p&&(a={scheduledAt:null,status:l,supplierId:null,supplierUserId:null},r.push({status:l,jobId:o.id,userId:u.id,notes:t.rejectedNotes})),b({variables:{noAnotherOffers:s,assignedReject:p,changes:{status:"cancelled",notes:t.rejectedNotes,statusLog:i},id:f.id,jobChanges:a,jobId:o.id,timing:r,cancelMod:c}});case 10:case"end":return e.stop()}},e)})),function(e){return v.apply(this,arguments)}),j=(0,e6.cI)({defaultValues:{rejectedNotes:null===(n=f)||void 0===n?void 0:n.notes},resolver:(0,e5.S)(rV)}),g=j.control,y=j.errors,Z=j.handleSubmit,w=j.register;return(0,eJ.jsx)(e4.Z,{id:"offCanvasForm",handleSubmit:Z(x),children:(0,eJ.jsx)(tl.Z,{label:"Notes",children:(0,eJ.jsx)(tC.Z,iV(iV({},{control:g,errors:y,register:w}),{},{name:"rejectedNotes",rows:3}))})})};iz.defaultProps={cancelMod:!1};var iY,iB=(iQ=(0,eh.Z)(ej().mark(function e(t){var n,r,i,o;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n=t.job,r=t.offCanvas,i=t.refetch,o=t.accountId,r.show({content:(0,eJ.jsx)(rB,{accountId:o||null,job:n,offCanvas:r,refetch:i}),submit:!1,title:"Accept Job"});case 2:case"end":return e.stop()}},e)})),function(e){return iQ.apply(this,arguments)}),iG=(iY=(0,eh.Z)(ej().mark(function e(t){var n,r,i,o;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n=t.job,r=t.offCanvas,i=t.refetch,o=t.accountId,r.show({content:(0,eJ.jsx)(iz,{accountId:o||null,job:n,offCanvas:r,refetch:i}),title:"Reject Job"});case 2:case"end":return e.stop()}},e)})),function(e){return iY.apply(this,arguments)}),iW=(0,es.Ps)(Z||(Z=(0,ea.Z)(["\n  mutation UpdateJob($id: Int!, $update: Job_set_input!) {\n    update_Job_by_pk(pk_columns: { id: $id }, _set: $update) {\n      id\n    }\n  }\n"]))),iK=(0,es.Ps)(w||(w=(0,ea.Z)(['\n  mutation UPSERT_JOB_REPORT_WITH_MEDIA(\n    $objects: [JobReport_insert_input!]!\n    $jobReportId: Int\n    $isNewCustomerSignature: Boolean!\n    $isNewSupplierSignature: Boolean!\n  ) {\n    deleteCustomerSignature: delete_Media(\n      where: {\n        category: { _eq: "customerSignature" }\n        Media_Entities: { JobReport: { id: { _eq: $jobReportId } } }\n      }\n    ) @skip(if: $isNewCustomerSignature) {\n      returning {\n        id\n      }\n    }\n    deleteSupplierSignature: delete_Media(\n      where: {\n        category: { _eq: "supplierSignature" }\n        Media_Entities: { JobReport: { id: { _eq: $jobReportId } } }\n      }\n    ) @skip(if: $isNewSupplierSignature) {\n      returning {\n        name\n        id\n      }\n    }\n    insert_JobReport(\n      objects: $objects\n      on_conflict: {\n        constraint: uc_JobReport_jobId\n        update_columns: [completion, meta, notes, timing, passFailStatus, recommendations]\n      }\n    ) {\n      returning {\n        id\n        completion\n        meta\n        notes\n        timing\n        createdAt\n        updatedAt\n      }\n    }\n  }\n']))),iX=n(56815),i0=n(41391),i1=n(47568),i2=(0,e9.Ry)({id:(0,e9.Rx)(),completion:(0,e9.Z_)().when("completed",{is:"true",then:(0,e9.Z_)().oneOf(i1.M2.map(function(e){return e.value})).required()}),notes:(0,e9.Z_)().min(50,"Insufficient information added.\n    Please enter a minimum of 50 characters in the description before submitting your report."),timing:(0,e9.Z_)().when("completed",{is:"true",then:(0,e9.Z_)().oneOf(["correct","incorrect"]).required()}),completionNotes:(0,e9.Z_)(),houseKeepingExpenses:(0,e9.nK)(),houseKeepingPhotos:(0,e9.nK)(),correctStart:(0,e9.hT)().max(new Date),correctEnd:(0,e9.hT)().when("correctStart",function(e,t){return e?t.min(e).max(new Date):t.max(new Date)}),correctDuration:(0,e9.Rx)().min(1).when(["correctStart","correctEnd"],function(e,t,n){var r=e0()(t).diff(e,"minutes");return n.max(r)}),recommendations:(0,e9.Z_)().when(["passFailStatus","$requireRecommendations"],function(e,t,n){return"Failed"===e&&t?n.min(50,"Please enter a minimum of 50 characters in the\n          recommendations before submitting your report."):n.min(0)})}),i3=n(10166),i6=n(6514),i5=n(64666),i4=n(40238),i7=n(60092),i8=function(e){var t=e.status,n=e.open,r=e.onClose,i=e.onConfirm;return(0,eJ.jsx)(i9,{open:n,onClose:r,"aria-labelledby":"alert-dialog-title","aria-describedby":"alert-dialog-description",children:(0,eJ.jsxs)(i6.Z,{sx:{fontFamily:i7.Q.THEME_TYPOGRAPHY.newFont,padding:"32px 44px"},children:[(0,eJ.jsxs)(eD.Z,{width:"100%",alignItems:"center",spacing:1,mb:"24px",children:[(0,eJ.jsx)(i4.Z,{sx:{color:i7.Q.COLOUR.warning}}),(0,eJ.jsx)(ot,{variant:"h6",children:"Please ensure that the job's Pass/Fail status below is correct."}),(0,eJ.jsx)(ot,{variant:"h6",color:"Passed"===t?"green":"red",children:t})]}),(0,eJ.jsxs)(eD.Z,{width:"100%",direction:"row",justifyContent:"center",spacing:2,children:[(0,eJ.jsx)(oe,{variant:"outlined",onClick:r,children:"Cancel"}),(0,eJ.jsx)(oe,{type:"submit",form:"offCanvasForm",variant:"contained",onClick:i,children:"Confirm"})]})]})})};i8.defaultProps={onClose:function(){},onConfirm:function(){}};var i9=(0,i3.Z)(i5.Z)(function(){return{"&.MuiDialog-root.MuiModal-root":{zIndex:1e4},"& .MuiPaper-root":{width:"400px"}}}),oe=(0,i3.Z)(eC.Z)(function(){return{fontFamily:"inherit"}}),ot=(0,i3.Z)(eI.Z)(function(){return{fontFamily:"inherit",fontWeight:600,textAlign:"center"}}),on=n(61730),or=n(37645),oi=(0,es.Ps)(O||(O=(0,ea.Z)(['\n  query GET_SIGNATURES_TAXONOMY($signatureType: jsonb) {\n    Taxonomy(\n      where: {\n        type: { _eq: "signatures" }\n        status: { _eq: "active" }\n        meta: { _contains: $signatureType }\n      }\n    ) {\n      id\n      name\n      status\n      meta\n    }\n  }\n']))),oo=(0,es.Ps)(I||(I=(0,ea.Z)(['\n  query GET_SIGNATURES_MEDIA($jobReportId: Int) {\n    customerSignatureMedia: Media(\n      where: {\n        category: { _eq: "customerSignature" }\n        Media_Entities: { JobReport: { id: { _eq: $jobReportId } } }\n      }\n      order_by: { createdAt: desc }\n      limit: 1\n    ) {\n      filename\n      id\n      category\n    }\n    supplierSignatureMedia: Media(\n      where: {\n        category: { _eq: "supplierSignature" }\n        Media_Entities: { JobReport: { id: { _eq: $jobReportId } } }\n      }\n      order_by: { createdAt: desc }\n      limit: 1\n    ) {\n      filename\n      id\n      category\n    }\n    JobReport(where: { id: { _eq: $jobReportId } }) {\n      meta\n    }\n  }\n']))),oa=n(18574),os=n(93362);function oc(){var e,t=window;return{width:t.innerWidth,height:t.innerHeight}}var ou=(0,os.D)(),ol={customer:{customerSignature:!0},supplier:{supplierSignature:!0}},od=function(e){var t,n,r,i=e.label,o=e.title,a=e.signatureState,s=e.setSignatureState,c=e.signatureType,u=e.signatureError,l=(n=(t=(0,K.useState)(oc()))[0],r=t[1],(0,K.useEffect)(function(){function e(){r(oc())}return window.addEventListener("resize",e),function(){return window.removeEventListener("resize",e)}},[]),n).width,d=(0,on.Z)("(max-width: 600px)"),p=K.useState(!1),m=(0,eb.Z)(p,2),f=m[0],v=m[1],h=(0,K.useState)([{label:"Select...",value:null}]),b=h[0],x=h[1],j=(0,K.useState)(!1),g=j[0],y=j[1],Z=(0,K.useState)((null==a?void 0:a.signer)||""),w=Z[0],O=Z[1],I=(0,K.useState)(!1),S=I[0],P=I[1],C=(0,K.useState)(!0),D=C[0],R=C[1],k=(0,K.useRef)(null),E=(0,er.a)(oi,{variables:{signatureType:ol[c]},onCompleted:function(e){x(e.Taxonomy.map(function(e){return{label:e.name,value:e.name}}))}}).loading,A=function(){v(!1)},q=function(e){R(!1);var t=k.current,n=t.getContext("2d"),r=e.nativeEvent.changedTouches[0],i=r.clientX,o=r.clientY,a=t.getBoundingClientRect();n.beginPath(),n.moveTo(i-a.left,o-a.top),y(!0)},T=function(e){R(!1);var t=k.current.getContext("2d"),n=e.nativeEvent,r=n.offsetX,i=n.offsetY;t.beginPath(),t.moveTo(r,i),y(!0)},_=function(e){if(g){var t=k.current.getContext("2d"),n=e.nativeEvent,r=n.offsetX,i=n.offsetY;t.lineTo(r,i),t.stroke()}},$=function(e){if(g){var t=k.current,n=t.getContext("2d"),r=e.nativeEvent.changedTouches[0],i=r.clientX,o=r.clientY,a=t.getBoundingClientRect();n.lineTo(i-a.left,o-a.top),n.stroke()}},H=function(){y(!1)},N=function(e){if(!w){P(!0);return}var t={signature:k.current.toDataURL("image/png"),signer:w.label,timestamp:e0()().toISOString(),isBase64:!0,isBlank:D};s(function(){return t}),P(!1),v(!1)},M=function(){v(!1)};return(0,eJ.jsxs)(eJ.Fragment,{children:[(0,eJ.jsxs)(eD.Z,{direction:"row",spacing:2,alignItems:"center",children:[(0,eJ.jsx)(eC.Z,{variant:"outlined",color:u?"error":"secondary",sx:{width:"40px",height:"40px",borderRadius:"20px",minWidth:0},onClick:function(){v(!0)},children:"+"}),(0,eJ.jsx)(eI.Z,{sx:{color:"rgb(0,55,83)"},children:i}),(0,eJ.jsxs)(op,{fullScreen:d,open:f,onClose:A,sx:{zIndex:1500},children:[(0,eJ.jsx)(or.Z,{children:o}),(0,eJ.jsxs)(eD.Z,{direction:"column",sx:{padding:2},spacing:2,children:[(0,eJ.jsx)("canvas",{ref:k,width:d?l:600,height:200,style:{border:"1px solid #000",padding:"10px"},onTouchStart:q,onTouchMove:$,onTouchEnd:H,onTouchCancel:H,onMouseDown:T,onMouseMove:_,onMouseUp:H,onMouseOut:H}),(0,eJ.jsxs)(eD.Z,{direction:"row",spacing:2,sx:{height:"fit"},alignItems:"center",children:[(0,eJ.jsx)(eI.Z,{children:"Name: "}),(0,eJ.jsx)(oa.F,{freeSolo:!0,error:S,sx:{width:"100%",zIndex:11e3},loading:E,placeholder:i,size:"medium",options:b,className:"responsive-fontSize",value:w,getOptionLabel:function(e){return"string"==typeof e?e:e.value?e.value:e.label},onChange:function(e,t){"string"==typeof t?O({label:t}):t&&t.value?O({label:t.value}):O(t)},filterOptions:function(e,t){var n=ou(e,t),r=t.inputValue,i=e.some(function(e){return r===e.title});return""===r||i||n.push({value:r,label:'Add "'.concat(r,'"')}),n}})]}),(0,eJ.jsxs)(eD.Z,{direction:"row",spacing:3,justifyContent:"flex-end",children:[(0,eJ.jsx)(eC.Z,{variant:"contained",color:"error",onClick:M,children:"Cancel"}),(0,eJ.jsx)(eC.Z,{variant:"contained",color:"success",onClick:N,children:"Submit"})]})]})]})]}),(null==a?void 0:a.signature)&&(0,eJ.jsxs)(eD.Z,{direction:"column",children:[(0,eJ.jsx)(eZ.Z,{children:(0,eJ.jsx)("img",{src:null==a?void 0:a.signature,alt:"signature",width:400,height:200})}),(0,eJ.jsxs)(eI.Z,{children:["Name: ",null==a?void 0:a.signer]}),(0,eJ.jsxs)(eI.Z,{children:["Time: ",e0()(null==a?void 0:a.timestamp).format("YYYY-MM-DD HH:mm")]})]})]})};od.defaultProps={label:"",title:"Customer signature",signatureState:{signature:"",signer:"",timestamp:""},setSignatureState:function(){},signatureError:!1};var op=(0,i3.Z)(i5.Z)(function(){return{"&.MuiDialog-root.MuiModal-root":{zIndex:1e4},"& .MuiPaper-root":{width:"100%",maxWidth:"600px"}}}),om=n(49088),of=function(e){for(var t=atob(e.split(",")[1]),n=Array(t.length),r=0;r<t.length;r++)n[r]=t.charCodeAt(r);var i=new Uint8Array(n),o=new Blob([i],{type:"image/png"});return new File([o],"canvasImage.png",{type:"image/png"})};function ov(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function oh(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ov(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ov(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var ob=function(e){var t,n,r,i,o,a,s,c,u,l,d,p,m,f,v,h,b,x,j,g=e.job,y=e.offCanvas,Z=e.refetch,w=(0,eg.x)(),O=(0,t2.x)().user,I={id:null===(t=g.report)||void 0===t?void 0:t.id,completion:null===(n=g.report)||void 0===n?void 0:n.completion,notes:(null===(r=g.report)||void 0===r?void 0:r.notes)||"",timing:g.timingStatus,completionNotes:(null===(i=g.report)||void 0===i?void 0:null===(o=i.meta)||void 0===o?void 0:o.completionNotes)||"",houseKeepingExpenses:null===(a=g.report)||void 0===a?void 0:null===(s=a.meta)||void 0===s?void 0:s.houseKeepingExpenses,houseKeepingPhotos:null===(c=g.report)||void 0===c?void 0:null===(u=c.meta)||void 0===u?void 0:u.houseKeepingPhotos,correctDuration:g.correctDuration,correctStart:g.correctStart?new Date(g.correctStart):"",correctEnd:g.correctEnd?new Date(g.correctEnd):"",passFailStatus:(null===(l=g.report)||void 0===l?void 0:l.passFailStatus)||"Passed",recommendations:(null===(d=g.report)||void 0===d?void 0:d.recommendations)||""},S=(0,e6.cI)({defaultValues:I,resolver:(0,e5.S)(i2),context:{completed:(0,eK.E)(g,"completed"),requireRecommendations:g.requireReportRecommendations}}),P=S.errors,C=S.handleSubmit,D=S.register,R=S.watch,k=S.control,E=S.setValue,A=(0,K.useState)(!1),q=A[0],T=A[1],_=(0,K.useState)(!1),$=_[0],H=_[1],N=(0,K.useState)(!1),M=N[0],F=N[1],J=(0,K.useState)(!1),L=J[0],U=J[1],V=(0,K.useState)(!1),Q=V[0],z=V[1],Y=R("notes"),B=R("timing"),G=R("completion"),W=R("correctStart"),X=R("correctEnd"),ee=R("recommendations"),en=R("passFailStatus"),ei=(0,K.useState)({signature:"",signer:"",timestamp:"",isBase64:!1,isBlank:!0}),eo=ei[0],ea=ei[1],es=(0,K.useState)({signature:"",signer:"",timestamp:"",isBase64:!1,isBlank:!0}),ec=es[0],eu=es[1];(0,K.useEffect)(function(){return!g.reportPassFail||I.id?F(!0):F(!1)},[]),(0,K.useEffect)(function(){var e,t;null!==(e=g.report)&&void 0!==e&&e.passFailStatus&&((null===(t=g.report)||void 0===t?void 0:t.passFailStatus)!==en?F(!1):F(!0))},[en]),(0,K.useEffect)(function(){var e;eo.signature&&null!=g&&null!==(e=g.meta)&&void 0!==e&&e.customerSignature&&U(!1)},[eo]),(0,K.useEffect)(function(){var e;ec.signature&&null!=g&&null!==(e=g.meta)&&void 0!==e&&e.supplierSignature&&z(!1)},[ec]);var el,ed=ra({autoStart:!1,startTime:(0,eK.E)(g,"inProgress"),endTime:(0,eK.E)(g,"completed")}).time,ep=ed.seconds,em=ed.minutes,ef=ed.hours,ev=(0,ey.D)(iW,{onCompleted:(el=(0,eh.Z)(ej().mark(function e(t){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!g){e.next=3;break}return e.next=3,(0,tD.F)(w,g.id);case 3:y.close(),Z&&Z();case 5:case"end":return e.stop()}},e)})),function(e){return el.apply(this,arguments)})}),ex=(0,eb.Z)(ev,1)[0];(0,er.a)(oo,{skip:!(null!==(p=g.report)&&void 0!==p&&p.id),variables:{jobReportId:null===(m=g.report)||void 0===m?void 0:m.id},onCompleted:function(e){if(e.customerSignatureMedia.length>0){var t={};t.signature="".concat("https://cleverly-media.s3.eu-west-2.amazonaws.com","/").concat(e.customerSignatureMedia[0].filename),t.signer=e.JobReport[0].meta.customerSignatureName,t.timestamp=e.JobReport[0].meta.customerSignatureTime,t.isBlank=!1,ea(t)}if(e.supplierSignatureMedia.length>0){var n={};n.signature="".concat("https://cleverly-media.s3.eu-west-2.amazonaws.com","/").concat(e.supplierSignatureMedia[0].filename),n.signer=e.JobReport[0].meta.supplierSignatureName,n.timestamp=e.JobReport[0].meta.supplierSignatureTime,n.isBlank=!1,eu(n)}}});var eZ,ew=(0,ey.D)(iK,{onCompleted:function(e){y.close(),Z&&Z()}}),eO=(0,eb.Z)(ew,1)[0],eS=(0,K.useContext)(et.Z).user,eP=(eZ=(0,eh.Z)(ej().mark(function e(t){var n,r,i,o,a,s,c,u,l,d,p;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,U(!1),z(!1),M){e.next=5;break}return e.abrupt("return",H(!0));case 5:if(!(!eo.signature&&null!=g&&null!==(n=g.meta)&&void 0!==n&&n.customerSignature&&(0,eK.E)(g,"completed"))){e.next=8;break}return U(!0),e.abrupt("return");case 8:if(!(!ec.signature&&null!=g&&null!==(r=g.meta)&&void 0!==r&&r.supplierSignature&&(0,eK.E)(g,"completed"))){e.next=11;break}return z(!0),e.abrupt("return");case 11:if(T(!0),o=[],!eo.isBase64){e.next=21;break}return e.next=16,(0,om.V)(of(eo.signature),"image");case 16:s=e.sent.key,(c={entity:"JobReport"}).Medium={data:{adminId:O.adminId,category:"customerSignature",caption:"test",expiryAt:null,extension:null==s?void 0:s.split(".").pop(),userId:eS.id,filename:s,meta:{},type:"image"}},o.push(c);case 21:if(!ec.isBase64){e.next=29;break}return e.next=24,(0,om.V)(of(ec.signature),"image");case 24:l=e.sent.key,(d={entity:"JobReport"}).Medium={data:{adminId:O.adminId,category:"supplierSignature",caption:"test",expiryAt:null,extension:null==l?void 0:l.split(".").pop(),userId:eS.id,filename:l,meta:{},type:"image"}},o.push(d);case 29:p={id:t.id,jobId:g.id,completion:t.completion,notes:t.notes,passFailStatus:t.passFailStatus,recommendations:t.recommendations,meta:{houseKeepingExpenses:t.houseKeepingExpenses,houseKeepingPhotos:t.houseKeepingPhotos,customerSignatureName:eo.signer,customerSignatureTime:eo.timestamp,customerSignatureIsBlank:eo.isBlank,supplierSignatureName:ec.signer,supplierSignatureTime:ec.timestamp,supplierSignatureIsBlank:ec.isBlank},Media_Entity:{data:o.length>0?o:[]}},t.completionNotes&&(p.meta.completionNotes=t.completionNotes),eO({variables:{jobReportId:null==g?void 0:null===(i=g.report)||void 0===i?void 0:i.id,objects:[p],isNewCustomerSignature:!eo.isBase64,isNewSupplierSignature:!ec.isBase64}}),(0,eK.E)(g,"completed")&&ex({variables:{id:g.id,update:{timingStatus:t.timing,correctDuration:"incorrect"===t.timing?t.correctDuration:null,correctStart:"incorrect"===t.timing?t.correctStart:null,correctEnd:"incorrect"===t.timing?t.correctEnd:null}}});case 33:return e.prev=33,T(!1),e.finish(33);case 36:case"end":return e.stop()}},e,null,[[0,,33,36]])})),function(e){return eZ.apply(this,arguments)}),eC=(null==g?void 0:null===(f=g.media)||void 0===f?void 0:f.length)||0,eR={control:k,errors:P,register:D},ek=null;switch(G){case"returnVisit":ek="Please provide description of works and time required in hours/days";break;case"returnVisitByAnother":ek="Please indicate the type of works and engineer required";break;case"couldNotDo":ek="Please advise why you were unable to do these works"}var eE,eA=function(e){e.target.checked?E("passFailStatus","Failed"):E("passFailStatus","Passed")},eq=function(){H(!1)},eT=function(){F(!0),H(!1)};return(0,eJ.jsxs)(eJ.Fragment,{children:[(0,eJ.jsx)(i8,{status:en,open:$,onClose:eq,onConfirm:eT}),q?(0,eJ.jsx)(nq.Z,{color:"inherit",size:20}):(0,eJ.jsxs)("form",{id:"offCanvasForm",onSubmit:C(eP),children:[(0,eJ.jsxs)(tl.Z,{label:"Detailed description of works",children:[(0,eJ.jsx)(tC.Z,oh(oh({},eR),{},{name:"notes",rows:4})),(null==P?void 0:P.notes)&&(0,eJ.jsx)(iX.Z,{sx:{m:0},children:null==P?void 0:null===(v=P.notes)||void 0===v?void 0:v.message}),(0,eJ.jsxs)(eI.Z,{children:[Y.length,"/50"]})]}),!(0,eK.E)(g,"completed")&&(0,eJ.jsx)(tH.Z,{style:{margin:0,justifyContent:"flex-end"},children:(0,eJ.jsx)(tp.Z,{content:"Save",context:"secondary",type:"submit",size:"sm"})}),!(0,eK.E)(g,"completed")&&(0,eJ.jsx)(eD.Z,{spacing:1,children:(null==g?void 0:null===(h=g.meta)||void 0===h?void 0:h.customerSignature)&&(0,eJ.jsx)(od,{label:"Add customer signature",title:"Add customer signature",name:"customerSignature",jobReport:g.report,onCancel:function(){},signatureState:eo,setSignatureState:ea,signatureType:"customer",signatureError:L})}),(0,eK.E)(g,"completed")&&(0,eJ.jsxs)(eJ.Fragment,{children:[(0,eJ.jsx)(rJ.Z,{}),(0,eJ.jsx)(tl.Z,{label:"Timing",children:(0,eJ.jsx)(tu.Z,oh(oh({},eR),{},{data:[{id:"correct",label:"I confirm that the job took ".concat(ef,":").concat(em,":").concat(ep),value:"correct"},{id:"incorrect",label:"The timing is incorrect",value:"incorrect"}],name:"timing",stacked:!0}))}),"incorrect"===B&&(0,eJ.jsxs)(eJ.Fragment,{children:[(0,eJ.jsx)(tl.Z,{label:"Enter correct time of starting ",children:(0,eJ.jsx)(tA.M,oh(oh({},eR),{},{errors:P,dateFormat:"d MMM yyyy HH:mm",disableInitialDateBackground:!1,placeholder:"Click to select Start time",name:"correctStart",showTimeSelect:!0,todayButton:!1,maxDate:X?new Date(X):new Date,onChange:function(e){E("correctStart",e),E("correctDuration",e0()(X).diff(e,"minutes"))}}))}),(0,eJ.jsx)(tl.Z,{label:"Enter correct time of ending ",children:(0,eJ.jsx)(tA.M,oh(oh({},eR),{},{errors:P,dateFormat:"d MMM yyyy HH:mm",disableInitialDateBackground:!1,placeholder:"Click to select End time",name:"correctEnd",showTimeSelect:!0,todayButton:!1,minDate:W?new Date(W):new Date,maxDate:new Date,onChange:function(e){E("correctEnd",e),E("correctDuration",e0()(e).diff(W,"minutes"))}}))}),(0,eJ.jsx)(tl.Z,{label:"Enter correct job duration",children:(0,eJ.jsxs)(tY.Z,{children:[(0,eJ.jsx)(td.Z,{errors:P,min:0,name:"correctDuration",register:D,type:"number"}),(0,eJ.jsx)(tB.Z,oh(oh({},eR),{},{addonType:"append",size:"sm",text:!0,children:"Minutes"}))]})})]}),g.reportPassFail&&(0,eJ.jsxs)(eJ.Fragment,{children:[(0,eJ.jsx)(rJ.Z,{}),(0,eJ.jsx)(eI.Z,{sx:{color:"rgb(0,55,83)"},children:g.reportPassFailTitle}),(0,eJ.jsxs)(eD.Z,{direction:"row",spacing:1,alignItems:"center",children:[(0,eJ.jsx)(eI.Z,{children:"Pass"}),(0,eJ.jsx)(e6.Qr,{name:"passFailStatus",control:k,render:function(e){var t=e.value;return(0,eJ.jsx)(oj,{checked:"Passed"!==t,onChange:eA})}}),(0,eJ.jsx)(eI.Z,{children:"Fail"})]}),(0,eJ.jsxs)(tl.Z,{label:"Recommendations",children:[(0,eJ.jsx)(tC.Z,oh(oh({},eR),{},{name:"recommendations",rows:4})),(null==P?void 0:P.recommendations)&&(0,eJ.jsx)(iX.Z,{sx:{m:0},children:null==P?void 0:null===(b=P.recommendations)||void 0===b?void 0:b.message}),(0,eJ.jsxs)(eI.Z,{children:[ee.length,"/50"]})]})]}),(0,eJ.jsx)(rJ.Z,{}),(0,eJ.jsx)(tl.Z,{label:"Job status",children:(0,eJ.jsx)(tu.Z,oh(oh({},eR),{},{data:i1.M2,name:"completion",stacked:!0}))}),ek&&(0,eJ.jsx)(eJ.Fragment,{children:(0,eJ.jsx)(tl.Z,{label:ek,children:(0,eJ.jsx)(tC.Z,oh(oh({},eR),{},{name:"completionNotes",rows:2}))})}),(0,eJ.jsx)(rJ.Z,{}),(0,eJ.jsxs)(tl.Z,{label:"Requirements",children:[(0,eJ.jsx)(tc.Z,oh(oh({},eR),{},{data:[{id:"expensesAdded",label:"Expenses added",value:"expensesAdded"}],name:"houseKeepingExpenses"})),(0,eJ.jsxs)(ox,{children:["Confirm all expenses have been added, expenses not added before completing a job may not be paid",(eE=(0,i0.E)(g.expenses,0,"supplier").totalExpenses,(0,eJ.jsx)(t7.Z,{content:"Total submitted",text:(0,e1.Z)(eE)}))]}),(0,eJ.jsx)(tc.Z,oh(oh({},eR),{},{data:[{id:"photosAdded",label:"Photos added",value:"photosAdded"}],name:"houseKeepingPhotos"})),(0,eJ.jsxs)(ox,{children:["You must add at least 1 photo, but please include before and after photos as a minimum (",eC," Photo(s) added)"]}),(0,eJ.jsx)(rJ.Z,{}),(0,eJ.jsxs)(eD.Z,{spacing:1,children:[(null==g?void 0:null===(x=g.meta)||void 0===x?void 0:x.customerSignature)&&(0,eJ.jsx)(od,{label:"Add customer signature",title:"Add customer signature",name:"customerSignature",jobReport:g.report,onCancel:function(){},signatureState:eo,setSignatureState:ea,signatureType:"customer",signatureError:L}),(null==g?void 0:null===(j=g.meta)||void 0===j?void 0:j.supplierSignature)&&(0,eJ.jsx)(od,{label:"Add engineer signature",title:"Add engineer signature",jobReport:g.report,name:"supplierSignature",onCancel:function(){},signatureState:ec,setSignatureState:eu,signatureType:"supplier",signatureError:Q})]})]})]})]})]})},ox=tQ.ZP.small.withConfig({displayName:"form__StyledSmall",componentId:"sc-d1alez-0"})(["margin-top:-0.75rem;display:block;"]),oj=(0,i3.Z)(nD.Z)(function(e){var t=e.checked;return{"&.MuiSwitch-root":{"& .MuiSwitch-thumb":{backgroundColor:t?"red":"green"},"& .MuiSwitch-track":{backgroundColor:t?"red":"green"},"& .Mui-checked+.MuiSwitch-track":{backgroundColor:t?"red":"green"}}}}),og=n(70136),oy=n(34613),oZ=n(33006),ow=n(40826),oO=function(e){var t,n,r,i,o,a,s,c,u,l,d,p,m,f=e.job,v={completion:null===(n=f.report)||void 0===n?void 0:n.completion,notes:null===(r=f.report)||void 0===r?void 0:r.notes,timing:f.timingStatus,completionNotes:(null===(i=f.report)||void 0===i?void 0:null===(o=i.meta)||void 0===o?void 0:o.completionNotes)||"",houseKeepingExpenses:null===(a=f.report)||void 0===a?void 0:null===(s=a.meta)||void 0===s?void 0:s.houseKeepingExpenses,houseKeepingPhotos:null===(c=f.report)||void 0===c?void 0:null===(u=c.meta)||void 0===u?void 0:u.houseKeepingPhotos,correctDuration:f.correctDuration,correctStart:f.correctStart?new Date(f.correctStart):"",correctEnd:f.correctEnd?new Date(f.correctEnd):"",passFailStatus:null===(l=f.report)||void 0===l?void 0:l.passFailStatus,reportPassFailTitle:f.reportPassFailTitle||"",recommendations:(null===(d=f.report)||void 0===d?void 0:d.recommendations)||"",comments:(null===(p=f.report)||void 0===p?void 0:p.comments)||""},h=(0,og.Z)({autoStart:!1,startTime:(0,eK.E)(f,"inProgress"),endTime:(0,eK.E)(f,"completed")}).time,b=h.seconds,x=h.minutes,j=h.hours,g=null;switch(v.completionNotes){case"returnVisit":g="Please provide description of works and time required in hours/days";break;case"returnVisitByAnother":g="Please indicate the type of works and engineer required";break;case"couldNotDo":g="Please advise why you were unable to do these works"}return(0,eJ.jsxs)("div",{children:[(0,eJ.jsxs)(eJ.Fragment,{children:[(0,eJ.jsx)(t7.Z,{content:"Notes",text:v.notes}),(0,eJ.jsx)(rJ.Z,{})]}),(0,eK.E)(f,"completed")&&(0,eJ.jsxs)(eJ.Fragment,{children:["correct"===v.timing&&(0,eJ.jsx)(t7.Z,{content:"Timing",text:"I confirm that the job took ".concat(j,":").concat(x,":").concat(b)}),"incorrect"===v.timing&&(0,eJ.jsxs)(eJ.Fragment,{children:[(0,eJ.jsx)(t7.Z,{content:"The timing is incorrect",text:"incorrect"}),v.correctStart&&(0,eJ.jsx)(t7.Z,{content:"Correct start",text:"".concat((0,e2.Z)(v.correctStart)," - ").concat((0,oy.Z)(v.correctStart))}),v.correctEnd&&(0,eJ.jsx)(t7.Z,{content:"Correct end",text:"".concat((0,e2.Z)(v.correctEnd)," - ").concat((0,oy.Z)(v.correctEnd))}),v.correctDuration&&(0,eJ.jsx)(t7.Z,{content:"Correct duration",text:"".concat(v.correctDuration," - minutes")})]}),v.passFailStatus&&(0,eJ.jsxs)(eJ.Fragment,{children:[(0,eJ.jsx)(t7.Z,{content:v.reportPassFailTitle,text:v.passFailStatus}),(0,eJ.jsx)(t7.Z,{content:"Recommendations",text:v.recommendations}),v.comments&&(0,eJ.jsx)(t7.Z,{content:"Comments",text:v.comments})]}),(0,eJ.jsx)(rJ.Z,{}),(0,eJ.jsx)(t7.Z,{content:"Job status",text:null===(m=i1.M2.find(function(e){return e.value===v.completion}))||void 0===m?void 0:m.label}),g&&(0,eJ.jsx)(t7.Z,{content:g,text:v.completionNotes}),(0,eJ.jsx)(rJ.Z,{}),(0,eJ.jsx)(oZ.Z,{tag:"h4",content:"Requirements"}),"expensesAdded"===v.houseKeepingExpenses&&(0,eJ.jsxs)(oS,{children:[(0,eJ.jsx)(ow.Z,{context:"success",icon:"check",size:"sm"}),(0,eJ.jsx)(t7.Z,{content:"",text:"Expenses added"}),(0,eJ.jsx)(oI,{children:(t=(0,i0.E)(f.expenses,0,"supplier").totalExpenses,(0,eJ.jsx)(t7.Z,{content:"Total submitted",text:(0,e1.Z)(t)}))})]}),"photosAdded"===v.houseKeepingPhotos&&(0,eJ.jsxs)(oS,{children:[(0,eJ.jsx)(ow.Z,{context:"success",icon:"check",size:"sm"}),(0,eJ.jsx)(t7.Z,{content:"",text:"Photos added"})]})]})]})},oI=tQ.ZP.small.withConfig({displayName:"details__StyledSmall",componentId:"sc-zc4e8j-0"})(["display:block;"]),oS=tQ.ZP.div.withConfig({displayName:"details__StyledIconBox",componentId:"sc-zc4e8j-1"})(["display:flex;align-items:center;"]);function oP(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function oC(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?oP(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):oP(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var oD,oR,ok,oE=function(e){var t,n,r,i,o,a,s,c=e.job,u=e.refetch,l=e.toggleShow,d=(0,K.useContext)(et.Z).user,p=(0,e6.cI)({defaultValues:{email:null===(t=c.customerUser)||void 0===t?void 0:t.email}}),m=p.errors,f=p.control,v=p.handleSubmit,h=p.register,b=p.watch,x=b("sendEmail"),j=b("email"),g=(0,ey.D)(ec.yT),y=(0,eb.Z)(g,1)[0],Z=(0,ey.D)(ec.xY,{onCompleted:(a=(0,eh.Z)(ej().mark(function e(){var t;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(j&&"sendEmail"===x)){e.next=5;break}return e.next=3,(0,rI.e)({adminId:c.adminId,job:c,openReport:!1});case 3:t=e.sent,y({variables:{timing:{status:"reportPDFSentSupplier",jobId:c.id,userId:d.id,meta:{toEmail:j,fileUrl:t.link}}}});case 5:u&&u(),l();case 7:case"end":return e.stop()}},e)})),function(){return a.apply(this,arguments)})}),w=(0,eb.Z)(Z,1)[0],O=(s=(0,eh.Z)(ej().mark(function e(t){var n,r;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n="reportSent",r=c.meta||{},w({variables:{id:c.id,changes:{meta:r,status:n},timing:{status:n,jobId:c.id,userId:d.id},_append:{statusData:(0,W.Z)({},n,e0()().toISOString())}}});case 3:case"end":return e.stop()}},e)})),function(e){return s.apply(this,arguments)});return(0,eJ.jsxs)(e4.Z,{handleSubmit:v(O),children:[(0,eJ.jsx)(t7.Z,{content:"Customer",text:null===(n=c.customer)||void 0===n?void 0:n.name}),(0,eJ.jsx)(t7.Z,{content:"Customer Contact",text:null===(r=c.customerUser)||void 0===r?void 0:r.fullName}),(0,eJ.jsx)(t7.Z,{content:"Phone",text:null===(i=c.customerUser)||void 0===i?void 0:i.phone}),(0,eJ.jsx)(t7.Z,{content:"Email",text:null===(o=c.customerUser)||void 0===o?void 0:o.email}),(0,eJ.jsx)(rL.Z,{}),(0,eJ.jsx)(tu.Z,oC(oC({},{errors:m,register:h,control:f}),{},{data:[{id:"sendEmail",label:"Send report via email",value:"sendEmail"},{id:"markAsReportSent",label:"Mark report as sent",value:"markAsReportSent"}],name:"sendEmail"})),"sendEmail"===x&&(0,eJ.jsx)(eJ.Fragment,{children:(0,eJ.jsx)(ne.Z,{fullWidth:!0,inputRef:h,label:"Send to email address",name:"email"})}),(0,eJ.jsx)(e7.H,{content:"Submit",type:"submit"})]})},oA=(oD=(0,eh.Z)(ej().mark(function e(t,n,r){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,eJ.jsx)(oE,{job:t,refetch:r,toggleShow:n.show}),submit:!1,title:"Send Report"});case 1:case"end":return e.stop()}},e)})),function(e,t,n){return oD.apply(this,arguments)}),oq=(oR=(0,eh.Z)(ej().mark(function e(t,n,r){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,eJ.jsx)(ob,{job:t,offCanvas:n,refetch:r}),title:t.report?"Update Report":"Create Report"});case 1:case"end":return e.stop()}},e)})),function(e,t,n){return oR.apply(this,arguments)}),oT=(ok=(0,eh.Z)(ej().mark(function e(t,n){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n.show({submit:!1,content:(0,eJ.jsx)(eJ.Fragment,{children:(0,eJ.jsx)(oO,{job:t})}),title:"Details Report"});case 1:case"end":return e.stop()}},e)})),function(e,t){return ok.apply(this,arguments)});(0,es.Ps)(S||(S=(0,ea.Z)(["\n  mutation AddQuotation($objects: [SupplierQuote_insert_input!]!) {\n    insert_SupplierQuote(objects: $objects) {\n      returning {\n        id\n      }\n    }\n  }\n"])));var o_=(0,es.Ps)(P||(P=(0,ea.Z)(["\n  mutation UpdateQuotation(\n    $id: Int!\n    $changes: SupplierQuote_set_input\n    $jobId: Int\n    $objectJobTiming: [JobTiming_insert_input!]!\n  ) {\n    update_SupplierQuote_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n      status\n    }\n    insert_JobTiming(objects: $objectJobTiming) {\n      returning {\n        id\n        status\n        notes\n        createdAt\n      }\n    }\n  }\n"])));(0,es.Ps)(C||(C=(0,ea.Z)(["\n  mutation UpdateQuotation(\n    $id: Int!\n    $changes: SupplierQuote_set_input\n    $supplierOffer: [SupplierOffer_insert_input!]!\n  ) {\n    update_SupplierQuote_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n    insert_SupplierOffer(objects: $supplierOffer) {\n      returning {\n        id\n      }\n    }\n  }\n"])));var o$=(0,es.Ps)(D||(D=(0,ea.Z)(["\n  query GetQuotationLineItems($quotationId: Int!, $type: String) {\n    lineItems: SupplierQuoteLineItem(\n      where: { quoteId: { _eq: $quotationId }, type: { _eq: $type } }\n    ) {\n      id\n      description\n      item\n      qty\n      qtyUnit\n      quoteId\n      supplierTotal\n      total\n      type\n      unitRate\n    }\n  }\n"]))),oH=(0,es.Ps)(R||(R=(0,ea.Z)(['\n  query GetQuoteUplift($jobId: Int) {\n    SupplierQuote: SupplierQuote(where: { jobId: { _eq: $jobId }, type: { _eq: "uplift" } }) {\n      status\n      quotationId: id\n      jobId\n      totalDuration\n      totalDurationUnit\n      startDate\n      methodStatement\n      notes\n    }\n  }\n']))),oN=(0,es.Ps)(k||(k=(0,ea.Z)(["\n  mutation InsertSupplierQuoteLineItem($objects: [SupplierQuoteLineItem_insert_input!]!) {\n    insert_SupplierQuoteLineItem(objects: $objects) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),oM=(0,es.Ps)(E||(E=(0,ea.Z)(["\n  mutation UpdateSupplierQuoteLineItem($id: Int!, $changes: SupplierQuoteLineItem_set_input) {\n    update_SupplierQuoteLineItem_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n  }\n"]))),oF=(0,es.Ps)(A||(A=(0,ea.Z)(["\n  mutation DeleteSupplierQuoteLineItem($id: Int!) {\n    delete_SupplierQuoteLineItem_by_pk(id: $id) {\n      id\n    }\n  }\n"]))),oJ=(0,es.Ps)(q||(q=(0,ea.Z)(["\n  mutation InsertSupplierQuoteLineItem(\n    $objects: [SupplierQuote_insert_input!]!\n    $objectJobTiming: [JobTiming_insert_input!]!\n  ) {\n    insert_SupplierQuote(objects: $objects) {\n      returning {\n        id\n        status\n      }\n    }\n    insert_JobTiming(objects: $objectJobTiming) {\n      returning {\n        id\n        status\n        notes\n        createdAt\n      }\n    }\n  }\n"]))),oL=n(11587),oU=n(68956),oV=n(16540),oQ=n(95618),oz=n(28497);function oY(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function oB(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?oY(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):oY(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var oG=function(e){var t,n,r=e.editMode,i=e.onSuccess,o=e.rawData,a=e.quotationId,s=(e.setQuote,e.supplierId),c=e.type,u=e.toggleShow,l=e.jobId,d=e.refetchView,p=(0,t2.x)(),m=p.hasRole,f=p.user,v=(0,e6.cI)({defaultValues:{description:r?o.description:"",qty:r?o.qty:"",qtyUnit:r?o.qtyUnit:"hours",unitRate:r?o.unitRate:"",item:r?o.item:"",total:r?o.total:null},resolver:(0,e5.S)((t=c,(0,e9.Ry)().shape({qty:(0,e9.Rx)().required(),unitRate:(0,e9.Rx)().required(),qtyUnit:"Labour"===t&&(0,e9.Z_)().oneOf(["hours","days"]).required()})))}),h=v.control,b=v.errors,x=v.handleSubmit,j=v.register,g=v.watch,y={control:h,errors:b,register:j},Z=g("qty"),w=g("unitRate"),O=g("total"),I=(0,ey.D)(oN,{onCompleted:function(e){var t=e.insert_SupplierQuoteLineItem.returning[0].id;i&&i(t)}}),S=(0,eb.Z)(I,2),P=S[0],C=S[1].loading,D=(0,ey.D)(oJ),R=(0,eb.Z)(D,2),k=R[0],E=R[1].loadingInsert,A=(0,ey.D)(oM,{onCompleted:function(e){var t=e.update_SupplierQuoteLineItem_by_pk.id;i&&i(t)}}),q=(0,eb.Z)(A,2),T=q[0],_=q[1].loadingUpdate,$=(n=(0,eh.Z)(ej().mark(function e(t){var n,i,u,p,m;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t.total=Number(t.total),!r){e.next=7;break}return t.supplierTotal=t.qty*t.unitRate,e.next=5,T({variables:{id:null==o?void 0:o.id,changes:t}});case 5:case 14:e.next=28;break;case 7:if(t.accountId=Number(s),t.type=c,t.quoteId=Number(a),t.supplierTotal=t.qty*t.unitRate,!a){e.next=16;break}return e.next=14,P({variables:{objects:[t]}});case 16:return n={accountId:s,jobId:l,status:"upliftDraft",quoteNumber:"Uplift",type:"uplift"},i={notes:"Create uplift draft with insert line item",status:"upliftDraft",jobId:l,userId:f.id},e.next=20,k({variables:{objects:[n],objectJobTiming:[i]}});case 20:return u=e.sent,e.next=23,u.data.insert_SupplierQuote.returning[0];case 23:return m=e.sent.id,e.next=27,P({variables:{objects:[oB(oB({},t),{},{quoteId:m})]}});case 27:d();case 28:case"end":return e.stop()}},e)})),function(e){return n.apply(this,arguments)});return(0,eJ.jsxs)(e4.Z,{handleSubmit:x($),children:[(0,eJ.jsx)(tH.Z,{children:(0,eJ.jsx)(tN.Z,{md:12,children:(0,eJ.jsx)(tl.Z,{label:"Description",children:(0,eJ.jsx)(tC.Z,oB(oB({},y),{},{name:"description",rows:2}))})})}),(0,eJ.jsxs)(tH.Z,{children:[(0,eJ.jsx)(tN.Z,{md:4,children:(0,eJ.jsx)(tl.Z,{label:"Quantity",children:(0,eJ.jsx)(td.Z,oB(oB({},y),{},{name:"qty",type:"number"}))})}),"Labour"===c&&(0,eJ.jsx)(tN.Z,{md:4,children:(0,eJ.jsx)(tl.Z,{label:"Quantity Unit",children:(0,eJ.jsx)(tE.Z,oB(oB({},y),{},{name:"qtyUnit",options:[{text:"Hours",value:"hours",disabled:!1},{text:"Days",value:"days",disabled:!1}]}))})}),(0,eJ.jsx)(tN.Z,{md:4,children:(0,eJ.jsx)(oz.Z,oB(oB({},y),{},{label:m("supplier")?"Unit Rate":"Supplier Unit Rate",name:"unitRate",vat:"Ex VAT"}))})]}),(0,eJ.jsxs)(tm.Z,{children:["Supplier Total: ",(0,e1.Z)(Z*w)]}),(0,eJ.jsx)(rJ.Z,{}),m("admin")&&(0,eJ.jsxs)(eJ.Fragment,{children:[(0,eJ.jsx)(tH.Z,{children:(0,eJ.jsx)(tN.Z,{md:12,children:(0,eJ.jsx)(oz.Z,oB(oB({},y),{},{label:"Customer Unit Rate",name:"total",vat:"Ex VAT"}))})}),(0,eJ.jsxs)(tm.Z,{children:["Customer Total (Labour Item): ",(0,e1.Z)(Z*O)]}),(0,eJ.jsx)(rJ.Z,{})]}),(0,eJ.jsxs)(tH.Z,{justify:"end",style:{margin:"0 5px"},children:[(0,eJ.jsx)(tp.Z,{content:"Cancel",onClick:u,style:{margin:"0 5px"}}),(0,eJ.jsx)(tp.Z,{content:r?"Save":"Add",disabled:C||_||E,type:"submit"})]}),(0,eJ.jsx)("div",{style:{clear:"both"}})]})};oG.defaultProps={rawData:{}};var oW=function(e){var t=e.type,n=e.updateTotal,r=e.quotationId,i=e.jobId,o=e.supplierId,a=e.success,s=e.readOnly,c=e.refetchView,u=(0,K.useContext)(np.Z).hasRole,l=(0,K.useContext)(eR.Z),d=(0,er.a)(o$,{skip:!r,variables:{quotationId:r,type:t}}),p=d.data,m=(p=void 0===p?{lineItems:[]}:p).lineItems,f=d.loading,v=d.refetch,h=(0,ey.D)(oF,{onCompleted:function(e){v(),a()}}),b=(0,eb.Z)(h,1)[0];(0,K.useEffect)(function(){(null==m?void 0:m.length)&&n(m)},[m]);var x=function(){v(),a(),l.close()},j=function(e,n){l.show({content:(0,eJ.jsx)(oG,{editMode:!!(null!=n&&n.rawData),onSuccess:x,rawData:null==n?void 0:n.rawData,toggleShow:l.close,quotationId:r,supplierId:o,type:t,jobId:i,readOnly:s,refetchView:c}),submit:!1,title:"".concat(n?"Edit":"Insert"," ").concat(t," Item")})},g=function(e,t){b({variables:{id:t.id}})},y=[{text:"ID",hidden:!0},{text:"Description"},{hidden:!u(["admin","supplier","customer"]),text:"Qty"},{hidden:!u(["admin","supplier"]),text:"Supplier Rate"},{hidden:!u(["admin","supplier"]),text:"Supplier Total"},{hidden:!u(["admin","customer"]),text:"Customer Rate"},{hidden:!u(["admin","customer"]),text:"Customer Total"},{hidden:!u(["admin","supplier"])||s,formatter:oU.Z,formatterData:(0,oQ.N)("",{onEditClick:j,onDeleteClick:g}),text:"Actions"},{text:"Raw Data",hidden:!0}],Z=m.reduce(function(e,t){return e+t.total*t.qty},0),w=m.reduce(function(e,t){return e+t.supplierTotal},0);return f?(0,eJ.jsx)(nA.Z,{sx:{zIndex:1e5},open:!0,children:(0,eJ.jsx)(nq.Z,{color:"secondary"})}):(0,eJ.jsxs)(eJ.Fragment,{children:[(0,eJ.jsx)(oZ.Z,{content:(0,eJ.jsxs)(oK,{align:"center",justify:"between",children:[(0,eJ.jsx)("span",{children:t}),u(["admin","supplier"])&&!s&&(0,eJ.jsx)(tp.Z,{content:"Insert ".concat(t," Item"),context:"secondary",onClick:j,size:"sm"})]}),tag:"h4"}),(0,eJ.jsx)(oV.Z,{columns:y,rows:m.map(function(e){return{id:e.id,description:e.description,qty:"Labour"===e.type?"".concat(e.qty," ").concat(e.qtyUnit):e.qty,rate:(0,e1.Z)(e.unitRate),supplierTotal:(0,e1.Z)(e.supplierTotal),customerRate:e.total,total:(0,e1.Z)(e.total*e.qty),action:"",rawData:e}})}),(0,eJ.jsxs)("div",{style:{textAlign:"right"},children:[u(["admin","supplier"])&&(0,eJ.jsxs)(oX,{children:["Subtotal - ",t," ",u(["admin"])&&"- Supplier",": ",(0,e1.Z)(w)]}),u(["admin","customer"])&&(0,eJ.jsxs)(oX,{children:["Subtotal - ",t,": ",(0,e1.Z)(Z)]})]})]})},oK=(0,tQ.ZP)(tH.Z).attrs(function(){return{align:"center",justify:"between"}}).withConfig({displayName:"lineItemTable__StyledRow",componentId:"sc-1uniqd1-0"})(["margin:0 5px;"]),oX=tQ.ZP.p.withConfig({displayName:"lineItemTable__StyledP",componentId:"sc-1uniqd1-1"})(["margin:0;"]);function o0(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function o1(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o0(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o0(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var o2=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1?arguments[1]:void 0;return e.reduce(function(e,n){return"total"===t?e+=n[t]*n.qty:e+=n[t]},0)},o3=function(e){var t=e.quotationId,n=e.jobId,r=e.supplierId,i=e.success,o=e.readOnly,a=e.refetchView,s=e.total,c=e.setTotal,u=(e.supplierTotal,e.setSupplierTotal),l=(e.customerTotal,e.setCustomerTotal),d=(0,K.useContext)(np.Z).hasRole,p=function(e,t){return c(function(n){return o1(o1({},n),{},(0,W.Z)({},e,o2(t,"total")))})},m=function(e,t){return u(function(n){return o1(o1({},n),{},(0,W.Z)({},e,o2(t,"supplierTotal")))})},f=function(e,t){return l(function(n){return o1(o1({},n),{},(0,W.Z)({},e,o2(t,"total")))})},v=s.labour+s.materials,h=.2*v;return(0,eJ.jsxs)(eJ.Fragment,{children:[(0,eJ.jsx)(tH.Z,{children:(0,eJ.jsx)(tN.Z,{md:12,children:(0,eJ.jsx)(oW,{jobId:n,quotationId:t,readOnly:o,success:i,supplierId:r,type:"Labour",updateTotal:function(e){p("labour",e),m("labour",e),f("labour",e)},refetchView:a})})}),(0,eJ.jsx)(rJ.Z,{}),(0,eJ.jsx)(tH.Z,{children:(0,eJ.jsx)(tN.Z,{md:12,children:(0,eJ.jsx)(oW,{jobId:n,quotationId:t,readOnly:o,success:i,supplierId:r,type:"Materials",updateTotal:function(e){p("materials",e),m("materials",e),f("materials",e)},refetchView:a})})}),(0,eJ.jsx)(rJ.Z,{}),d(["admin","customer"])&&(0,eJ.jsx)(tH.Z,{children:(0,eJ.jsxs)(tN.Z,{md:12,style:{textAlign:"right"},children:[(0,eJ.jsxs)("div",{children:["Sub Total: ",(0,e1.Z)(v)]}),(0,eJ.jsxs)("div",{children:["VAT (20%): ",(0,e1.Z)(h)]}),(0,eJ.jsxs)("div",{children:["Total: ",(0,e1.Z)(v+h)]})]})})]})},o6=(0,e9.Ry)().shape({notes:(0,e9.Z_)()}),o5=n(33366);function o4(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function o7(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o4(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o4(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var o8=function(e){var t,n,r,i,o=e.jobId,a=e.onSuccess,s=e.supplierId,c=e.readOnly,u=e.refetchView,l=(0,K.useContext)(eR.Z),d=(0,eg.x)(),p=(0,t2.x)(),m=p.hasRole,f=p.user,v=(0,K.useState)(),h=v[0],b=v[1],x=(0,K.useState)(),j=x[0],g=x[1],y=(0,K.useState)({text:"-",context:"info"}),Z=y[0],w=y[1],O=(0,K.useState)({labour:0,materials:0}),I=O[0],S=O[1],P=(0,K.useState)({labour:0,materials:0}),C=P[0],D=P[1],R=(0,K.useState)({labour:0,materials:0}),k=R[0],E=R[1],A=(0,ey.D)(o_,{skip:c,onCompleted:(t=(0,eh.Z)(ej().mark(function e(t){var n,r,i;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!o){e.next=3;break}return e.next=3,(0,tD.F)(d,o);case 3:r=(n=t.update_SupplierQuote_by_pk).id,i=n.status,a&&a({id:r,status:i}),l.close();case 6:case"end":return e.stop()}},e)})),function(e){return t.apply(this,arguments)})}),q=(0,eb.Z)(A,1)[0],T=(0,ey.D)(oJ,{skip:c,onCompleted:(n=(0,eh.Z)(ej().mark(function e(t){var n,r,i;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!o){e.next=3;break}return e.next=3,(0,tD.F)(d,o);case 3:r=(n=t.insert_SupplierQuote.returning[0]).id,i=n.status,a&&a({id:r,status:i}),l.close();case 6:case"end":return e.stop()}},e)})),function(e){return n.apply(this,arguments)})}),_=(0,eb.Z)(T,1)[0],$=(0,er.a)(oH,{variables:{jobId:o},onCompleted:(r=(0,eh.Z)(ej().mark(function e(t){var n;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!o){e.next=3;break}return e.next=3,(0,tD.F)(d,o);case 3:b(null===(n=t.SupplierQuote[0])||void 0===n?void 0:n.quotationId),g(t.SupplierQuote[0]);case 5:case"end":return e.stop()}},e)})),function(e){return r.apply(this,arguments)})}).refetch,H=(0,e6.cI)({resolver:(0,e5.S)(o6)}),N=H.handleSubmit,M=H.setValue;(0,K.useEffect)(function(){M("totalDuration",null==j?void 0:j.totalDuration),M("totalDurationUnit",null==j?void 0:j.totalDurationUnit),M("methodStatement",null==j?void 0:j.methodStatement),j&&w(o5.AK.find(function(e){return e.value===(null==j?void 0:j.status)}))},[j]);var F=(i=(0,eh.Z)(ej().mark(function e(t){var n,r,i,a;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t.status=m("supplier")?"supplierUpliftRequested":"upliftRequestSendCustomer",n={jobId:o,userId:f.id,notes:"Supplier Uplift requested ",status:"supplierUpliftRequested",meta:{total:C.labour+C.materials}},r={jobId:o,userId:f.id,notes:"Uplift requested sent customer ",status:"upliftRequestSendCustomer",meta:{total:(I.labour+I.materials)*1.2}},i=m("supplier")?[n]:(null==j?void 0:j.status)==="supplierUpliftRequested"?[r]:[n].concat([r]),!h){e.next=9;break}return e.next=7,q({variables:{id:h,changes:t,objectJobTiming:i}});case 7:e.next=12;break;case 9:return a=o7(o7({},t),{},{accountId:s,jobId:o,quoteNumber:"Uplift",type:"uplift"}),e.next=12,_({variables:{objects:[a],objectJobTiming:i}});case 12:case"end":return e.stop()}},e)})),function(e){return i.apply(this,arguments)}),J=function(){l.close(),u()};return(0,eJ.jsxs)(e4.Z,{handleSubmit:N(F),children:[(0,eJ.jsxs)(tH.Z,{children:[(0,eJ.jsx)(tN.Z,{md:12,children:(0,eJ.jsx)(ts.Z,{content:"This is the total amount to be paid for the job and includes any time spent on the job thus far.",context:"info"})}),(0,eJ.jsxs)(tN.Z,{md:12,children:["Status: ",(0,eJ.jsx)(oL.Z,{content:null==Z?void 0:Z.text,size:"md",context:null==Z?void 0:Z.context})]})]}),(0,eJ.jsx)(rJ.Z,{}),(0,eJ.jsx)(o3,{quotationId:h,jobId:o,supplierId:s,success:$,readOnly:c,refetchView:u,total:I,setTotal:S,supplierTotal:C,setSupplierTotal:D,customerTotal:k,setCustomerTotal:E}),(0,eJ.jsx)(tH.Z,{justify:"end",style:{margin:"0 5px"},children:(0,eJ.jsxs)(ig.Z,{children:[m(["admin","supplier"])&&!c&&(0,eJ.jsx)(tp.Z,{content:"Cancel",context:"danger",onClick:J,type:"button",size:"sm"}),m(["admin","supplier"])&&!c&&(0,eJ.jsx)(tp.Z,{content:"Submit ".concat(m(["admin"])?"(send to customer)":""),type:"submit",size:"sm"})]})}),(0,eJ.jsx)("div",{style:{clear:"both"}})]})};o8.defaultProps={readOnly:!1};var o9=function(e){var t=e.jobId,n=e.onSuccess,r=e.readOnly,i=e.supplierId,o=e.refetch;return(0,eJ.jsx)(o8,{jobId:t,onSuccess:n,supplierId:i,readOnly:r,refetchView:o})};function ae(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function at(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ae(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ae(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var an,ar,ai,ao=function(e){var t,n,r,i=e.job,o=e.refetch,a=e.status,s=e.toggleShow,c=(0,K.useContext)(et.Z).user,u=null===(t=i.quotations.find(function(e){return"uplift"===e.type}))||void 0===t?void 0:t.lineItems,l="customerUpliftApproved"===a,d=null==i?void 0:i.financeLogs,p=(0,e6.cI)({defaultValues:{comments:""}}),m=p.errors,f=p.handleSubmit,v=p.register,h=(0,ey.D)(eo.wU,{onCompleted:function(){o&&o(),s()}}),b=(0,eb.Z)(h,1)[0],x=u.reduce(function(e,t){return e+t.total*t.qty},0),j=u.filter(function(e){return"Materials"===e.type}).reduce(function(e,t){return e+t.supplierTotal},0),g=u.filter(function(e){return"Labour"===e.type}).reduce(function(e,t){return e+t.supplierTotal},0),y=(n=(0,eh.Z)(ej().mark(function e(){var t,n;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t={jobId:i.id,meta:{username:"".concat(c.nameFirst," ").concat(c.nameLast),userId:c.id}},(n=[]).push(at(at({},t),{},{type:"supplierLabourAmount",value:g,difference:g-(0,t1.B)("supplierLabourAmount",d)})),n.push(at(at({},t),{},{type:"supplierMaterialsAmount",value:j,difference:j-(0,t1.B)("supplierMaterialsAmount",d)})),n.push(at(at({},t),{},{type:"amount",value:x,difference:x-(0,t1.B)("amount",d)})),e.abrupt("return",n);case 6:case"end":return e.stop()}},e)})),function(){return n.apply(this,arguments)}),Z=(r=(0,eh.Z)(ej().mark(function e(t){var n,r;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n={notes:t.comments,status:a,jobId:i.id,userId:c.id},e.t0=l,!e.t0){e.next=6;break}return e.next=5,y();case 5:e.t0=e.sent;case 6:b({variables:{financeLog:e.t0,hasFinanceLog:l,jobChange:{pricing:"fixed"},jobId:i.id,timing:[n]}});case 8:case"end":return e.stop()}},e)})),function(e){return r.apply(this,arguments)});return(0,eJ.jsx)(e4.Z,{id:"offCanvasForm",handleSubmit:f(Z),children:(0,eJ.jsx)(tl.Z,{label:"Comments",children:(0,eJ.jsx)(tC.Z,{errors:m,name:"comments",register:v,rows:3})})})},aa=(an=(0,eh.Z)(ej().mark(function e(t,n,r){var i,o,a=arguments;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:i=a.length>3&&void 0!==a[3]&&a[3],o=function(){n.close(),r()},n.show({content:(0,eJ.jsx)(o9,{jobId:t.id,onSuccess:o,readOnly:i,supplierId:t.supplier.id,refetch:r}),submit:!1,title:"".concat(i?"Uplift details":"Uplift request"),width:"50%"});case 3:case"end":return e.stop()}},e)})),function(e,t,n){return an.apply(this,arguments)}),as=(ar=(0,eh.Z)(ej().mark(function e(t,n,r){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,eJ.jsx)(ao,{job:t,refetch:r,status:"customerUpliftApproved",toggleShow:n.show}),title:"Approve uplift"});case 1:case"end":return e.stop()}},e)})),function(e,t,n){return ar.apply(this,arguments)}),ac=(ai=(0,eh.Z)(ej().mark(function e(t,n,r){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,eJ.jsx)(ao,{job:t,refetch:r,status:"customerUpliftRejected",toggleShow:n.show}),title:"Reject uplift"});case 1:case"end":return e.stop()}},e)})),function(e,t,n){return ai.apply(this,arguments)}),au=function(e){var t,n,r=e.job,i=e.offCanvas,o=e.refetch,a=(0,K.useContext)(et.Z).user,s=(0,e6.cI)({defaultValues:{comments:""}}),c=s.errors,u=s.handleSubmit,l=s.register,d=(0,ey.D)(ev,{onCompleted:(t=(0,eh.Z)(ej().mark(function e(){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:o&&o(),i&&i.close();case 2:case"end":return e.stop()}},e)})),function(){return t.apply(this,arguments)})}),p=(0,eb.Z)(d,1)[0],m=(n=(0,eh.Z)(ej().mark(function e(t){var n;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n=(0,rx.e)(r,["onHold","closed"]),p({variables:{id:r.id,changes:{status:null==n?void 0:n.status},deleteTiming:{jobId:{_eq:r.id},status:{_eq:"closed"}},insertTiming:{notes:t.comments,status:"reopened",jobId:r.id,userId:a.id}}});case 2:case"end":return e.stop()}},e)})),function(e){return n.apply(this,arguments)});return(0,eJ.jsxs)(e4.Z,{handleSubmit:u(m),children:[(0,eJ.jsx)(tl.Z,{label:"Comments",children:(0,eJ.jsx)(tC.Z,{errors:c,name:"comments",register:l,rows:3})}),(0,eJ.jsx)(e7.H,{content:"Submit",type:"submit"})]})};au.defaultProps={job:{},offCanvas:{},refetch:function(){}};var al=function(e){var t=e.job,n=e.offCanvas,r=e.refetch;n.show({content:(0,eJ.jsx)(au,{job:t,offCanvas:n,refetch:r}),submit:!1,title:"Reopen job"})},ad=(0,es.Ps)(T||(T=(0,ea.Z)(["\n  mutation AcceptCustomerIssue($jobId: Int!, $notes: String) {\n    acceptCustomerIssue(jobId: $jobId, notes: $notes) {\n      data\n      success\n    }\n  }\n"]))),ap=function(e){var t,n=e.jobId,r=e.refetch,i=e.close,o=(0,n_.D)(),a=(0,e6.cI)({defaultValues:{notes:""}}),s=a.control,c=a.errors,u=a.handleSubmit,l=(0,ey.D)(ad,{onError:function(e){o.show({content:"Error: ".concat(e.message),severity:"error"})},onCompleted:function(){r(),i()}}),d=(0,eb.Z)(l,1)[0],p=(t=(0,eh.Z)(ej().mark(function e(t){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,d({variables:{jobId:n,notes:t.notes}});case 2:case"end":return e.stop()}},e)})),function(e){return t.apply(this,arguments)});return(0,eJ.jsx)("form",{id:"offCanvasForm",onSubmit:u(p),children:(0,eJ.jsx)(e6.Qr,{control:s,name:"notes",render:function(e){var t,n=e.value,r=e.onChange;return(0,eJ.jsx)(ne.Z,{fullWidth:!0,multiline:!0,minRows:6,variant:"filled",color:"secondary",label:"Please insert any relevant information for this approval.",value:n,onChange:r,error:c.notes,helperText:null===(t=c.notes)||void 0===t?void 0:t.message})}})})};ap.defaultProps={refetch:function(){},close:function(){}};var am,af=(am=(0,eh.Z)(ej().mark(function e(t){var n,r;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n=t.jobId,(r=t.offCanvas).show({content:(0,eJ.jsx)(ap,{jobId:n,close:r.close}),submit:!0,title:"Issue approval"});case 2:case"end":return e.stop()}},e)})),function(e){return am.apply(this,arguments)}),av=function(e){var t,n=e.timings,r=(void 0===n?[]:n).find(function(e){return"reportSentSupplier"===e.status});return r&&"Report Sent by ".concat((null==r?void 0:null===(t=r.user)||void 0===t?void 0:t.fullName)||"")},ah=function(e){var t,n=e.timings,r=void 0===n?[]:n,i=null==r?void 0:r.find(function(e){return"invoiceSent"===e.status});return i&&"Invoice sent by ".concat((null==i?void 0:null===(t=i.user)||void 0===t?void 0:t.fullName)||"")},ab=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1?arguments[1]:void 0,n=null==e?void 0:e.reduce(function(e,n){return"total"===t?e+=n[t]*n.qty:e+=n[t]},0);return isNaN(n)?null:n},ax=function(e){var t,n,r,i,o,a,s,c,u,l,d,p,m,f,v,h,b,x,j=e.addJobTiming,g=e.deleteJobTiming,y=e.job,Z=e.offCanvas,w=e.offCanvasNew,O=e.updateJob,I=e.refetch,S=e.hasRole,P=e.user,C=(0,eg.x)(),D=null;S(["admin","superadmin"])&&P.accountId&&(D=P.accountId);var R=null==P?void 0:P.invoiceThreshold,k=null==y?void 0:null===(t=y.quotations)||void 0===t?void 0:t.find(function(e){return"quotationRejected"!==e.status}),E=ab(null==k?void 0:k.lineItems,"total"),A=E+.2*E,q=null==y?void 0:null===(n=y.customerFinances)||void 0===n?void 0:null===(r=n.amountInfo)||void 0===r?void 0:r.vatTotal,T="onHold"===rf(y.timings),_=(0,eK.E)(y,"accepted"),$=(0,eK.E)(y,"closed"),H="incorrect"===y.timingStatus?y.correctEnd:(0,eK.E)(y,"completed"),N=(0,eK.E)(y,"complianceRejected"),M=(0,eK.E)(y,"complianceApproved"),F=(0,eK.E)(y,"complianceRequestedDocumentation"),J=(0,eK.E)(y,"customerPaid"),L=(null===(i=y.compliances)||void 0===i?void 0:i.length)>0,U="incorrect"===y.timingStatus?y.correctStart:(0,eK.E)(y,"inProgress"),V=(0,eK.E)(y,"supplierUpliftRequested"),Q=(0,eK.E)(y,"upliftRequestSendCustomer"),z=(0,eK.E)(y,"customerUpliftApproved"),Y=(0,eK.E)(y,"customerUpliftRejected"),B=(0,eK.E)(y,"invoiceSent"),G=(0,eK.E)(y,"invoiceSentSupplier"),W=(0,eK.E)(y,"ppmInvoiceCreated"),K=(0,eK.E)(y,"offered"),X=(0,eK.E)(y,"pending"),ee=(0,eK.E)(y,"pricingChanged"),et=(0,eK.E)(y,"quoteAccepted"),en=(0,eK.E)(y,"quoteNew"),er=(0,eK.E)(y,"raised"),ei=(0,eK.E)(y,"rejected"),eo=(0,eK.E)(y,"reportSent"),ea=(0,eK.E)(y,"reportSentSupplier"),es=(0,eK.E)(y,"supplierPaid"),ec=(0,eK.E)(y,"timingChanged"),eu=(0,eK.E)(y,"unvalidated"),el=(0,eK.E)(y,"validated"),ed=null===(o=y.childJobs)||void 0===o?void 0:o.find(function(e){return"quote"===e.type}),ep=(0,eK.E)(y,"updateAcceptOfferInput"),em=(0,eK.E)(y,"supplierCancel"),ef=(0,eK.E)(y,"expensesPendingAmount"),ev=(0,eK.E)(y,"expensesPendingAmountResolved"),eh=y.scheduledAt?null!==(a=y.meta)&&void 0!==a&&a.arrivalAnytime?"".concat(e0()(y.scheduledAt).format("D MMM YYYY")," (anytime)"):e0()(y.scheduledAt).format("D MMM YYYY HH:mm"):e0()(et||_).format("D MMM YYYY HH:mm"),eb=y.supplierOffers.filter(function(e){return"cancelled"!==e.status}).length,ex=tj("adminUplift",null==y?void 0:y.timings),ej=tg("adminUplift",null==y?void 0:y.timings),ey=ty("adminUplift",null==y?void 0:y.timings),eZ=tj("adminInvoice",null==y?void 0:y.timings),ew=tg(["adminUplift","adminInvoice"],null==y?void 0:y.timings),eO=ty("adminInvoice",null==y?void 0:y.timings),eI=null==y?void 0:null===(s=y.invoices)||void 0===s?void 0:s.filter(function(e){return id.SR.customer.includes(e.invoiceType)}),eS=null==y?void 0:null===(c=y.invoices)||void 0===c?void 0:c.filter(function(e){return id.SR.supplier.includes(e.invoiceType)}),eP=(null==eI?void 0:eI.reduce(function(e,t){var n,r,i,o;return e+((null==t?void 0:null===(n=t.reconciledAmount)||void 0===n?void 0:null===(r=n.reconciliations)||void 0===r?void 0:null===(i=r.aggregate)||void 0===i?void 0:null===(o=i.sum)||void 0===o?void 0:o.amount)||0)},0))||null,eD=(null==eS?void 0:eS.reduce(function(e,t){var n,r,i,o;return e+((null==t?void 0:null===(n=t.reconciledAmount)||void 0===n?void 0:null===(r=n.reconciliations)||void 0===r?void 0:null===(i=r.aggregate)||void 0===i?void 0:null===(o=i.sum)||void 0===o?void 0:o.amount)||0)},0))||null,eR=(null==eI?void 0:eI.reduce(function(e,t){var n;return e+((null==t?void 0:null===(n=t.amounts)||void 0===n?void 0:n.vatTotal)||0)},0))||null,ek=(null==eS?void 0:eS.reduce(function(e,t){var n;return e+((null==t?void 0:null===(n=t.amounts)||void 0===n?void 0:n.vatTotal)||0)},0))||null;return"pending"!==y.status&&"closed"!==y.status||er||en?[{id:1,label:"Job raised",date:(0,eK.E)(y,["raised","quoteNew"]),content:[{id:1,active:!0,data:"Created By ".concat((null==y?void 0:null===(u=y.timings[0])||void 0===u?void 0:null===(l=u.user)||void 0===l?void 0:l.fullName)||"")}]},{id:2,label:"Job offered",info:"no assigned suppliers",date:K,content:[{id:1,active:!T&&K&&!U&&!_&&!ec&&!ee&&y.supplierOffers&&y.supplierOffers.length>0,data:"Offered to ".concat(eb," suppliers")},{id:2,active:!T&&ei,data:"Job rejected by supplier"}],actions:[{id:1,active:!T&&er&&!U&&!K&&!y.jobScheduleId,content:"Create Quote",context:"secondary",handleClick:function(){return nU(y,Z,O,j,P)},type:"button"},{id:2,active:!$&&!T&&(0,eK.E)(y,["raised","quoteNew"])&&!U&&!_&&!y.supplier,content:"Assign Suppliers",context:"info",data:{"data-cy":"supplierAssign"},handleClick:function(){return nL({jobId:y.id,offCanvas:w,refetch:I,isSingleSupplier:(0,eK.E)(y,"quoteNew")})},type:"button"},{id:3,active:!(0,eK.E)(y,"quoteAccepted")&&!T&&!U&&y.supplier&&(K||ei),content:"Repost Job",context:"danger",handleClick:function(){return nY({jobId:y.id,offCanvas:w,refetch:I})},type:"button"}]},{id:3,label:"Accepted",info:"waiting for supplier to accept",date:"quote"!==y.type?(0,eK.E)(y,"accepted"):(0,eK.E)(y,"quoteAccepted"),content:[{id:1,active:(_||et||ec||ee)&&y.supplier,data:"Assigned to ".concat(null===(d=y.supplier)||void 0===d?void 0:d.name)},{id:2,active:(_||et)&&y.supplierUser,data:"Operative: ".concat(null===(p=y.supplierUser)||void 0===p?void 0:p.fullName)},{id:3,active:_||et,data:"Arrival time: ".concat(eh)},{id:4,active:ec&&!_&&y.supplier,data:"Job timing has changed, supplier needs to Accept the job again and set new\n          attendance time"},{id:5,active:ee&&!_&&y.supplier,data:"Job service or pricing has changed, supplier needs to Accept the job again and\n          confirm attendance and operative"},{id:6,active:ep,data:"Attendance and operative has changed by ".concat((0,tZ.j$)(y,"updateAcceptOfferInput"))},{id:7,active:em,data:"Job canceled by ".concat((0,tZ.j$)(y,"supplierCancel"))},{id:8,active:!0,data:function(){var e;return!$&&"offered"===y.status&&(null===(e=y.supplier)||void 0===e?void 0:e.id)&&!_&&(0,eJ.jsxs)(r6.Z,{size:"small",children:[(0,eJ.jsx)(eC.Z,{variant:"contained",color:"primary",onClick:function(){var e;return iB({job:y,offCanvas:Z,refetch:I,accountId:null==y?void 0:null===(e=y.supplier)||void 0===e?void 0:e.id})},size:"small",children:"Accept job"}),(0,eJ.jsx)(eC.Z,{variant:"contained",color:"danger",onClick:function(){var e;return iG({job:y,offCanvas:Z,refetch:I,accountId:null==y?void 0:null===(e=y.supplier)||void 0===e?void 0:e.id})},size:"small",children:"Reject job"})]})}}],actions:[{id:1,active:!$&&!T&&!U&&(_||ec||ee)&&y.supplier,content:"Change job timing",context:"danger",handleClick:function(){return nQ(y,Z,I)},type:"button"},{id:2,active:!$&&!T&&!U&&(_||ec||ee)&&y.supplier,content:"Change job pricing or service",context:"danger",handleClick:function(){return nV(y,Z,I)},type:"button"}]},{id:4,label:"In progress",info:"waiting for supplier to start",date:U,actions:[{id:1,active:!$&&!T&&U&&!(z||Y)&&"reactive"===y.type&&!H,content:"".concat(V?"Edit":"Request"," uplift"),context:"danger",handleClick:function(){return aa(y,Z,I,!1)},type:"button"},{id:2,active:U&&!ed,content:"Create remedial quote",context:"success",handleClick:function(){return n5({jobId:y.id,customerId:y.customerId,locationId:y.locationId,offCanvas:Z})},type:"button"},{id:3,active:ed,content:"Remedial quote Q ".concat(null==ed?void 0:ed.number),context:"info",handleClick:function(){return n4(null==ed?void 0:ed.number,Z)},type:"button"}]},{id:5,label:"Uplift requested",info:"waiting for customer",date:U&&(Q||V),active:!!(U&&(Q||V))&&"reactive"===y.type,content:[{id:1,active:z,data:"Uplift approved by ".concat((0,tZ.j$)(y,"customerUpliftApproved"))},{id:2,active:Y,data:"Uplift rejected by ".concat((0,tZ.j$)(y,"customerUpliftRejected"))},{id:4,active:V,data:function(){var e=Q&&!(z||Y);return(0,eJ.jsxs)(r6.Z,{size:"small",children:[e&&(0,eJ.jsx)(eC.Z,{variant:"contained",color:"primary",onClick:function(){return(0,tZ.il)(R,A)||ej?as(y,Z,I):(0,tv.I_)({type:"issue",role:"adminUplift",jobId:y.id,accountId:P.accountId,quotationId:null==k?void 0:k.id,amount:A,offCanvas:Z})},size:"small",children:"Approve"}),(Q||V)&&(0,eJ.jsx)(eC.Z,{variant:"contained",color:"info",onClick:function(){return aa(y,Z,I,!0)},size:"small",children:"Details"}),e&&(0,eJ.jsx)(eC.Z,{variant:"contained",color:"danger",onClick:function(){(0,tZ.il)(R,A)||ej?ac(y,Z,I):(0,tv.I_)({type:"issue",role:"adminUplift",jobId:y.id,accountId:P.accountId,quotationId:null==k?void 0:k.id,amount:A,offCanvas:Z})},size:"small",children:"Reject"})]})}}]},{id:6,label:"Threshold approval",info:"",date:(null==ej?void 0:ej.createdAt)||(null==ey?void 0:ey.createdAt),active:!!(ex||ej||ey),content:[{id:1,active:ex&&!ej&&!ey,data:"Awaiting threshold approval"},{id:2,active:ej,data:"Threshold approved by ".concat(null==ej?void 0:null===(m=ej.user)||void 0===m?void 0:m.fullName)},{id:3,active:ey,data:"Threshold rejected by ".concat(null==ey?void 0:null===(f=ey.user)||void 0===f?void 0:f.fullName)},{id:4,active:!T&&ex&&(0,tZ.il)(R,A),data:function(){return(0,eJ.jsxs)(r6.Z,{size:"small",children:[ex&&!B&&!ej&&(0,eJ.jsx)(eC.Z,{variant:"contained",color:"primary",onClick:function(){return(0,tv.i$)({type:"issue",role:"adminUplift",job:y,quoteId:null==k?void 0:k.id,offCanvas:Z,refetch:I})},size:"small",children:"Approve"}),ex&&!B&&!ej&&!ey&&(0,eJ.jsx)(eC.Z,{variant:"contained",color:"danger",onClick:function(){return(0,tv.Ii)({type:"issue",role:"adminUplift",job:y,quoteId:null==k?void 0:k.id,offCanvas:Z,refetch:I})},size:"small",children:"Reject"})]})}}]},{id:7,label:"Complete",info:"waiting for supplier to complete",date:H,content:[{id:1,active:H&&L&&F,data:(0,eJ.jsx)(r6.Z,{size:"small",children:(0,eJ.jsx)(eC.Z,{variant:"contained",color:"info",onClick:function(){var e;return r8({addJobTiming:j,job:y,entityId:null===(e=y.compliances[0])||void 0===e?void 0:e.id,userId:P.id},Z)},size:"small",children:"Upload compliance Documentation"})})}],actions:[{id:1,active:!T&&H&&L&&!F,content:"Request Documentation",context:"secondary",handleClick:function(){return ir(y,Z,I)},type:"button"},{id:2,active:!T&&H&&L&&F,content:"No Documentation Required",context:"info",handleClick:function(){return it({job:y,userId:P.id,deleteJobTiming:g})},type:"button"},{id:3,active:null===y.pricing&&!T&&H&&!$,content:"Change job pricing or service",context:"danger",handleClick:function(){return nV(y,Z,I)},type:"button"}]},{id:8,label:"Report sent",info:"after job complete",date:eo,content:[{id:1,active:ea,data:"Report submitted by supplier"},{id:2,active:!0,data:av(y)}],actions:[{id:1,active:y.report&&(ea||eo),content:"Download job report",context:"secondary",handleClick:function(){return(0,rI.e)({job:y,adminId:D})},type:"button"},{id:2,active:y.report&&!T&&(ea||eo)&&!$,content:y.report?"Update report":"Create report",context:"info",handleClick:function(){return oq(y,Z,I)},type:"button"},{id:3,active:y.report&&!T&&ea&&!eo&&!$,content:"Send to customer",context:"primary",handleClick:function(){return oA(y,Z,I)},type:"button"}]},{id:9,label:"Customer Sign Off",info:"",date:L&&(M||N),active:L,content:[{id:1,active:M,data:"Compliance sing off by ".concat((0,tZ.j$)(y,"complianceApproved"))},{id:2,active:N,data:"Compliance rejected by ".concat((0,tZ.j$)(y,"complianceRejected"))},{id:3,active:!T&&L&&F&&!(M||N),data:function(){return(0,eJ.jsxs)(r6.Z,{size:"small",children:[(0,eJ.jsx)(eC.Z,{variant:"contained",color:"primary",onClick:function(){return r9(y,Z,I)},size:"small",children:"Approve"}),(0,eJ.jsx)(eC.Z,{variant:"contained",color:"danger",onClick:function(){return ie(y,Z,I)},size:"small",children:"Reject"})]})}}]},{id:10,label:"Threshold approval",info:"",date:(null==ew?void 0:ew.createdAt)||(null==eO?void 0:eO.createdAt),active:!!(eZ||ew||eO),content:[{id:1,active:eZ&&!ew&&!eO,data:"Awaiting threshold approval"},{id:2,active:ew,data:"Threshold approved by ".concat(null==ew?void 0:null===(v=ew.user)||void 0===v?void 0:v.fullName)},{id:3,active:eO,data:"Threshold rejected by ".concat(null==eO?void 0:null===(h=eO.user)||void 0===h?void 0:h.fullName)},{id:4,active:!T&&eZ&&(0,tZ.il)(R,q),data:function(){return(0,eJ.jsxs)(r6.Z,{size:"small",children:[eZ&&!el&&!ew&&(0,eJ.jsx)(eC.Z,{variant:"contained",color:"primary",onClick:function(){return(0,tv.i$)({type:"issue",role:"adminInvoice",job:y,quoteId:null==k?void 0:k.id,offCanvas:Z,refetch:I})},size:"small",children:"Approve"}),eZ&&!el&&!ew&&!eO&&(0,eJ.jsx)(eC.Z,{variant:"contained",color:"danger",onClick:function(){return(0,tv.Ii)({type:"issue",role:"adminInvoice",job:y,quoteId:null==k?void 0:k.id,offCanvas:Z,refetch:I})},size:"small",children:"Reject"})]})}}]},{id:11,label:"Awaiting expenses pricing",info:"",date:ev,active:!!(ef||ev)},{id:12,label:"Invoices sent",info:"after validation",date:B,content:[{id:1,active:el,data:"Job validated"},{id:2,active:"ppm"!==y.type&&B,data:"Invoice number ".concat(null==y?void 0:null===(b=y.invoices)||void 0===b?void 0:null===(x=b[0])||void 0===x?void 0:x.invoiceNumber," sent")},{id:3,active:!0,data:ah(y)}],actions:"ppm"===y.type?[{id:1,active:B,content:"Download customer invoice",context:"secondary",handleClick:function(){return i$("customer",y,w,I,!1,C)},type:"button"},{id:2,active:G,content:"Download supplier invoice",context:"secondary",handleClick:function(){return i$("supplier",y,w,I,!1,C)},type:"button"}]:[{id:1,active:!$&&!T&&eu&&!el,content:"Change finance",context:"danger",handleClick:function(){return nz(y,w,I)},type:"button"},{id:2,active:!$&&!T&&eu&&!el,content:"Update invoice address",context:"danger",handleClick:function(){return iH(y,w,I)},type:"button"},{id:3,active:!T&&!el&&eo&&(!ef||ev)&&!$,content:"Validate job",context:"info",handleClick:function(){return(0,tZ.il)(R,q)||ew?iT(y,j,g,w,I):(0,tv.I_)({type:"issue",role:"adminInvoice",jobId:y.id,accountId:P.accountId,quotationId:null==k?void 0:k.id,amount:q,offCanvas:Z})},type:"button"},{id:5,active:!T&&el&&!$,content:"Un-Validate job",context:"danger",handleClick:function(){return i_(y,j,g,w,I)},type:"button"},{id:6,active:!T&&!B&&el&&!$,content:"Send customer invoice",context:"primary",handleClick:function(){return i$("customer",y,w,I,!0)},type:"button"},{id:7,active:!T&&B&&!G&&el&&!$,content:"Send supplier invoice",context:"primary",handleClick:function(){return i$("supplier",y,w,I,!0)},type:"button"},{id:8,active:el&&B,content:"Download customer invoice",context:"secondary",handleClick:function(){return i$("customer",y,w,I,!1,C)},type:"button"},{id:9,active:el&&G,content:"Download supplier invoice",context:"secondary",handleClick:function(){return i$("supplier",y,w,I,!1,C)},type:"button"}]},{id:13,label:"Customer ".concat(J?"paid":eP>0?"partially paid":"not paid"),date:J,active:"quote"!==y.type,actions:[{id:1,active:!$&&!T&&!J&&(B||W)&&el,content:"Mark customer paid",context:"info",handleClick:function(){return r4({type:"customer",job:y,offCanvas:Z,refetch:I})},type:"button"}],content:[{id:1,active:!J&&eP,data:"Reconciled amount ".concat((0,e1.Z)(eP))},{id:2,active:!J&&eP,data:"Amount outstanding ".concat((0,e1.Z)(eR))}]},{id:14,label:"Supplier ".concat(es?"paid":eD>0?"partially paid":"not paid"),date:es,active:"quote"!==y.type,actions:[{id:1,active:!$&&!T&&!es&&(G||W)&&el,content:"Mark supplier paid",context:"info",handleClick:function(){return r4({type:"supplier",job:y,offCanvas:Z,refetch:I})},type:"button"}],content:[{id:1,active:!es&&eD,data:"Reconciled amount ".concat((0,e1.Z)(eD))},{id:2,active:!es&&eD,data:"Amount outstanding ".concat((0,e1.Z)(ek))}]},{id:15,label:"Closed",info:"automatically after steps complete",date:$,actions:[{id:1,active:!T&&!$,content:"Close job",context:"danger",handleClick:function(){return tk(y,"closed",Z,I)},type:"button"},{id:2,active:!T&&!U&&!$,content:"Close and zero value job",context:"danger",handleClick:function(){return iL(y,Z,I)},type:"button"},{id:3,active:$,content:"Re-open job",context:"danger",handleClick:function(){return al({job:y,offCanvas:Z,refetch:I})},type:"button"}]}]:[{id:1,label:"Issue Reported",date:X,actions:[{id:1,active:!er&&!$,content:"Approve job",context:"primary",handleClick:function(){return af({jobId:y.id,offCanvas:w})},type:"button"}]},{id:2,label:"Closed",date:$,actions:[{id:1,active:!$,content:"Close request",context:"danger",handleClick:function(){return tk(y,"closed",Z,I)},type:"button"}]}]},aj=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1?arguments[1]:void 0,n=null==e?void 0:e.reduce(function(e,n){return"total"===t?e+=n[t]*n.qty:e+=n[t]},0);return isNaN(n)?null:n},ag=function(e){var t,n,r,i,o=e.job,a=e.user,s=e.offCanvas,c=e.offCanvasNew,u=e.refetch,l=(0,rq.q)().hasUserModule,d=(0,t2.x)().hasRole,p=(0,eg.x)(),m=d("customer_user"),f=l("finances"),v=l("jobReports"),h=null==a?void 0:a.invoiceThreshold,b=null==o?void 0:null===(t=o.quotations)||void 0===t?void 0:t.find(function(e){return"quotationRejected"!==e.status}),x=aj(null==b?void 0:b.lineItems,"total"),j=x+.2*x,g=rf(o.timings),y="incorrect"===o.timingStatus?o.correctEnd:(0,eK.E)(o,"completed"),Z=(0,eK.E)(o,"complianceRejected"),w=(0,eK.E)(o,"complianceApproved"),O=(null===(n=o.compliances)||void 0===n?void 0:n.length)>0,I=(0,eK.E)(o,"inDispute"),S=(0,eK.E)(o,"reportSent"),P=(0,eK.E)(o,"invoiceSent"),C=(0,eK.E)(o,"complianceRequestedDocumentation"),D="incorrect"===o.timingStatus?o.correctStart:(0,eK.E)(o,"inProgress"),R=(0,eK.E)(o,"upliftRequestSendCustomer"),k=(0,eK.E)(o,"customerUpliftApproved"),E=(0,eK.E)(o,"customerUpliftRejected"),A=(0,eK.E)(o,"closed"),q=tj("customer",null==o?void 0:o.timings),T=tg("customer",null==o?void 0:o.timings),_=ty("customer",null==o?void 0:o.timings),$=(0,eK.E)(o,"raised"),H=(0,eK.E)(o,"quoteNew"),N=(0,eK.E)(o,"pending"),M=o.timings.find(function(e){return"reportedByNonLoggedUser"===e.status});return"pending"!==o.status&&"closed"!==o.status||$||H||!M?[{id:1,label:"Issue reported",info:"no assigned suppliers",date:(0,eK.E)(o,"pending")||(0,eK.E)(o,"raised")||(0,eK.E)(o,"quoteNew")},{id:2,label:"Job offered",info:"no assigned suppliers",date:(0,eK.E)(o,"offered")||(0,eK.E)(o,"quoteNew")},{id:3,label:"Accepted",info:"waiting for supplier to accept the job",date:"quote"!==o.type?(0,eK.E)(o,"accepted"):(0,eK.E)(o,"quoteAccepted")},{id:4,label:"In progress",info:"waiting for supplier to start the job",date:D},{id:44,label:"Uplift requested",info:"waiting for you",date:D&&R,active:!!(D&&R)&&"reactive"===o.type,content:[{id:1,active:k,data:"Uplift approved by ".concat((0,tZ.j$)(o,"customerUpliftApproved"))},{id:2,active:E,data:"Uplift rejected by ".concat((0,tZ.j$)(o,"customerUpliftRejected"))},{id:4,active:R&&"reactive"===o.type,data:function(){var e=R&&!(k||E);return(0,eJ.jsx)(eJ.Fragment,{children:(0,eJ.jsxs)(r6.Z,{size:"small",children:[e&&(0,eJ.jsx)(eC.Z,{variant:"contained",color:"primary",onClick:function(){return(0,tZ.il)(h,j)||T?as(o,s,u):(0,tv.I_)({type:"issue",role:"customer",jobId:null==o?void 0:o.id,accountId:null==a?void 0:a.accountId,quotationId:null==b?void 0:b.id,amount:j,offCanvas:s})},size:"small",children:"Approve"}),R&&(0,eJ.jsx)(eC.Z,{variant:"contained",color:"info",onClick:function(){return aa(o,s,u,!0)},size:"small",children:"Details"}),e&&(0,eJ.jsx)(eC.Z,{variant:"contained",color:"danger",onClick:function(){return(0,tZ.il)(h,j)||T?ac(o,s,u):(0,tv.I_)({type:"issue",role:"customer",jobId:null==o?void 0:o.id,accountId:null==a?void 0:a.accountId,quotationId:null==b?void 0:b.id,amount:j,offCanvas:s})},size:"small",children:"Reject"})]})})}}]},{id:8,label:"Threshold approval",info:"",date:(null==T?void 0:T.createdAt)||(null==_?void 0:_.createdAt),active:!!(q||T||_),content:[{id:1,active:q&&!T&&!_,data:"Awaiting threshold approval"},{id:2,active:T,data:"Threshold approved by ".concat(null==T?void 0:null===(r=T.user)||void 0===r?void 0:r.fullName)},{id:3,active:_,data:"Threshold rejected by ".concat(null==_?void 0:null===(i=_.user)||void 0===i?void 0:i.fullName)},{id:4,active:"onHold"!==g&&q&&(0,tZ.il)(h,j),data:function(){return(0,eJ.jsxs)(r6.Z,{size:"small",children:[q&&!P&&!T&&(0,eJ.jsx)(eC.Z,{variant:"contained",color:"primary",onClick:function(){return(0,tv.i$)({type:"issue",role:"customer",job:o,quoteId:null==b?void 0:b.id,offCanvas:s,refetch:u})},size:"small",children:"Approve"}),q&&!P&&!T&&!_&&(0,eJ.jsx)(eC.Z,{variant:"contained",color:"danger",onClick:function(){return(0,tv.Ii)({type:"issue",role:"customer",job:o,quoteId:null==b?void 0:b.id,offCanvas:s,refetch:u})},size:"small",children:"Reject"})]})}}]},{id:5,label:"Complete",info:"waiting for supplier to complete the job",date:y,actions:[{id:1,active:!A&&y&&!I&&(v||!m),content:"Dispute",context:"danger",handleClick:function(){return rw(o,s,u)},type:"button"}],content:[{id:1,active:I&&(v||!m),data:(0,eJ.jsx)(eC.Z,{variant:"contained",color:"info",onClick:function(){return rg((0,tZ.wo)(o,"inDispute"),s)},size:"small",children:"Dispute media"})}]},{id:6,label:"Report sent",info:"waiting for supplier to send report",date:S,actions:[{id:1,active:S&&(v||!m),content:"Download job report",context:"secondary",handleClick:function(){return(0,rI.e)({adminId:o.adminId,job:o})},type:"button"}]},{id:7,label:"Customer Sign Off",info:"",date:O&&(w||Z),active:O,content:[{id:1,active:w,data:"Compliance report sang off by ".concat((0,tZ.j$)(o,"complianceApproved"))},{id:3,active:O&&C&&!(w||Z),data:function(){return(0,eJ.jsxs)(r6.Z,{size:"small",children:[(0,eJ.jsx)(eC.Z,{variant:"contained",color:"primary",onClick:function(){return r9(o,s,u)},size:"small",children:"Approve"}),(0,eJ.jsx)(eC.Z,{variant:"contained",color:"danger",onClick:function(){return ie(o,s,u)},size:"small",children:"Reject"})]})}}]},{id:8,label:"Invoice sent",info:"",date:P,actions:[{id:1,active:"ppm"!==o.type&&P&&(f||!m),content:"Download invoice",context:"secondary",handleClick:function(){return i$("customer",o,c,u,!1,p)},type:"button"},{id:2,active:"ppm"===o.type&&P&&(f||!m),content:"Download invoice",context:"secondary",handleClick:function(){return i$("customer",o,c,u,!1,p)},type:"button"}]}]:[{id:1,label:"Issue Reported",date:N,actions:[{id:1,active:!$&&!A,content:"Approve job",context:"primary",handleClick:function(){return af({jobId:o.id,offCanvas:c})},type:"button"}]},{id:2,label:"Closed",date:A,actions:[{id:1,active:!A,content:"Close request",context:"danger",handleClick:function(){return tk(o,"closed",s,u,{shouldCalculateFinance:!1})},type:"button"}]}]},ay=function(e){var t,n,r,i,o,a,s=e.addJobTiming,c=e.job,u=e.offCanvas,l=e.offCanvasNew,d=e.refetch,p=e.user,m=null==p?void 0:p.invoiceThreshold,f=null==c?void 0:null===(t=c.quotations)||void 0===t?void 0:t.find(function(e){return"quotationRejected"!==e.status}),v=null==f?void 0:null===(n=f.lineItems)||void 0===n?void 0:n.reduce(function(e,t){return e+t.supplierTotal},0),h=(0,eg.x)(),b=(null==c?void 0:null===(r=c.compliances)||void 0===r?void 0:r.length)>0,x=(0,eK.E)(c,"complianceRequestedDocumentation"),j="incorrect"===c.timingStatus?c.correctEnd:(0,eK.E)(c,"completed"),g="incorrect"===c.timingStatus?c.correctStart:(0,eK.E)(c,"inProgress"),y=(0,eK.E)(c,"closed"),Z=(0,eK.E)(c,"accepted"),w=(0,eK.E)(c,"supplierUpliftRequested"),O=(0,eK.E)(c,"customerUpliftApproved"),I=(0,eK.E)(c,"customerUpliftRejected"),S=(0,eK.E)(c,"invoiceSent"),P=(0,eK.E)(c,"invoiceSentSupplier"),C=(0,eK.E)(c,"upliftRequestSendCustomer"),D=null===(i=c.childJobs)||void 0===i?void 0:i.find(function(e){return"quote"===e.type}),R=tj("supplier",null==c?void 0:c.timings),k=tg("supplier",null==c?void 0:c.timings),E=ty("supplier",null==c?void 0:c.timings),A=(0,eK.E)(c,"expensesPendingAmount"),q=(0,eK.E)(c,"expensesPendingAmountResolved");return[{id:1,label:"Job offered",info:"no assigned suppliers",date:(0,eK.E)(c,"offered"),active:"quote"!==c.type&&!(0,eK.E)(c,"quoteAccepted")},{id:2,label:"Accepted",info:"need to accept the job",date:"quote"!==c.type?(0,eK.E)(c,"accepted"):(0,eK.E)(c,"quoteAccepted"),content:[{id:1,active:(0,eK.E)(c,"timingChanged")&&!(0,eK.E)(c,"accepted")&&c.supplier,data:"Job timing has changed, click Accept to set new attendance time or Reject if you\n          can\n        not make it"},{id:2,active:(0,eK.E)(c,"pricingChanged")&&!(0,eK.E)(c,"accepted")&&c.supplier,data:"Job service or pricing has changed, click Accept to confirm attendance"},{id:3,active:!0,data:function(){return!y&&"offered"===c.status&&!Z&&(0,eJ.jsxs)(r6.Z,{size:"small",children:[(0,eJ.jsx)(eC.Z,{variant:"contained",color:"primary",onClick:function(){return iB({job:c,offCanvas:u,refetch:d,accountId:p.accountId})},size:"small",children:"Accept job"}),(0,eJ.jsx)(eC.Z,{variant:"contained",color:"danger",onClick:function(){return iG({job:c,offCanvas:u,refetch:d,accountId:p.accountId})},size:"small",children:"Reject job"})]})}}]},{id:3,label:"In progress",info:"click the timer to start",date:(0,eK.E)(c,"inProgress"),actions:[{id:1,active:!y&&g&&!(O||I)&&"reactive"===c.type&&!j&&!C,content:"".concat(w?"Edit":"Request"," uplift"),context:"danger",handleClick:function(){return aa(c,u,d,!1)},type:"button"},{id:2,active:g&&!D,content:"Create remedial quote",context:"success",handleClick:function(){return n5({jobId:c.id,customerId:c.customerId,locationId:c.locationId,offCanvas:u})},type:"button"},{id:3,active:D,content:"Remedial quote Q ".concat(null==D?void 0:D.number),context:"info",handleClick:function(){return n4(null==D?void 0:D.number,u)},type:"button"}]},{id:44,label:"Uplift requested",info:"",date:"reactive"===c.type&&g&&w,active:!!(g&&w),content:[{id:1,active:O,data:"Uplift request approved"},{id:2,active:I,data:"Uplift request rejected"},{id:3,active:w,data:function(){return(0,eJ.jsx)(eC.Z,{variant:"contained",color:"info",onClick:function(){return aa(c,u,d,!0)},size:"small",children:"Uplift details"})}}]},{id:4,label:"Complete",info:"upload a photo and stop timer",date:j,content:[{id:1,active:b&&x,data:(0,eJ.jsx)(eC.Z,{variant:"contained",color:"info",onClick:function(){var e;return r8({addJobTiming:s,job:c,entityId:null===(e=c.compliances[0])||void 0===e?void 0:e.id,userId:p.id},u)},size:"small",children:"Upload compliance Documentation"})}]},{id:8,label:"Threshold approval",info:"",date:(null==k?void 0:k.createdAt)||(null==E?void 0:E.createdAt),active:!!(R||k||E),content:[{id:1,active:R&&!k&&!E,data:"Awaiting threshold approval"},{id:2,active:k,data:"Threshold approved by ".concat(null==k?void 0:null===(o=k.user)||void 0===o?void 0:o.fullName)},{id:3,active:E,data:"Threshold rejected by ".concat(null==E?void 0:null===(a=E.user)||void 0===a?void 0:a.fullName)},{id:4,active:R&&(0,tZ.il)(m,v),data:function(){return(0,eJ.jsxs)(r6.Z,{size:"small",children:[R&&!k&&(0,eJ.jsx)(eC.Z,{variant:"contained",color:"primary",onClick:function(){return(0,tv.i$)({type:"issue",role:"supplier",job:c,quoteId:null==f?void 0:f.id,offCanvas:u,refetch:d})},size:"small",children:"Approve"}),R&&!k&&!E&&(0,eJ.jsx)(eC.Z,{variant:"contained",color:"danger",onClick:function(){return(0,tv.Ii)({type:"issue",role:"supplier",job:c,quoteId:null==f?void 0:f.id,offCanvas:u,refetch:d})},size:"small",children:"Reject"})]})}}]},{id:5,label:"Report sent",info:"after job complete",date:(0,eK.E)(c,"reportSentSupplier"),actions:[{id:1,active:(0,eK.E)(c,"reportSentSupplier")||S||P,content:"View job report",context:"info",handleClick:function(){return oT(c,u)},type:"button"}]},{id:6,label:"Awaiting expenses pricing",info:"",date:q,active:!!(A||q)},{id:7,label:"Invoice sent",info:"",date:P,actions:[{id:1,active:"ppm"!==c.type&&P,content:"Download invoice",context:"secondary",handleClick:function(){return i$("supplier",c,l,d,!1,h)},type:"button"},{id:2,active:"ppm"===c.type&&P,content:"Download invoice",context:"secondary",handleClick:function(){return i$("supplier",c,l,d,!1,h)},type:"button"}]}]},aZ=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1?arguments[1]:void 0,n=null==e?void 0:e.reduce(function(e,n){return"total"===t?e+=n[t]*n.qty:e+=n[t]},0);return isNaN(n)?null:n},aw=function(e){var t,n,r,i,o,a=e.job,s=e.user,c=e.offCanvas,u=e.refetch,l=null==s?void 0:s.invoiceThreshold,d=null==a?void 0:null===(t=a.quotations)||void 0===t?void 0:t.find(function(e){return"quotationRejected"!==e.status}),p=aZ(null==d?void 0:d.lineItems,"total"),m=rf(a.timings),f="incorrect"===a.timingStatus?a.correctEnd:(0,eK.E)(a,"completed"),v=(0,eK.E)(a,"complianceRejected"),h=(0,eK.E)(a,"complianceApproved"),b=(null===(n=a.compliances)||void 0===n?void 0:n.length)>0,x=(0,eK.E)(a,"inDispute"),j=(0,eK.E)(a,"reportSent"),g=(0,eK.E)(a,"invoiceSent"),y=(0,eK.E)(a,"complianceRequestedDocumentation"),Z="incorrect"===a.timingStatus?a.correctStart:(0,eK.E)(a,"inProgress"),w=(0,eK.E)(a,"upliftRequestSendCustomer"),O=(0,eK.E)(a,"customerUpliftApproved"),I=(0,eK.E)(a,"customerUpliftRejected"),S=(0,eK.E)(a,"closed"),P=tj("customer",null==a?void 0:a.timings),C=tg("customer",null==a?void 0:a.timings),D=ty("customer",null==a?void 0:a.timings);return[{id:1,label:"Issue reported",info:"no assigned suppliers",date:(0,eK.E)(a,"pending")||(0,eK.E)(a,"raised")||(0,eK.E)(a,"quoteNew")},{id:2,label:"Job offered",info:"no assigned suppliers",date:(0,eK.E)(a,"offered")||(0,eK.E)(a,"quoteNew")},{id:3,label:"Accepted",info:"waiting for supplier to accept the job",date:"quote"!==a.type?(0,eK.E)(a,"accepted"):(0,eK.E)(a,"quoteAccepted")},{id:4,label:"In progress",info:"waiting for supplier to start the job",date:Z},{id:44,label:"Uplift requested",info:"waiting for you",date:Z&&w,active:!!(Z&&w)&&"reactive"===a.type,content:[{id:1,active:O,data:"Uplift approved by ".concat((0,tZ.j$)(a,"customerUpliftApproved"))},{id:2,active:I,data:"Uplift rejected by ".concat((0,tZ.j$)(a,"customerUpliftRejected"))},{id:4,active:w&&"reactive"===a.type,data:"Uplift requested by ".concat((0,tZ.j$)(a,"upliftRequestSendCustomer"))}]},{id:8,label:"Threshold approval",info:"",date:(null==C?void 0:C.createdAt)||(null==D?void 0:D.createdAt),active:!!(P||C||D),content:[{id:1,active:P&&!C&&!D,data:"Awaiting threshold approval"},{id:2,active:C,data:"Threshold approved by ".concat(null==C?void 0:null===(r=C.user)||void 0===r?void 0:r.fullName)},{id:3,active:D,data:"Threshold rejected by ".concat(null==D?void 0:null===(i=D.user)||void 0===i?void 0:i.fullName)},{id:4,active:"onHold"!==m&&P&&(0,tZ.il)(l,p+.2*p),data:"Threshold requested by ".concat(null==P?void 0:null===(o=P.user)||void 0===o?void 0:o.fullName)}]},{id:5,label:"Complete",info:"waiting for supplier to complete the job",date:f,actions:[{id:1,active:!S&&f&&!x,content:"Dispute",context:"danger",handleClick:function(){return rw(a,c,u)},type:"button"}],content:[{id:1,active:x,data:(0,eJ.jsx)(eC.Z,{variant:"contained",color:"info",onClick:function(){return rg((0,tZ.wo)(a,"inDispute"),c)},size:"small",children:"Dispute media"})}]},{id:6,label:"Report sent",info:"waiting for supplier to send report",date:j,actions:[{id:1,active:j,content:"Download job report",context:"secondary",handleClick:function(){return(0,rI.e)({adminId:a.adminId,job:a})},type:"button"}]},{id:7,label:"Customer Sign Off",info:"",date:b&&(h||v),active:b,content:[{id:1,active:h,data:"Compliance report sang off by ".concat((0,tZ.j$)(a,"complianceApproved"))},{id:3,active:b&&y&&!(h||v),data:"Compliance report sang off by ".concat((0,tZ.j$)(a,"complianceRequestedDocumentation"))}]},{id:8,label:"Invoice sent",info:"",date:g}]},aO=function(e,t,n,r,i,o,a,s,c){var u;return n("admin")?u=ax({addJobTiming:e,deleteJobTiming:t,job:r,offCanvas:i,offCanvasNew:o,updateJob:a,refetch:s,hasRole:n,user:c}):n("supplier")?u=ay({addJobTiming:e,job:r,offCanvas:i,offCanvasNew:o,refetch:s,user:c}):n("customer")?u=ag({job:r,user:c,offCanvas:i,offCanvasNew:o,refetch:s}):n("tenant")&&(u=aw({addJobTiming:e,job:r,offCanvas:i,offCanvasNew:o,refetch:s,user:c})),u.forEach(function(e){e.date&&(e.date=e0()(e.date).format("D MMM YYYY HH:mm"))}),u},aI=function(e){var t,n=[],r=null!==(t=e.meta)&&void 0!==t&&t.arrivalAnytime?"".concat(e0()(e.scheduledAt).format("D MMM YYYY")," (anytime)"):e0()(e.scheduledAt).format("D MMM YYYY HH:mm");return n.push({label:"Scheduled start:",value:e.timingStart?e0()(e.timingStart).format("D MMM YYYY HH:mm"):""}),e.timingEnd&&n.push({label:"Scheduled end:",value:e.timingEnd?e0()(e.timingEnd).format("D MMM YYYY HH:mm"):""}),n.push({label:"Supplier arrival:",value:r}),n},aS=(0,es.Ps)(_||(_=(0,ea.Z)(['\n  mutation UpdateSupplierOffer(\n    $jobId: Int!\n    $jobChanges: Job_set_input\n    $timing: [JobTiming_insert_input!]!\n  ) {\n    delete_JobTiming(where: { jobId: { _eq: $jobId }, status: { _in: ["accepted", "offered"] } }) {\n      returning {\n        jobId\n      }\n    }\n    insert_JobTiming(objects: $timing) {\n      returning {\n        id\n        status\n        createdAt\n      }\n    }\n\n    update_SupplierOffer(where: { jobId: { _eq: $jobId } }, _set: { status: "cancelled" }) {\n      returning {\n        id\n      }\n    }\n\n    update_Job_by_pk(pk_columns: { id: $jobId }, _set: $jobChanges) {\n      id\n    }\n  }\n']))),aP=function(e){var t=e.job,n=e.refetch,r=e.offCanvas,i=(0,t2.x)().user,o=(0,ey.D)(aS,{onCompleted:function(e){r.close(),"supplier"===i.accountType?ee().push("/dashboard"):n&&n()}}),a=(0,eb.Z)(o,1)[0],s=function(){var e,n=[],r=null;r={scheduledAt:null,status:"raised",supplierId:null,supplierUserId:null},n.push({status:"supplierCancel",jobId:t.id,userId:i.id,notes:null,meta:{supplierId:null===(e=t.supplier)||void 0===e?void 0:e.id}}),a({variables:{jobChanges:r,jobId:t.id,timing:n}})};return(0,eJ.jsxs)(eZ.Z,{children:[(0,eJ.jsx)(ts.Z,{context:"help",content:"Please confirm that you want to revert this job to a raised status."}),(0,eJ.jsxs)(eD.Z,{width:"100%",direction:"row",justifyContent:"flex-end",spacing:2,mt:2,children:[(0,eJ.jsx)(tp.Z,{content:"Cancel",context:"danger",onClick:function(){return r.close()},size:"md"}),(0,eJ.jsx)(tp.Z,{content:"Confirm",context:"secondary",onClick:s,size:"md"})]})]})},aC=n(58095),aD=n(37068),aR=function(e){var t,n,r,i,o,a,s,c,u,l,d,p,m,f,v=e.job,h=e.refetch,b=(0,rq.q)(),x=(0,eg.x)(),j=null===(t=b.admin)||void 0===t?void 0:null===(n=t.jobSetting)||void 0===n?void 0:n.jobNumberPrefix,g=null===(r=b.admin)||void 0===r?void 0:null===(i=r.jobSetting)||void 0===i?void 0:i.jobNumberSuffix,y=(0,K.useContext)(eR.Z),Z=(0,aC.a)(),w=(0,t2.x)(),O=w.user,I=w.hasRole,S=I("admin"),P=rf(v.timings),C="onHold"===P,D=(0,eK.E)(v,"quoteOffered"),R=(0,eK.E)(v,"accepted"),k="incorrect"===v.timingStatus?v.correctEnd:(0,eK.E)(v,"completed"),E="incorrect"===v.timingStatus?v.correctStart:(0,eK.E)(v,"inProgress"),A=(0,eK.E)(v,"disputeResolved"),q=(0,eK.E)(v,"inDispute"),T=(0,eK.E)(v,"reportSent"),_=(0,eK.E)(v,"quoteClosed"),$=(0,eK.E)(v,"closed"),H=(0,ey.D)(eo.qD,{onCompleted:(d=(0,eh.Z)(ej().mark(function e(){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!v){e.next=3;break}return e.next=3,(0,tD.F)(x,v.id);case 3:h();case 4:case"end":return e.stop()}},e)})),function(){return d.apply(this,arguments)})}),N=(0,eb.Z)(H,1)[0],M=(0,ey.D)(ta.j6,{onCompleted:(p=(0,eh.Z)(ej().mark(function e(){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!v){e.next=3;break}return e.next=3,(0,tD.F)(x,v.id);case 3:h();case 4:case"end":return e.stop()}},e)})),function(){return p.apply(this,arguments)})}),F=(0,eb.Z)(M,1)[0],J=(0,ey.D)(eo.r2,{onCompleted:(m=(0,eh.Z)(ej().mark(function e(){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!v){e.next=3;break}return e.next=3,(0,tD.F)(x,v.id);case 3:h();case 4:case"end":return e.stop()}},e)})),function(){return m.apply(this,arguments)})}),L=(0,eb.Z)(J,1)[0],U=(0,ey.D)(ec.xY,{onCompleted:function(){h&&h()}}),V=(0,eb.Z)(U,1)[0],Q=(0,ey.D)(eo.k7,{onCompleted:(f=(0,eh.Z)(ej().mark(function e(){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!v){e.next=3;break}return e.next=3,(0,tD.F)(x,v.id);case 3:h();case 4:case"end":return e.stop()}},e)})),function(){return f.apply(this,arguments)})}),z=(0,eb.Z)(Q,1)[0],Y="quote"===v.type?rt(v):aI(v),B=function(){ee().push("quote"===v.type?"/dashboard/issues/manage?id=".concat(v.number,"&quoted=1"):"/dashboard/issues/manage?id=".concat(v.number))},G=function(){y.show({content:(0,eJ.jsx)(rH,{job:v,refetch:h,toggleShow:y.show}),submit:!1,title:"Put the job on hold"})},W=function(){var e;V({variables:{id:v.id,changes:{status:null===(e=(0,rx.e)(v,"onHold"))||void 0===e?void 0:e.status},timing:{status:"resumed",jobId:v.id,userId:O.id}}})},X=function(){y.show({content:(0,eJ.jsx)(r3,{job:v,refetch:h,offCanvas:y}),submit:!1,title:"Cancel"})},et=function(){y.show({content:(0,eJ.jsx)(aP,{job:v,refetch:h,offCanvas:y}),submit:!1,title:"Revert"})},en=(0,K.useCallback)(function(){Z.show({content:(0,eJ.jsx)(aD.h,{jobId:v.id,completed:!!k,close:Z.close}),title:"Roll back"})},[Z,v.id,k]),er=(I("admin")||I("supplier")&&!!(R||D))&&"paused"!==P&&!C&&"quote"!==v.type,ei=(I("admin")||I("supplier")&&!!(R||D))&&C&&"quote"!==v.type;return(0,eJ.jsxs)(eZ.Z,{children:[(0,eJ.jsxs)(ew.Z,{expanded:!0,children:[(0,eJ.jsx)(eO.Z,{children:(0,eJ.jsx)(eI.Z,{variant:"h6",children:(null==v?void 0:null===(o=v.shortJobDesc)||void 0===o?void 0:o.length)>0&&(null==v?void 0:null===(a=v.shortJobDesc[0])||void 0===a?void 0:a.taxonomy.name)||v.title})}),(0,eJ.jsx)(eS.Z,{sx:{pt:0},children:(0,eJ.jsxs)(eP.ZP,{container:!0,rowGap:1,columnSpacing:1,children:[(0,eJ.jsxs)(eP.ZP,{item:!0,xs:12,xs3:5,pt:0,display:"flex",alignItems:"center",children:[(0,eJ.jsx)(eY.Z,{sx:{width:"24px"}}),(0,eJ.jsx)(eI.Z,{ml:1.5,children:"Type "})," ",(0,eJ.jsx)(eI.Z,{ml:.5,color:"secondary",children:(null===(s=rE.x.find(function(e){return e.value===v.type}))||void 0===s?void 0:s.text)||"-"})]}),(0,eJ.jsxs)(eP.ZP,{item:!0,xs:12,xs3:7,pt:0,display:"flex",alignItems:"center",children:[(0,eJ.jsx)(eB.Z,{sx:{width:"24px"}}),(0,eJ.jsx)(eI.Z,{ml:1.5,children:"Order"})," ",(0,eJ.jsx)(eI.Z,{ml:.5,color:"secondary",children:(0,eJ.jsx)(rA.D,{id:v.id,number:v.number,invoiceNumber:null==v?void 0:null===(c=v.invoices)||void 0===c?void 0:null===(u=c[0])||void 0===u?void 0:u.invoiceNumber,type:v.type,numberPrefix:j,numberSuffix:g,isQuote:v.quoted})})]}),(0,eJ.jsxs)(eP.ZP,{item:!0,xs:12,xs3:5,display:"flex",alignItems:"center",children:[(0,eJ.jsx)(eG.Z,{sx:{width:"24px"}}),(0,eJ.jsx)(eI.Z,{ml:1.5,children:"Source "}),(0,eJ.jsx)(eI.Z,{ml:.5,color:"secondary",children:null===(l=rT.Y.find(function(e){return e.value===v.source}))||void 0===l?void 0:l.text})]}),v&&I(["admin","customer_owner","customer_manager"])&&(0,eJ.jsx)(eP.ZP,{item:!0,xs:12,xs3:7,children:(0,eJ.jsx)(eC.Z,{variant:"contained",color:"secondary",startIcon:(0,eJ.jsx)(ez.Z,{}),onClick:B,sx:{height:"30px"},children:"Edit"})})]})})]}),I(["admin","supplier"])&&(0,eK.E)(v,["accepted","quoteAccepted"])&&(0,eJ.jsx)(rb,{job:v}),(0,eJ.jsxs)(ew.Z,{children:[(0,eJ.jsx)(eO.Z,{expandIcon:(0,eJ.jsx)(eW.Z,{}),children:(0,eJ.jsxs)(eD.Z,{direction:"row",spacing:3,children:[(0,eJ.jsx)(eI.Z,{variant:"h6",children:"Workflow"}),(0,eJ.jsx)(rk.B,{value:v.status})]})}),(0,eJ.jsxs)(eS.Z,{children:[(0,eJ.jsx)(eL,{steps:"quote"!==v.type||(0,eK.E)(v,"quoteAccepted")?aO(L,z,I,v,y,Z,N,h,O):re(F,z,I,v,y,Z,h,N,O,x)}),(0,eJ.jsx)(eD.Z,{mt:2,children:Y.map(function(e){var t=e.label,n=e.value;return(0,eJ.jsxs)(eD.Z,{direction:"row",spacing:1,children:[(0,eJ.jsx)(eI.Z,{sx:{fontSize:"14px"},children:t}),(0,eJ.jsx)(eI.Z,{sx:{fontSize:"14px",color:"secondary.main"},children:n})]})})}),(0,eJ.jsxs)(eD.Z,{direction:"row",sx:{flexWrap:"wrap",rowGap:"8px",columnGap:"8px"},mt:2,children:[I("admin")&&!C&&k&&(0,eJ.jsx)(eC.Z,{variant:"contained",color:"secondary",onClick:function(){rR(v,y)},size:"medium",children:"Follow On"}),I("supplier")&&!$&&!C&&!E&&R&&"quote"!==v.type&&(0,eJ.jsx)(eC.Z,{variant:"contained",color:"danger",onClick:X,size:"medium",children:"Cancel"}),I("admin")&&!$&&!C&&!E&&R&&"quote"!==v.type&&(0,eJ.jsx)(eC.Z,{variant:"contained",color:"danger",onClick:et,size:"medium",children:"Revert job"}),I(["admin","customer"])&&"quote"===v.type&&!_&&!$&&(0,eJ.jsx)(eC.Z,{variant:"contained",color:"danger",onClick:function(){tk(v,"quoteClosed",y,h)},size:"medium",children:"Close"}),!C&&k&&!q&&(0,eJ.jsx)(eC.Z,{variant:"contained",color:"secondary",onClick:function(){rw(v,y,h)},size:"medium",children:"Dispute"}),(I("admin")||I("supplier"))&&q&&!A&&"onHold"!==P&&(0,eJ.jsx)(eC.Z,{variant:"contained",color:"secondary",onClick:function(){rO(v,y,h)},size:"medium",children:"Resolve Dispute"}),!$&&er&&(0,eJ.jsx)(eC.Z,{variant:"contained",onClick:G,size:"medium",children:"On Hold"}),!$&&ei&&(0,eJ.jsx)(eC.Z,{variant:"contained",onClick:W,size:"medium",children:"Resume"}),!C&&q&&!A&&(0,eJ.jsx)(eC.Z,{variant:"contained",color:"info",onClick:function(){return rg((0,tZ.wo)(v,"inDispute"),y)},size:"medium",children:"Dispute media"}),S&&(k||E)&&!T&&!C&&!$&&(0,eJ.jsx)(eC.Z,{variant:"outlined",color:"danger",onClick:en,size:"medium",children:"Roll back"})]})]})]})]})},ak=n(99751),aE=n(93946),aA=n(87043),aq=n(4730),aT=["apiKey","center","zoom","size","scale","mapType","format","language","markers","path","region"];function a_(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function a$(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a_(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a_(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var aH=function(e){var t=e.apiKey,n=e.center,r=e.zoom,i=e.size,o=e.scale,a=e.mapType,s=e.format,c=e.language,u=e.markers,l=e.path,d=e.region,p=(0,aq.Z)(e,aT),m=(0,K.useState)(""),f=m[0],v=m[1];return(0,K.useEffect)(function(){var e=new URLSearchParams;e.append("center",n),e.append("zoom",r.toString()),e.append("size",i),e.append("scale",o),e.append("maptype",a),e.append("format",s),e.append("language",c),u&&e.append("markers",u),l&&e.append("path",l),d&&e.append("region",d),e.append("key",t),v("".concat("https://maps.googleapis.com/maps/api/staticmap","?").concat(e.toString()))},[t,n,r,i,a,s,c,u,l,d]),(0,eJ.jsx)("img",a$(a$({},p),{},{src:f,alt:"Static Map"}))};aH.defaultProps={apiKey:"YOUR_DEFAULT_API_KEY",center:"0,0",zoom:15,size:"400x200",scale:1,mapType:"roadmap",format:"png",language:"en",markers:"",path:"",region:""};var aN=n(94094);function aM(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function aF(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?aM(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):aM(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var aJ=function(e){var t=e.access,n=e.address,r=e.edit,i=e.entity,o=e.entityId,a=e.id,s=e.name,c=(e.open,e.refetch),u=e.showMap,l=e.showLink,d=e.title,p=e.type,m=e.expanded,f=e.onChangeExpanded,v=e.hideExpandIcon,h=(0,aC.a)(),b=function(e){e&&c&&c()},x=function(e){e.stopPropagation(),h.show({content:(0,eJ.jsx)(ii.H,{entity:i,entityId:o,id:a,onSubmit:b,addressId:n.id,type:p}),submit:!1,title:"Manage addresses"})},j=function(){h.show({title:"Property information",content:(0,eJ.jsx)(aN.w,{propertyId:o,toggleShow:h.close})})},g=(0,io.UC)(n);return(0,eJ.jsxs)(ew.Z,{disableGutters:!0,expanded:m,onChange:f,children:[(0,eJ.jsx)(aL,aF(aF({},v?{}:{expandIcon:(0,eJ.jsx)(eW.Z,{})}),{},{"aria-controls":"address-content",id:"address-header",sx:{mb:0},children:(0,eJ.jsxs)(eD.Z,{direction:"row",alignItems:"center",spacing:1,children:[(0,eJ.jsx)(eI.Z,{variant:"h6",children:d}),r&&(0,eJ.jsx)(aE.Z,{size:"small",onClick:x,children:(0,eJ.jsx)(ez.Z,{sx:{height:"17px",width:"17px"}})})]})})),(0,eJ.jsx)(eS.Z,{children:(0,eJ.jsxs)(eP.ZP,{container:!0,children:[(0,eJ.jsxs)(eP.ZP,{container:!0,item:!0,xs:12,rowSpacing:1,columnSpacing:1,children:[s&&(0,eJ.jsxs)(eP.ZP,{item:!0,xs:6,children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Property"}),(0,eJ.jsx)(ak.O,aF(aF({maxLength:17},l&&{color:"secondary",sx:{"&:hover":{cursor:"pointer"}},onClick:j}),{},{children:s}))]}),"invoice"===p&&n.invoicingEntity&&(0,eJ.jsxs)(eP.ZP,{item:!0,xs:6,children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Property"}),(0,eJ.jsx)(ak.O,{maxLength:17,children:n.invoicingEntity})]}),"invoice"!==p&&n.name&&(0,eJ.jsxs)(eP.ZP,{item:!0,xs:6,children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Name"}),(0,eJ.jsx)(ak.O,{maxLength:17,children:n.name})]})]}),(0,eJ.jsxs)(eP.ZP,{container:!0,item:!0,xs:6,rowSpacing:1,columnSpacing:1,children:[(0,eJ.jsxs)(eP.ZP,{item:!0,xs:12,children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Address"}),(0,eJ.jsx)(eI.Z,{children:n.addressLine1}),(0,eJ.jsx)(eI.Z,{children:n.addressLine2}),(0,eJ.jsx)(eI.Z,{children:n.addressLine3}),(0,eJ.jsx)(eI.Z,{children:n.city}),(0,eJ.jsx)(eI.Z,{children:n.county}),(0,eJ.jsx)(eI.Z,{children:n.postCode})]}),t&&(0,eJ.jsxs)(eP.ZP,{item:!0,xs:12,children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Access"}),(0,eJ.jsx)(ak.O,{maxLength:17,children:t})]})]}),(0,eJ.jsx)(eP.ZP,{container:!0,item:!0,xs:6,children:u&&aA.ie.map&&(0,eJ.jsx)(eP.ZP,{item:!0,xs:12,children:(0,eJ.jsx)(aU,{apiKey:aA.ie.map,center:g,markers:[g],size:"400x300",style:{display:"block",maxWidth:"250px",width:"100%",height:"auto"}})})})]})})]})};aJ.defaultProps={edit:!1,open:!0,showMap:!1,showLink:!0,title:"Address",expanded:void 0,onChangeExpanded:function(){},hideExpandIcon:!1};var aL=(0,eT.ZP)(eO.Z)(function(){return{"&.MuiButtonBase-root.Mui-expanded":{minHeight:"auto"},"& .MuiAccordionSummary-content.Mui-expanded":{marginBottom:0}}}),aU=(0,eT.ZP)(aH)(function(e){var t=e.theme;return{marginLeft:"4px",border:"1px solid ".concat(t.palette.secondary.main),borderRadius:"10px"}}),aV=n(9164);function aQ(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}var az=function(e){var t,n,r,i,o,a,s,c,u=e.job,l=e.refetch,d=(0,t2.x)().hasRole,p=(0,K.useState)(["job-location"]),m=p[0],f=p[1],v=((null===(t=u.location)||void 0===t?void 0:t.name)||"")+(u.sublocation?" (".concat(u.sublocation.name,")"):""),h=(0,io.WE)(null==u?void 0:u.location,"registered"),b=null;b=(0,eK.E)(u,"validated")&&null!==(n=u.meta)&&void 0!==n&&null!==(r=n.customerVATInvoice)&&void 0!==r&&null!==(i=r.invoiceInfo)&&void 0!==i&&i.invoiceToAddress?{address:function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?aQ(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):aQ(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}({},u.meta.customerVATInvoice.invoiceInfo.invoiceToAddress)}:(0,io.Hv)(u,"customer");var x=function(e){return function(t,n){n?f(function(t){return[].concat((0,en.Z)(t),[e])}):f(function(t){return t.filter(function(t){return t!==e})})}};return(0,eJ.jsxs)(aY,{children:[u.customer&&d(["admin"])&&(0,eJ.jsxs)(ew.Z,{expanded:m.includes("customer-content"),onChange:x("customer-content"),children:[(0,eJ.jsx)(eO.Z,{expandIcon:(0,eJ.jsx)(eW.Z,{}),"aria-controls":"customer-content",id:"customer-header",children:(0,eJ.jsxs)(eD.Z,{width:"100%",children:[(0,eJ.jsx)(eI.Z,{variant:"h6",children:"Customer"}),!m.includes("customer-content")&&(0,eJ.jsxs)(eP.ZP,{container:!0,columnSpacing:2,children:[(0,eJ.jsxs)(eP.ZP,{item:!0,xs:6,children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Name"}),(0,eJ.jsx)(ak.O,{href:"/dashboard/customers/view?id=".concat(u.customer.id),maxLength:17,children:u.customer.name})]}),(0,eJ.jsxs)(eP.ZP,{item:!0,xs:6,children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Contact"}),(0,eJ.jsx)(ak.O,{maxLength:17,children:null===(o=u.customerUser)||void 0===o?void 0:o.fullName})]})]})]})}),(0,eJ.jsx)(eS.Z,{sx:{pt:0},children:(0,eJ.jsxs)(eD.Z,{spacing:1,children:[(0,eJ.jsxs)(eD.Z,{children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Name"}),(0,eJ.jsx)(aV.r,{color:"secondary",href:"/dashboard/customers/view?id=".concat(u.customer.id),children:(0,eJ.jsx)(eI.Z,{children:u.customer.name})})]}),(0,eJ.jsxs)(eD.Z,{children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Contact"}),(0,eJ.jsx)(eI.Z,{children:null===(a=u.customerUser)||void 0===a?void 0:a.fullName})]}),(0,eJ.jsxs)(eD.Z,{children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Email"}),(0,eJ.jsx)(eI.Z,{children:null===(s=u.customerUser)||void 0===s?void 0:s.email})]}),(0,eJ.jsxs)(eD.Z,{children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Phone"}),(0,eJ.jsx)(eI.Z,{children:null===(c=u.customerUser)||void 0===c?void 0:c.phone})]}),(0,eJ.jsxs)(eD.Z,{children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Spend Threshold"}),(0,eJ.jsx)(eI.Z,{children:(0,nR.T)(u.customerSpendThreshold)})]})]})})]}),u.customer&&b&&d(["admin"])&&m.includes("customer-content")&&(0,eJ.jsx)(aJ,{hideExpandIcon:!0,expanded:m.includes("customer-content"),address:b.address,edit:!(0,eK.E)(u,"validated"),entity:"Location",entityId:u.location.id,id:b.id,refetch:l,title:"Invoice Address",type:"invoice"}),h&&(0,eJ.jsx)(aJ,{expanded:m.includes("job-location"),onChangeExpanded:x("job-location"),access:u.access,address:h.address,edit:d(["admin","customer"]),entity:"Location",entityId:u.location.id,id:h.id,name:v,showMap:!0,showLink:d(["admin","customer"]),title:"Job Location",type:"registered"}),u.customer&&b&&d(["customer"])&&(0,eJ.jsx)(aJ,{expanded:m.includes("customer-content"),onChangeExpanded:x("customer-content"),address:b.address,entity:"Location",entityId:u.location.id,id:b.id,refetch:l,title:"Invoice Address",type:"invoice"})]})},aY=(0,eT.ZP)(eZ.Z)(function(e){var t=e.theme;return{"&.MuiBox-root":{borderLeft:"5px solid ".concat(t.palette.secondary.main),borderTopLeftRadius:"5px",borderBottomLeftRadius:"5px"}}}),aB=function(e){var t,n,r,i,o,a,s,c,u=e.job,l=e.refetch,d=(0,K.useState)(["operating-location"]),p=d[0],m=d[1],f=(0,io.WE)(u.supplier,"registered"),v=(0,io.WE)(u.supplier,"operating"),h=u.supplier.contactUsers[0],b=(null===(t=u.supplierUser)||void 0===t?void 0:t.id)&&(null==h?void 0:h.user)&&(null===(n=u.supplierUser)||void 0===n?void 0:n.id)!==(null==h?void 0:h.user.id),x=function(e){return function(t,n){n?m(function(t){return[].concat((0,en.Z)(t),[e])}):m(function(t){return t.filter(function(t){return t!==e})})}};return(0,eJ.jsxs)(aG,{children:[(0,eJ.jsxs)(ew.Z,{expanded:p.includes("supplier-content"),onChange:x("supplier-content"),children:[(0,eJ.jsx)(eO.Z,{expandIcon:(0,eJ.jsx)(eW.Z,{}),"aria-controls":"supplier-content",id:"supplier-header",children:(0,eJ.jsxs)(eD.Z,{width:"100%",children:[(0,eJ.jsx)(eI.Z,{variant:"h6",children:"Supplier"}),!p.includes("supplier-content")&&(0,eJ.jsxs)(eP.ZP,{container:!0,columnSpacing:2,children:[(0,eJ.jsxs)(eP.ZP,{item:!0,xs:6,children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Name"}),(0,eJ.jsx)(ak.O,{href:"/dashboard/suppliers/view?id=".concat(u.supplier.id),maxLength:17,children:u.supplier.name})]}),(0,eJ.jsxs)(eP.ZP,{item:!0,xs:6,children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:b?"Contact":"Contact / Operative"}),(0,eJ.jsx)(ak.O,{maxLength:17,children:h.user.fullName})]})]})]})}),(0,eJ.jsx)(eS.Z,{sx:{pt:0},children:(0,eJ.jsxs)(eD.Z,{spacing:1,children:[(0,eJ.jsxs)(eD.Z,{children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Name"}),(0,eJ.jsx)(aV.r,{color:"secondary",href:"/dashboard/suppliers/view?id=".concat(u.supplier.id),children:(0,eJ.jsx)(eI.Z,{children:u.supplier.name})})]}),(0,eJ.jsxs)(eD.Z,{children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:b?"Contact":"Contact / Operative"}),(0,eJ.jsx)(eI.Z,{children:h.user.fullName})]}),(0,eJ.jsxs)(eD.Z,{children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:b?"Contact email":"Email"}),(0,eJ.jsx)(eI.Z,{children:null==h?void 0:null===(r=h.user)||void 0===r?void 0:r.email})]}),(0,eJ.jsxs)(eD.Z,{children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:b?"Contact phone":"Phone"}),(0,eJ.jsx)(eI.Z,{children:null==h?void 0:null===(i=h.user)||void 0===i?void 0:i.phone})]}),u.supplierUser&&b&&(0,eJ.jsxs)(eJ.Fragment,{children:[(0,eJ.jsxs)(eD.Z,{children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Operative"}),(0,eJ.jsx)(eI.Z,{children:u.supplierUser.fullName})]}),(0,eJ.jsxs)(eD.Z,{children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Operative email"}),(0,eJ.jsx)(eI.Z,{children:null===(o=u.supplierUser)||void 0===o?void 0:o.email})]}),(0,eJ.jsxs)(eD.Z,{children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Operative phone"}),(0,eJ.jsx)(eI.Z,{children:null===(a=u.supplierUser)||void 0===a?void 0:a.phone})]})]})]})})]}),f&&p.includes("supplier-content")&&(0,eJ.jsx)(aJ,{hideExpandIcon:!0,expanded:p.includes("supplier-content"),showMap:!0,address:f.address,entity:"Account",entityId:null===(s=u.supplier)||void 0===s?void 0:s.id,id:f.id,refetch:l,title:"Registered Address",type:"registered"}),v&&(0,eJ.jsx)(aJ,{expanded:p.includes("operating-location"),onChangeExpanded:x("operating-location"),showMap:!0,address:v.address,entity:"Account",entityId:null===(c=u.supplier)||void 0===c?void 0:c.id,id:v.id,refetch:l,title:"Operating Address",type:"operating"})]})};aB.defaultProps={};var aG=(0,eT.ZP)(eZ.Z)(function(e){var t=e.theme;return{"&.MuiBox-root":{borderLeft:"5px solid ".concat(t.palette.primary.main),borderTopLeftRadius:"5px",borderBottomLeftRadius:"5px"}}}),aW=n(90263),aK=n(67720),aX=n(23132),a0=function(e){return parseInt(e).toLocaleString("en-GB",{minimumIntegerDigits:2,useGrouping:!1})};function a1(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function a2(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a1(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a1(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var a3=function(e,t,n){var r,i,o,a,s=e.customerInfo.customerSpendThreshold,c=e.addendum,u=c.additions,l=c.deductions,d=c.discount,p=c.deposit,m=e.amountInfo,f=m.supplierAmountByTiming,v=m.vatAmount,h=m.vatRate,b=m.vatTotal,x=m.total,j=e.expensesInfo,g=j.expenses,y=j.expensesTotalExVAT,Z=e.rateInfo,w=Z.normalRate,O=Z.oohRate,I=Z.premiumRate,S=Z.calcWithServiceRate,P=(Z.costWithServiceRateExVat,Z.totalbyAmount,Z.totalByTiming),C=Z.timeSegmentsNormalRateDuration,D=Z.timeSegmentsOohRateDuration,R=Z.timeSegmentsPremiumRateDuration,k=Z.timeSegmentsTotalDuration,E=Z.pricing,A=Z.selectedSla,q=Z.serviceRateExpenses,T=Z.serviceRateLabour,_=Z.supplierService,$=Z.selectedService,H=e.invoiceInfo.invoiceType,N=e.rebate,M=e.hidden,F=t.reconciledAmount,J=t.invoicedToDate,L=n.type,U=function(e){return e?"".concat(e>0?"+":"-").concat((0,nR.T)(Math.abs(e))):""},V="supplier"===H?_:$,Q=k>V.minimumDuration?"actual":"minimum length",z=null==g?void 0:g.find(function(e){return e.vatRate!==h}),Y=J-F,B=b-J,G=[{key:"Labour",value:null,calcAmount:function(){return(0,eJ.jsx)(eJ.Fragment,{children:(0,nR.T)(f)})},show:S},{key:"Service Rate Labour",value:"".concat(T,"%"),calcAmount:null,show:S},{key:"Service Rate Expenses and Materials",value:"".concat(q,"%"),calcAmount:null,show:S},{key:"Time",value:"".concat(a0(k/60),":").concat(a0(k%60)," (").concat(Q,")"),calcAmount:null,show:!S},{key:"First hour rate",value:"".concat((0,nR.T)(null==w?void 0:w.firstHour)," ").concat(null!=N&&N.percent?"(+".concat(null==N?void 0:N.percent,"% rebate)"):""),calcAmount:function(){return(0,eJ.jsx)(eJ.Fragment,{children:(0,nR.T)(null==C?void 0:C.firstHourTotal)})},show:!S},{key:"Rate \xa3/H",value:"".concat((0,nR.T)(null==w?void 0:w.subsequentHours)," ").concat(null!=N&&N.percent?"(+".concat(null==N?void 0:N.percent,"% rebate)"):""),calcAmount:function(){return(0,eJ.jsx)(eJ.Fragment,{children:(0,nR.T)(null==C?void 0:C.subsequentHoursTotal)})},show:!S},{key:"First hour rate(OOH)",value:"".concat((0,nR.T)(null==O?void 0:O.firstHour)," ").concat(null!=N&&N.percent?"(+".concat(null==N?void 0:N.percent,"% rebate)"):""),calcAmount:function(){return(0,eJ.jsx)(eJ.Fragment,{children:(0,nR.T)(null==D?void 0:D.firstHourTotal)})},show:!S},{key:"Rate \xa3/H(OOH)",value:"".concat((0,nR.T)(null==O?void 0:O.subsequentHours)," ").concat(null!=N&&N.percent?"(+".concat(null==N?void 0:N.percent,"% rebate)"):""),calcAmount:function(){return(0,eJ.jsx)(eJ.Fragment,{children:(0,nR.T)(null==D?void 0:D.subsequentHoursTotal)})},show:!S},{key:"First hour rate(Premium)",value:"".concat((0,nR.T)(null==I?void 0:I.firstHour)," ").concat(null!=N&&N.percent?"(+".concat(null==N?void 0:N.percent,"% rebate)"):""),calcAmount:function(){return(0,eJ.jsx)(eJ.Fragment,{children:(0,nR.T)(null==R?void 0:R.firstHourTotal)})},show:!S},{key:"Rate \xa3/H(Premium)",value:"".concat((0,nR.T)(null==I?void 0:I.subsequentHours)," ").concat(null!=N&&N.percent?"(+".concat(null==N?void 0:N.percent,"% rebate)"):""),calcAmount:function(){return(0,eJ.jsx)(eJ.Fragment,{children:(0,nR.T)(null==R?void 0:R.subsequentHoursTotal)})},show:!S},{key:"SLA",value:"(".concat(null==A?void 0:A.name," -").concat(A.entity,")"),calcAmount:function(){return""},show:!S&&"ppm"!==L},{key:"Labour",value:null,calcAmount:function(){return(0,eJ.jsx)(eJ.Fragment,{children:(0,nR.T)(P)})},show:!S&&"supplier"!==H},{key:"Expenses",value:null!=N&&N.percent?"".concat((0,nR.T)(y*(1-N.percent/100))," (+").concat(N.percent,"% rebate)"):"",calcAmount:function(){return U(y)},show:y||!1},{key:"Additions",value:null,calcAmount:function(){return U(u)},show:u&&"supplier"!==H||!1},{key:"Deductions",value:null,calcAmount:function(){return U(-1*l)},show:l&&"supplier"!==H||!1},{key:"supplier"===H?"Deductions":"Discount",value:null,calcAmount:function(){return U(-1*d)},show:d||!1},{key:(0,eJ.jsx)(eJ.Fragment,{children:"Net"}),value:null,calcAmount:function(){return(0,eJ.jsx)(eJ.Fragment,{children:"=".concat((0,nR.T)(x))})},show:!0},{key:"VAT",value:!z&&"(".concat(100*h,"%)"),calcAmount:function(){return U(v)},show:!0},{key:(0,eJ.jsx)(eJ.Fragment,{children:"Gross"}),value:null,calcAmount:function(){return(0,eJ.jsx)(eJ.Fragment,{children:"=".concat((0,nR.T)(b))})},show:!0},{key:"Rebate",value:null!=N&&N.percent?"(".concat(N.percent,"%)"):"",calcAmount:function(){return(0,eJ.jsx)(eJ.Fragment,{children:(0,nR.T)(null==N?void 0:N.amount)})},show:(null==N?void 0:N.percent)||!1},{key:"Due from Customer",value:null,calcAmount:function(){return(0,eJ.jsx)(eJ.Fragment,{children:(0,nR.T)(b-(null==N?void 0:N.amount))})},show:!S&&(null==N?void 0:N.percent)||!1},{key:"Deposit",value:null,calcAmount:function(){return(0,nR.T)(p)},show:!!p},{key:"Reconciled Amount",value:null,calcAmount:(0,eJ.jsx)(eJ.Fragment,{children:(0,nR.T)(F)}),show:F>0},{key:"Amount outstanding",value:null,calcAmount:function(){return(0,nR.T)(Y)},show:!0},{key:"Amount to be invoiced",value:null,calcAmount:function(){return(0,nR.T)(B)},show:!0}],W=[{id:1,key:"Pricing",value:S?"Service Rate":"time-materials"===E?"Time & Materials":"Fixed"},{id:2,key:"Threshold",value:s&&(0,nR.T)(s)},{id:3,key:S?"":"Rate \xa3/H",value:S?"":"Adjusted by ".concat((i=(r={entity:V.entity,rebate:N}).entity,a=(null==(o=r.rebate)?void 0:o.amount)>0?"/ Rebate":"","".concat(i," ").concat("Service"," ").concat(a)))}];return{amounts:G.map(function(e,t){return a2(a2({},e),{},{id:t+1,calcAmount:M||e.calcAmount})}).filter(function(e){return e.show}),texts:W}};function a6(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function a5(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a6(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a6(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}a3.propTypes={job:ro().object.isRequired,isOOH:ro().string,multiplier:ro().string,rate:ro().string,selectedSla:ro().string,selectedService:ro().string};var a4=function(e,t,n){var r,i=e.customerInfo.customerSpendThreshold,o=e.addendum,a=o.additions,s=o.deductions,c=o.discount,u=o.deposit,l=e.amountInfo,d=l.amount,p=l.amountIncludingRebate,m=l.supplierLabourAmount,f=l.supplierMaterialsAmount,v=l.vatAmount,h=l.vatRate,b=l.total,x=l.vatTotal,j=e.expensesInfo,g=j.expenses,y=j.expensesTotalExVAT,Z=e.rateInfo,w=Z.calcWithServiceRate,O=Z.pricing,I=Z.selectedSla,S=Z.serviceRateExpenses,P=Z.serviceRateLabour,C=e.invoiceInfo.invoiceType,D=e.rebate,R=e.hidden,k=t.reconciledAmount,E=t.invoicedToDate,A=n.type,q=function(e){return e?"".concat(e>0?"+":"-").concat((0,nR.T)(Math.abs(e))):""},T=null==g?void 0:g.find(function(e){return e.vatRate!==h}),_=E-k,$=x-E,H=[{key:"Labour",value:null,calcAmount:function(){return(0,eJ.jsx)(eJ.Fragment,{children:(0,nR.T)(m)})},show:w},{key:"Service Rate Labour",value:"",calcAmount:function(){return(0,eJ.jsx)(eJ.Fragment,{children:"".concat(P,"%")})},show:w},{key:"Materials",value:null,calcAmount:function(){return(0,eJ.jsx)(eJ.Fragment,{children:(0,nR.T)(f)})},show:w},{key:"Service Rate Expenses and Materials",value:"",calcAmount:function(){return(0,eJ.jsx)(eJ.Fragment,{children:"".concat(S,"%")})},show:w},{key:"Amount",value:null!=D&&D.percent?"".concat(d," (+").concat(D.percent,"% rebate)"):"",calcAmount:function(){return(0,eJ.jsx)(eJ.Fragment,{children:(0,nR.T)(p)})},show:!("supplier"===C||w)},{key:"Labour",value:null,calcAmount:function(){return(0,eJ.jsx)(eJ.Fragment,{children:(0,nR.T)(m)})},show:"supplier"===C},{key:"Materials",value:null,calcAmount:function(){return(0,eJ.jsx)(eJ.Fragment,{children:(0,nR.T)(f)})},show:"supplier"===C},{key:"Expenses",value:null!=D&&D.percent?"".concat((0,nR.T)(y*(1-D.percent/100))," (+").concat(D.percent,"% rebate)"):"",calcAmount:function(){return q(y)},show:!0},{key:"Additions",value:null,calcAmount:function(){return q(a)},show:a&&"supplier"!==C||!1},{key:"Deductions",value:null,calcAmount:function(){return q(-1*s)},show:s&&"supplier"!==C||!1},{key:"supplier"===C?"Deductions":"Discount",value:null,calcAmount:function(){return q(-1*c)},show:!!c},{key:(0,eJ.jsx)(eJ.Fragment,{children:"Net"}),value:null,calcAmount:function(){return(0,eJ.jsx)(eJ.Fragment,{children:"=".concat((0,nR.T)(b))})},show:!0},{key:"VAT",value:!T&&"(".concat(100*h,"%)"),calcAmount:function(){return q(v)},show:!0},{key:(0,eJ.jsx)(eJ.Fragment,{children:"Gross"}),value:null,calcAmount:function(){return(0,eJ.jsx)(eJ.Fragment,{children:"=".concat((0,nR.T)(x))})},show:!0},{key:"Rebate",value:null!=D&&D.percent?"(".concat(D.percent,"%)"):"",calcAmount:function(){return(0,eJ.jsx)(eJ.Fragment,{children:(0,nR.T)(null==D?void 0:D.amount)})},show:(null==D?void 0:D.percent)||!1},{key:"Due from Customer",value:null,calcAmount:function(){return(0,eJ.jsx)(eJ.Fragment,{children:(0,nR.T)(x-(null==D?void 0:D.amount))})},show:(null==D?void 0:D.percent)||!1},{key:"Deposit",value:null,calcAmount:function(){return(0,nR.T)(u)},show:!!u},{key:"Reconciled Amount",value:null,calcAmount:(0,eJ.jsx)(eJ.Fragment,{children:(0,nR.T)(k)}),show:k>0},{key:"Amount outstanding",value:null,calcAmount:function(){return(0,nR.T)(_)},show:!0},{key:"Amount to be invoiced",value:null,calcAmount:function(){return(0,nR.T)($)},show:!0}],N=[{id:1,key:"Pricing",value:w?"Service Rate":O||"Fixed"},{id:2,key:"Threshold",value:i&&(0,nR.T)(i)},{id:3,key:"SLA",value:"ppm"!==A?(null==I?void 0:I.name)||(null==I?void 0:null===(r=I.sla)||void 0===r?void 0:r.name):"N/A"}];return{amounts:H.map(function(e,t){return a5(a5({},e),{},{id:t+1,calcAmount:R||e.calcAmount})}).filter(function(e){return e.show}),texts:N}};a4.propTypes={job:ro().object.isRequired,selectedSla:ro().string};var a7=n(22227),a8=function(e){var t=e.filter(function(e){return id.cJ.includes(e.invoiceType)});return{invoicedToDate:null==e?void 0:e.reduce(function(e,t){var n;return e+(Number(null===(n=t.amounts)||void 0===n?void 0:n.vatTotal)||0)},0),reconciledAmount:null==e?void 0:e.reduce(function(e,t){var n,r,i,o;return e+(Number(null==t?void 0:null===(n=t.reconciledAmount)||void 0===n?void 0:null===(r=n.reconciliations)||void 0===r?void 0:null===(i=r.aggregate)||void 0===i?void 0:null===(o=i.sum)||void 0===o?void 0:o.amount)||0)},0),proformaInvoiceVatTotal:null==t?void 0:t.reduce(function(e,t){var n;return e+(Number(null===(n=t.amounts)||void 0===n?void 0:n.vatTotal)||0)},0)}},a9=function(e){var t,n,r,i,o,a,s=e.financeSupplier,c=e.financeCustomer,u=null==s?void 0:null===(t=s.amountInfo)||void 0===t?void 0:t.total,l=null==c?void 0:null===(n=c.amountInfo)||void 0===n?void 0:n.total,d=(null==c?void 0:null===(r=c.amountInfo)||void 0===r?void 0:r.vatTotal)-(null==c?void 0:null===(i=c.rebate)||void 0===i?void 0:i.amount),p=(0,a7.l)(l-u,2),m=(0,a7.l)(p/l*100,2),f=(0,a7.l)(d-u,2),v=(0,a7.l)(f/d*100,2);return!(null!=c&&null!==(o=c.rateInfo)&&void 0!==o&&o.calcWithServiceRate)&&null!=c&&null!==(a=c.rebate)&&void 0!==a&&a.percent?{netProfitAmount:f,netProfitMargin:v}:{netProfitAmount:p,netProfitMargin:m}},se=function(e){var t=e.job,n=e.type,r=e.financeSupplier,i=e.financeCustomer,o=(0,t2.x)().hasRole,a=o("customer"),s=o("customer_user"),c=o("tenant_user"),u=(0,K.useState)([]),l=u[0],d=u[1],p=(0,K.useState)([]),m=p[0],f=p[1],v=(0,K.useState)(),h=v[0],b=v[1],x=(0,K.useState)(),j=x[0],g=x[1],y=(0,eK.E)(t,"invoiceSent");(0,K.useEffect)(function(){var e,o="supplier"===n?r:i;a&&!y&&(o.hidden="N/A");var s=null==t?void 0:null===(e=t.invoices)||void 0===e?void 0:e.filter(function(e){return id.SR[n].includes(e.invoiceType)}),c=a8(s),u="time-materials"===t.pricing?a3(o,c,t):a4(o,c,t),l=u.amounts;f(u.texts),d(l);var p=a9({financeCustomer:i,financeSupplier:r}),m=p.netProfitAmount,v=p.netProfitMargin;b((0,nR.T)(m||0)),g("".concat(v||0,"%"))},[a,t,n,y,r,i,s,c]);var Z=(0,K.useMemo)(function(){return[{field:"key",flex:1,sortable:!1,renderCell:function(e){var t=e.value,n="function"==typeof t?t():t;return(0,eJ.jsx)(rh.Z,{title:n,children:n})}},{field:"value",flex:1,sortable:!1,renderCell:function(e){var t=e.value,n="function"==typeof t?t():t;return(0,eJ.jsx)(rh.Z,{title:n,children:n})}},{field:"calcAmount",flex:1,sortable:!1,align:"right",renderCell:function(e){var t=e.value,n="function"==typeof t?t():t;return(0,eJ.jsx)(rh.Z,{title:n,children:n})}}]},[]);return(0,eJ.jsxs)(eD.Z,{spacing:2,children:[m.length>0&&(0,eJ.jsxs)(eJ.Fragment,{children:[(0,eJ.jsx)(eD.Z,{direction:"row",justifyContent:"space-between",spacing:2,sx:{pl:"10px",pr:"10px"},children:m.map(function(e){var t=e.key,n=e.value;return(0,eJ.jsxs)(eD.Z,{children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:t}),(0,eJ.jsx)(eI.Z,{children:n})]})})}),(0,eJ.jsx)(aK.Z,{})]}),l.length>0&&(0,eJ.jsx)(tX.i,{hideHeader:!0,columns:Z,rows:l,getRowClassName:function(e){return e.row.id%2==0?"odd":"even"}}),o("admin")&&"customer"===n&&(0,eJ.jsxs)(eP.ZP,{container:!0,pl:"10px",pr:"10px",children:[(0,eJ.jsxs)(eP.ZP,{item:!0,xs:4,children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Net Profit"}),(0,eJ.jsx)(eI.Z,{children:h})]}),(0,eJ.jsxs)(eP.ZP,{item:!0,xs:8,children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Net Profit Margin"}),(0,eJ.jsx)(eI.Z,{children:j})]})]})]})};se.defaultProps={};var st=(0,es.Ps)($||($=(0,ea.Z)(['\n  query GetExpenses($entity: String, $entityId: Int, $jobId: Int) {\n    expenses: Expense(\n      where: { jobId: { _eq: $jobId }, entity: { _eq: $entity }, entityId: { _eq: $entityId } }\n    ) {\n      id\n      categoryId\n      description\n      amount\n      unit\n      markup\n      vat\n      paid\n      jobId\n      total\n      entity\n      entityId\n      occurredAt\n      recurring\n      pendingAmount\n      category: Category {\n        name\n      }\n      media: Media(where: { entity: { _eq: "Expense" } }) {\n        id\n      }\n    }\n  }\n']))),sn=(0,es.Ps)(H||(H=(0,ea.Z)(["\n  mutation InsertExpense(\n    $objects: [Expense_insert_input!]!\n    $pendingAmountJobTiming: [JobTiming_insert_input!]!\n    $pendingAmountJobTimingWhere: JobTiming_bool_exp!\n    $shouldAddPendingAmount: Boolean!\n    $shouldRemovePendingAmountResolved: Boolean!\n  ) {\n    insert_Expense(objects: $objects) {\n      returning {\n        id\n      }\n    }\n    insert_JobTiming(objects: $pendingAmountJobTiming) @include(if: $shouldAddPendingAmount) {\n      returning {\n        id\n      }\n    }\n    delete_JobTiming(where: $pendingAmountJobTimingWhere)\n      @include(if: $shouldRemovePendingAmountResolved) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),sr=(0,es.Ps)(N||(N=(0,ea.Z)(["\n  mutation UpdateExpense(\n    $id: Int!\n    $changes: Expense_set_input\n    $pendingAmountJobTiming: [JobTiming_insert_input!]!\n    $pendingAmountJobTimingWhere: JobTiming_bool_exp!\n    $shouldAddPendingAmount: Boolean!\n    $shouldRemovePendingAmountResolved: Boolean!\n  ) {\n    update_Expense_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n    insert_JobTiming(objects: $pendingAmountJobTiming) @include(if: $shouldAddPendingAmount) {\n      returning {\n        id\n      }\n    }\n    delete_JobTiming(where: $pendingAmountJobTimingWhere)\n      @include(if: $shouldRemovePendingAmountResolved) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),si=(0,es.Ps)(M||(M=(0,ea.Z)(["\n  mutation DeleteExpense(\n    $id: Int!\n    $pendingAmountJobTimingWhere: JobTiming_bool_exp!\n    $shouldRemovePendingAmount: Boolean!\n  ) {\n    delete_Expense_by_pk(id: $id) {\n      id\n    }\n    delete_JobTiming(where: $pendingAmountJobTimingWhere) @include(if: $shouldRemovePendingAmount) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),so=(0,e9.Ry)().shape({amount:(0,e9.Rx)().when("pendingAmount",{is:function(e){return!1===e},then:function(e){return(0,e9.Rx)().required()}}),unit:(0,e9.Rx)().min(0).required(),categoryId:(0,e9.Ry)().required(),description:(0,e9.Z_)().required(),markup:(0,e9.Rx)().transform(function(e){return isNaN(e)?null:e}).nullable(),paid:(0,e9.Z_)().when("isAdmin",{is:function(e){return!0===e},then:function(){return(0,e9.Z_)().oneOf(["admin","supplier"]).required()}}),vatMarkup:(0,e9.Rx)().transform(function(e){return isNaN(e)?null:e}).nullable(),pendingAmount:(0,e9.O7)()});function sa(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function ss(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?sa(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):sa(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var sc=[{id:"admin",label:"Admin",value:"admin"},{id:"supplier",label:"Supplier",value:"supplier"}],su=[{id:"pendingAmount",label:"Pending amount",value:!0}],sl=[{id:"default",label:"Default (20%)",value:"20"},{id:"custom",label:"Custom",value:"custom"}],sd=function(e){var t,n=e.defaultValues,r=e.submit,i=e.serviceRateExpenses,o=(0,(0,t2.x)().hasRole)("admin"),a=(0,e6.cI)({defaultValues:ss({vat:"20"},n),resolver:(0,e5.S)(so),context:{isAdmin:o}}),s=a.control,c=a.errors,u=a.handleSubmit,l=a.register,d=a.watch,p=a.setValue,m=(0,K.useState)(!1),f=m[0],v=m[1],h=d("vat"),b=d("pendingAmount");(0,K.useEffect)(function(){null!=n&&n.vat&&(null==n?void 0:n.vat)!=="20"?(p("vatMarkup",n.vat),p("vat","custom")):p("vat","20")},[b]);var x=(t=(0,eh.Z)(ej().mark(function e(t){var n;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=ss(ss({},t),{},{paid:o?t.paid:"supplier"}),e.prev=1,v(!0),e.next=5,r(n);case 5:return e.prev=5,v(!1),e.finish(5);case 8:case"end":return e.stop()}},e,null,[[1,,5,8]])})),function(e){return t.apply(this,arguments)}),j={control:s,errors:c,register:l};return f?(0,eJ.jsx)(eD.Z,{direction:"row",justifyContent:"center",children:(0,eJ.jsx)(nq.Z,{color:"secondary"})}):(0,eJ.jsxs)(e4.Z,{id:"offCanvasForm",handleSubmit:u(x),children:[o&&(0,eJ.jsx)(tu.Z,ss(ss({},j),{},{name:"paid",data:sc,legend:"Paid by"})),(0,eJ.jsx)(tc.Z,ss(ss({},j),{},{data:su,name:"pendingAmount"})),!b&&(0,eJ.jsx)(oz.Z,ss(ss({},j),{},{name:"amount",label:"Unit Cost",vat:"Ex VAT"})),(0,eJ.jsx)(tl.Z,{label:"Units",children:(0,eJ.jsx)(td.Z,ss(ss({},j),{},{name:"unit"}))}),!b&&(0,eJ.jsx)(tu.Z,ss(ss({},j),{},{name:"vat",data:sl,legend:"VAT"})),!b&&"custom"===h&&(0,eJ.jsx)(tz.Z,ss(ss({},j),{},{label:"Custom VAT",name:"vatMarkup"})),!b&&!!i&&(0,eJ.jsx)(td.Z,ss(ss({},j),{},{name:"markup",type:"hidden"})),!b&&!i&&o&&(0,eJ.jsx)(tz.Z,ss(ss({},j),{},{label:"Markup ".concat(i?"(Service Rate Expenses and Materials : ".concat(i,"%)"):""),name:"markup"})),(0,eJ.jsx)(e8.P,ss(ss({},j),{},{errors:ss({},c),label:"Category",name:"categoryId",type:"expenseCategory"})),(0,eJ.jsx)(tl.Z,{label:"Description",children:(0,eJ.jsx)(tC.Z,ss(ss({},j),{},{name:"description",rows:2}))}),n.id&&(0,eJ.jsx)(td.Z,ss(ss({},j),{},{name:"id",type:"hidden"}))]})};function sp(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function sm(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?sp(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):sp(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}sd.defaultProps={serviceRateExpenses:0,submitting:!1};var sf=function(e,t,n){var r=0,i=0,o=null==e?void 0:e.filter(function(e){return"supplier"===n&&"supplier"===e.paid||"supplier"!==n});return{preparedExpenses:null==o?void 0:o.map(function(e){var o=e.amount;"supplier"!==n&&(o+=e.markup/100*o,o/=1-t/100);var a=o*(e.unit||1),s=a+a*(e.vat/100);return i+=a,r+=s,sm(sm({},e),{},{id:e.id,name:e.description,unitCost:o,price:a,total:s,unit:e.unit||1,vatAmount:a*(e.vat/100),vatRate:e.vat/100,markup:e.markup})}),totalExpenses:r,totalExpensesExVAT:i}},sv=n(26143),sh=n(14218);function sb(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function sx(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?sb(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):sb(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var sj=function(e){var t,n,r,i,o,a=e.job,s=e.refetchParent,c=e.tab,u=e.expanded,l=e.onChangeExpanded,d=(0,eg.x)(),p=(0,t2.x)(),m=p.hasRole,f=p.user,v=(0,K.useContext)(eR.Z),h=(0,eK.E)(a,"invoiceSent"),b=(0,eK.E)(a,"closed"),x=m("customer")&&!h,j=!a||!b&&(m(["admin"])&&!(0,eK.E)(a,["validated","unvalidated"])||m(["admin","supplier"])&&!(0,eK.E)(a,"reportSent")),g=(0,t1.B)("serviceRateExpenses",null==a?void 0:a.financeLogs,null==a?void 0:null===(t=a.customer)||void 0===t?void 0:null===(n=t.meta)||void 0===n?void 0:null===(r=n.finance)||void 0===r?void 0:r.serviceRateExpenses)||0,y=c||(!m("admin")&&m("supplier")?"supplier":"admin"),Z=(0,er.a)(st,{variables:{jobId:a.id},skip:x}),w=Z.data,O=(w=void 0===w?{expenses:[]}:w).expenses,I=Z.loading,S=Z.refetch,P=sf(O,0,y),C=P.preparedExpenses,D=P.totalExpenses,R=P.totalExpensesExVAT,k=C.length>0&&C.length===C.filter(function(e){return e.pendingAmount}).length,E=(0,ey.D)(si,{onCompleted:function(){a&&(0,tD.F)(d,a.id),s(),S()}}),A=(0,eb.Z)(E,1)[0],q=(0,ey.D)(sn,{onCompleted:function(){a&&(0,tD.F)(d,a.id),v.close(),s(),S()}}),T=(0,eb.Z)(q,1)[0],_=(0,ey.D)(sr,{onCompleted:function(){a&&(0,tD.F)(d,a.id),v.close(),s(),S()}}),$=(0,eb.Z)(_,1)[0],H=(i=(0,eh.Z)(ej().mark(function e(t){var n,r,i,o,s,c,u,l,p,m,v,h,b;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return"custom"===t.vat&&(t.vat=t.vatMarkup),i=(r=(n=(t.unit||0)*(t.amount||0))*((t.markup||0)/100)+n)*((t.vat||0)/100)+r,o={id:t.id,paid:t.paid,markup:t.markup||0,description:t.description,categoryId:t.categoryId.value,unit:t.unit,pendingAmount:t.pendingAmount,amount:t.amount||0,vat:t.vat||0,total:i},e.next=7,d.query({query:st,variables:{jobId:a.id}});case 7:if(l=(u=(c=void 0===(c=(0,e.sent).data)?{expenses:[]}:c).expenses).find(function(e){return e.id===+t.id})||{},p=u.filter(function(e){var n=e.id;return e.pendingAmount&&n!==+t.id}),m=t.pendingAmount,v=l.pendingAmount&&!t.pendingAmount&&p.length<=0,h=[],b={},m&&(h.push({status:"expensesPendingAmount",notes:t.description,userId:f.id,jobId:a.id}),b.status={_eq:"expensesPendingAmountResolved"},b.jobId={_eq:a.id}),v&&h.push({status:"expensesPendingAmountResolved",userId:f.id,jobId:a.id}),!o.id){e.next=24;break}return e.next=22,$({variables:{id:o.id,changes:o,pendingAmountJobTiming:h,pendingAmountJobTimingWhere:b,shouldAddPendingAmount:!!m||!!v,shouldRemovePendingAmountResolved:!!m}});case 22:e.next=26;break;case 24:return e.next=26,T({variables:{objects:sx(sx({},o),{},{jobId:null==a?void 0:a.id}),pendingAmountJobTiming:h,pendingAmountJobTimingWhere:b,shouldAddPendingAmount:!!m||!!v,shouldRemovePendingAmountResolved:!!m}});case 26:case"end":return e.stop()}},e)})),function(e){return i.apply(this,arguments)}),N=function(e){return function(t){t.stopPropagation();var n=null!=e&&e.item?sx({},null==e?void 0:e.item):{markup:g};null!=n&&n.vat&&(n.vat=String(n.vat)),v.show({content:(0,eJ.jsx)(sd,{defaultValues:n,submit:H,serviceRateExpenses:g}),title:"Expenses"})}},M=(o=(0,eh.Z)(ej().mark(function e(t,n){var r,i,o,s,c,u;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t.preventDefault(),t.stopPropagation(),e.next=4,d.query({query:st,variables:{jobId:a.id}});case 4:return s=(0,(i=void 0===(i=(0,e.sent).data)?{expenses:[]}:i).expenses).filter(function(e){var t=e.id;return e.pendingAmount&&t!==+n.id}),c=n.pendingAmount&&s.length<=0,u={},c&&(u.status={_eq:"expensesPendingAmount"},u.jobId={_eq:a.id}),e.next=14,A({variables:{id:n.item.id,shouldRemovePendingAmount:c,pendingAmountJobTimingWhere:u}});case 14:case"end":return e.stop()}},e)})),function(e,t){return o.apply(this,arguments)}),F=function(e){v.show({content:(0,eJ.jsx)(rj.G,{entity:"Expenses",entityId:e.item.id}),submit:!1,title:"Media"})},J=function(e){return[{context:"secondary",icon:"edit",onClick:function(t){return N(e)(t)},tooltip:"Edit"},{context:"info",icon:"uploadFile",onClick:function(t){return F(e)},tooltip:"Media"},{context:"danger",icon:"delete",onClick:function(t){return M(t,e)},tooltip:"Delete"}]};return(0,eJ.jsxs)(ew.Z,{expanded:u,onChange:l,children:[(0,eJ.jsx)(eO.Z,{children:(0,eJ.jsxs)(eD.Z,{width:"100%",spacing:2,children:[(0,eJ.jsx)(eI.Z,{variant:"h6",children:" Expenses"}),(0,eJ.jsxs)(eP.ZP,{container:!0,children:[(0,eJ.jsxs)(eP.ZP,{item:!0,xs:4,children:[(0,eJ.jsx)(eI.Z,{children:"Total"}),(0,eJ.jsx)(eI.Z,{children:k?"N/A":(0,nR.T)(R)})]}),(0,eJ.jsxs)(eP.ZP,{item:!0,xs:8,children:[(0,eJ.jsx)(eI.Z,{children:"VAT Total"}),(0,eJ.jsx)(eI.Z,{children:k?"N/A":(0,nR.T)(D)})]})]})]})}),(0,eJ.jsx)(eS.Z,{sx:{pt:0},children:(0,eJ.jsxs)(eD.Z,{width:"100%",children:[(0,eJ.jsx)(tX.i,{columns:[{field:"description",headerName:"Description",flex:1,sortable:!1},{field:"total",headerName:"Total",flex:1,sortable:!1,renderCell:function(e){var t=e.value;return e.row.pendingAmount?"Pending":(0,nR.T)(t)}},{field:"paid",headerName:"Paid By",flex:1,sortable:!1},{field:"actions",headerName:"",width:50,sortable:!1,renderCell:function(e){var t=e.row;return(0,eJ.jsx)(sv.C,{actionsData:J,row:t})},hide:!j}],rows:null==C?void 0:C.map(function(e){var t,n;return{id:e.id,description:e.description,total:e.total,paid:e.paid.charAt(0).toUpperCase()+e.paid.slice(1),actions:"",item:sx(sx(sx({},e),{occurredAt:new Date(e.occurredAt)}),{categoryId:{label:null===(t=e.category)||void 0===t?void 0:t.name,value:e.categoryId}}),mediaCount:null===(n=e.media)||void 0===n?void 0:n.length,pendingAmount:e.pendingAmount}}),loading:I,noResultsMessage:"There are currently no expenses.",columnVisibilityModel:{actions:j}}),j&&(0,eJ.jsx)(aE.Z,{onClick:N(),sx:{alignSelf:"center"},children:(0,eJ.jsx)(sh.Z,{})})]})})]})};sj.defaultProps={refetchParent:function(){},onChangeExpanded:function(){}};var sg=n(21714),sy=(0,es.Ps)(F||(F=(0,ea.Z)(["\n  query getReconciliation($accountEntryId: Int!) {\n    reconciliation: Reconciliation(where: { InvoiceEntry: { id: { _eq: $accountEntryId } } }) {\n      amount\n      createdAt\n      id\n      creditEntity\n      creditEntityId\n      meta\n      paymentEntry: PaymentEntry {\n        id\n        meta\n        credit\n      }\n    }\n    meta: Reconciliation_aggregate(where: { InvoiceEntry: { id: { _eq: $accountEntryId } } }) {\n      aggregate {\n        total: sum {\n          amount\n        }\n      }\n    }\n  }\n"]))),sZ=(0,es.Ps)(J||(J=(0,ea.Z)(["\n  mutation AddCreditNote(\n    $job: Job_set_input!\n    $jobId: Int!\n    $timing: [JobTiming_insert_input!]!\n    $isPaid: Boolean!\n  ) {\n    update_Job_by_pk(pk_columns: { id: $jobId }, _set: $job) @include(if: $isPaid) {\n      id\n    }\n\n    insert_JobTiming(objects: $timing) @include(if: $isPaid) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),sw=(0,es.Ps)(L||(L=(0,ea.Z)(["\n  mutation AddCreditNote($object: AccountEntry_insert_input!) {\n    insert_AccountEntry_one(object: $object) {\n      id\n    }\n  }\n"]))),sO=function(e){var t=e.loading,n=e.reconciliation;return(0,eJ.jsx)(oV.Z,{columns:[{hidden:!0},{hidden:!0},{text:"Type"},{formatter:function(e){var t=e.row;return(0,e1.Z)(t.amountReceived)},text:"Payment Amount "},{formatter:function(e){var t=e.row;return(0,e1.Z)(t.reconciledAmount)},text:"Reconciled"},{text:"Date"},{hidden:!0,text:"Reference"},{hidden:!0},{hidden:!0}],loading:t,rows:n.map(function(e){var t,n,r,i;return{id:e.id,creditEntityId:e.creditEntityId,creditEntity:e.creditEntity,amountReceived:e.paymentEntry.credit,reconciledAmount:e.amount,dateReceived:(0,e2.Z)(e.createdAt),paymentReference:(null===(t=e.paymentEntry)||void 0===t?void 0:null===(n=t.meta)||void 0===n?void 0:n.paymentReference)||"-",comment:(null===(r=e.paymentEntry)||void 0===r?void 0:null===(i=r.meta)||void 0===i?void 0:i.comment)||"-",meta:e.meta}})})},sI=function(e){var t=e.accountEntryId,n=e.currency,r=(0,er.a)(sy,{variables:{accountEntryId:t}}),i=r.loading,o=r.data,a=(o=void 0===o?{reconciliation:[],meta:{aggregate:{total:{amount:0}}}}:o).reconciliation,s=o.meta;return(0,eJ.jsxs)(eJ.Fragment,{children:[(0,eJ.jsx)("strong",{children:"Reconciliation"}),(0,eJ.jsx)(t7.Z,{content:"Total",text:(0,e1.Z)(s.aggregate.total.amount,n)}),(0,eJ.jsx)(sO,{loading:i,reconciliation:a})]})},sS=n(2112);function sP(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function sC(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?sP(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):sP(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var sD=function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{items:[]};return(null==t?void 0:null===(e=t.items)||void 0===e?void 0:e.map(function(e){return{type:e.type,unit:e.minutes,description:e.name,price:e.itemTotal,gross:e.itemTotalIncVAT,unitCost:e.rate,net:e.minutes*(e.rate||1),vat:e.rate*e.minutes*1.2-(e.rate*e.minutes||1),vatPercent:100*e.vatRate}}))||[]},sR=function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{items:[]};return null==t?void 0:null===(e=t.items)||void 0===e?void 0:e.map(function(e){return{description:e.description,unit:e.unit,rate:e.rate,net:e.unit*e.rate,vatRate:100*e.vatRate,vat:e.unit*e.rate*e.vatRate,gross:e.unit*e.rate*(e.vatRate+1)}})},sk=function(e){var t=e.unit,n=void 0===t?0:t,r=e.unitCost,i=void 0===r?0:r,o=e.vatPercent,a=void 0===o?0:o;return{net:n*i||0,vatTotal:i*n*(1+a)-i*n||0,gross:i*n*(1+a)||0,price:i*(n||1)}},sE=function(e){var t=e.type,n=e.invoiceType,r=e.vatId,i={type:t,vat:"default",vatPercent:20,vatDefault:20};return"ProformaInvoiceSupplier"!==n||(0,sS.b)(r)||(i.vatPercent=0,i.vatDefault=0),i},sA=function(e){var t=e.rowData,n=e.invoiceType,r=e.vatId,i=sC(sC({},t),{},{vat:"default",vatDefault:20});return 20!==Number(t.vatPercent)&&(i.vat="custom"),"ProformaInvoiceSupplier"!==n||(0,sS.b)(r)||0===Number(t.vatPercent)||(i.vat="custom",i.vatDefault=0),i},sq=(0,e9.Ry)().shape({type:(0,e9.Z_)().oneOf((0,en.Z)(id.cJ)).required(),description:(0,e9.Z_)(),dueDate:(0,e9.Z_)().required()});function sT(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function s_(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?sT(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):sT(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var s$=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:20;return[{id:"default",label:"Default (".concat(e,"%)"),value:"default"},{id:"custom",label:"Custom",value:"custom"}]},sH=function(e){var t=e.defaultValues,n=e.editMode,r=e.toggleShow,i=e.onSuccess,o=t.vat,a=t.vatPercent,s=t.vatDefault,c=(0,e6.cI)({defaultValues:s_(s_({},t),{},{vat:o,vatPercent:a})}),u=c.control,l=c.errors,d=c.handleSubmit,p=c.register,m=c.watch,f=c.setValue,v=m("unitCost"),h=m("unit"),b=m("vat"),x=m("vatPercent");(0,K.useEffect)(function(){"default"===b&&f("vatPercent",s)},[b]);var j,g=sk({unit:h,unitCost:v,vatPercent:x/100}),y=g.net,Z=g.vatTotal,w=g.gross,O=g.price,I=(j=(0,eh.Z)(ej().mark(function e(t){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:i(s_(s_({},t),{},{price:O,net:y,vat:Z,gross:w,vatPercent:x}));case 1:case"end":return e.stop()}},e)})),function(e){return j.apply(this,arguments)}),S={control:u,errors:l,register:p};return(0,eJ.jsxs)(e4.Z,{handleSubmit:d(I),children:[(0,eJ.jsx)(tH.Z,{children:(0,eJ.jsx)(tN.Z,{md:12,children:(0,eJ.jsx)(tl.Z,{label:"Description",children:(0,eJ.jsx)(tC.Z,s_(s_({},S),{},{name:"description",rows:2}))})})}),(0,eJ.jsxs)(tH.Z,{children:[(0,eJ.jsx)(tN.Z,{md:8,children:(0,eJ.jsx)(oz.Z,s_(s_({},S),{},{name:"unitCost",label:"Unit Cost",vat:"Ex VAT",min:.01}))}),(0,eJ.jsx)(tN.Z,{md:4,children:(0,eJ.jsx)(tl.Z,{label:"Units",children:(0,eJ.jsx)(td.Z,s_(s_({},S),{},{name:"unit",type:"number",step:"1",min:1}))})})," ",(0,eJ.jsxs)(tN.Z,{md:12,children:[(0,eJ.jsx)(tl.Z,{label:"VAT %"}),(0,eJ.jsx)(tu.Z,s_(s_({},S),{},{name:"vat",data:s$(s)})),(0,eJ.jsx)(tz.Z,s_(s_({},S),{},{label:"Custom VAT",name:"vatPercent",show:"custom"===b}))]})]}),(0,eJ.jsxs)(tm.Z,{children:["Net: ",(0,e1.Z)(y)]}),(0,eJ.jsxs)(tm.Z,{children:["VAT: ",(0,e1.Z)(Z)]}),(0,eJ.jsxs)(tm.Z,{children:["Gross: ",(0,e1.Z)(w)]}),(0,eJ.jsxs)(tH.Z,{justify:"end",style:{margin:"0 5px"},children:[(0,eJ.jsx)(tp.Z,{content:"Back",onClick:r,style:{margin:"0 5px"},context:"danger"}),(0,eJ.jsx)(tp.Z,{content:n?"Save":"Add",type:"submit"})]}),(0,eJ.jsx)(td.Z,s_(s_({},S),{},{name:"id",type:"hidden"})),(0,eJ.jsx)(td.Z,s_(s_({},S),{},{name:"type",type:"hidden"})),(0,eJ.jsx)("div",{style:{clear:"both"}})]})};function sN(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function sM(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?sN(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):sN(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var sF=[{id:"ProformaInvoiceCustomer",label:"Customer invoice",value:"ProformaInvoiceCustomer"},{id:"ProformaInvoiceSupplier",label:"Supplier invoice",value:"ProformaInvoiceSupplier"}],sJ=function(e){var t,n,r,i,o=e.job,a=e.showDetails,s=e.defaultValues,c=e.toggleShow,u=(0,aC.a)(),l=(0,n_.D)(),d=(0,e6.cI)({resolver:(0,e5.S)(sq),defaultValues:{description:null==s?void 0:null===(t=s.configs)||void 0===t?void 0:t.descriptionInvoice,type:"ProformaInvoiceCustomer"}}),p=d.control,m=d.errors,f=d.handleSubmit,v=d.register,h=d.watch,b=d.setValue,x=h("type");(0,K.useEffect)(function(){a||("ProformaInvoiceCustomer"===x?b("dueDate",(0,iA.I)({job:o,type:"customer",invoiceDate:new Date})):b("dueDate",(0,iA.I)({job:o,type:"supplier",invoiceDate:new Date})))},[x]);var j,g=(0,K.useState)(sD(null==s?void 0:null===(n=s.accountEntry)||void 0===n?void 0:n.meta)),y=g[0],Z=g[1],w=(0,ey.D)(iZ.bK,{refetchQueries:["getInvoices","GetJob"],onCompleted:function(){l.show({content:"Ad-hoc invoice was created"}),c()},onError:function(e){l.show({content:"Error: ".concat(e.message),color:"error"})}}),O=(0,eb.Z)(w,2),I=O[0],S=O[1].loading,P=(j=(0,eh.Z)(ej().mark(function e(t){var n,r,i;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.type,r=t.description,i=t.dueDate,e.next=3,I({variables:{jobId:o.id,invoiceType:n,description:r,dueDate:e0()(i).toISOString(),items:y}});case 3:case"end":return e.stop()}},e)})),function(e){return j.apply(this,arguments)}),C=function(e){if(e.id){var t=Number(e.id),n=y.map(function(n){return n.id!==t?n:sM({},e)});Z((0,en.Z)(n))}else{e.id=(null==y?void 0:y.length)+1;var r=y.concat(e);Z((0,en.Z)(r))}u.close()},D=function(e){var t,n=sE({type:e,invoiceType:x,vatId:null===(t=o.supplier)||void 0===t?void 0:t.vatId});u.show({content:(0,eJ.jsx)(sH,{onSuccess:C,toggleShow:u.close,defaultValues:n}),submit:!1,title:"Insert Item",xs3:"100vw",sm:"100vw",sm2:"80vw",sm3:"70vw",md2:"60vw",lg:"50vw",lg2:"40vw"})},R=function(e,t){var n,r=sA({rowData:t.rowData,invoiceType:x,vatId:null===(n=o.supplier)||void 0===n?void 0:n.vatId});u.show({content:(0,eJ.jsx)(sH,{editMode:!0,onSuccess:C,toggleShow:u.close,defaultValues:r}),submit:!1,title:"Edit Item",xs3:"100vw",sm:"100vw",sm2:"80vw",sm3:"70vw",md2:"60vw",lg:"50vw",lg2:"40vw"})},k=function(e,t){y.splice(y.findIndex(function(e){return e.id===t.id}),1),Z((0,en.Z)(y))},E=[{text:"ID",hidden:!0},{text:"Description"},{hidden:!1,text:"Quantity"},{hidden:!1,text:"Rate"},{hidden:!1,text:"Net"},{hidden:!1,text:"VAT % "},{hidden:!1,text:"VAT"},{hidden:!1,text:"Gross"},{hidden:!0},{formatter:oU.Z,formatterData:(0,oQ.N)(null,{onEditClick:R,onDeleteClick:k}),text:"Actions",hidden:a}],A=y.reduce(function(e,t){return e+(t.net||0)},0),q=y.reduce(function(e,t){return e+(t.vat||0)},0),T=y.reduce(function(e,t){return e+(t.gross||0)},0),_={control:p,errors:m,register:v};return S?(0,eJ.jsx)(tH.Z,{style:{justifyContent:"center",alignItems:"center"},children:(0,eJ.jsx)(nq.Z,{size:30})}):(0,eJ.jsxs)(e4.Z,{id:"offCanvasForm",handleSubmit:f(P),children:[![].concat((0,en.Z)(id.pX),(0,en.Z)(id.YK)).includes(null==s?void 0:s.invoiceType)&&(0,eJ.jsxs)(eJ.Fragment,{children:[!a&&(0,eJ.jsx)(tH.Z,{children:(0,eJ.jsx)(tN.Z,{md:12,children:(0,eJ.jsx)(tu.Z,sM(sM({},_),{},{name:"type",data:sF}))})}),(0,eJ.jsx)(tH.Z,{children:(0,eJ.jsxs)(tN.Z,{md:12,children:[(0,eJ.jsx)(rJ.Z,{}),(0,eJ.jsxs)(sL,{align:"center",justify:"between",children:[(0,eJ.jsx)(tm.Z,{children:"Labour"}),!a&&(0,eJ.jsx)(tp.Z,{content:"Insert Labour Item",context:"secondary",onClick:function(){return D("Labour")},size:"sm"})]}),(0,eJ.jsx)(oV.Z,{columns:E,rows:y.filter(function(e){return"Labour"===e.type}).map(function(e,t){return{id:t,description:e.description,units:e.unit,unitCost:(0,e1.Z)(null==e?void 0:e.unitCost),net:(0,e1.Z)(e.net),vatPercent:"".concat(e.vatPercent,"%"),vat:(0,e1.Z)(e.vat),gross:(0,e1.Z)(e.gross),rowData:e,action:""}})}),(0,eJ.jsx)(rJ.Z,{}),(0,eJ.jsxs)(sL,{align:"center",justify:"between",children:[(0,eJ.jsx)(tm.Z,{children:"Materials"}),!a&&(0,eJ.jsx)(tp.Z,{content:"Insert Materials Item",context:"secondary",onClick:function(){return D("Materials")},size:"sm"})]}),(0,eJ.jsx)(oV.Z,{columns:E,rows:y.filter(function(e){return"Materials"===e.type}).map(function(e){return{id:e.id,description:e.description,units:e.unit,unitCost:(0,e1.Z)(null==e?void 0:e.unitCost),net:(0,e1.Z)(e.net),vatPercent:"".concat(e.vatPercent,"%"),vat:(0,e1.Z)(e.vat),gross:(0,e1.Z)(e.gross),rowData:e,action:""}})}),(0,eJ.jsxs)(sV,{children:[(0,eJ.jsxs)(sU,{children:[(0,eJ.jsx)("div",{children:"Net Total :"})," ",(0,eJ.jsx)("div",{children:(0,e1.Z)(A)})]}),(0,eJ.jsxs)(sU,{children:[(0,eJ.jsx)("div",{children:"VAT Total :"})," ",(0,eJ.jsx)("div",{children:(0,e1.Z)(q)})]}),(0,eJ.jsxs)(sU,{children:[(0,eJ.jsx)("div",{children:"Gross Total :"})," ",(0,eJ.jsx)("div",{children:(0,e1.Z)(T)})]})]})]})}),(0,eJ.jsx)(rJ.Z,{}),(0,eJ.jsx)(tH.Z,{children:(0,eJ.jsx)(tN.Z,{md:12,children:a?(0,eJ.jsx)(t7.Z,{content:"Description",text:null==s?void 0:null===(r=s.configs)||void 0===r?void 0:r.descriptionInvoice}):(0,eJ.jsx)(tl.Z,{label:"Description",children:(0,eJ.jsx)(tC.Z,sM(sM({},_),{},{name:"description",rows:2,disabled:a}))})})}),(0,eJ.jsx)(rJ.Z,{}),(0,eJ.jsx)(tH.Z,{children:(0,eJ.jsx)(tN.Z,{md:6,children:!a&&(0,eJ.jsx)(tl.Z,{label:"Due date",children:(0,eJ.jsx)(tA.M,sM(sM({},_),{},{name:"dueDate",placeholder:"Due date"}))})})})]}),(null==s?void 0:null===(i=s.accountEntry)||void 0===i?void 0:i.id)&&(0,eJ.jsx)(sI,{currency:"GBP",accountEntryId:s.accountEntry.id})]})},sL=(0,tQ.ZP)(tH.Z).withConfig({displayName:"addInvoiceForm__StyledRow",componentId:"sc-xsyxc8-0"})(["width:100%;margin:1rem 0;"]),sU=tQ.ZP.div.withConfig({displayName:"addInvoiceForm__StyledText",componentId:"sc-xsyxc8-1"})(["margin:0;display:flex;justify-content:space-between;"]),sV=tQ.ZP.div.withConfig({displayName:"addInvoiceForm__StyledTextBox",componentId:"sc-xsyxc8-2"})(["margin:0 0 0 auto;display:flex;flex-direction:column;width:144px;"]),sQ=n(19149),sz=(0,e9.Ry)().shape({amountReceived:(0,e9.Rx)().moreThan(0).required(),dateReceived:(0,e9.hT)().required(),reason:(0,e9.Z_)().required()}),sY=(0,e9.Ry)().shape({id:(0,e9.Rx)(),description:(0,e9.Z_)(),rate:(0,e9.Rx)().moreThan(0).required(),unit:(0,e9.Rx)().integer().moreThan(0).required(),vatRate:(0,e9.Z_)(),vatCustom:(0,e9.Rx)().min(0)});function sB(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function sG(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?sB(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):sB(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var sW=[{id:"default",label:"Default (20%)",value:20},{id:"custom",label:"Custom",value:"custom"}],sK=function(e){var t,n,r=e.defaultValues,i=e.editMode,o=e.toggleShow,a=e.onSuccess;null!=r&&r.vatRate&&(null==r?void 0:r.vatRate)!==20?(t=r.vatRate,n="custom"):n="20";var s,c,u,l,d,p,m,f,v=(0,e6.cI)({defaultValues:sG(sG({},r),{},{vatCustom:t,vatRate:n}),resolver:(0,e5.S)(sY)}),h=v.control,b=v.errors,x=v.handleSubmit,j=v.register,g=v.watch,y={control:h,errors:b,register:j},Z=g("vatRate"),w=g("rate"),O=g("unit"),I=g("vatCustom"),S=g("vatRate"),P=(u=void 0===(c=(s={unit:O,rate:w,vatRate:("20"===S?20:I||0)/100}).unit)?0:c,d=void 0===(l=s.rate)?0:l,m=void 0===(p=s.vatRate)?0:p,{net:u*d||0,vat:d*u*m||0,gross:d*u*(1+m)||0}),C=P.net,D=P.vat,R=P.gross,k=(f=(0,eh.Z)(ej().mark(function e(t){var n;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:delete(n=sG(sG({},t),{},{vatRate:"20"===t.vatRate?20:t.vatCustom||0})).vatCustom,a(sG(sG({},n),{},{net:C,gross:R,vat:D}),i);case 3:case"end":return e.stop()}},e)})),function(e){return f.apply(this,arguments)});return(0,eJ.jsxs)(e4.Z,{handleSubmit:x(k),children:[(0,eJ.jsx)(tH.Z,{children:(0,eJ.jsx)(tN.Z,{md:12,children:(0,eJ.jsx)(tl.Z,{label:"Description",children:(0,eJ.jsx)(tC.Z,sG(sG({},y),{},{name:"description",rows:2}))})})}),(0,eJ.jsxs)(tH.Z,{children:[(0,eJ.jsx)(tN.Z,{md:6,children:(0,eJ.jsx)(oz.Z,sG(sG({},y),{},{name:"rate",label:"Unit Cost",vat:"Ex VAT"}))}),(0,eJ.jsx)(tN.Z,{md:6,children:(0,eJ.jsx)(tl.Z,{label:"Units",children:(0,eJ.jsx)(td.Z,sG(sG({},y),{},{name:"unit",type:"number"}))})})]}),(0,eJ.jsx)(tH.Z,{children:(0,eJ.jsxs)(tN.Z,{md:12,children:[(0,eJ.jsx)(tl.Z,{label:"VAT %"}),(0,eJ.jsx)(tu.Z,sG(sG({},y),{},{name:"vatRate",data:sW})),"custom"===Z&&(0,eJ.jsx)(tz.Z,sG(sG({},y),{},{label:"Custom VAT",name:"vatCustom"}))]})}),(0,eJ.jsxs)(tm.Z,{children:["Net: ",(0,e1.Z)(C)]}),(0,eJ.jsxs)(tm.Z,{children:["VAT: ",(0,e1.Z)(D)]}),(0,eJ.jsxs)(tm.Z,{children:["Gross: ",(0,e1.Z)(R)]}),(0,eJ.jsxs)(tH.Z,{justify:"end",style:{margin:"0 5px"},children:[(0,eJ.jsx)(tp.Z,{content:"Back",onClick:o,style:{margin:"0 5px"},context:"danger"}),(0,eJ.jsx)(tp.Z,{content:i?"Save":"Add",type:"submit"})]}),"number"==typeof(null==r?void 0:r.id)&&(0,eJ.jsx)(td.Z,sG(sG({},y),{},{name:"id",type:"hidden"})),(0,eJ.jsx)("div",{style:{clear:"both"}})]})},sX=function(e){var t=e.values,n=e.setValue,r=e.showDetails,i=(0,K.useContext)(eR.Z),o=function(e,r){if(r){var o=(0,en.Z)(t);o[e.id]=e,n(o)}else n([].concat((0,en.Z)(t),[e]));i.close()},a=function(e,t){i.show({content:(0,eJ.jsx)(sK,{editMode:!!t,onSuccess:o,toggleShow:i.close,defaultValues:t}),submit:!1,title:"".concat(t?"Edit":"Insert","  Item")})},s=function(e,r){var i=(0,en.Z)(t);i.splice(r.id,1),n((0,en.Z)(i))},c=[{hidden:!0},{hidden:!1,text:"Description"},{hidden:!1,text:"Quantity",formatter:function(e){return e.row.unit}},{hidden:!1,text:"Rate",formatter:function(e){var t=e.row;return(0,e1.Z)(t.rate)}},{hidden:!1,text:"Net",formatter:function(e){var t=e.row;return(0,e1.Z)(t.net)}},{hidden:!1,text:"VAT % ",formatter:function(e){var t=e.row;return"".concat(t.vatRate,"%")}},{hidden:!1,text:"VAT",formatter:function(e){var t=e.row;return(0,e1.Z)(t.vat)}},{hidden:!1,text:"Gross",formatter:function(e){var t=e.row;return(0,e1.Z)(t.gross)}},{formatter:oU.Z,formatterData:(0,oQ.N)(null,{onEditClick:a,onDeleteClick:s}),text:"Actions",hidden:r}],u=t.reduce(function(e,t){return e+(t.itemTotal||t.net||0)},0),l=t.reduce(function(e,t){return e+(t.vatAmount||t.vat||0)},0),d=t.reduce(function(e,t){return e+(t.itemTotalIncVAT||t.gross||0)},0);return(0,eJ.jsxs)(eJ.Fragment,{children:[(0,eJ.jsx)(oZ.Z,{content:(0,eJ.jsxs)(s0,{align:"center",justify:"between",children:[(0,eJ.jsx)("span",{children:"Items:"}),!r&&(0,eJ.jsx)(tp.Z,{content:"Insert Item",context:"secondary",onClick:a,size:"sm"})]}),tag:"h4"}),(0,eJ.jsx)(oV.Z,{columns:c,rows:t.map(function(e,t){return{id:t,description:e.description,unit:e.unit,rate:e.rate,net:e.net,vatRate:e.vatRate,vat:e.vat,gross:e.gross,action:""}})}),(0,eJ.jsxs)("div",{style:{textAlign:"right"},children:[(0,eJ.jsxs)(s1,{children:["Net Total : ",(0,e1.Z)(u)]}),(0,eJ.jsxs)(s1,{children:["VAT Total : ",(0,e1.Z)(l)]}),(0,eJ.jsxs)(s1,{children:["Gross Total : ",(0,e1.Z)(d)]})]})]})},s0=(0,tQ.ZP)(tH.Z).attrs(function(){return{align:"center",justify:"between"}}).withConfig({displayName:"creditNoteTable__StyledRow",componentId:"sc-1eov9hu-0"})(["margin:0 5px;"]),s1=tQ.ZP.p.withConfig({displayName:"creditNoteTable__StyledP",componentId:"sc-1eov9hu-1"})(["margin:0;"]),s2=n(77301);function s3(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function s6(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s3(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s3(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var s5=function(e){var t,n,r,i,o,a,s=e.defaultValues,c=e.job,u=e.refetch,l=e.toggleShow,d=(e.userId,e.invoiceId),p=e.invoice,m=e.totalReconciledAmount,f=(0,K.useState)(),v=f[0],h=f[1],b=(0,e6.cI)({defaultValues:s6({},s),resolver:(0,e5.S)(sz)}),x=b.control,j=b.errors,g=b.handleSubmit,y=b.register,Z=b.setValue,w=(0,K.useState)(sR(s)),O=w[0],I=w[1],S="ProformaInvoiceCustomer"===p.invoiceType?(null==p?void 0:null===(t=p.reconciledAmount)||void 0===t?void 0:null===(n=t.reconciliations)||void 0===n?void 0:null===(r=n.aggregate)||void 0===r?void 0:null===(i=r.sum)||void 0===i?void 0:i.amount)||0:m||0,P=null!==(o=p.amounts.vatTotal)&&void 0!==o?o:0,C=(0,ey.D)(sZ,{onCompleted:function(){u(),l()}}),D=(0,eb.Z)(C,1)[0],R=(0,ey.D)(sw),k=(0,eb.Z)(R,2),E=k[0],A=k[1].loading,q=(a=(0,eh.Z)(ej().mark(function e(t){var n,r,i,o;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!A){e.next=2;break}return e.abrupt("return");case 2:if(!(Number((n=O.reduce(function(e,t){return e+t.gross},0))+S)>P)){e.next=6;break}return h("maximum allowed value is ".concat((0,e1.Z)(P-S))),e.abrupt("return");case 6:return r={accountId:c.customer.id,balance:0,credit:parseFloat(t.amountReceived).toFixed(2),currencyId:(0,s2.K)(c.customer.id),debit:0,entity:"CreditNote",meta:{paymentReference:null,comment:t.reason},type:"creditNote",paymentStatus:"creditNote",dateReceived:(0,rQ.v)(t.dateReceived),Reconciliations:{data:{amount:n,creditEntity:"CreditNote",debitEntity:"Invoice",debitEntityId:d,meta:{items:O.map(function(e){return{description:e.description,unit:e.unit,rate:e.rate,vatRate:e.vatRate/100}})}}}},e.next=9,E({variables:{object:r}}).then(function(e){return e.data.insert_AccountEntry_one.id});case 9:i={job:{},jobId:c.id,timing:[],isPaid:!1},n+S===P&&(o="customerPaid",i.job={status:o},i.timing.push({status:o,jobId:c.id}),i.isPaid="ProformaInvoiceCustomer"!==p.invoiceType),D({variables:i});case 12:case"end":return e.stop()}},e)})),function(e){return a.apply(this,arguments)}),T={control:x,errors:j,register:y};return Z("amountReceived",(0,a7.l)(null==O?void 0:O.reduce(function(e,t){return e+t.gross},0),2)),(0,eJ.jsxs)(e4.Z,{id:"offCanvasForm",handleSubmit:g(q),children:[(0,eJ.jsx)(t7.Z,{content:"Invoice amount ",text:(0,e1.Z)(P)}),(0,eJ.jsx)(t7.Z,{content:"Reconciled amount",text:(0,e1.Z)(S)}),(0,eJ.jsx)(sX,{setValue:I,values:O,showDetails:!1}),(0,eJ.jsx)(tl.Z,{label:"Date created"}),(0,eJ.jsx)(tA.M,s6(s6({},T),{},{name:"dateReceived"})),(0,eJ.jsx)(tl.Z,{label:"Amount"}),(0,eJ.jsxs)(tY.Z,{children:[(0,eJ.jsx)(tB.Z,s6(s6({},T),{},{addonType:"prepend",size:10,text:!0,children:"\xa3"})),(0,eJ.jsx)(td.Z,s6(s6({},T),{},{name:"amountReceived",readOnly:!0})),(0,eJ.jsx)(tB.Z,s6(s6({},T),{},{addonType:"append",size:10,text:!0,children:"EX Vat"}))]}),(0,eJ.jsx)(tl.Z,{label:"Reason",children:(0,eJ.jsx)(tC.Z,s6(s6({},T),{},{name:"reason",rows:2}))}),v&&(0,eJ.jsx)(ts.Z,{context:"danger",content:v})]})},s4=function(e){var t,n,r,i=e.job,o=e.refetch,a=e.type,s=e.financeSupplier,c=e.financeCustomer,u=e.expanded,l=e.onChangeExpanded,d=(0,t2.x)().user,p=(0,aC.a)(),m=(0,eg.x)(),f=(0,eK.E)(i,"closed"),v=(0,er.a)(iZ.Rm,{variables:{jobId:i.id,locationId:i.location.id}}),h=v.loading,b=v.data,x=(b=void 0===b?{invoices:[],meta:{aggregate:{totalCount:0}}}:b).invoices,j=b.meta,g=v.refetch,y=(0,K.useMemo)(function(){return x.filter(function(e){return id.SR[a].includes(e.invoiceType)})},[a,x]),Z=(0,K.useMemo)(function(){return a8(y)},[y]),w=Z.invoicedToDate,O=Z.reconciledAmount,I="customer"===a?(null==c?void 0:null===(t=c.amountInfo)||void 0===t?void 0:t.vatTotal)||0:(null==s?void 0:null===(n=s.amountInfo)||void 0===n?void 0:n.vatTotal)||0,S=function(e){e.stopPropagation(),p.show({content:(0,eJ.jsx)(sJ,{job:i,refetch:function(){g(),o()},toggleShow:p.close}),title:"Create invoice",xs3:"100vw",sm:"100vw",sm2:"80vw",sm3:"70vw",md2:"60vw",lg:"50vw",lg2:"40vw"})},P=(r=(0,eh.Z)(ej().mark(function e(t,n){var r,i,o,a,s;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t.stopPropagation(),i=(r=n.rowData).invoiceType,!id.cJ.includes(i)){e.next=11;break}return e.next=6,m.query({query:iZ.WG,variables:{id:r.id}});case 6:s=e.sent.data.invoice,(0,sQ.u)({meta:null==s?void 0:null===(o=s.accountEntry)||void 0===o?void 0:o.meta,invoice:s}),e.next=12;break;case 11:id.pX.includes(i)?(0,iy._Z)({client:m,jobId:r.entityId,type:i}):id.YK.includes(i)&&(0,iw.$)(r.accountEntry.meta);case 12:case"end":return e.stop()}},e)})),function(e,t){return r.apply(this,arguments)}),C=function(e){p.show({content:(0,eJ.jsx)(sJ,{showDetails:!0,defaultValues:e.rowData}),submit:!1,title:"Items Details",xs3:"100vw",sm:"100vw",sm2:"80vw",sm3:"70vw",md2:"60vw",lg:"50vw",lg2:"40vw"})},D=function(e,t){e.stopPropagation(),p.show({content:(0,eJ.jsx)(s5,{defaultValues:void 0,job:i,refetch:o,toggleShow:p.close,userId:d.id,invoiceId:t.id,invoice:t.rowData,reconciledAmount:O}),title:"Add Credit Note"})},R=function(e){return[{context:"secondary",icon:"download",onClick:function(t){return P(t,e)},tooltip:"Download"},{context:"secondary",icon:"add",onClick:function(t){return D(t,e)},tooltip:"Add Credit Note",disabled:!0},{context:"secondary",icon:"info",onClick:function(t){return C(e)},tooltip:"Details",disabled:"Location"===e.entity}]},k=function(e){e.stopPropagation(),ee().push(s7[a](i))};return(0,eJ.jsxs)(ew.Z,{expanded:u,onChange:l,children:[(0,eJ.jsx)(eO.Z,{expandIcon:(0,eJ.jsx)(eW.Z,{}),children:(0,eJ.jsxs)(eD.Z,{direction:"row",alignItems:"center",spacing:1,children:[(0,eJ.jsx)(eI.Z,{variant:"h6",children:"Invoices"}),(0,eJ.jsx)(aE.Z,{size:"small",onClick:k,children:(0,eJ.jsx)(sg.Z,{sx:{height:"17px",width:"17px"}})})]})}),(0,eJ.jsx)(eS.Z,{children:(0,eJ.jsxs)(eD.Z,{spacing:2,children:[(0,eJ.jsxs)(eP.ZP,{container:!0,columnSpacing:1,children:[(0,eJ.jsxs)(eP.ZP,{item:!0,xs:4,children:[(0,eJ.jsx)(eI.Z,{children:"Invoiced to date"}),(0,eJ.jsx)(eI.Z,{children:(0,nR.T)(w)})]}),(0,eJ.jsxs)(eP.ZP,{item:!0,xs:4,children:[(0,eJ.jsx)(eI.Z,{children:"Amount outstanding"}),(0,eJ.jsx)(eI.Z,{children:(0,nR.T)(w-O)})]}),(0,eJ.jsxs)(eP.ZP,{item:!0,xs:4,children:[(0,eJ.jsx)(eI.Z,{children:"Amount to be invoiced"}),(0,eJ.jsx)(eI.Z,{children:(0,nR.T)(I-w)})]})]}),(0,eJ.jsx)(tX.i,{columns:[{field:"number",headerName:"Number",minWidth:100,sortable:!1},{field:"type",headerName:"Type",minWidth:200,sortable:!1},{field:"vatTotal",headerName:"VAT total",minWidth:100,sortable:!1,renderCell:function(e){var t=e.value;return(0,eJ.jsx)(eJ.Fragment,{children:(0,nR.T)(t)})}},{field:"date",headerName:"Date",minWidth:150,sortable:!1},{field:"dueDate",headerName:"Due Date",minWidth:150,sortable:!1},{field:"status",headerName:"Status",minWidth:100,sortable:!1},{field:"actions",headerName:"",width:50,sortable:!1,renderCell:function(e){var t=e.row;return(0,eJ.jsx)(sv.C,{actionsData:R,row:t})}}],rows:null==y?void 0:y.map(function(e){var t,n,r,i,o,a,s,c;return{id:e.id,number:e.invoiceNumber,type:e.invoiceType,entity:e.entity,total:null!==(t=e.amounts)&&void 0!==t&&t.vatRate?(null===(n=e.amounts)||void 0===n?void 0:n.vatTotal)/(1+(null===(r=e.amounts)||void 0===r?void 0:r.vatRate)):null===(i=e.amounts)||void 0===i?void 0:i.vatTotal,vatRate:null===(o=e.amounts)||void 0===o?void 0:o.vatRate,date:e0()(e.createdAt).format("YYYY-MM-DD"),dueDate:e0()(null===(a=e.accountEntry)||void 0===a?void 0:a.dueDate).format("YYYY-MM-DD"),status:null===(s=e.accountEntry)||void 0===s?void 0:s.paymentStatus,vatTotal:null===(c=e.amounts)||void 0===c?void 0:c.vatTotal,rowData:e,action:""}}),meta:j,loading:h,noResultsMessage:"There are currently no invoices."}),!f&&(0,eJ.jsx)(eC.Z,{color:"secondary",variant:"contained",sx:{alignSelf:"center"},onClick:S,children:"Create ad-hoc invoice"})]})})]})};s4.defaultProps={onChangeExpanded:function(){}};var s7={customer:function(e){var t;return"/dashboard/customers/view?id=".concat(null===(t=e.customer)||void 0===t?void 0:t.id,"&tab=finance")},supplier:function(e){var t;return"/dashboard/suppliers/view?id=".concat(null===(t=e.supplier)||void 0===t?void 0:t.id,"&tab=finance")}},s8=function(e){var t,n,r,i=e.job,o=e.refetch,a=(0,t2.x)().hasRole,s=(0,K.useContext)(eR.Z),c=(0,aC.a)(),u=a("admin"),l=a("supplier"),d=a("customer"),p=a("tenant"),m=(0,eK.E)(i,["validated","unvalidated"]),f=(0,eK.E)(i,"invoiceSent"),v="pending"===i.status,h=(0,eK.E)(i,"closed"),b=(0,K.useState)(!u&&l?"supplier":"customer"),x=b[0],j=b[1],g=(0,K.useState)([]),y=g[0],Z=g[1],w=(0,K.useState)(null),O=w[0],I=w[1],S=(0,K.useState)(null),P=S[0],C=S[1],D=(null===(t=i.media)||void 0===t?void 0:t.filter(function(e){var t;return(null===(t=e.item)||void 0===t?void 0:t.category)==="invoice"}).length)||0,R=a9({financeCustomer:P,financeSupplier:O}),k=R.netProfitAmount,E=R.netProfitMargin,A=function(){ee().push("quote"===i.type?"/dashboard/issues/manage?id=".concat(i.number,"&quoted=1"):"/dashboard/issues/manage?id=".concat(i.number))},q=(0,ey.D)(ec.iU),T=(0,eb.Z)(q,1)[0],_=(0,K.useCallback)(function(){T({variables:{jobId:i.id,invoiceType:"customerVat"}}).then(function(e){var t;C(null==e?void 0:null===(t=e.data.calculateJobFinance)||void 0===t?void 0:t.data.persistentData)}).catch(function(e){}),T({variables:{jobId:i.id,invoiceType:"supplier"}}).then(function(e){var t;I(null==e?void 0:null===(t=e.data.calculateJobFinance)||void 0===t?void 0:t.data.persistentData)}).catch(function(){})},[T,null==i?void 0:i.id]);(0,K.useEffect)(function(){_()},[_,null==i?void 0:i.expenses,null==i?void 0:i.financeLogs]);var $,H=function(e){e.stopPropagation(),s.show({content:(0,eJ.jsx)(rj.G,{category:"invoice",entity:"Job",entityId:i.id,onMediaAdd:o,type:"document"}),submit:!1,title:"Upload Invoice"})},N=function(e){e.stopPropagation(),c.show({content:(0,eJ.jsx)(t4,{job:i,refetchJob:o,activeTab:x}),title:"Update Amounts",submit:!1,xs3:"100vw",sm:"100vw",sm2:"100vw",sm3:"65vw",md2:"50vw",lg:"50vw",lg2:"50vw"})},M=function(e){return function(t){t.stopPropagation(),j(e)}},F=[{id:1,label:"Gross",value:"customer"===x?null==P?void 0:null===(n=P.amountInfo)||void 0===n?void 0:n.vatTotal:null==O?void 0:null===(r=O.amountInfo)||void 0===r?void 0:r.vatTotal}];return(0,eJ.jsxs)(eZ.Z,{children:[(0,eJ.jsxs)(ew.Z,{expanded:y.includes("finance-content"),onChange:($="finance-content",function(e,t){t?Z(function(e){return[].concat((0,en.Z)(e),[$])}):Z(function(e){return e.filter(function(e){return e!==$})})}),children:[(0,eJ.jsx)(eO.Z,{expandIcon:(0,eJ.jsx)(eW.Z,{}),children:(0,eJ.jsxs)(eD.Z,{width:"100%",spacing:1,children:[(0,eJ.jsxs)(eD.Z,{width:"100%",direction:"row",justifyContent:"space-between",children:[(0,eJ.jsxs)(eD.Z,{direction:"row",alignItems:"center",spacing:1,children:[(0,eJ.jsx)(eI.Z,{variant:"h6",children:"Finance"}),u&&null!==i.pricing&&!h&&!m&&(0,eJ.jsx)(aE.Z,{size:"small",onClick:N,children:(0,eJ.jsx)(ez.Z,{sx:{height:"17px",width:"17px"}})})]}),!h&&!m&&!d&&!p&&(0,eJ.jsx)(aW.Z,{color:"info",badgeContent:D,showZero:!0,children:(0,eJ.jsx)(eC.Z,{disableMinWidth:!0,color:"info",variant:"contained",size:"small",onClick:H,children:(0,eJ.jsx)(aX.Z,{})})})]}),u&&null!==i.pricing&&(0,eJ.jsxs)(r6.Z,{children:[(0,eJ.jsx)(s9,{color:"secondary",variant:"customer"===x?"contained":"outlined",onClick:M("customer"),children:"Customer"}),(0,eJ.jsx)(s9,{color:"primary",variant:"supplier"===x?"contained":"outlined",onClick:M("supplier"),children:"Supplier"})]}),!y.includes("finance-content")&&null!==i.pricing&&(0,eJ.jsxs)(eJ.Fragment,{children:[(0,eJ.jsxs)(eZ.Z,{children:[(0,eJ.jsx)(tX.i,{hideHeader:!0,columns:[{field:"label",flex:1,sortable:!1,renderCell:function(e){var t=e.value;return(0,eJ.jsx)(eI.Z,{fontWeight:700,children:t})}},{field:"value",flex:1,sortable:!1,align:"right",renderCell:function(e){var t=e.value;return(0,eJ.jsx)(eJ.Fragment,{children:(d||p)&&!f?"N/A":(0,nR.T)(t)})}}],rows:F}),(0,eJ.jsx)(aK.Z,{})]}),a("admin")&&"customer"===x&&(0,eJ.jsxs)(eP.ZP,{container:!0,children:[(0,eJ.jsxs)(eP.ZP,{item:!0,xs:4,children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Net Profit"}),(0,eJ.jsx)(eI.Z,{children:(0,nR.T)(k||0)})]}),(0,eJ.jsxs)(eP.ZP,{item:!0,xs:8,children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Net Profit Margin"}),(0,eJ.jsxs)(eI.Z,{children:[E||0,"%"]})]})]})]}),null===i.pricing&&(0,eJ.jsxs)(eD.Z,{spacing:2,children:[(0,eJ.jsx)(nT.Z,{severity:"error",children:"Finance information will only be available once job has been created."}),u&&!v&&!h&&(0,eJ.jsx)(eC.Z,{color:"danger",variant:"contained",size:"large",onClick:function(e){e.stopPropagation(),a("admin")?A():nV(i,s,o)},children:"Change job pricing or service"})]})]})}),(0,eJ.jsx)(eS.Z,{sx:{pt:0},children:null!==i.pricing&&(P&&"customer"===x||O&&"supplier"===x)&&(0,eJ.jsx)(se,{job:i,type:x,financeSupplier:O,financeCustomer:P})})]}),y.includes("finance-content")&&(0,eK.E)(i,"accepted")&&(0,eJ.jsx)(sj,{expanded:y.includes("finance-content"),job:i,refetchParent:o,tab:x}),a("admin")&&"quote"!==i.type&&(0,eJ.jsx)(s4,{job:i,refetch:o,type:x,financeSupplier:O,financeCustomer:P})]})};s8.defaultProps={};var s9=(0,eT.ZP)(eC.Z)(function(){return{height:"30px"}}),ce=n(48758),ct=(0,e9.Ry)().shape({relatedSelected:(0,e9.Ry)().required(),relType:(0,e9.Z_)().required()});function cn(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function cr(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?cn(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):cn(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var ci=function(e){var t,n,r,i,o,a=e.job,s=e.submit,c=(0,e6.cI)({resolver:(0,e5.S)(ct)}),u=c.control,l=c.errors,d=c.handleSubmit,p=c.register,m=c.watch,f={control:u,errors:l,register:p},v=m("relatedSelected"),h=m("relType"),b=function(e){s(e)};return(0,eJ.jsxs)(e4.Z,{id:"offCanvasForm",handleSubmit:d(b),children:[(0,eJ.jsx)(tu.Z,cr(cr({},f),{},{legend:"Relation Type",name:"relType",data:[{id:"parent",label:"Parent",value:"parent"},{id:"child",label:"Child",value:"child"}]})),(0,eJ.jsx)(e8.P,cr(cr({},f),{},{errors:cr({},l),label:"Work Orders",locationId:a.locationId,name:"relatedSelected",type:"job"})),v&&(0,eJ.jsxs)("div",{children:[(0,eJ.jsx)(t7.Z,{content:"Id",text:v.number}),(0,eJ.jsx)(t7.Z,{content:"Title",text:v.title}),(0,eJ.jsx)(t7.Z,{content:"Date",text:(0,e2.Z)(v.timingStart)}),(0,eJ.jsx)(t7.Z,{content:"Short Job Description",text:(null==v?void 0:v.Taxonomy.length)>0&&null!==(t=null==v?void 0:null===(n=v.Taxonomy[0].Taxonomy)||void 0===n?void 0:n.shortJobDescription)&&void 0!==t?t:"-"}),(0,eJ.jsx)(t7.Z,{content:"Address",text:null!==(r=null==v?void 0:null===(i=v.Location)||void 0===i?void 0:i.name)&&void 0!==r?r:""}),(0,eJ.jsx)(t7.Z,{content:"Status",text:null===(o=o5.yW.find(function(e){return e.value===v.status}))||void 0===o?void 0:o.text}),(0,eJ.jsx)("br",{})]}),"parent"===h&&a.parentId&&(0,eJ.jsx)(ts.Z,{content:"This job already has a parent job defined. Do you want to update it?",context:"warning"})]})},co=function(e){var t,n,r,i,o=e.job,a=e.refetch,s=e.expanded,c=e.onChangeExpanded,u=(0,rq.q)(),l=(0,t2.x)().hasRole,d=(0,K.useContext)(eR.Z),p=null===(t=u.admin.jobSetting)||void 0===t?void 0:t.jobNumberPrefix,m=null===(n=u.admin.jobSetting)||void 0===n?void 0:n.jobNumberSuffix,f=[],v=(0,ey.D)(eo.qD),h=(0,eb.Z)(v,1)[0],b=function(e){return[{context:"danger",icon:"delete",onClick:function(t){return g(t,e)},tooltip:"Delete"}]},x=[{field:"relType",headerName:"Relation",flex:1,sortable:!1},{field:"number",headerName:"Number",flex:1,sortable:!0,renderCell:function(e){var t=e.row;return(0,eJ.jsx)(rA.D,{id:t.id,number:t.number,openCanvas:!0,type:t.type,numberPrefix:p,numberSuffix:m})}},{field:"actions",headerName:"",width:50,sortable:!1,hide:!l("admin"),renderCell:function(e){var t=e.row;return(0,eJ.jsx)(sv.C,{actionsData:b,row:t})}}];o.parentJob&&f.push({relType:"parent",id:o.parentJob.id,type:o.parentJob.type,number:o.parentJob.number,reference:o.parentJob.reference,status:(null===(r=o5.yW.find(function(e){return e.value===o.parentJob.status}))||void 0===r?void 0:r.text)||"",date:e0()(o.parentJob.createdAt).format("YYYY-MM-DD"),actions:""}),(null===(i=o.childJobs)||void 0===i?void 0:i.length)&&o.childJobs.forEach(function(e){var t=(o5.yW.find(function(t){return t.value===e.status})||"").text;f.push({relType:"child",id:e.id,type:e.type,number:e.number,reference:e.reference,status:t,date:e0()(e.createdAt).format("YYYY-MM-DD"),actions:""})});var j,g=function(e,t){h({variables:{id:"child"===t.relType?t.id:o.id,changes:{parentId:null}}}),e.stopPropagation(),a()},y=(j=(0,eh.Z)(ej().mark(function e(t){var n,r;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n=t.relatedSelected,"parent"===(r=t.relType)&&n.value?h({variables:{id:o.id,changes:{parentId:n.value}}}):"child"===r&&n.value&&h({variables:{id:n.value,changes:{parentId:o.id}}}),a(),d.close();case 4:case"end":return e.stop()}},e)})),function(e){return j.apply(this,arguments)}),Z=function(e){d.show({content:(0,eJ.jsx)(ci,{job:o,submit:y,type:e}),title:"Related Works"})},w={actions:l("admin")};return(0,eJ.jsxs)(ew.Z,{expanded:s,onChange:c,children:[(0,eJ.jsx)(eO.Z,{expandIcon:(0,eJ.jsx)(eW.Z,{}),children:(0,eJ.jsx)(eI.Z,{variant:"h6",children:"Related Works"})}),(0,eJ.jsx)(eS.Z,{children:(0,eJ.jsxs)(eD.Z,{width:"100%",children:[(0,eJ.jsx)(tX.i,{columns:x,rows:f,columnVisibilityModel:w}),(0,eJ.jsx)(aE.Z,{sx:{alignSelf:"center"},onClick:function(){return Z("parent")},children:(0,eJ.jsx)(sh.Z,{})})]})})]})};co.defaultProps={onChangeExpanded:function(){}};var ca=n(87918);function cs(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function cc(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?cs(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):cs(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var cu=function(e){var t,n,r=e.job,i=(null===(t=i1.M2.find(function(e){var t;return e.value===(null==r?void 0:null===(t=r.report)||void 0===t?void 0:t.completion)}))||void 0===t?void 0:t.label)||"Unconfirmed";return(0,eJ.jsxs)(eJ.Fragment,{children:[(0,eJ.jsx)(ca.Z,{color:function(){var e;switch(null==r?void 0:null===(e=r.report)||void 0===e?void 0:e.completion){case"complete":return"success";case"couldNotDo":return"danger";default:return"info"}}(),label:i,size:"small"}),(0,eJ.jsx)(ca.Z,cc(cc({},function(){switch(null==r?void 0:r.timingStatus){case"correct":return{color:"success",label:"Timing: Correct"};case"incorrect":return{color:"danger",label:"Timing: Incorrect"};default:return{color:"info",label:"Timing: Unconfirmed"}}}()),{},{size:"small"})),(null===(n=r.report)||void 0===n?void 0:n.passFailStatus)&&(0,eJ.jsx)(ca.Z,cc(cc({},function(){var e;switch(null===(e=r.report)||void 0===e?void 0:e.passFailStatus){case"Passed":return{label:"Passed",color:"success"};case"Failed":return{label:"Failed",color:"warning"};case"Failure resolved":return{label:"Failure resolved",color:"info"}}}()),{},{size:"small"}))]})};cu.defaultProps={job:{}};var cl=(0,es.Ps)(U||(U=(0,ea.Z)(["\n  mutation ResolveJobReport(\n    $id: Int!\n    $changes: JobReport_set_input!\n    $timings: [JobTiming_insert_input!]!\n  ) {\n    update_JobReport(where: { id: { _eq: $id } }, _set: $changes) {\n      returning {\n        id\n      }\n    }\n    insert_JobTiming(objects: $timings) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),cd=e9.Ry({comments:e9.Z_().min(30,"Comments must have a minimum of 30 characters.").required()}),cp=function(e){var t,n,r=e.id,i=e.jobId,o=e.offCanvas,a=e.refetch,s=(0,e6.cI)({defaultValues:{comments:""},resolver:(0,e5.S)(cd)}),c=s.register,u=s.errors,l=s.handleSubmit,d=(0,ey.D)(cl,{onCompleted:function(){o.close(),a()}}),p=(0,eb.Z)(d,1)[0],m=function(e){p({variables:{id:r,changes:{passFailStatus:"Failure resolved",comments:e.comments},timings:[{status:"reportFailureResolved",jobId:i,notes:e.comments,userId:1}]}})};return(0,eJ.jsx)("form",{id:"offCanvasForm",onSubmit:l(m),children:(0,eJ.jsx)(eZ.Z,{children:(0,eJ.jsx)(ne.Z,{fullWidth:!0,label:"Comments",multiline:!0,rows:4,maxRows:4,name:"comments",inputRef:c,error:null===(t=u.comments)||void 0===t?void 0:t.message,helperText:null===(n=u.comments)||void 0===n?void 0:n.message})})})};cp.defaultProps={offCanvas:{},refetch:function(){}};var cm=function(e){var t,n,r,i,o,a,s,c,u,l,d=e.job,p=e.refetch,m=e.expanded,f=e.onChangeExpanded,v=(0,K.useContext)(eR.Z),h=(0,t2.x)(),b=h.hasRole,x=h.user,j=null==x?void 0:x.invoiceThreshold,g=null==d?void 0:d.supplierVatTotal,y=rf(d.timings),Z=(0,eK.E)(d,"inProgress"),w=(0,eK.E)(d,"reportSentSupplier"),O=(0,eK.E)(d,"closed"),I=tg("supplier",null==d?void 0:d.timings),S=(0,ey.D)(ec.xY,{onCompleted:function(){p&&p()}}),P=(0,eb.Z)(S,1)[0],C=function(){v.show({content:(0,eJ.jsx)(ob,{job:d,offCanvas:v,refetch:p}),title:"Job Report",submit:(0,eK.E)(d,"completed")})},D=function(){var e,t,n=[{jobId:d.id,status:"reportSentSupplier",userId:x.id}];(null===(e=d.report)||void 0===e?void 0:e.passFailStatus)==="Failed"&&n.push({jobId:d.id,status:"reportFailed",notes:null===(t=d.report)||void 0===t?void 0:t.recommendations,userId:x.id}),P({variables:{id:d.id,changes:{},timing:n}})},R=function(e){e.stopPropagation(),(0,rI.e)({job:d,adminId:x.adminId})},k=function(e){var t;e.stopPropagation(),v.show({content:(0,eJ.jsx)(cp,{id:null===(t=d.report)||void 0===t?void 0:t.id,jobId:d.id,offCanvas:v,refetch:p}),title:"Resolve",submit:!0})};return(0,eJ.jsxs)(ew.Z,{expanded:m,onChange:f,children:[(0,eJ.jsx)(eO.Z,{expandIcon:(0,eJ.jsx)(eW.Z,{}),children:(0,eJ.jsxs)(eD.Z,{direction:"row",children:[(0,eJ.jsx)(eI.Z,{variant:"h6",children:"Report"}),(0,eJ.jsx)(cf,{direction:"row",alignItems:"center",flexWrap:"wrap",children:d.report&&(0,eK.E)(d,"completed")&&(0,eJ.jsx)(cu,{job:d})})]})}),(0,eJ.jsx)(eS.Z,{children:(0,eJ.jsxs)(eD.Z,{width:"100%",spacing:2,children:[null!==(t=d.report)&&void 0!==t&&t.notes?(0,eJ.jsxs)(eZ.Z,{children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Notes"}),(0,eJ.jsx)(eI.Z,{children:d.report.notes})]}):(0,eJ.jsx)(eZ.Z,{children:(0,eJ.jsx)(eI.Z,{children:"The job report has not yet been created"})}),((null===(n=d.report)||void 0===n?void 0:n.passFailStatus)==="Failed"||(null===(r=d.report)||void 0===r?void 0:r.passFailStatus)==="Failure resolved")&&(null===(i=d.report)||void 0===i?void 0:i.recommendations)&&(0,eJ.jsxs)(eZ.Z,{children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",sx:{fontWeight:700},children:"Recommendations"}),(0,eJ.jsx)(eI.Z,{sx:{fontWeight:700},children:d.report.recommendations})]}),(null===(o=d.report)||void 0===o?void 0:o.passFailStatus)==="Failure resolved"&&(null===(a=d.report)||void 0===a?void 0:a.comments)&&(0,eJ.jsxs)(eZ.Z,{children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",sx:{fontWeight:700},children:"Comments"}),(0,eJ.jsx)(eI.Z,{sx:{fontWeight:700},children:d.report.comments})]}),Z&&!w&&"onHold"!==y&&!O&&(0,eJ.jsxs)(eD.Z,{width:"100%",direction:"row",justifyContent:"flex-end",spacing:2,children:[(0,eJ.jsx)(eC.Z,{color:"secondary",variant:"contained",onClick:C,children:d.report?"Update Report":"Create Report"}),b("supplier")&&((0,tZ.il)(j,g)||I)&&(0,eJ.jsx)(eC.Z,{variant:"contained",onClick:D,disabled:!(null!==(s=d.report)&&void 0!==s&&s.completion),children:"Submit Report"}),b("supplier")&&!((0,tZ.il)(j,g)||I)&&(0,eJ.jsx)(eC.Z,{variant:"contained",onClick:function(){return(0,tv.I_)({type:"issue",role:"supplier",jobId:d.id,accountId:x.accountId,amount:g,offCanvas:v})},disabled:!(null!==(c=d.report)&&void 0!==c&&c.completion),children:"Request approval"}),!b("supplier")&&(0,eJ.jsx)(eC.Z,{variant:"contained",onClick:D,disabled:!(null!==(u=d.report)&&void 0!==u&&u.completion),children:"Submit Report"})]}),(0,eJ.jsxs)(eD.Z,{width:"100%",direction:"row",justifyContent:"flex-end",spacing:2,children:[d.report&&w&&b("admin")&&(0,eJ.jsx)(eC.Z,{color:"secondary",variant:"contained",onClick:R,children:"Download report"}),(null===(l=d.report)||void 0===l?void 0:l.passFailStatus)==="Failed"&&w&&b("admin")&&(0,eJ.jsx)(eC.Z,{color:"secondary",variant:"contained",onClick:k,children:"Resolve"})]})]})})]})};cm.defaultProps={onChangeExpanded:function(){}};var cf=(0,i3.Z)(eD.Z)(function(){return{rowGap:"4px","& .MuiChip-root":{marginLeft:"16px"}}});function cv(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function ch(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?cv(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):cv(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var cb=function(e){var t,n,r,i,o,a,s,c,u,l,d,p,m,f,v,h=e.job,b=e.refetch,x=(0,K.useContext)(eR.Z),j=(0,t2.x)().hasRole,g=h.shortJobDesc&&h.shortJobDesc.length?h.shortJobDesc[0].taxonomy.name:"",y=h.assets||[],Z=null===(t=h.answers)||void 0===t?void 0:t.map(function(e){var t;return{id:e.id,taxonomyId:e.taxonomyId,comments:e.comments,name:null===(t=e.taxonomy)||void 0===t?void 0:t.name}}),w=(0,ey.D)(eo.FA),O=(0,eb.Z)(w,1)[0],I=(v=(0,eh.Z)(ej().mark(function e(t){var n,r,i,o;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=(0,t8.eD)(t,h.id),r=(0,t8.G2)(t),o=(0,t8.a6)(h,t).meta,delete t.questions,delete t.taxonomyId_ShortDesc,e.next=7,O({variables:{jobId:h.id,originatorEmail:r.email,originatorChanges:r,changes:ch(ch({},t),{},{meta:o}),questions:n,hasQuestions:n.length>0}});case 7:x.close(),b();case 9:case"end":return e.stop()}},e)})),function(e){return v.apply(this,arguments)}),S=function(e){e.stopPropagation(),x.show({content:(0,eJ.jsx)(nc,{description:h.description||"",handleWorkDescriptionSubmit:I,job:h,currentQuestions:Z}),title:"Work Description"})};return(0,eJ.jsxs)(eZ.Z,{children:[(0,eJ.jsxs)(ew.Z,{children:[(0,eJ.jsx)(eO.Z,{expandIcon:(0,eJ.jsx)(eW.Z,{}),children:(0,eJ.jsx)(eD.Z,{width:"100%",spacing:2,children:(0,eJ.jsxs)(eD.Z,{direction:"row",alignItems:"center",spacing:2,children:[(0,eJ.jsx)(eI.Z,{variant:"h6",children:"Issue Reported"}),j(["admin"])&&!(0,eK.E)(h,"validated")&&(0,eJ.jsx)(aE.Z,{size:"small",onClick:S,children:(0,eJ.jsx)(ez.Z,{sx:{height:"17px",width:"17px"}})})]})})}),(0,eJ.jsxs)(eS.Z,{children:[(0,eJ.jsxs)(eP.ZP,{container:!0,children:[(0,eJ.jsxs)(eP.ZP,{item:!0,xs:6,children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Short Job Description"}),(0,eJ.jsx)(ak.O,{maxLength:20,children:g||"-"})]}),(0,eJ.jsxs)(eP.ZP,{item:!0,xs:6,children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Job Description"}),(0,eJ.jsx)(ak.O,{maxLength:20,children:h.description||"-"})]}),y.length>0&&(0,eJ.jsxs)(eP.ZP,{item:!0,xs:12,children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Asset(s)"}),(0,eJ.jsx)(ak.O,{maxLength:100,children:y.map(function(e){var t=e.asset;return(0,eJ.jsxs)(aV.r,{color:"secondary",href:"/dashboard/assets/view?id=".concat(t.id),children:[(null==t?void 0:t.name)||"-",";"]})})})]}),(0,eJ.jsxs)(eP.ZP,{item:!0,xs:12,children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Issue description"}),(0,eJ.jsx)(ak.O,{maxLength:20,children:h.issueReportedDescription||"-"})]}),(0,eJ.jsxs)(eP.ZP,{item:!0,xs:12,children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Issue type"}),(0,eJ.jsx)(ak.O,{maxLength:20,children:(null===(n=h.issueTypes)||void 0===n?void 0:null===(r=n[0])||void 0===r?void 0:null===(i=r.issue)||void 0===i?void 0:i.name)||"-"})]}),(null===(o=h.meta)||void 0===o?void 0:null===(a=o.reporter)||void 0===a?void 0:a.email)&&(0,eJ.jsxs)(eJ.Fragment,{children:[(0,eJ.jsx)(eP.ZP,{item:!0,xs:12,mt:1,mb:1,children:(0,eJ.jsx)(eI.Z,{typography:"subtitle1",children:"Originator"})}),(0,eJ.jsxs)(eP.ZP,{item:!0,xs:6,children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Email"}),(0,eJ.jsx)(ak.O,{maxLength:20,children:(null===(s=h.meta)||void 0===s?void 0:null===(c=s.reporter)||void 0===c?void 0:c.email)||"-"})]}),(0,eJ.jsxs)(eP.ZP,{item:!0,xs:6,children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Name"}),(0,eJ.jsx)(ak.O,{maxLength:20,children:"".concat(null===(u=h.meta)||void 0===u?void 0:null===(l=u.reporter)||void 0===l?void 0:l.nameFirst," ").concat(null===(d=h.meta)||void 0===d?void 0:null===(p=d.reporter)||void 0===p?void 0:p.nameLast)||"-"})]}),(0,eJ.jsxs)(eP.ZP,{item:!0,xs:6,children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Phone"}),(0,eJ.jsx)(ak.O,{maxLength:20,children:(null===(m=h.meta)||void 0===m?void 0:null===(f=m.reporter)||void 0===f?void 0:f.phone)||"-"})]})]})]}),(0,eJ.jsx)(ce.y,{answers:Z})]})]}),(j(["admin"])||j(["customer"]))&&(0,eJ.jsx)(co,{job:h,refetch:b}),j(["admin","supplier"])&&(0,eJ.jsx)(cm,{job:h,refetch:b})]})};cb.defaultProps={};var cx=n(83704),cj=n.n(cx),cg=n(96486),cy=(0,e9.Ry)().shape({assignedTo:(0,e9.Ry)().required()});function cZ(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function cw(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?cZ(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):cZ(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var cO=function(e){var t,n=e.defaultValues,r=e.onSuccess,i=e.user,o=(0,e6.cI)({defaultValues:n,resolver:(0,e5.S)(cy)}),a=o.control,s=o.errors,c=o.handleSubmit,u={control:a,errors:s,register:o.register},l=(t=(0,eh.Z)(ej().mark(function e(t){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:r(t);case 1:case"end":return e.stop()}},e)})),function(e){return t.apply(this,arguments)});return(0,eJ.jsxs)(e4.Z,{id:"offCanvasForm",handleSubmit:c(l),children:[(0,eJ.jsx)(e8.P,cw(cw({},u),{},{accountId:i.accountId,errors:cw({},s),label:"Assigned to",name:"assignedTo",type:"user"})),(0,eJ.jsx)(tl.Z,{label:"Customer reference",children:(0,eJ.jsx)(td.Z,cw(cw({},u),{},{name:"reference"}))})]})},cI=n(1950),cS=n(78898),cP=n(17497);function cC(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}cj()(e0());var cD=function(e){var t,n,r,i,o,a,s,c,u,l,d,p,m,f,v,h,b,x,j,g=e.job,y=e.refetch,Z=e.isQuotes,w=e.showOrder,O=e.expanded,I=e.onChangeExpanded,S=(0,rq.q)(),P=(0,t2.x)(),C=P.hasRole,D=P.user,R=(0,eg.x)(),k=(0,K.useContext)(eR.Z),E=(0,e6.cI)({defaultValues:{relatedLinks:(null==g?void 0:g.relatedLinks)||[]}}),A=E.setValue,q=E.watch,T=E.register,_=E.handleSubmit,$=(0,cP.b)(g),H=null==S?void 0:null===(t=S.admin)||void 0===t?void 0:null===(n=t.meta)||void 0===n?void 0:null===(r=n.supplierInstructions)||void 0===r?void 0:r.terms,N=null===(i=S.admin)||void 0===i?void 0:null===(o=i.jobSetting)||void 0===o?void 0:o.jobNumberPrefix,M=null===(a=S.admin)||void 0===a?void 0:null===(s=a.jobSetting)||void 0===s?void 0:s.jobNumberSuffix,F=q("relatedLinks"),J=(0,ey.D)(eo.qD,{onCompleted:(x=(0,eh.Z)(ej().mark(function e(){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!g){e.next=3;break}return e.next=3,(0,tD.F)(R,g.id);case 3:y();case 4:case"end":return e.stop()}},e)})),function(){return x.apply(this,arguments)})}),L=(0,eb.Z)(J,1)[0],U=function(e){L({variables:{id:g.id,changes:e}})},V=function(e){e.stopPropagation();var t,n,r,i,o={reference:g.reference,location:g.location};null!==(t=g.manager)&&void 0!==t&&t.id&&(o.assignedTo={value:null===(n=g.manager)||void 0===n?void 0:n.id,label:"".concat(null===(r=g.manager)||void 0===r?void 0:r.nameFirst," ").concat(null===(i=g.manager)||void 0===i?void 0:i.nameLast)}),k.show({content:(0,eJ.jsx)(cO,{defaultValues:o,onSuccess:Q,user:D}),title:"Edit Assignee"})},Q=(j=(0,eh.Z)(ej().mark(function e(t){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:L({variables:{id:g.id,changes:{managerId:t.assignedTo.value,reference:t.reference}}}),y(),k.close();case 3:case"end":return e.stop()}},e)})),function(e){return j.apply(this,arguments)});return(0,eJ.jsxs)(ew.Z,{expanded:O,onChange:I,children:[(0,eJ.jsx)(eO.Z,{expandIcon:(0,eJ.jsx)(eW.Z,{}),children:(0,eJ.jsxs)(eD.Z,{direction:"row",alignItems:"center",spacing:1,children:[(0,eJ.jsx)(eI.Z,{variant:"h6",children:"Details"}),C("admin")&&(0,eJ.jsx)(aE.Z,{size:"small",onClick:V,children:(0,eJ.jsx)(ez.Z,{sx:{height:"17px",width:"17px"}})})]})}),(0,eJ.jsx)(eS.Z,{children:(0,eJ.jsxs)(eD.Z,{direction:"row",children:[(0,eJ.jsxs)(eD.Z,{spacing:1,sx:{width:"100%",height:"auto"},children:[C(["admin","supplier"])&&H&&(0,eJ.jsx)(eZ.Z,{children:(0,eJ.jsx)(nT.Z,{severity:"warning",children:H})}),w&&(0,eJ.jsxs)(eZ.Z,{children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Order"}),(0,eJ.jsx)(eI.Z,{children:(0,eJ.jsx)(rA.D,{id:g.id,number:g.number,numberPrefix:N,numberSuffix:M,type:g.type})})]}),g.tenantUser&&(0,eJ.jsxs)(eZ.Z,{children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Tenant"}),(0,eJ.jsx)(eI.Z,{children:g.tenantUser&&g.tenantUser.fullName})]}),!Z&&g.reference&&(0,eJ.jsxs)(eZ.Z,{children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Reference"}),(0,eJ.jsx)(eI.Z,{children:g.reference})]}),(0,eJ.jsxs)(eZ.Z,{children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:Z?"Description":"Short Job Description"}),(0,eJ.jsx)(eI.Z,{children:(null==g?void 0:null===(c=g.shortJobDesc)||void 0===c?void 0:c.length)>0&&(null==g?void 0:null===(u=g.shortJobDesc[0])||void 0===u?void 0:u.taxonomy.name)||g.title})]}),(0,eJ.jsxs)(eZ.Z,{children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Status"}),(0,eJ.jsx)(rk.B,{value:g.status})]}),Z&&(0,eJ.jsxs)(eZ.Z,{children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Quote due date"}),(0,eJ.jsxs)(eI.Z,{children:[e0()(g.quoteDue).format("YYYY-MM-DD")," "]})]}),Z&&(0,eJ.jsxs)(eZ.Z,{children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Supplier(s)"}),g.quotations.map(function(e){return(0,eJ.jsxs)(eI.Z,{children:[e.supplier.name," "]})})]}),Z&&(0,eJ.jsxs)(eZ.Z,{children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Quotation"}),(0,eJ.jsxs)(eI.Z,{children:[g.quotations.length," "]})]}),Z&&(0,eJ.jsxs)(eZ.Z,{children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Received"}),(0,eJ.jsx)(eI.Z,{children:"".concat((g.quotations||[]).reduce(function(e,t){return"supplierQuoteComplete"===t.status?e+1:e},0),"/").concat((null===(l=g.quotations)||void 0===l?void 0:l.length)||0)})]}),!Z&&(0,eJ.jsxs)(eZ.Z,{children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Cost Category"}),(0,eJ.jsx)(eI.Z,{children:null===(d=g.costCategoryTaxonomy)||void 0===d?void 0:d.name})]}),!Z&&(0,eJ.jsxs)(eZ.Z,{children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Service"}),(0,eJ.jsx)(eI.Z,{children:null===(p=g.service)||void 0===p?void 0:p.name})]}),g.estimatedDuration&&(0,eJ.jsxs)(eZ.Z,{children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Estimated duration"}),(0,eJ.jsx)(eI.Z,{children:e0().duration(g.estimatedDuration).format()})]}),!Z&&"ppm"!==g.type&&(0,eJ.jsxs)(eZ.Z,{children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Priority"}),(0,eJ.jsx)(eI.Z,{children:(0,eJ.jsx)(eJ.Fragment,{children:"".concat((null==$?void 0:$.name)||"Not Specified "," (").concat((null==$?void 0:$.entity)||"Default",")")})})]}),(0,eJ.jsxs)(eZ.Z,{children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Assigned To"}),(0,eJ.jsx)(eI.Z,{children:g.manager?"".concat(g.manager.nameFirst," ").concat(g.manager.nameLast," "):"Unassigned"})]}),(null===(m=g.compliances)||void 0===m?void 0:m.length)>0&&(0,eJ.jsxs)(eZ.Z,{children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Compliance"}),(0,eJ.jsx)(eI.Z,{children:g.compliances[0].compliance.name})]}),C(["admin","customer","supplier"])&&(0,eJ.jsxs)(eZ.Z,{children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Permits required"}),(0,eJ.jsx)(eI.Z,{children:null!==(f=g.location)&&void 0!==f&&f.permitsRequired?"Yes":"No"})]}),C("admin")&&(0,eJ.jsxs)(eZ.Z,{children:[(0,eJ.jsx)(eI.Z,{typography:"subtitle2",children:"Tags"}),(0,eJ.jsx)(eD.Z,{direction:"row",columnGap:1,rowGap:2,sx:{marginTop:"5px",flexWrap:"wrap"},children:null===(v=g.tags)||void 0===v?void 0:v.map(function(e){var t;return(0,eJ.jsx)(cS.V,{tagEntityId:e.id,name:e.tag.name,color:null===(t=e.tag.meta)||void 0===t?void 0:t.color},null==e?void 0:e.tag.id)})})]}),(0,eJ.jsxs)("form",{id:"relatedLinksForm",onSubmit:_(U),children:[(0,eJ.jsx)(cI.V,{setValue:A,values:F,name:"relatedLinks",noDeleteEdit:!0,titleSx:{fontSize:"12px!important"}}),((null===(h=g.relatedLinks)||void 0===h?void 0:h.length)>0||(null==F?void 0:F.length)>0)&&!cg.isEqual(g.relatedLinks,F)&&(0,eJ.jsx)(eC.Z,{type:"submit",variant:"contained",color:"secondary",sx:{marginTop:"30px"},children:"Submit"}),(0,eJ.jsx)("input",function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?cC(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):cC(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}({type:"hidden"},T("relatedLinks")))]})]}),(null===(b=g.compliances)||void 0===b?void 0:b.length)>0&&(0,eJ.jsxs)(eZ.Z,{children:[(0,eJ.jsx)(eI.Z,{variant:"subtitle2",children:"Compliance"}),(0,eJ.jsx)(eI.Z,{children:g.compliances[0].compliance.name})]})]})})]})};cD.defaultProps={showOrder:!0,onChangeExpanded:function(){}};var cR=n(73073),ck=function(e){var t=e.job,n=e.refetch,r=(0,t2.x)().hasRole,i=(0,K.useState)([]),o=i[0],a=i[1],s=r("tenant");(0,K.useEffect)(function(){var e=(0,eK.E)(t,"inProgress")&&!(0,eK.E)(t,"completed"),n=!t.media||0===t.media.length;e&&n&&c("issues-details")(null,!0)},[t]);var c=function(e){return function(t,n){n?a(function(t){return[].concat((0,en.Z)(t),[e])}):a(function(t){return t.filter(function(t){return t!==e})})}};return(0,eJ.jsxs)(eZ.Z,{children:[(0,eJ.jsx)(cD,{expanded:o.includes("issues-details"),onChangeExpanded:c("issues-details"),job:t,refetch:n,showOrder:!1}),o.includes("issues-details")&&(0,eJ.jsx)(cR.G,{hideExpandIcon:!0,showActionButtons:!s,expanded:o.includes("issues-details"),entity:"Job",entityId:t.id,onMediaAdd:function(){return n()},onMediaRemove:function(){return n()}})]})};ck.defaultProps={};var cE=n(7581),cA=n(16387),cq=n(53344),cT=n(46165),c_=n(10667),c$=n(73816),cH=function(e){var t=e.supplierId,n=e.toggleShow,r=(0,X.useRouter)();(0,K.useEffect)(function(){var e=function(e){n()};return r.events.on("routeChangeComplete",e),function(){r.events.off("routeChangeComplete",e)}},[]);var i=(0,er.a)(cE.l1,{variables:{id:t}}),o=i.loading,a=i.refetch,s=i.data,c=(s=void 0===s?{supplier:{}}:s).supplier;if(o)return(0,eJ.jsx)(nA.Z,{sx:{zIndex:1e5},open:!0,children:(0,eJ.jsx)(nq.Z,{color:"secondary"})});var u=(0,io.WE)(c,"registered"),l=(0,io.WE)(c,"operating");return(0,eJ.jsxs)(eJ.Fragment,{children:[(0,eJ.jsx)(cT.g,{avatar:(0,cq.Q)(c.media),editable:!1,entity:c,entityName:"Account",linkTitleTo:"/dashboard/suppliers/view?id=".concat(c.id)}),(0,eJ.jsx)(c$.D,{supplier:c}),(0,eJ.jsx)(c_.T,{open:!1,supplier:c}),u&&(0,eJ.jsx)(cA.f,{address:u.address,entity:"Account",entityId:c.id,id:u.id,open:!1,refetch:a,title:"Registered Address",type:"registered"}),l&&(0,eJ.jsx)(cA.f,{address:l.address,entity:"Account",entityId:c.id,id:l.id,open:!1,refetch:a,title:"Operating Address",type:"operating"})]})},cN=function(e){var t=e.job,n=e.refetch,r=(0,K.useContext)(eR.Z),i=(0,t2.x)().hasRole,o=rf(t.timings),a=function(e,i,o){e.stopPropagation(),"accepted"===o?r.show({content:(0,eJ.jsx)(rB,{accountId:i.accountId,job:t,offCanvas:r,refetch:n}),submit:!1,title:"Accept Job"}):r.show({content:(0,eJ.jsx)(iz,{accountId:i.accountId,job:t,offCanvas:r,refetch:n}),title:"Reject Job"})},s=function(e){return[{context:"primary",icon:"check",onClick:function(t){return a(t,e,"accepted")},tooltip:"Accept"},{context:"danger",icon:"delete",onClick:function(t){return a(t,e,"rejected")},tooltip:"Reject"}]},c=t.supplierOffers.filter(function(e){return"cancelled"!==e.status}).map(function(e){var t=e.account,n=e.dayRate,r=e.id,i=e.status,o=e.rate;return{id:r,accountId:t.id,name:t.name,rate:o,dayRate:n,status:i||"pending",actions:""}}),u=function(e){var t=e.row;r.show({title:"Supplier information",content:(0,eJ.jsx)(cH,{supplierId:t.accountId,toggleShow:r.close})})};return"onHold"!==o&&t.supplierOffers&&t.supplierOffers.length>0&&(null==c?void 0:c.length)>0&&(0,eJ.jsx)(eZ.Z,{children:(0,eJ.jsxs)(ew.Z,{children:[(0,eJ.jsx)(eO.Z,{expandIcon:(0,eJ.jsx)(eW.Z,{}),children:(0,eJ.jsx)(eI.Z,{variant:"h6",children:"Supplier Offers"})}),(0,eJ.jsx)(eS.Z,{children:i("admin")&&t.supplierOffers&&t.supplierOffers.length>0&&(0,eJ.jsx)(tX.i,{columns:[{field:"name",headerName:"Supplier",flex:1,sortable:!1},{field:"rate",headerName:"Rate/h",flex:1,sortable:!1,renderCell:function(e){var t=e.value;return(0,eJ.jsx)(eJ.Fragment,{children:(0,nR.T)(t)})}},{field:"status",headerName:"Status",flex:1,sortable:!1},{field:"actions",headerName:"",width:50,sortable:!1,renderCell:function(e){var t=e.row;return(0,eJ.jsx)(sv.C,{actionsData:s,row:t})}}],rows:c,onRowClick:u})})]})})};cN.defaultProps={};var cM=n(23855),cF=n(29383),cJ=n(76972),cL=n(69690),cU=e9.Ry({slaId:e9.Rx().integer().required()});function cV(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function cQ(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?cV(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):cV(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var cz=function(e){var t,n,r=e.customerId,i=e.locationId,o=e.onSuccess,a=(0,e6.cI)({resolver:(0,e5.S)(cU)}),s=a.control,c=a.errors,u=a.handleSubmit,l=a.register,d=(0,a.watch)("slaId"),p=(0,er.a)(eo.Ab,{skip:!r||!i,variables:{customerId:r,locationId:i}}).data,m=(0,t8.GU)("reactive",p),f=null==m?void 0:null===(t=m.find(function(e){return e.id===Number(d)}))||void 0===t?void 0:t.notes,v=(n=(0,eh.Z)(ej().mark(function e(t){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:o(t);case 1:case"end":return e.stop()}},e)})),function(e){return n.apply(this,arguments)});return(0,eJ.jsxs)(e4.Z,{handleSubmit:u(v),children:[(0,eJ.jsx)(tu.Z,{register:l,errors:c,data:m,legend:"Priority",name:"slaId"}),d&&(0,eJ.jsx)(ts.Z,{content:f||"-",context:"light"}),(0,eJ.jsx)(tl.Z,{label:"Notes",children:(0,eJ.jsx)(tC.Z,cQ(cQ({},{control:s,errors:c,register:l}),{},{name:"notes",rows:3}))}),(0,eJ.jsx)(tp.Z,{content:"Accept",context:"primary",type:"submit"})]})},cY=function(e){e.accountId,e.quotationId;var t,n=e.onSuccess,r=(0,e6.cI)(),i=r.control,o=r.errors,a=r.handleSubmit,s=r.register,c=(t=(0,eh.Z)(ej().mark(function e(t){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n(t.acceptedNotes);case 1:case"end":return e.stop()}},e)})),function(e){return t.apply(this,arguments)});return(0,eJ.jsxs)(e4.Z,{handleSubmit:a(c),children:[(0,eJ.jsx)(tl.Z,{label:"Notes",children:(0,eJ.jsx)(tC.Z,cQ(cQ({},{control:i,errors:o,register:s}),{},{name:"acceptedNotes",rows:3}))}),(0,eJ.jsx)(tp.Z,{content:"Reject",context:"danger",type:"submit"})]})},cB=n(48501),cG=(0,e9.Ry)().shape({terms:(0,e9.Z_)().required()});function cW(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function cK(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?cW(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):cW(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var cX=function(e){var t,n,r,i,o=e.refetch,a=e.quotation,s=e.toggleShow,c=e.PublicQuoteTerms,u=(0,ey.D)(ta.Dg,{onCompleted:function(){s(),o&&o()}}),l=(0,eb.Z)(u,1)[0],d=(0,e6.cI)({defaultValues:{terms:null!==(t=null!==(n=null===(r=a.meta)||void 0===r?void 0:r.terms)&&void 0!==n?n:c)&&void 0!==t?t:""},resolver:(0,e5.S)(cG)}),p=d.control,m=d.errors,f=d.handleSubmit,v=d.register,h=(i=(0,eh.Z)(ej().mark(function e(t){var n;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return(n=cK({},a.meta)||{}).terms=t.terms,e.next=4,l({variables:{changes:{meta:n},supplierOffer:[],id:a.id}});case 4:case"end":return e.stop()}},e)})),function(e){return i.apply(this,arguments)});return(0,eJ.jsx)(e4.Z,{id:"offCanvasForm",handleSubmit:f(h),children:(0,eJ.jsx)(tC.Z,cK(cK({},{control:p,errors:m,register:v}),{},{name:"terms",rows:8}))})},c0=n(19015),c1=n(39702),c2=(0,es.Ps)(V||(V=(0,ea.Z)(["\n  mutation AcceptQuote($quoteId: Int!, $notes: String, $slaId: Int!) {\n    acceptQuote(quoteId: $quoteId, notes: $notes, slaId: $slaId) {\n      data\n      success\n    }\n  }\n"]))),c3=(0,es.Ps)(Q||(Q=(0,ea.Z)(["\n  mutation RejectQuote($quoteId: Int!, $notes: String) {\n    rejectQuote(quoteId: $quoteId, notes: $notes) {\n      data\n      success\n    }\n  }\n"]))),c6=["job","quote","quotes","refetch","isHideAllQuotation","expanded","onChangeExpanded","hideExpandIcon"];function c5(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function c4(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?c5(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):c5(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}cj()(e0());var c7=function(e){var t,n,r,i,o,a,s,c,u,l=e.job,d=e.quote,p=e.quotes,m=e.refetch,f=e.isHideAllQuotation,v=e.expanded,h=e.onChangeExpanded,b=e.hideExpandIcon,x=(0,aq.Z)(e,c6),j=(0,eg.x)(),g=(0,on.Z)("(max-width: 500px)"),y=(0,n_.D)(),Z=(0,t2.x)(),w=Z.user,O=Z.hasRole,I=O("admin"),S=O((0,en.Z)(c0.Sf)),P=O(["admin","customer"]),C=O(["admin","supplier"]),D=O("customer"),R=O((0,en.Z)(c0.n)),k=O("supplier"),E=O((0,en.Z)(c0.nx)),A=(0,er.a)(ed.nh,{variables:{id:w.id}}).data,q=(A=void 0===A?{user:{}}:A).user,T=null===(t=w=c4(c4({},w),q))||void 0===t?void 0:t.quoteThreshold,_=d.lineItems.reduce(function(e,t){return e+t.supplierTotal},0),$=(null==d?void 0:null===(n=d.lineItems)||void 0===n?void 0:n.reduce(function(e,t){return e+t.total},0))||0,H=$+.2*$,N=(0,K.useContext)(eR.Z),M=(0,aC.a)(),F=["supplierQuoteRequested","thresholdApproved","quotationRejected"].includes(d.status),J=(0,ey.D)(ec.xY,{onCompleted:function(){m&&m()}}),L=(0,eb.Z)(J,1)[0],U=(0,ey.D)(c2,{refetchQueries:["GetJob"],onCompleted:function(){M.close()},onError:function(e){y.show({content:"Error: ".concat(e.message),color:"error"})}}),V=(0,eb.Z)(U,1)[0],Q=(0,ey.D)(c3,{refetchQueries:["GetJob"],onCompleted:function(){M.close()},onError:function(e){y.show({content:"Error: ".concat(e.message),color:"error"})}}),z=(0,eb.Z)(Q,1)[0],Y=(0,er.a)(ed.nE,{variables:{id:w.adminId}}),B=Y.data,G=Y.loading,W=null==B?void 0:null===(r=B.account)||void 0===r?void 0:null===(i=r.meta)||void 0===i?void 0:null===(o=i.quote)||void 0===o?void 0:o.terms,X=function(e){e.stopPropagation(),M.show({content:(0,eJ.jsx)(cR.G,{entity:"Quotation",entityId:d.id}),submit:!1,title:"View media"})},ee=function(e){var t=e.status;if(("supplierQuoteComplete"===t||"supplierQuoteRefused"===t||"waitingThresholdApproval"===t)&&("quoteOffered"===l.status||"waitingThresholdApproval"===l.status)){var n="quoteReceived";L({variables:{id:l.id,changes:{status:n},timing:{status:n,jobId:l.id,userId:w.id,quoteId:d.id}}})}else m&&m();N.close()},et=o5.E6.find(function(e){return e.value===d.status})||{text:"-",context:"info"},ei=function(){N.show({title:"Quotation Number: ".concat(d.quoteNumber),content:(0,eJ.jsx)(cB.m,{onSuccess:ee,quotationId:d.id}),width:"50%",submit:!1})},eo=(c=(0,eh.Z)(ej().mark(function e(t){var n,r;return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.notes,r=t.slaId,e.next=3,V({variables:{quoteId:d.id,notes:n,slaId:r}});case 3:case"end":return e.stop()}},e)})),function(e){return c.apply(this,arguments)}),ea=(u=(0,eh.Z)(ej().mark(function e(t){return ej().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,z({variables:{quoteId:d.id,notes:t}});case 2:case"end":return e.stop()}},e)})),function(e){return u.apply(this,arguments)}),es=function(){M.show({title:"Accept Quotation Number: ".concat(d.quoteNumber),submit:!1,content:(0,eJ.jsx)(cz,{customerId:l.customerId,locationId:l.locationId,onSuccess:eo})})},eu=function(){M.show({title:"Reject Quotation Number: ".concat(d.quoteNumber),submit:!1,content:(0,eJ.jsx)(cY,{accountId:d.supplier.id,quotationId:d.id,quote:d,toggleShow:N.close,onSuccess:ea})})},el=function(){N.show({content:(0,eJ.jsx)(cX,{refetch:m,quotation:d,toggleShow:N.close,PublicQuoteTerms:W}),title:"Terms of quote",width:"30%"})},ep=(0,K.useCallback)(function(){var e;return[{key:"Status",value:et.text},{key:"Supplier",hidden:D,value:(null==d?void 0:null===(e=d.supplier)||void 0===e?void 0:e.name)||l.quotations[0].supplier.name},{hidden:k,key:"Quote due by Customer",value:e0()(l.quoteDue).format("YYYY-MM-DD")},{hidden:D,key:"Quote due from Supplier",value:e0()(l.quoteDueSupplier).format("YYYY-MM-DD")},{key:"Date received",value:e0()(d.createdAt).format("YYYY-MM-DD")},{hidden:!P,key:"Labour Total",value:(0,nR.T)(d.lineItems.filter(function(e){return"Labour"===e.type}).reduce(function(e,t){return e+t.total*t.qty},0))},{hidden:!P,key:"Materials Total",value:(0,nR.T)(d.lineItems.filter(function(e){return"Materials"===e.type}).reduce(function(e,t){return e+t.total*t.qty},0))},{hidden:!P,key:"Quote Total",value:(0,nR.T)(d.lineItems.reduce(function(e,t){return e+t.total*t.qty},0))},{hidden:!C,key:"Labour Supplier Total",value:(0,nR.T)(d.lineItems.filter(function(e){return"Labour"===e.type}).reduce(function(e,t){return e+t.supplierTotal},0))},{hidden:!C,key:"Materials Supplier Total",value:(0,nR.T)(d.lineItems.filter(function(e){return"Materials"===e.type}).reduce(function(e,t){return e+t.supplierTotal},0))},{hidden:!C,key:"Supplier Total",value:(0,nR.T)(d.lineItems.reduce(function(e,t){return e+t.supplierTotal},0))},{key:"Duration",value:d.totalDuration?"".concat(d.totalDuration," ").concat(d.totalDurationUnit):"-"},{key:"Start date",value:d.startDate?e0()(d.startDate).format("YYYY-MM-DD"):"-"},{key:"Site Visit",value:d.siteVisitAt&&e0()(d.siteVisitAt,!0).format("YYYY-MM-DD"),hidden:!l.siteVisitStart||!d.siteVisitAt}].filter(function(e){return!e.hidden}).map(function(e,t){return c4(c4({},e),{},{id:t})})},[et.text,JSON.stringify(d),JSON.stringify(l)]);return G?null:(0,eJ.jsxs)(ew.Z,c4(c4({},x),{},{expanded:v,onChange:h,children:[(0,eJ.jsx)(eO.Z,c4(c4({},!b&&{expandIcon:(0,eJ.jsx)(eW.Z,{})}),{},{children:(0,eJ.jsxs)(eI.Z,{variant:"h6",children:["Quotation ",d.quoteNumber,d.recommended?" (Recommended)":"","quotationAccepted"===d.status?" (Accepted)":""]})})),(0,eJ.jsx)(eS.Z,{children:(0,eJ.jsxs)(eD.Z,{spacing:2,children:[(0,eJ.jsxs)(eP.ZP,{container:!0,display:"flex",alignItems:"center",columnGap:2,children:[(0,eJ.jsx)(eP.ZP,{item:!0,xs:4,children:(0,eJ.jsx)(eI.Z,{children:"Quotation"})}),(0,eJ.jsx)(eP.ZP,{item:!0,xs:7,display:"flex",children:(0,eJ.jsx)(eC.Z,{variant:"contained",color:"secondary",onClick:ei,children:"View Quotation"})})]}),!f&&!F&&I&&(0,eJ.jsxs)(eP.ZP,{container:!0,display:"flex",alignItems:"center",columnGap:2,children:[(0,eJ.jsx)(eP.ZP,{item:!0,xs:4,children:(0,eJ.jsx)(eI.Z,{children:"Accept / Reject"})}),(0,eJ.jsxs)(eP.ZP,{item:!0,xs:7,display:"flex",columnGap:1,children:[(0,eJ.jsx)(eC.Z,{variant:"contained",color:"primary",size:"small",onClick:function(){return(0,tZ.il)(T,H)||tb("adminSupplier",null==l?void 0:l.timings,d.id)?es():(0,tv.I_)({type:"quote",role:"adminSupplier",quotations:p,quotationId:d.id,jobId:l.id,accountId:l.adminId,amount:H,offCanvas:N})},children:"Accept"}),(0,eJ.jsx)(eC.Z,{variant:"contained",color:"danger",size:"small",onClick:eu,children:"Reject"})]})]}),!f&&!F&&D&&(0,eJ.jsxs)(eP.ZP,{container:!0,display:"flex",alignItems:"center",columnGap:2,children:[(0,eJ.jsx)(eP.ZP,{item:!0,xs:4,children:(0,eJ.jsx)(eI.Z,{children:"Accept / Reject"})}),(0,eJ.jsxs)(eP.ZP,{item:!0,xs:7,display:"flex",columnGap:1,children:[(0,eJ.jsx)(eC.Z,{variant:"contained",color:"primary",size:"small",onClick:function(){return(0,tZ.il)(T,H)||tb(w.accountType,null==l?void 0:l.timings,d.id)?es():(0,tv.I_)({type:"quote",role:"customer",quotations:p,quotationId:d.id,jobId:l.id,accountId:l.customer.id,amount:H,offCanvas:N})},children:"Accept"}),(0,eJ.jsx)(eC.Z,{variant:"contained",color:"danger",size:"small",onClick:eu,children:"Reject"})]})]}),(E||R)&&th(w.accountType,null==l?void 0:l.timings,d.id)&&(0,tZ.il)(T,"supplier"===w.accountType?_:H)&&(0,eJ.jsxs)(eP.ZP,{container:!0,display:"flex",alignItems:"center",columnGap:2,children:[(0,eJ.jsx)(eP.ZP,{item:!0,xs:4,children:(0,eJ.jsx)(eI.Z,{children:"Threshold approval"})}),(0,eJ.jsxs)(eP.ZP,{item:!0,xs:7,display:"flex",columnGap:1,children:[!tb(w.accountType,null==l?void 0:l.timings,d.id)&&(0,eJ.jsx)(eC.Z,{variant:"contained",color:"primary",size:"small",onClick:function(){return(0,tv.i$)({type:"quote",role:w.accountType,job:l,quoteId:d.id,offCanvas:N,refetch:m})},children:"Approve"}),!tb(w.accountType,null==l?void 0:l.timings,d.id)&&!tx(w.accountType,null==l?void 0:l.timings,d.id)&&(0,eJ.jsx)(eC.Z,{variant:"contained",color:"danger",size:"small",onClick:function(){return(0,tv.Ii)({type:"quote",role:w.accountType,job:l,quoteId:d.id,offCanvas:N,refetch:m})},children:"Reject"})]})]}),S&&th("adminSupplier",null==l?void 0:l.timings,d.id)&&(0,tZ.il)(T,_)&&(0,eJ.jsxs)(eP.ZP,{container:!0,display:"flex",alignItems:"center",columnGap:2,children:[(0,eJ.jsx)(eP.ZP,{item:!0,xs:4,children:(0,eJ.jsx)(eI.Z,{children:"Permission request to accept quote"})}),(0,eJ.jsxs)(eP.ZP,{item:!0,xs:7,display:"flex",columnGap:1,children:[!tb("adminSupplier",null==l?void 0:l.timings,d.id)&&(0,eJ.jsx)(eC.Z,{variant:"contained",color:"primary",size:"small",onClick:function(){return(0,tv.i$)({type:"quote",role:"adminSupplier",job:l,quoteId:d.id,offCanvas:N,refetch:m})},children:"Approve"}),!tb("adminSupplier",null==l?void 0:l.timings,d.id)&&!tx("adminSupplier",null==l?void 0:l.timings,d.id)&&(0,eJ.jsx)(eC.Z,{variant:"contained",color:"danger",size:"small",onClick:function(){return(0,tv.Ii)({type:"quote",role:"adminSupplier",job:l,quoteId:d.id,offCanvas:N,refetch:m})},children:"Reject"})]})]}),S&&th("adminCustomer",null==l?void 0:l.timings,d.id)&&(0,tZ.il)(T,H)&&(0,eJ.jsxs)(eP.ZP,{container:!0,display:"flex",alignItems:"center",columnGap:2,children:[(0,eJ.jsxs)(eP.ZP,{item:!0,xs:4,children:[" ",(0,eJ.jsx)(eI.Z,{children:"Permission request to send quote to customer"})]}),(0,eJ.jsxs)(eP.ZP,{item:!0,xs:7,display:"flex",columnGap:1,children:[!tb("adminCustomer",null==l?void 0:l.timings,d.id)&&(0,eJ.jsx)(eC.Z,{variant:"contained",color:"primary",size:"small",onClick:function(){return(0,tv.i$)({type:"quote",role:"adminCustomer",job:l,quoteId:d.id,offCanvas:N,refetch:m})},children:"Approve"}),!tb("adminCustomer",null==l?void 0:l.timings,d.id)&&!tx("adminCustomer",null==l?void 0:l.timings,d.id)&&(0,eJ.jsx)(eC.Z,{variant:"contained",color:"danger",size:"small",onClick:function(){return(0,tv.Ii)({type:"quote",role:"adminCustomer",job:l,quoteId:d.id,offCanvas:N,refetch:m})},children:"Reject"})]})]}),(0,eJ.jsx)(aK.Z,{}),(0,eJ.jsx)(tX.i,{hideHeader:!0,columns:[{field:"key",flex:1,sortable:!1,renderCell:function(e){var t=e.value;return"function"==typeof t?t():t}},{field:"value",flex:1,sortable:!1,renderCell:function(e){var t=e.value;return"function"==typeof t?t():t}}],rows:ep(),getRowClassName:function(e){return e.row.id%2==0?"odd":"even"}}),(0,eJ.jsx)(aK.Z,{}),(0,eJ.jsxs)(eP.ZP,{container:!0,rowSpacing:2,children:[(0,eJ.jsxs)(eP.ZP,{item:!0,xs:12,xs3:8,display:"flex",alignItems:"center",columnGap:2,children:[(0,eJ.jsx)(eI.Z,{children:"Attachments"}),(0,eJ.jsx)(aW.Z,{color:"secondary",badgeContent:(null==d?void 0:null===(a=d.media)||void 0===a?void 0:a.length)>0?null==d?void 0:null===(s=d.media)||void 0===s?void 0:s.length:0,children:(0,eJ.jsx)(eC.Z,{variant:"contained",color:"secondary",size:"small",onClick:X,children:"View Attachments"})})]}),("quoteSent"===l.status||"quoteReceived"===l.status||"quotationAccepted"===d.status)&&(0,eJ.jsxs)(eP.ZP,{item:!0,xs:12,xs3:4,display:"flex",alignItems:"center",columnGap:2,children:[(0,eJ.jsx)(eI.Z,c4(c4({},g&&{sx:{width:"80px"}}),{},{children:"PDF"})),(0,eJ.jsx)(eC.Z,{variant:"contained",color:"info",size:"small",onClick:function(){return(0,e3.g)(l,d.id,j)},children:(0,eJ.jsx)(c1.Z,{})})]}),I&&(0,eJ.jsxs)(eP.ZP,{item:!0,xs:12,xs3:12,display:"flex",alignItems:"center",columnGap:2,children:[(0,eJ.jsx)(eI.Z,{width:"80px",children:"Terms"}),(0,eJ.jsx)(eC.Z,{variant:"contained",color:"secondary",size:"small",onClick:el,children:"Terms of the Quote"})]})]})]})})]}))};c7.defaultProps={onChangeExpanded:function(){}};var c8=function(e){var t,n=e.job,r=e.refetch,i=(0,t2.x)().hasRole,o=(0,K.useState)([]),a=o[0],s=o[1],c=(0,K.useState)(0),u=c[0],l=c[1],d=n.quotations.slice().filter(function(e){return"uplift"!==e.type}).sort(function(e){return"quotationAccepted"===e.status?-1:0}),p=!!d.find(function(e){return"quotationAccepted"===e.status}),m=n.siteVisitStart&&e0()(n.siteVisitStart,!0).format("YYYY-MM-DD"),f=n.siteVisitEnd&&e0()(n.siteVisitEnd,!0).format("YYYY-MM-DD"),v=n.siteVisitWeekends,h=function(e){var t=(0,cF.Z)((0,cM.Z)((0,eK.E)(e,"quoteAccepted")),(0,cM.Z)((0,eK.E)(e,"quoteReceived"))),n=(0,cJ.Z)((0,cM.Z)((0,eK.E)(e,"quoteAccepted")),(0,cM.Z)((0,eK.E)(e,"quoteReceived"))),r=(0,cL.Z)((0,cM.Z)((0,eK.E)(e,"quoteAccepted")),(0,cM.Z)((0,eK.E)(e,"quoteReceived")));return"".concat(t>0?t+" day ":"").concat(n>0?n+" hours ":"").concat(r+" minutes")},b=(0,K.useCallback)(function(){var e,t;return[{id:1,key:"Status",value:function(){return(0,eJ.jsx)(rk.B,{value:n.status})}},{id:2,key:"Required quotes",value:n.quoteNumber},{id:3,key:"Quote due by Customer",value:e0()(n.quoteDue).format("YYYY-MM-DD")},{id:4,key:"Quote due from Supplier",value:e0()(n.quoteDueSupplier).format("YYYY-MM-DD")},{hidden:n.quotations.find(function(e){return"quotationAccepted"===e.status}),id:5,key:"Sent quotations",value:(null===(e=n.quotations)||void 0===e?void 0:e.filter(function(e){return"supplierQuoteSent"===e.status}).map(function(e){return e.quoteNumber}).join(", "))||"-"},{hidden:!n.quotations.find(function(e){return"quotationAccepted"===e.status}),id:6,key:"Accepted quotation",value:null===(t=n.quotations.find(function(e){return"quotationAccepted"===e.status}))||void 0===t?void 0:t.quoteNumber},{hidden:!n.quotations.find(function(e){return"quotationAccepted"===e.status}),id:7,key:"Acceptance time",value:h(n)},{id:8,key:"Site Visit Start",value:m,hidden:!m},{id:9,key:"Site Visit End",value:f,hidden:!f},{id:10,key:"Include Weekends",value:v&&"Yes",hidden:!v}].filter(function(e){return!e.hidden})},[JSON.stringify(n)]);return(0,eJ.jsxs)(eZ.Z,{children:[(0,eJ.jsxs)(ew.Z,{expanded:a.includes("quote-details"),onChange:(t="quote-details",function(e,n){n?s(function(e){return[].concat((0,en.Z)(e),[t])}):s(function(e){return e.filter(function(e){return e!==t})})}),children:[(0,eJ.jsx)(eO.Z,{expandIcon:(0,eJ.jsx)(eW.Z,{}),children:(0,eJ.jsx)(eI.Z,{variant:"h6",children:"Quote details"})}),(0,eJ.jsxs)(eS.Z,{sx:{pb:0},children:[(0,eJ.jsx)(eZ.Z,{mb:2,children:(0,eJ.jsx)(tX.i,{hideHeader:!0,columns:[{field:"key",flex:1,sortable:!1,renderCell:function(e){var t=e.value;return"function"==typeof t?t():t}},{field:"value",flex:1,sortable:!1,renderCell:function(e){var t=e.value;return"function"==typeof t?t():t}}],rows:b(),getRowClassName:function(e){return e.row.id%2==0?"odd":"even"}})}),i("admin")&&d.length>1&&(0,eJ.jsx)(r6.Z,{children:d.map(function(e,t){var n;return(0,eJ.jsx)(c9,{color:"secondary",variant:u===t?"contained":"outlined",onClick:function(e){e.stopPropagation(),l(t)},children:e.quoteNumber})})})]})]}),a.includes("quote-details")&&i("admin")&&d.map(function(e,t){return u===t?(0,eJ.jsx)(c7,{job:n,quote:e,refetch:r,quotes:d,isHideAllQuotation:p,expanded:!0,hideExpandIcon:!0,sx:{"&.MuiAccordion-root.Mui-expanded":{borderTop:0,boxShadow:"none"}}},e.quoteNumber):null})]})},c9=(0,eT.ZP)(eC.Z)(function(){return{height:"30px"}}),ue=(0,es.Ps)(z||(z=(0,ea.Z)(["\n  fragment TaskFields on Task {\n    id\n    archived\n    status\n    priority\n    statusLog\n    meta\n    relatedLinks\n    title\n    content\n    dueDate\n    createdAt\n    updatedAt\n    adminId\n    userId\n    assignedAccountId\n    assignedUser: AssignedUser {\n      id\n      fullName\n    }\n    jobId\n  }\n"]))),ut=(0,es.Ps)(Y||(Y=(0,ea.Z)(["\n  query GetTasks(\n    $jobId: Int\n    $assignedUserId: Int\n    $limit: Int\n    $offset: Int\n    $orderBy: Task_order_by!\n  ) {\n    tasks: Task(\n      where: { jobId: { _eq: $jobId }, assignedUserId: { _eq: $assignedUserId } }\n      limit: $limit\n      offset: $offset\n      order_by: [$orderBy]\n    ) {\n      ...TaskFields\n    }\n    meta: Task_aggregate(\n      where: { jobId: { _eq: $jobId }, assignedUserId: { _eq: $assignedUserId } }\n    ) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n\n  ","\n"])),ue),un=(0,es.Ps)(B||(B=(0,ea.Z)(["\n  subscription GetTasks(\n    $jobId: Int\n    $assignedUserId: Int\n    $limit: Int\n    $offset: Int\n    $orderBy: Task_order_by!\n  ) {\n    tasks: Task(\n      where: { jobId: { _eq: $jobId }, assignedUserId: { _eq: $assignedUserId } }\n      limit: $limit\n      offset: $offset\n      order_by: [$orderBy]\n    ) {\n      ...TaskFields\n    }\n  }\n  ","\n"])),ue),ur=n(42846),ui=n(44267),uo=n(62023),ua=n(66242),us=n(41796),uc=n(89077),uu=function(e){var t,n=(t=e.priority,uc.FX.find(function(e){return e.value===t})),r=n.icon,i=n.label;return(0,eJ.jsx)(eZ.Z,{display:"flex",alignItems:"center",children:(0,eJ.jsxs)(eD.Z,{direction:"row",alignItems:"center",children:[r,(0,eJ.jsx)(eI.Z,{ml:1,children:i})]})})};uu.defaultProps={};var ul=function(e){var t,n=(t=e.status,uc.jb.find(function(e){return e.value===t})),r=n.icon,i=n.label,o=n.color,a=n.bgcolor,s=n.value;return(0,eJ.jsx)(ca.Z,{size:"small",label:i,icon:r,sx:{color:o,bgcolor:a}},s)};ul.defaultProps={};var ud=function(e){var t=e.dueDate,n=e.priority,r=e.status,i=e.title,o=e.content,a=e.assigned,s=e.onView;return(0,eJ.jsxs)(up,{variant:"outlined",children:[(0,eJ.jsxs)(ui.Z,{sx:{padding:1},children:[(0,eJ.jsxs)(eD.Z,{direction:"row",justifyContent:"space-between",children:[(0,eJ.jsx)(uu,{priority:n}),(0,eJ.jsx)(ul,{status:r})]}),(0,eJ.jsxs)(eI.Z,{mt:1,variant:"h6",sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[i," \xa0"]}),(0,eJ.jsx)(eI.Z,{mt:1,sx:{height:"63px",overflow:"hidden"},children:o}),(0,eJ.jsxs)(eI.Z,{variant:"subtitle2",children:["Assigned by ",a]})]}),(0,eJ.jsxs)(uo.Z,{sx:{display:"flex",justifyContent:"space-between",pt:0},children:[(0,eJ.jsx)(eC.Z,{variant:"contained",color:"secondary",onClick:s,sx:{height:"30px"},children:"View"}),(0,eJ.jsx)(um,{variant:"subtitle2",children:t})]})]})};ud.defaultProps={title:"",onView:function(){}};var up=(0,eT.ZP)(ua.Z)(function(e){return{display:"flex",flexDirection:"column",justifyContent:"space-between",maxHeight:"210px",minWidth:"280px",backgroundColor:e.theme.palette.muiCardGray.main}}),um=(0,eT.ZP)(eI.Z)(function(e){var t=e.theme;return{alignSelf:"flex-end",fontWeight:700,color:(0,us.$n)(t.palette.black.main,.46)}}),uf=n(24437),uv=n(55733);function uh(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function ub(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?uh(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):uh(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var ux={item:"dueDate",order:"desc"},uj=function(e){var t=e.jobId,n=e.subscription,r=e.showMyTaskButton,i=e.expanded,o=e.onChangeExpanded,a=(0,aC.a)(),s=(0,t2.x)().user,c=(0,ur.x)({filters:{jobId:t},initialSort:ux}).initialData,u=(0,K.useState)(!1),l=u[0],d=u[1],p=ub(ub({},c),{},{assignedUserId:l?s.id:c.userId}),m=(0,er.a)(ut,{variables:ub({},p),skip:n}),f=m.loading,v=m.data,h=(v=void 0===v?{tasks:[],meta:{aggregate:{totalCount:0}}}:v).tasks,b=(0,ei.m)(un,{variables:ub({},p),skip:!n}),x=b.loading,j=b.data,g=(j=void 0===j?{tasks:[]}:j).tasks,y=function(e,t){e.preventDefault(),e.stopPropagation(),a.show({content:(0,eJ.jsx)(uf.J,{id:t,close:a.close}),title:"Task Details",xs3:"100vw",sm:"100vw",sm2:"100vw",sm3:"100vw",md2:"100vw",lg:"90vw",lg2:"80vw"})},Z=function(e){e.preventDefault(),e.stopPropagation(),a.show({content:(0,eJ.jsx)(uv.G,{jobId:t,close:a.close}),title:"Create Task",xs3:"100vw",sm:"100vw",sm2:"80vw",sm3:"70vw",md2:"60vw",lg:"50vw",lg2:"40vw"})},w=(n?g:h).map(function(e){var t;return{id:e.id,status:e.status,priority:e.priority,title:e.title,content:e.content,dueDate:e0()(e.dueDate).format("YYYY-MM-DD"),assignedUser:null===(t=e.assignedUser)||void 0===t?void 0:t.fullName,item:e,actions:""}}),O=function(e){e.stopPropagation(),d(function(e){return!e})};return(0,eJ.jsx)(eZ.Z,{children:(0,eJ.jsxs)(ew.Z,{expanded:i,onChange:o,children:[(0,eJ.jsx)(eO.Z,{expandIcon:(0,eJ.jsx)(eW.Z,{}),children:(0,eJ.jsx)(eI.Z,{variant:"h6",children:"Tasks"})}),(0,eJ.jsx)(eS.Z,{sx:{paddingTop:0},children:(0,eJ.jsxs)(eD.Z,{width:"100%",spacing:1,children:[(0,eJ.jsxs)(eD.Z,{width:"100%",direction:"row",justifyContent:"space-between",alignItems:"center",children:[(0,eJ.jsx)(eI.Z,{children:"Current task in progress"}),r&&(0,eJ.jsx)(nt.Z,{control:(0,eJ.jsx)(nn.Z,{color:"secondary",checked:l,onChange:O}),label:"My Tasks"})]}),(0,eJ.jsx)(eD.Z,{width:"100%",direction:"row",spacing:2,pb:1,sx:{overflowX:"scroll"},children:f||x?(0,eJ.jsx)(eD.Z,{width:"100%",direction:"row",justifyContent:"center",children:(0,eJ.jsx)(nq.Z,{color:"secondary"})}):w.map(function(e){return(0,eJ.jsx)(ud,{dueDate:e.dueDate,priority:e.priority,status:e.status,title:e.title,content:e.content,assigned:e.assignedUser,onView:function(t){return y(t,e.id)}})})}),(0,eJ.jsx)(eD.Z,{direction:"row",justifyContent:"center",children:(0,eJ.jsx)(eC.Z,{variant:"contained",color:"secondary",onClick:Z,children:"Add new task"})})]})})]})})};uj.defaultProps={showMyTaskButton:!1,onChangeExpanded:function(){}};var ug=n(78893),uy=(0,es.Ps)(G||(G=(0,ea.Z)(["\n  query GetUserLocations($accountId: Int, $jobId: Int) {\n    supplierLocations: UserLocation(\n      limit: 10\n      order_by: { id: desc }\n      where: { jobId: { _eq: $jobId }, accountId: { _eq: $accountId } }\n    ) {\n      id\n      geo\n      meta\n      createdAt\n    }\n  }\n"]))),uZ=n(28499),uw=function(e){var t=e.children,n=e.defaultCenter,r=e.defaultZoom,i=function(e){return{fullscreenControl:!0,mapTypeControl:!0,mapTypeId:e.MapTypeId.ROADMAP,scaleControl:!0,scrollwheel:!1,streetViewControl:!0}};return(0,eJ.jsx)(uZ.ZP,{options:i,bootstrapURLKeys:{key:aA.ie.map},defaultCenter:n,defaultZoom:r,children:t})};function uO(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function uI(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?uO(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):uO(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}uw.defaultProps={defaultZoom:14};var uS=function(e){var t,n=e.job,r=(0,io.WE)(null==n?void 0:n.location,"registered"),i=null,o=null;null!=r&&null!==(t=r.address)&&void 0!==t&&t.geo&&(i=(0,io.Pk)(r.address.geo));var a={jobId:n.id,accountId:n.supplier.id},s=(0,er.a)(uy,{skip:!i,variables:uI({},a)}).data,c=(s=void 0===s?{supplierLocations:[]}:s).supplierLocations;if(c.length){var u=c[0];o=(0,io.Pk)(u.geo)}return i&&o?(0,eJ.jsx)(eZ.Z,{children:(0,eJ.jsxs)(ew.Z,{children:[(0,eJ.jsx)(eO.Z,{expandIcon:(0,eJ.jsx)(eW.Z,{}),children:(0,eJ.jsx)(eI.Z,{variant:"h6",children:"Supplier Operative Location"})}),(0,eJ.jsx)(eS.Z,{children:(0,eJ.jsxs)(eD.Z,{children:[(0,eJ.jsx)(eZ.Z,{sx:{height:"300px",width:"100%"},children:(0,eJ.jsxs)(uw,{defaultCenter:i,children:[i&&(0,eJ.jsx)(eZ.Z,uI({component:"img",src:"https://maps.google.com/mapfiles/ms/icons/red-dot.png"},i)),o&&(0,eJ.jsx)(eZ.Z,uI({component:"img",src:"https://maps.google.com/mapfiles/ms/icons/blue-dot.png"},o))]})}),(0,eJ.jsx)(tX.i,{rows:c.map(function(e){var t,n,r=e.meta;return{id:e.id,distance:null!=r&&null!==(t=r.distance)&&void 0!==t&&t.text?r.distance.text:"-",duration:null!=r&&null!==(n=r.duration)&&void 0!==n&&n.text?r.duration.text:"-",time:e0()(e.createdAt).format("YYYY-MM-DD")}}),columns:[{field:"distance",headerName:"Distance",flex:1,sortable:!1},{field:"duration",headerName:"Arrival",flex:1,sortable:!1},{field:"time",headerName:"Last update",flex:1,sortable:!1}]})]})})]})}):null};uS.defaultProps={};var uP=function(e){var t=e.job,n=e.refetch,r=(0,t2.x)().hasRole,i=["supplierQuoteSent","quotationAccepted","supplierQuoteUpdated","waitingThresholdApproval"],o=!0,a=t.quotations.slice().filter(function(e){return r("customer")?"uplift"!==e.type&&i.find(function(t){return t===e.status}):"uplift"!==e.type});return o=!!a.find(function(e){return"quotationAccepted"===e.status}),a.sort(function(e){return"quotationAccepted"===e.status?-1:0}).map(function(e){return(0,eJ.jsx)(eZ.Z,{children:(0,eJ.jsx)(c7,{job:t,quote:e,refetch:n,quotes:a,isHideAllQuotation:o},e.quoteNumber)})})};function uC(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}uP.defaultProps={};var uD=function(e){var t=e.job,n=e.onUpdateJob,r=(0,e6.cI)({defaultValues:{permitsLinks:t.permitsLinks}}),i=r.setValue,o=r.register,a=r.watch,s=r.handleSubmit,c=a("permitsLinks");return(0,eJ.jsxs)("form",{id:"supportingDocumentsFrom",onSubmit:s(n),children:[(0,eJ.jsx)(cI.V,{setValue:i,values:c,name:"permitsLinks",title:"Permit links",noDeleteEdit:!0}),(0,eJ.jsx)("input",function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?uC(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):uC(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}({type:"hidden"},o("permitsLinks"))),(0,eJ.jsx)(eC.Z,{type:"submit",variant:"contained",color:"secondary",sx:uR.submitButton,children:"Submit"})]})},uR={submitButton:{marginTop:"20px"}},uk=function(e){var t=e.job,n=e.refetch,r=(0,aC.a)(),i=(0,ey.D)(eo.qD,{}),o=(0,eb.Z)(i,1)[0],a=function(e){o({variables:{id:t.id,changes:e}}).then(function(){n(),r.close()})},s=function(e){e.stopPropagation(),r.show({content:(0,eJ.jsx)(uD,{job:t,onUpdateJob:a}),title:"Supporting documents",submit:!1})};return(0,eJ.jsx)(uA,{children:(0,eJ.jsxs)(ew.Z,{children:[(0,eJ.jsx)(eO.Z,{expandIcon:(0,eJ.jsx)(eW.Z,{}),children:(0,eJ.jsxs)(eD.Z,{direction:"row",alignItems:"center",spacing:1,children:[(0,eJ.jsx)(eI.Z,{typography:"h6",children:"Supporting Documents"}),(0,eJ.jsx)(aE.Z,{onClick:s,size:"small",children:(0,eJ.jsx)(ez.Z,{sx:uE.editIcon})})]})}),(0,eJ.jsxs)(eS.Z,{children:[(0,eJ.jsx)(eZ.Z,{sx:uE.boxContainer,children:(0,eJ.jsx)(cI.V,{values:t.permitsLinks,title:"Permit links",displayMode:!0})}),(0,eJ.jsx)(aK.Z,{}),(0,eJ.jsx)(eZ.Z,{sx:uE.boxContainer,children:(0,eJ.jsx)(cR.G,{entity:"Job",entityId:t.id,carousel:!0,category:"supportingDocuments"})})]})]})})},uE={editIcon:{height:"17px",width:"17px"},boxContainer:{padding:"15px 10px"}},uA=(0,eT.ZP)(eZ.Z)(function(e){var t=e.theme;return{"&.MuiBox-root":{borderLeft:"5px solid ".concat(t.palette.error.light),borderTopLeftRadius:"5px",borderBottomLeftRadius:"5px"}}});function uq(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function uT(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?uq(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):uq(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var u_=function(e){var t,n,r,i,o=e.id,a=(0,K.useState)(["task-board","messaging-comonent"]),s=a[0],c=a[1],u=(0,rq.q)().hasUserModule,l=(0,t2.x)(),d=l.hasRole,p=l.user,m=d("tenant"),f=d("customer_user"),v=u("quotes"),h=u("finances"),b=(0,er.a)(ed.nh,{variables:{id:p.id}}).data,x=(b=void 0===b?{user:{}}:b).user;p=uT(uT({},p),x);var j=eo.E6;d("supplier")&&(j=em),d("customer")&&(j=ef),d("tenant")&&(j=ep);var g=(0,er.a)(j,{skip:!o,variables:{number:o,adminId:p.adminId}}),y=g.loading,Z=g.data,w=(Z=void 0===Z?{job:null}:Z).job,O=g.refetch,I=(0,ei.m)(eo.$6,{skip:!o,variables:{number:o,adminId:p.adminId}}).data,S=(I=void 0===I?{timings:[]}:I).timings;if(!o)return null;if(!y&&!w)return ee().push("/404"),!1;var P=w?uT({},w[0]):{};if((null==S?void 0:S.length)>0&&(P.timings=S),!v&&f&&"quote"===P.type)throw Error("No access to quotes module");var C=function(e){return function(t,n){n?c(function(t){return[].concat((0,en.Z)(t),[e])}):c(function(t){return t.filter(function(t){return t!==e})})}};return!y&&(0,eJ.jsxs)(eP.ZP,{container:!0,spacing:4,children:[(0,eJ.jsx)(eP.ZP,{item:!0,xs:12,md:6,lg2:4,children:(0,eJ.jsxs)(eD.Z,{spacing:4,children:[(0,eJ.jsx)(aR,{job:P,refetch:O}),(0,eJ.jsx)(az,{job:P,refetch:O}),P.supplier&&d(["admin"])&&(0,eJ.jsx)(aB,{job:P,refetch:O})]})}),(0,eJ.jsxs)(eP.ZP,{item:!0,container:!0,xs:12,md:6,lg2:8,spacing:4,children:[(0,eJ.jsx)(eP.ZP,{item:!0,xs:12,lg2:6,children:(0,eJ.jsxs)(eD.Z,{spacing:4,children:["quote"!==P.type&&(!f||h)&&(!m||h)&&(0,eJ.jsx)(s8,{job:P,refetch:O}),(0,eJ.jsx)(cb,{job:P,refetch:O}),(0,eJ.jsx)(ck,{job:P,refetch:O}),P.supplier&&d(["admin","customer"])&&(0,eJ.jsx)(uS,{job:P}),!P.supplier&&(null==P?void 0:null===(t=P.supplierOffers)||void 0===t?void 0:t.length)>0&&d(["admin"])&&!(0,eK.E)(P,"rejected")&&!(0,eK.E)(P,"closed")&&(0,eJ.jsx)(cN,{job:P,refetch:O}),(0,eK.E)(P,"quoteNew")&&d("admin")&&(0,eJ.jsx)(c8,{job:P,refetch:O}),(0,eK.E)(P,"quoteNew")&&d(["customer","supplier"])&&(!f||h)&&(!f||v)&&(0,eJ.jsx)(uP,{job:P,refetch:O})]})}),(0,eJ.jsx)(eP.ZP,{item:!0,xs:12,lg2:6,children:(0,eJ.jsxs)(eD.Z,{spacing:4,children:[(0,eJ.jsx)(uj,{jobId:P.id,subscription:!0,showMyTaskButton:!0,expanded:s.includes("task-board"),onChangeExpanded:C("task-board")}),(0,eJ.jsx)(ug.b,{id:P.id,adminId:P.adminId,customerId:null===(n=P.customer)||void 0===n?void 0:n.id,supplierId:null===(r=P.supplier)||void 0===r?void 0:r.id,scope:"job",expanded:s.includes("messaging-comonent"),onChangeExpanded:C("messaging-comonent")}),(null==P?void 0:null===(i=P.location)||void 0===i?void 0:i.permitsRequired)&&(0,eJ.jsx)(uk,{job:P,refetch:O})]})})]})]})},u$=n(38033);function uH(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}var uN=function(){var e=(0,K.useContext)(et.Z).user,t=(0,X.useRouter)().query;return e?(0,eJ.jsx)(u$.Z,{children:(0,eJ.jsx)(u_,function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?uH(Object(n),!0).forEach(function(t){(0,W.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):uH(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}({},t))}):(ee().push("/account/sign-in"),null)};uN.getLayout=function(e){return e};var uM=uN},39647:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/dashboard/issues/view",function(){return n(21788)}])}},function(e){e.O(0,[3662,367,2283,212,8890,619,1100,1336,4135,5020,6043,1564,4244,5370,3911,3776,6540,2329,778,4046,1023,4253,3148,2797,9241,653,8062,1207,7328,4061,6075,597,2904,3704,1121,4930,7786,7725,8033,9229,4195,9201,7277,2161,9404,9774,2888,179],function(){return e(e.s=39647)}),_N_E=e.O()}]);