"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8403],{32836:function(e,n,t){t.d(n,{i:function(){return O}});var r=t(59499),o=t(67294),a=t(11163),i=t(83148),c=t(26447),s=t(15861),u=t(90948),d=t(5616),l=t(41796),p=t(87361),m=t(42096),h=t(87043),f=t(61730),g=t(58886),v=t(70872),b=t(85893);function y(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),t.push.apply(t,r)}return t}function x(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?y(Object(t),!0).forEach(function(n){(0,r.Z)(e,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):y(Object(t)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})}return e}var _=function(e){var n=e.currentPage,t=e.totalCount,r=e.pageSize,o=e.onPageChange,a=(0,f.Z)("(max-width:400px)"),i=(0,f.Z)("(max-width:500px)");return(0,b.jsx)(j,{mb:2,page:n,count:Math.ceil(t/r),onChange:function(e,n){return o(n)},variant:"outlined",shape:"rounded",size:a?"small":"medium",hidePrevButton:1===n,hideNextButton:n===Math.ceil(t/r),siblingCount:i?0:1,renderItem:function(e){return(0,b.jsx)(g.Z,x({slots:{previous:function(){return"Previous"},next:function(){return"Next"}}},e))}})};_.defaultProps={currentPage:1,totalCount:0,pageSize:50,onPageChange:function(){}};var j=(0,u.ZP)(v.Z)(function(e){var n,t=e.hidePrevButton,o=e.hideNextButton,a=e.theme;return n={},(0,r.Z)(n,"&.MuiPagination-root",{alignSelf:"center",marginTop:"16px"}),(0,r.Z)(n,"& .MuiPaginationItem-root",{fontWeight:600,margin:0,borderRadius:0}),(0,r.Z)(n,"& .MuiPagination-ul > li:last-child .MuiPaginationItem-previousNext:last-child",{margin:0,borderRadius:"0 5px 5px 0"}),(0,r.Z)(n,"& .MuiPagination-ul > li:first-child .MuiPaginationItem-previousNext:last-child",{margin:0,borderRadius:"5px 0 0 5px"}),(0,r.Z)(n,"& button.Mui-selected",x(x({color:a.palette.white.main,backgroundColor:a.palette.secondary.main},o?{borderRadius:"0 5px 5px 0"}:{}),t?{borderRadius:"5px 0 0 5px"}:{})),n});function Z(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),t.push.apply(t,r)}return t}function I(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?Z(Object(t),!0).forEach(function(n){(0,r.Z)(e,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):Z(Object(t)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})}return e}var O=(0,o.forwardRef)(function(e,n){var t=e.columns,r=e.history,i=e.initialSort,u=e.meta,d=e.refetch,l=e.paginationSize,f=e.containerHeight,g=e.noResultsMessage,v=e.autoHeight,y=(0,a.useRouter)(),x=y.query,j=void 0===x?{}:x,Z=(0,o.useState)(parseInt(null==j?void 0:j.page,10)||1),O=Z[0],$=Z[1],U=(0,o.useState)(l||h.C1.paginationSize),q=U[0],C=U[1];i||(i={item:"createdAt",order:"desc"});var A=(0,o.useState)({item:i.item,order:i.order}),k=A[0],S=A[1],L=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,n=y.query,t=void 0===n?{}:n;if(e>1?t.page=e:delete t.page,!(Object.keys(t).length>0))return{};var r=Object.keys(t).map(function(n){return"page"===n?"".concat(n,"=").concat(e):"".concat(n,"=").concat(t[n])}).join("&");return"?".concat(r)},M=function(){S({item:i.item,order:i.order}),$(1);var e=L();y.push(e),C(l||h.C1.paginationSize)};(0,o.useImperativeHandle)(n,function(){return{currentPage:O,pageSize:q,sort:k,resetPagination:function(){M()}}});var D=function(e){var n=L(e);r&&y.push(n),$(e),!r&&d&&d()},T=function(e){e&&e.field&&e.sort?(S({item:t.find(function(n){return n.field===e.field}).sortName||e.field||e.item||i.item,order:e.sort||e.order||i.order}),d&&d()):(S({item:i.item,order:i.order}),d&&d())};return(0,b.jsxs)(w,{containerHeight:f,children:[(0,b.jsx)(P,I({hideFooter:!0,disableColumnMenu:!0,disableSelectionOnClick:!0,autoHeight:v,sortingMode:"server",onSortModelChange:function(e){return T(e[0])},columns:t,pageSize:q,slots:{columnSortedAscendingIcon:function(){return(0,b.jsx)(p.Z,{})},columnSortedDescendingIcon:function(){return(0,b.jsx)(m.Z,{})},columnUnsortedIcon:function(){return(0,b.jsxs)(c.Z,{alignItems:"center",sx:{width:"33px"},children:[(0,b.jsx)(p.Z,{sx:{marginBottom:"-15px"}}),(0,b.jsx)(m.Z,{})]})},noResultsOverlay:function(){return(0,b.jsx)(c.Z,{height:"100%",alignItems:"center",justifyContent:"center",spacing:1,p:1,children:(0,b.jsx)(s.Z,{children:g})})},noRowsOverlay:function(){return(0,b.jsx)(c.Z,{height:"100%",alignItems:"center",justifyContent:"center",spacing:1,p:1,children:(0,b.jsx)(s.Z,{children:g})})}}},e)),u&&Math.ceil(u.aggregate.totalCount/q)>1&&(0,b.jsx)(_,{currentPage:O,totalCount:u.aggregate.totalCount,pageSize:q,onPageChange:D})]})});O.defaultProps={columns:[],history:!1,loading:!1,rows:[],noResultsMessage:"There are no results.",autoHeight:!0};var w=(0,u.ZP)(d.Z)(function(e){return{height:e.containerHeight,display:"flex",flexDirection:"column"}}),P=(0,u.ZP)(i.s)(function(e){var n,t=e.theme,o=e.hideHeader,a=(e.rows,e.loading,e.rowHeight),i=e.isPdf;return n={"--DataGrid-overlayHeight":"40px"},(0,r.Z)(n,"&.MuiDataGrid-root",I({color:t.palette.black.main,border:"none"},i&&{"@media print":{display:"block"}})),(0,r.Z)(n,"& .MuiDataGrid-main",I({},i&&{"@media print":{overflow:"visible !important"}})),(0,r.Z)(n,"& .MuiDataGrid-columnHeaders",I(I({},o&&{display:"none"}),{},{"& .MuiDataGrid-iconButtonContainer":{visibility:"visible","& .MuiButtonBase-root.MuiIconButton-root":{backgroundColor:"inherit",color:t.palette.black.main,"&:hover":{backgroundColor:"rgba(0, 0, 0, 0.1)"}}}})),(0,r.Z)(n,"& .MuiDataGrid-virtualScroller",I(I({},o&&{marginTop:"0 !important"}),i&&{"@media print":{overflow:"visible !important"}})),(0,r.Z)(n,"& .MuiDataGrid-iconSeparator",{opacity:0}),(0,r.Z)(n,"& .MuiDataGrid-columnHeaderTitle",{fontWeight:700}),(0,r.Z)(n,"& .MuiButtonBase-root.MuiDataGrid-columnHeaderTitle",{fontWeight:700}),(0,r.Z)(n,"& .MuiDataGrid-virtualScrollerContent",I({},i&&{height:"initial !important",minHeight:"initial !important"})),(0,r.Z)(n,"& .MuiDataGrid-virtualScrollerRenderZone",I({},i&&{position:"relative"})),(0,r.Z)(n,"& .MuiDataGrid-overlayWrapper",(0,r.Z)({},"& .MuiCircularProgress-root",{color:t.palette.secondary.main})),(0,r.Z)(n,"& .MuiDataGrid-row",I({},i&&{minHeight:"".concat(a,"cm !important"),maxHeight:"".concat(a,"cm !important")})),(0,r.Z)(n,"& .MuiDataGrid-row > .MuiDataGrid-cell",I({},i&&{minHeight:"".concat(a,"cm !important"),maxHeight:"".concat(a,"cm !important")})),(0,r.Z)(n,"& .MuiDataGrid-row.even",{backgroundColor:t.palette.muiLightGray.main,"&:hover, &.Mui-hovered":{backgroundColor:(0,l.Fq)(t.palette.muiLightGray.main,.3),"@media (hover: none)":{backgroundColor:"transparent"}},"&.Mui-selected":{backgroundColor:(0,l.Fq)(t.palette.muiLightGray.main,.3+t.palette.action.selectedOpacity),"&:hover, &.Mui-hovered":{backgroundColor:(0,l.Fq)(t.palette.muiLightGray.main,.3+t.palette.action.selectedOpacity+t.palette.action.hoverOpacity),"@media (hover: none)":{backgroundColor:(0,l.Fq)(t.palette.muiLightGray.main,.3+t.palette.action.selectedOpacity)}}}}),n})},9316:function(e,n,t){t.d(n,{E:function(){return s}});var r,o=t(50029),a=t(64687),i=t.n(a),c=t(69496),s=(r=(0,o.Z)(i().mark(function e(n,t){var r,o,a,s=arguments;return i().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=s.length>2&&void 0!==s[2]&&s[2],e.prev=1,e.next=4,n.query({query:c.WF,variables:{email:t}});case 4:if(!((a=e.sent.data.users)&&a.length>0)){e.next=8;break}return e.abrupt("return",!!r&&a[0]);case 8:return e.abrupt("return",!r||null);case 11:return e.prev=11,e.t0=e.catch(1),e.abrupt("return",!0);case 14:case"end":return e.stop()}},e,null,[[1,11]])})),function(e,n){return r.apply(this,arguments)})},19796:function(e,n,t){t.d(n,{H:function(){return z}});var r,o,a=t(59499),i=t(27812),c=t(67294),s=t(6812),u=t(42283),d=t(79665),l=t(69368),p=t(26447),m=t(15861),h=t(98456),f=t(5616),g=t(94054),v=t(56815),b=t(50135),y=t(76600),x=t(49501),_=t(95103),j=t(55563),Z=t(90951),I=t(3915),O=t(18902),w=t(74231),P=(0,w.Ry)().shape({nameFirst:(0,w.Z_)().required(),nameLast:(0,w.Z_)().required(),email:(0,w.Z_)().required().email(),phone:(0,w.Z_)().required(),status:(0,w.Z_)().when("$hasRole",function(e){return e?(0,w.Z_)().oneOf(["active","inactive"]).required():void 0}),invoiceThreshold:(0,w.Rx)().nullable(!0).transform(function(e){return isNaN(e)?null:e}),quoteThreshold:(0,w.Rx)().nullable(!0).transform(function(e){return isNaN(e)?null:e}),role:(0,w.Z_)().when(["$hasRole","$hasOneOwner","accountId"],function(e,n,t){if(e)return n?(0,w.Z_)().oneOf(["owner"],"Each account must have a designated owner.\n          If you would like to change the account type on this user,\n          please create another user account and designate this new account as an owner."):t&&t.length>0&&(0,w.Z_)().required()}),position:(0,w.Z_)().when("accountId",{is:function(e){return e&&e.length>0},then:(0,w.Z_)()}),isContact:(0,w.Z_)().when("accountId",{is:function(e){return e&&e.length>0},then:(0,w.Z_)().oneOf(["yes","no"]).required()}),location:(0,w.IX)().when("$hasLocation",function(e){return e?(0,w.IX)().of((0,w.Rx)().integer().required()).required():void 0})}),$=t(72936),U=t(69496),q=t(42846),C=t(60092),A=t(63928),k=t(50480),S=t(85893),L=function(e){var n=e.name,t=e.control,r=e.permissions,o=e.styles;return(0,S.jsxs)(f.Z,{sx:o,children:[(0,S.jsx)(m.Z,{variant:"h6",color:"dark.main",sx:{fontFamily:"Arial, sans-serif, sans-serif",fontWeight:"normal"},children:"Permissions"}),(0,S.jsx)(p.Z,{spacing:1,direction:"row",children:r.map(function(e){return(0,S.jsx)(u.Qr,{name:"".concat(n?n+".":"").concat(e.name),control:t,render:function(n){var t=n.value,r=n.onChange;return(0,S.jsx)(k.Z,{color:"dark.main",control:(0,S.jsx)(l.Z,{color:"secondary",checked:t,onChange:function(e){return r(e.target.checked)}}),label:e.label})}})})})]})};L.defaultProps={permissions:[]};var M={customer_user:[{label:"Job reports",name:"jobReports"},{label:"PPM Schedules",name:"ppmSchedules"},{label:"Quotes",name:"quotes"},{label:"Finances",name:"finances"}]},D=t(71383),T=t(75063),E=(0,T.Ps)(r||(r=(0,D.Z)(["\n  query GetUserEditOffCanvas($userId: Int!, $accountId: Int, $includeAccount: Boolean!) {\n    user: User_by_pk(id: $userId) {\n      id\n      name: nameFirst\n      nameFirst\n      nameLast\n      phone\n      status\n      email\n      createdAt\n      meta\n      invoiceThreshold\n      quoteThreshold\n      accounts: Account_Users(where: { accountId: { _eq: $accountId } })\n        @include(if: $includeAccount) {\n        id\n        role\n        position\n        isContact\n        status\n        modules\n        account: Account {\n          id\n          name\n          type\n        }\n        userLocations: User_Account_Locations {\n          accountLocationId\n        }\n      }\n    }\n  }\n"]))),F=(0,T.Ps)(o||(o=(0,D.Z)(['\n  query FindOwnersByAccount($accountId: Int, $userId: Int) {\n    accountUsers: Account_User(\n      where: { role: { _eq: "owner" }, accountId: { _eq: $accountId }, userId: { _neq: $userId } }\n    ) {\n      id\n      role\n    }\n  }\n']))),R=t(32836);function G(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),t.push.apply(t,r)}return t}function N(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?G(Object(t),!0).forEach(function(n){(0,a.Z)(e,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):G(Object(t)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})}return e}var H=["customer_user"],B=["customer_user","tenant_user"],z=function(e){var n,t=e.userId,r=e.accountId,o=e.accountType,a=e.submit,w=(0,$.x)(),k=w.hasRole,D=w.user,T=(0,q.x)({filters:{}}),G=T.initialData,z=T.ref,W=(0,c.useState)(!0),Q=W[0],X=W[1],J=(0,c.useState)(""),V=J[0],Y=J[1],K=(0,c.useState)(null),ee=K[0],en=K[1],et=(0,u.cI)({defaultValues:{id:t,accountId:r},resolver:(0,d.S)(P),context:{hasRole:(0,A.t4)(o,k),hasLocation:!H.includes(D.role)&&H.includes(V),hasOneOwner:Q}}),er=et.control,eo=et.errors,ea=et.handleSubmit,ei=et.register,ec=et.watch,es=et.reset,eu=et.setValue,ed=ec("role"),el=ec("location");(0,c.useEffect)(function(){Y("".concat(o,"_").concat(ed))},[o,ed]);var ep=(0,s.a)(E,{skip:!t,variables:{userId:t,accountId:r,includeAccount:!!r},onCompleted:function(e){var n,t=e.user,a={id:t.id,accountId:t.accountId,nameFirst:t.nameFirst||"",nameLast:t.nameLast||"",email:t.email||"",phone:t.phone||"",invoiceThreshold:t.invoiceThreshold,quoteThreshold:t.quoteThreshold,role:"",position:"",isContact:"",status:"active",meta:t.meta},i=null===(n=t.accounts)||void 0===n?void 0:n.find(function(e){return e.account.id===r});i&&(a.accountUserId=i.id,a.accountId=i.account.id,a.role=i.role,a.position=i.position,a.isContact=!0===i.isContact?"yes":"no",a.status=i.status,a.location=i.userLocations.map(function(e){return e.accountLocationId}),a.modules=i.modules),es(a),Y("".concat(o,"_").concat(a.role)),en(a.accountUserId)}}),em=ep.data,eh=(em=void 0===em?{}:em).user,ef=ep.loading;(0,s.a)(F,{skip:!r,variables:{accountId:r,userId:t},onCompleted:function(e){X(!(e.accountUsers.length>0))}});var eg=(0,s.a)(U.ZA,{variables:N(N({},G),{},{accountId:r})}),ev=eg.data,eb=(ev=void 0===ev?{location:[],meta:{aggregate:{totalCount:0}}}:ev).location,ey=ev.meta,ex=eg.loading,e_=eg.refetch,ej=(0,i.Z)(O.I);switch(o){case"supplier":ej.push({text:"Operative",value:"contractor"});break;case"admin":ej.push({text:"Helpdesk",value:"helpdesk"})}var eZ={control:er,errors:eo,register:ei},eI=function(e){a(e,null==eh?void 0:eh.meta)},eO=(0,c.useCallback)(function(e){return function(n){n.target.checked?eu("location",[].concat((0,i.Z)(null!=el?el:[]),[e])):eu("location",el.filter(function(n){return n!==e}))}},[el,eu]),ew=(0,c.useMemo)(function(){return[{sortable:!1,minWidth:10,field:"id",headerName:"",renderCell:function(e){var n=e.row;return(0,S.jsx)(l.Z,{color:"secondary",checked:null==el?void 0:el.includes(n.id),onChange:eO(n.id)})}},{sortable:!1,flex:1,field:"name",headerName:"Name"},{sortable:!1,flex:1,field:"address",headerName:"Address",renderCell:function(e){var n=e.row;return n.address?(0,S.jsxs)(p.Z,{children:[(0,S.jsx)(m.Z,{children:n.address.addressLine1}),(0,S.jsx)(m.Z,{children:n.address.postCode})]}):(0,S.jsx)(m.Z,{children:"Please add"})}}]},[el,eO]);if(ef)return(0,S.jsx)(p.Z,{widht:"100%",alignItems:"center",children:(0,S.jsx)(h.Z,{color:"secondary"})});var eP={id:(0,A.t4)(o,k)};return(0,S.jsxs)(y.Z,{id:"offCanvasForm",handleSubmit:ea(eI),children:[(0,S.jsx)(I.q,N({},eZ)),r&&(0,S.jsxs)(S.Fragment,{children:[(0,S.jsxs)(f.Z,{children:[(0,A.t4)(o,k)&&(0,S.jsx)(g.Z,{fullWidth:!0,error:eo.role,children:(0,S.jsxs)(x.Z,{label:"Role",children:[(0,S.jsx)(_.Z,N(N({},eZ),{},{name:"role",options:ej})),(0,S.jsx)(v.Z,{sx:{margin:0},children:null===(n=eo.role)||void 0===n?void 0:n.message})]})}),(0,S.jsx)(x.Z,{label:"Position / Job title",children:(0,S.jsx)(j.Z,N(N({},eZ),{},{name:"position"}))}),(0,A.pP)({accountType:o,role:ed,hasRole:k})&&(null==eh?void 0:eh.id)!==D.id&&(0,S.jsxs)(S.Fragment,{children:[(0,S.jsx)(x.Z,{label:"Threshold limit / Invoice",children:(0,S.jsx)(b.Z,{inputRef:ei,inputProps:{min:0},size:"small",name:"invoiceThreshold",type:"number",sx:{width:"100%",fieldset:{border:"1px solid ".concat(C.Q.COLOUR.dark)}},InputProps:{sx:{input:{padding:"0 0.725rem",height:"2.25rem"}}}})}),(0,S.jsx)(x.Z,{label:"Threshold limit / Quote",children:(0,S.jsx)(b.Z,{inputRef:ei,inputProps:{min:0},size:"small",name:"quoteThreshold",type:"number",sx:{width:"100%",fieldset:{border:"1px solid ".concat(C.Q.COLOUR.dark)}},InputProps:{sx:{input:{padding:"0 0.725rem",height:"2.25rem"}}}})})]}),(0,S.jsx)(Z.Z,N(N({},eZ),{},{data:[{id:"yes",label:"Yes",value:"yes"},{id:"no",label:"No",value:"no"}],legend:"Contact User",name:"isContact",stacked:!0})),B.includes(V)&&t!==D.id&&(0,S.jsx)(L,{name:"modules",control:er,permissions:M[V],styles:{mb:2}})]}),(0,S.jsx)(f.Z,{children:H.includes(V)&&t!==D.id&&(0,S.jsxs)(x.Z,{label:"Locations",children:[(0,S.jsx)(R.i,{columnVisibilityModel:eP,columns:ew,loading:ex,meta:ey,ref:z,refetch:e_,rows:eb.map(function(e){var n;return{id:e.accountLocations[0].id,name:e.name,address:null===(n=e.addresses[0])||void 0===n?void 0:n.address}})}),(0,S.jsx)("input",N(N({},ei("location")),{},{type:"hidden"}))]})})]}),t&&(0,S.jsx)(j.Z,N(N({},eZ),{},{name:"id",type:"hidden"})),r&&(0,S.jsx)(j.Z,N(N({},eZ),{},{name:"accountId",type:"hidden"})),ee&&(0,S.jsx)(j.Z,N(N({},eZ),{},{name:"accountUserId",type:"hidden"}))]})}},63928:function(e,n,t){t.d(n,{pP:function(){return d},qF:function(){return s},t4:function(){return u},te:function(){return c}});var r=t(27812),o=t(59499),a=t(19015);function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),t.push.apply(t,r)}return t}var c=function(e,n,t){var r={};return e.id?(r.id=parseInt(e.id),r.changes={nameFirst:e.nameFirst,nameLast:e.nameLast,email:e.email,phone:e.phone,meta:function(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach(function(n){(0,o.Z)(e,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})}return e}({},n),invoiceThreshold:e.invoiceThreshold||null,quoteThreshold:e.quoteThreshold||null},e.accountUserId?(r.updateAccountUser=!0,r.accountUserId=parseInt(e.accountUserId),r.accountUserChanges={role:e.role,position:e.position,isContact:"yes"===e.isContact,status:e.status,modules:e.modules}):(r.accountUserId=0,r.updateAccountUser=!1)):(r.role=e.role||"user",r.position=e.position,r.isContact="yes"===e.isContact,r.status=e.status,r.accountId=e.accountId,r.modules=e.modules,t?r.userId=t.id:r.User={data:{nameFirst:e.nameFirst,nameLast:e.nameLast,email:e.email,phone:e.phone,status:e.status,meta:{sendDefaultWelcomeEmail:!0},invoiceThreshold:e.invoiceThreshold||null,quoteThreshold:e.quoteThreshold||null}}),r},s=function(e){return{accountUserId:e.accountUserId,objects:e.location.map(function(n){return{accountUserId:e.accountUserId,accountLocationId:n}})}},u=function(e,n){return"customer"!==e&&"supplier"!==e||n([].concat((0,r.Z)(a.td),(0,r.Z)(a.Sf),(0,r.Z)(a.n),(0,r.Z)(a.nx)))},d=function(e){var n=e.accountType,t=e.role,r=e.hasRole;return r(["admin_owner","customer_owner","supplier_owner"])?!["admin_owner","customer_owner","supplier_owner"].includes("".concat(n,"_").concat(t)):r(["customer_manager","supplier_manager"])?["admin_user","customer_user","supplier_user"].includes("".concat(n,"_").concat(t)):!!r(["admin_manager"])&&["admin_user","customer_user","supplier_user","customer_manager","supplier_manager"].includes("".concat(n,"_").concat(t))}},39259:function(e,n,t){t.d(n,{P:function(){return D}});var r=t(27812),o=t(59499),a=t(50029),i=t(16835),c=t(64687),s=t.n(c),u=t(67294),d=t(11163),l=t.n(d),p=t(66252),m=t(6812),h=t(50319),f=t(69496),g=t(78289),v=t(73987),b=t(62466),y=t(68956),x=t(26186),_=t(16551),j=t(77439),Z=t(58965),I=t(55843),O=t(15214),w=t(67872),P=t(99229),$=t(42846),U=t(19796),q=t(63928),C=t(14651),A=t(9316),k=t(19015),S=t(85893);function L(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),t.push.apply(t,r)}return t}function M(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?L(Object(t),!0).forEach(function(n){(0,o.Z)(e,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):L(Object(t)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})}return e}var D=function(e){var n,t=e.accountType,o=e.filters,c=(0,p.x)(),d=(0,$.x)({filters:o}),L=d.initialData,D=d.ref,T=(0,u.useContext)(g.Z),E=(0,u.useContext)(v.Z).user,F=null,R=(0,m.a)(f.fo,{variables:L}),G=R.data,N=(G=void 0===G?{users:[],meta:{aggregate:{totalCount:0}}}:G).users,H=G.meta,B=R.loading,z=R.refetch,W=(0,h.D)(f.I4,{onCompleted:function(e){T.close(),z()}}),Q=(0,i.Z)(W,2),X=Q[0],J=Q[1].error,V=(0,h.D)(f.AX,{onCompleted:function(e){T.close(),z()}}),Y=(0,i.Z)(V,2),K=Y[0],ee=Y[1].error,en=(0,h.D)(f.tW,{onCompleted:function(e){z()}}),et=(0,i.Z)(en,2),er=et[0],eo=et[1].error;J&&J.graphQLErrors.forEach(function(e){var n;F=(null===(n=e.extensions)||void 0===n?void 0:n.code)==="constraint-violation"?"Error: a user with this e-mail address already exists":"Error creating user"}),ee&&ee.graphQLErrors.forEach(function(e){var n;F=(null===(n=e.extensions)||void 0===n?void 0:n.code)==="constraint-violation"?"Error, a user with this e-mail address already exists":"Error updating user"}),eo&&(F="Error getting user`s locations");var ea,ei=(n=(0,a.Z)(s().mark(function e(n,t){var r,o,a,i;return s().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,A.E)(c,n.email,!0);case 2:if(r=e.sent,o=(0,q.te)(n,t,r),!n.id){e.next=9;break}K({variables:M({},o)}),n.location&&er({variables:M({},(0,q.qF)(n))}),e.next=14;break;case 9:return e.next=11,X({variables:{objects:o}});case 11:i=e.sent.data.insert_Account_User.returning,n.location&&er({variables:M({},(0,q.qF)({location:n.location,accountUserId:i[0].id}))});case 14:case"end":return e.stop()}},e)})),function(e,t){return n.apply(this,arguments)}),ec=function(e,n){e.stopPropagation(),T.show({content:(0,S.jsx)(U.H,{userId:null==n?void 0:n.id,accountId:null==n?void 0:n.accountId,accountType:t,submit:ei,submitError:F}),title:"Edit user",width:"50%"})},es=function(e){e.stopPropagation(),T.show({content:(0,S.jsx)(U.H,{accountId:o.accountId,accountType:t,submit:ei,submitError:F}),title:"Add user",width:"50%"})},eu=function(e,n){e.stopPropagation(),T.show({content:(0,S.jsx)(P.G,{category:"avatar",entity:"User",entityId:n.id,limit:1,type:"image"}),submit:!1,title:"Upload avatar"})},ed=[{hidden:!0},{text:"Name"},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:o.accountId,formatter:(0,b.Z)("","accountId","account","url"),text:"Account"},{text:"Email Address"},{text:"Contact User",formatter:function(e){var n=e.row;if(e.data,n.accountUser.isContact)return(0,S.jsx)(C.Z,{color:"error"})}},{text:"Phone"},{text:"Position"},{hidden:!0},{hidden:!o.accountId,text:"Role"},{text:"Status"},{text:"Date Added",sortable:!0,sortName:"createdAt"},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{formatter:function(e){var n=e.row,o=e.data;if(("supplier"===t||"customer"===t)&&(E.email===n.email||[].concat((0,r.Z)(k.td),(0,r.Z)(k.Sf),(0,r.Z)(k.n),(0,r.Z)(k.nx)).includes(E.role))||[].concat((0,r.Z)(k.td),(0,r.Z)(k.Sf),(0,r.Z)(k.n),(0,r.Z)(k.nx)).includes(E.role))return(0,S.jsx)(y.Z,{row:n,data:o})},formatterData:[{context:"secondary",icon:["fas","edit"],onClick:ec,tooltip:"Edit"},{context:"info",icon:["fas","file-upload"],onClick:eu,tooltip:"Avatar"}],text:"Actions"}],el=function(e){l().push("".concat("/dashboard/users/","view?id=").concat(e.id))},ep=function(){return(0,S.jsx)(_.Z,{children:(0,S.jsx)(j.Z,{context:"secondary",content:"Edit",onClick:es,size:"sm",children:"Create User"})})};return(0,S.jsxs)(Z.Z,{toolbar:o.accountId&&[].concat((0,r.Z)(k.td),(0,r.Z)(k.Sf),(0,r.Z)(k.n),(0,r.Z)(k.nx)).includes(E.role)&&(0,S.jsx)(ep,{}),open:!0,title:"Users",children:[(0,S.jsx)(w.t,{columns:ed,loading:B,meta:H,ref:D,refetch:z,rowClick:el,rows:(ea=[],N.forEach(function(e){var n,t,r,a=null;a=o.accountId?e.accounts.find(function(e){var n;return(null===(n=e.account)||void 0===n?void 0:n.id)===parseInt(o.accountId)}):e.accounts.find(function(e){return null!==e.account});var i={id:e.id,name:"".concat(e.nameFirst," ").concat(e.nameLast),nameFirst:e.nameFirst,nameLast:e.nameLast,accountId:a&&a.account.id,type:a&&a.account.type,email:e.email,account:a?"".concat(a.account.name," (").concat(a.account.type,")"):"-",phone:e.phone,position:null!==(n=a)&&void 0!==n&&n.position?a.position:"N/A",accountUser:a,role:null===(t=a)||void 0===t?void 0:t.role,status:a?a.status:e.status,createdAt:(0,x.Z)(e.createdAt),url:a&&!["admin","tenant"].includes(a.account.type.toLowerCase())?"/dashboard/".concat(null===(r=a)||void 0===r?void 0:r.account.type.toLowerCase(),"s/view"):"",invoiceThreshold:e.invoiceThreshold,quoteThreshold:e.quoteThreshold,meta:e.meta,actions:""};ea.push(i)}),ea)}),F&&(0,S.jsxs)(S.Fragment,{children:[(0,S.jsx)(I.Z,{}),(0,S.jsx)(O.Z,{content:F,context:"warning"})]})]})}},3915:function(e,n,t){t.d(n,{q:function(){return v}});var r=t(27812),o=t(59499),a=t(9270),i=t(62140),c=t(49501),s=t(55563),u=t(70982),d=t(95103),l=t(26380),p=t(72936),m=t(19015),h=t(85893);function f(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),t.push.apply(t,r)}return t}function g(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?f(Object(t),!0).forEach(function(n){(0,o.Z)(e,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):f(Object(t)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})}return e}var v=function(e){var n=e.errors,t=e.prefix,o=e.register,f=(0,p.x)().hasRole,v={errors:n,register:o};return(0,h.jsxs)(h.Fragment,{children:[(0,h.jsxs)(a.Z,{children:[(0,h.jsx)(i.Z,{md:6,children:(0,h.jsx)(c.Z,{label:"First name",children:(0,h.jsx)(s.Z,g(g({},v),{},{name:"".concat(t,"nameFirst")}))})}),(0,h.jsx)(i.Z,{md:6,children:(0,h.jsx)(c.Z,{label:"Last name",children:(0,h.jsx)(s.Z,g(g({},v),{},{name:"".concat(t,"nameLast")}))})}),(0,h.jsx)(i.Z,{md:6,children:(0,h.jsxs)(c.Z,{label:"Email",children:[(0,h.jsx)(s.Z,g(g({},v),{},{name:"".concat(t,"email"),type:"email"})),n["".concat(t,"email")]&&"duplicate"===n["".concat(t,"email")].type&&(0,h.jsx)(u.Z,{message:n["".concat(t,"email")].message})]})}),(0,h.jsx)(i.Z,{md:6,children:(0,h.jsx)(c.Z,{label:"Mobile",children:(0,h.jsx)(s.Z,g(g({},v),{},{name:"".concat(t,"phone")}))})})]}),f([].concat((0,r.Z)(m.td),(0,r.Z)(m.Sf),(0,r.Z)(m.n),(0,r.Z)(m.nx)))&&(0,h.jsx)(c.Z,{label:"Status",children:(0,h.jsx)(d.Z,g(g({},v),{},{name:"".concat(t,"status"),options:l.bg}))}),(0,h.jsx)(s.Z,g(g({},v),{},{name:"".concat(t,"userId"),type:"hidden"}))]})};v.defaultProps={prefix:""}},69496:function(e,n,t){t.d(n,{$E:function(){return M},AX:function(){return I},I4:function(){return Z},JA:function(){return w},MT:function(){return C},Px:function(){return $},WF:function(){return P},ZA:function(){return E},a8:function(){return U},fA:function(){return L},fo:function(){return O},ge:function(){return T},iM:function(){return S},nE:function(){return A},nh:function(){return k},r1:function(){return q},tW:function(){return F},uz:function(){return D}});var r,o,a,i,c,s,u,d,l,p,m,h,f,g,v,b,y,x,_=t(71383),j=t(75063),Z=(0,j.Ps)(r||(r=(0,_.Z)(["\n  mutation InsertAccountUser($objects: [Account_User_insert_input!]!) {\n    insert_Account_User(objects: $objects) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),I=(0,j.Ps)(o||(o=(0,_.Z)(["\n  mutation UpdateUser(\n    $id: Int!\n    $accountUserId: Int!\n    $accountUserChanges: Account_User_set_input\n    $changes: User_set_input\n    $updateAccountUser: Boolean!\n  ) {\n    update_Account_User_by_pk(pk_columns: { id: $accountUserId }, _set: $accountUserChanges)\n      @include(if: $updateAccountUser) {\n      id\n    }\n    update_User_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n  }\n"]))),O=(0,j.Ps)(a||(a=(0,_.Z)(["\n  query GetUsers(\n    $accountId: Int\n    $accountType: String\n    $date: timestamptz\n    $limit: Int\n    $offset: Int\n    $q: String\n    $orderBy: User_order_by!\n    $status: String\n  ) {\n    users: User(\n      limit: $limit\n      offset: $offset\n      where: {\n        Account_Users: { Account: { id: { _eq: $accountId }, type: { _eq: $accountType } } }\n        createdAt: { _eq: $date }\n        _or: [\n          { email: { _ilike: $q } }\n          { nameFirst: { _ilike: $q } }\n          { nameLast: { _ilike: $q } }\n        ]\n        status: { _eq: $status }\n      }\n      order_by: [$orderBy]\n    ) {\n      id\n      name: nameFirst\n      nameFirst\n      nameLast\n      phone\n      status\n      email\n      createdAt\n      meta\n      invoiceThreshold\n      quoteThreshold\n      media: Media {\n        id\n        medium: Medium {\n          id\n          category\n          filename\n          meta\n          type\n        }\n      }\n      accounts: Account_Users {\n        id\n        role\n        position\n        isContact\n        status\n        account: Account {\n          id\n          name\n          type\n        }\n        userLocations: User_Account_Locations {\n          accountLocationId\n        }\n      }\n    }\n    meta: User_aggregate(\n      where: {\n        Account_Users: { Account: { id: { _eq: $accountId }, type: { _eq: $accountType } } }\n        createdAt: { _eq: $date }\n        _or: [{ nameFirst: { _ilike: $q } }, { nameLast: { _ilike: $q } }]\n        status: { _eq: $status }\n      }\n    ) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n"]))),w=(0,j.Ps)(i||(i=(0,_.Z)(["\n  query GetUser($id: Int!) {\n    user: User_by_pk(id: $id) {\n      id\n      fullName\n      name: nameFirst\n      nameFirst\n      nameLast\n      phone\n      status\n      email\n      createdAt\n      meta\n      invoiceThreshold\n      quoteThreshold\n      media: Media {\n        id\n        medium: Medium {\n          id\n          category\n          filename\n          meta\n          type\n        }\n      }\n      accounts: Account_Users {\n        id\n        role\n        position\n        isContact\n        status\n        account: Account {\n          id\n          name\n          type\n        }\n      }\n    }\n  }\n"]))),P=(0,j.Ps)(c||(c=(0,_.Z)(["\n  query CheckDuplicateEmail($email: String!) {\n    users: User_public(where: { email: { _eq: $email } }) {\n      id\n      nameFirst\n      nameLast\n      email\n      phone\n    }\n  }\n"]))),$=(0,j.Ps)(s||(s=(0,_.Z)(["\n  fragment UserFields on User {\n    id\n    email\n    nameFirst\n    nameLast\n    fullName\n    phone\n    status\n  }\n"]))),U=(0,j.Ps)(u||(u=(0,_.Z)(["\n  mutation SendGoogleAuthCode($code: String!, $id: Int!, $type: String!) {\n    createGoogleToken(code: $code, id: $id, type: $type) {\n      success\n      tokens\n      error\n    }\n  }\n"]))),q=(0,j.Ps)(d||(d=(0,_.Z)(["\n  mutation GenerateMSURL($type: String!, $id: Int!) {\n    genenrateMSURL(id: $id, type: $type) {\n      url\n    }\n  }\n"]))),C=(0,j.Ps)(l||(l=(0,_.Z)(["\n  mutation signoutMS($id: Int!, $type: String!, $email: String!) {\n    signoutMS(id: $id, type: $type, email: $email) {\n      error\n      msId\n      success\n    }\n  }\n"]))),A=(0,j.Ps)(p||(p=(0,_.Z)(["\n  query getAccountMeta($id: Int!) {\n    account: Account_by_pk(id: $id) {\n      meta\n    }\n  }\n"]))),k=(0,j.Ps)(m||(m=(0,_.Z)(["\n  query user($id: Int!) {\n    user: User_by_pk(id: $id) {\n      meta\n      invoiceThreshold\n      quoteThreshold\n    }\n  }\n"]))),S=(0,j.Ps)(h||(h=(0,_.Z)(["\n  query GetAccountUserMeta($userId: Int!, $accountId: Int!) {\n    accountUser: Account_User(where: { userId: { _eq: $userId }, accountId: { _eq: $accountId } }) {\n      meta\n    }\n  }\n"]))),L=(0,j.Ps)(f||(f=(0,_.Z)(["\n  mutation UpdateAccountUserByUserIdAccoutId(\n    $userId: Int!\n    $accountId: Int!\n    $changes: Account_User_set_input!\n  ) {\n    update_Account_User(\n      where: { userId: { _eq: $userId }, accountId: { _eq: $accountId } }\n      _set: $changes\n    ) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),M=(0,j.Ps)(g||(g=(0,_.Z)(["\n  mutation updateAccount($accountId: Int!, $set: Account_set_input!) {\n    update_Account_by_pk(pk_columns: { id: $accountId }, _set: $set) {\n      id\n    }\n  }\n"]))),D=(0,j.Ps)(v||(v=(0,_.Z)(["\n  mutation updateUserMeta($userId: Int!, $meta: jsonb!) {\n    update_User_by_pk(pk_columns: { id: $userId }, _set: { meta: $meta }) {\n      id\n      meta\n    }\n  }\n"]))),T=(0,j.Ps)(b||(b=(0,_.Z)(['\n  query userDevices($accountId: Int!) {\n    users: User(\n      where: {\n        Account_Users: { accountId: { _eq: $accountId }, status: { _eq: "active" } }\n        UserDevices: { status: { _eq: "active" } }\n        status: { _eq: "active" }\n      }\n    ) {\n      id\n      fullName\n      devices: UserDevices(\n        order_by: { updatedAt: desc_nulls_last }\n        where: { status: { _eq: "active" } }\n        limit: 1\n      ) {\n        id\n        playerId\n      }\n    }\n  }\n']))),E=(0,j.Ps)(y||(y=(0,_.Z)(['\n  query GetAccountLocations($accountId: Int, $limit: Int, $offset: Int) {\n    location: Location(\n      offset: $offset\n      limit: $limit\n      where: {\n        Account_Locations: {\n          accountId: { _eq: $accountId }\n          Account: { type: { _eq: "customer" } }\n        }\n      }\n    ) {\n      id\n      name\n      accountLocations: Account_Locations {\n        id\n      }\n      addresses: Addresses(where: { entity: { _eq: "Location" }, registered: { _eq: true } }) {\n        id\n        status\n        address: Address {\n          id\n          name\n          addressLine1\n          postCode\n        }\n      }\n    }\n    meta: Location_aggregate(\n      where: {\n        Account_Locations: {\n          accountId: { _eq: $accountId }\n          Account: { type: { _eq: "customer" } }\n        }\n      }\n    ) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n']))),F=(0,j.Ps)(x||(x=(0,_.Z)(["\n  mutation InsertUserAccountLocations(\n    $accountUserId: Int!\n    $objects: [User_Account_Location_insert_input!]!\n  ) {\n    delete_User_Account_Location(where: { accountUserId: { _eq: $accountUserId } }) {\n      affected_rows\n    }\n    insert_User_Account_Location(objects: $objects) {\n      affected_rows\n      returning {\n        id\n      }\n    }\n  }\n"])))},62929:function(e,n,t){t.d(n,{Y:function(){return o},l:function(){return r}});var r=[{text:"Account Type",value:""},{text:"Admin",value:"admin"},{text:"Customer",value:"customer"},{text:"Supplier",value:"supplier"},{text:"Tenant",value:"tenant"}],o=function(e){return[{icon:"edit",tooltip:"Edit",to:"/dashboard/".concat(e.type,"s/").concat("supplier"===e.type?"edit":"manage","?id=").concat(e.id)}]}},26380:function(e,n,t){t.d(n,{bg:function(){return r}});var r=[{text:"Status",value:""},{text:"Active",value:"active"},{text:"Inactive",value:"inactive"}]},18902:function(e,n,t){t.d(n,{I:function(){return r}});var r=[{text:"Select Role",value:""},{text:"Owner",value:"owner"},{text:"Manager",value:"manager"},{text:"User",value:"user"}]}}]);